<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /> 
  
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dijit/themes/claro/claro.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/CheckedMultiSelect.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/UploaderFileList.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/dgrid.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/skins/claro.css" />

  <style type="text/css">

.thinButton .dijitButtonNode {
	padding: 0px !important;	
}

.thinButtonHover .dijitButtonNode {
	border-color:#a5beda !important;
	border-bottom-color:#5c7590 !important;
	border-right-color:#5c7590 !important;
	color:#000 !important;
	background:#fcfdff url(/dojo/dijit/themes/claro/images/buttonHover.png) repeat-x bottom !important;
}

.thinButtonActive .dijitButtonNode {
	border-color:#366dba !important;
	background: #ededed url(/dojo/dijit/themes/claro/images/buttonActive.png) bottom repeat-x !important;
}

.datetime {
  border: 1px solid #759dc0;
  background: white;
  display: inline-block;
  width: auto;
  vertical-align: middle;
}

.datetime > .dijitDateTextBox {
  border: none;
  padding-left: .25em;
  width: 10em;
}

.datetime > .dijitDateTextBox > .dijitButtonNode {
  border: none;
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAABp0lEQVQ4y43TP2hTcRAH8E/CI4QGRKSGugkiooNUhYh9k6i4COIah4JDFkclKthFUfHFvRBQqEMGQR2LoHaKfzKo7dBRFBxEHByaIkGiyz14hoIe/Ljffe9+x9337lcyIWkrW8UBpP1ue1DAP6OOI/1uez3HS2krq+AyjuEWlrEd53AeU7iG1XhzHJfwGvcSLOJCOO9PFHQyknUm8DNx9iRoFhyHcBN78Q3bAp/FAnZNJGqWUS0A13EKO/AU5cA7OIppPC7EV5O4vIpTlIe2lgeh5zCXJ1jAGxzEZr/bXktbWYLDGOPdcNAb1xrNWVSwFglelNJW9juYPY2rkXA/GlgK+yy+4m3YVzDASrnYz8R90p7aKjYpgEv4iSHW8R23w/cyfDeihUeY+SvBcND7UGs0P2HU77ZH+JK2srsY97vtjdjGDpLhoPej1mjO5JuYczAXmzjCviAwH9mJqOh9jPZiVLlSbGFn6EpsX73gq8c0cs6mixyMQy9jNzbxEb/wJOIG2IjeK3gepI5LaSvrB0F34tH/SBIfrJpgPibwrFDiv2Qcizf/B6rfbiV80qpEAAAAAElFTkSuQmCC);
  background-color: transparent;
  background-repeat: no-repeat;
  background-position: center;
  width: 22px;
  height: 22px;
}

.datetime > .dijitDateTextBox > .dijitButtonNode > .dijitArrowButtonInner,
.datetime > .dijitTimeTextBox > .dijitButtonNode > .dijitArrowButtonInner {
  display: none;
}

.datetime > .dijitTimeTextBox {
  border: none;
  padding-left: .25em;
  width: 5em;
}

.datetime > .dijitTimeTextBox > .dijitArrowButton {
  border: none;
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y7WVP2gUQRTGf1mWrSSIEYuUqcTqPAiIf1aCzXkowTKt0wSzTYoUB8oRPEhxRZpRYjGWkjZNuEaEASHVkTqF5SFyhJBKDjnSfIOTIXeXQl/1dt5737739ptv55hiZeXmgTqwqKMB0PfWnE+qmZsA9ABoAQ2gSMIjoAfseGuOpgKWlSuAXeBNdDwGhvJvA1l0vgdsemtGITlLwA4isGNgDVgAngMv5a8plin3QLWXAdVZQ34HWPbW7HtrzoAaUPfWnHlr9oFl5aCa3Usja2ff9YKOt+Yd17Cycu+Btxr/kbfmKFesJbBjoD0D5B6wCWwA28ALTdACVjNRI4za9daMo+LHZeXuJGBfgYdA5q35A3TD6GXl5nPxrFDbh0lDn4C8rNwKcFNgp8Azb81v5RyqtgDqWUTaIbBUVm49AnwF3AC+JWA/1fFr4G5Eq8Vs2r68NSfAikAHwNMAlvCUmDaDiLQ/vDV7V4DeB554a4ZJ7DNwolqAQQ70dZ0KoAl8uaLTX1MGaaqxEdDPdNF7Cm6Vlcu5pil3S489b8152OGOdlGbxcPE2qoZC+OvOJSV+xDd4w6wLZ6Fr1mE/aqztm4JwEdvzUYKGMShEYlDVzxbAnJ9gKbGrIVRgdWgOJPkaz2RqVP5t2bJ1/8V2H/xC7gA3Mu8RLBms9sAAAAASUVORK5CYII%3D);
  background-color: transparent;
  background-repeat: no-repeat;
  background-position: center;
  width: 22px;
  height: 22px;
}

.datetime > .timezone {
  display: inline-block;
  height: 22px;
  width: 2em;
  padding-left: .25em;
}

.datetime > .dijitTimeTextBox > .dijitInputContainer > span.dijitPlaceHolder {
  padding-top: 2px;
}

.durationHour {
  width: 4.25em;
}
.durationMinute {
  width: 3.25em;
}

#CalendarStartPeriods {
  height: 14em; /* DOES NOT WORK */
}

    .dgrid {
      margin: 0px;
    }
    .dgrid-grid {
      width: 900px;
    }
    .dgrid-list {
      width: 200px;
    }
    .dgrid {
      font-size: 12px;
    }

    .dgrid .field-pk {
      width: 2em;
    }
    .dgrid .field-order {
      width: 2em;
    }
    .dgrid .field-station {
      width: 6em;
    }
    .dgrid .field-lblType {
      width: 9em;
    }
    .dgrid .field-legType {
      width: 8em;
    }
    .dgrid .field-startDateTime {
      width: 11em;
      color: gray;
    }
    .dgrid .field-dhour {
      width: 6em;
    }
    .dgrid .field-dminute {
      width: 6em;
    }
    .dgrid .field-endDateTime {
      width: 11em;
      color: gray;
    }

    .dgrid-row-even {
      background-color: ivory !important;
    }



  </style>

  <script>
var dojoConfig = {
  async: true, 
  debug: true,
  packages: [{
    name: "dstore",
    location: "http://cdn.rawgit.com/SitePen/dstore/v1.1.1"
  }, {
    name: "dmodel",
    location: "http://cdn.rawgit.com/SitePen/dmodel/master"
  }, {
    name: "dgrid",
    location: "http://cdn.rawgit.com/SitePen/dgrid/v1.1.0"
  }, {
    name: "moment",
    location: "http://cdn.rawgit.com/moment/moment/2.17.1",
    main: "moment"
  }, {
    name: "moment-timezone",
    location: "http://cdn.rawgit.com/moment/moment-timezone/0.5.10",
    main: "timezone"
  }]
};
  </script>

  <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojo/dojo.js"></script>


  <script>

require([
  "dojo/_base/declare",
  "dojo/window",
  "dojo/sniff",
  "dojo/on",
  "dojo/touch",
  "dojo/dom",
  "dojo/dom-style",
  "dojo/dom-construct",
  "dojo/parser",
  "dojo/request/script",
  "dojo/date",
  "dojo/Stateful", 
  "dojo/query", 
  "dojo/data/ObjectStore", 
  "dojo/store/Memory", 
  "dojo/store/Observable",
  "dijit/_Widget",
  "dijit/registry",
  "dijit/Dialog",
  "dijit/form/Button",
  "dijit/form/Select",
  "dijit/form/FilteringSelect",
  "dijit/form/ComboBox",
  "dojox/xml/parser", 
  "dojox/widget/Standby",
  "dojox/form/CheckedMultiSelect",
  "dstore/Memory",
  "dstore/Trackable",
  "dstore/legacy/DstoreAdapter",
  "dmodel/Model",
  "dmodel/ComputedProperty",
  "dgrid/OnDemandGrid", 
  "dgrid/Selection", 
  "dgrid/Keyboard", 
  "dgrid/Editor", 
  "dgrid/extensions/CompoundColumns",
  "moment/moment",
  "moment-timezone/builds/moment-timezone-with-data",
  
  
  "dojo/domReady!",

  "dijit/MenuBar",
  "dijit/PopupMenuBarItem",
  "dijit/Menu",
  "dijit/MenuItem",
  "dijit/MenuBarItem",
  "dijit/DropDownMenu",
  "dijit/CheckedMenuItem",
  "dijit/form/Form",
  "dijit/form/CheckBox",
  "dijit/form/TextBox",
  "dijit/form/DateTextBox",
  "dijit/form/TimeTextBox",
  "dijit/layout/TabContainer", 
  "dijit/layout/ContentPane", 
  "dojox/layout/TableContainer",
  "dojox/form/Uploader",
  "dojox/form/uploader/FileList",
], function(
  // dojo
  declare,
  win,
  has,
  on, 
  touch,
  dom, 
  domStyle,
  domConstruct, 
  parser, 
  script,
  date,
  Stateful,
  query,
  ObjectStore, 
  LegacyMemory,
  LegacyObservable,
  // dijit
  _WidgetBase,
  registry, 
  Dialog,
  Button,
  Select,
  FilteringSelect,
  ComboBox,
  // dojox
  xmlparser,
  Standby,
  CheckedMultiSelect,
  // dstore
  Memory,
  Trackable,
  DstoreAdapter,
  // dmodel
  Model,
  ComputedProperty,
  // dgrid
  OnDemandGrid, 
  Selection, 
  Keyboard, 
  Editor, 
  CompoundColumns,
  // moment
  moment,
  timezone
//  ganttSVG
  ){

  // ===============================================
  // Resize graph size
  // ===============================================
  // on window change, update the size of the svg graph.
  on(window, "resize", function(){
    var windowSize = win.getBox();

    domStyle.set("graph", { height: windowSize.h - 3 * 8 - dom.byId("navMenu").offsetHeight + "px" });
  });


  // ===============================================
  // Fix to support reset on CheckedMultiSelect.
  // ===============================================
  // source: http://jsfiddle.net/FNL3h/
  var FixedCheckedMultiSelect = declare("dojox/form/FixedCheckedMultiSelect", [ CheckedMultiSelect ], {
    reset: function() {
      this.inherited(arguments);
      if (!this._resetValue || !this._resetValue.length) {
        this._updateSelection();
      }
    },
    validator: function() {
      if (!this.required){
        return true;
      }
      return this.value.length > 0 ? true : false; 
    },
  });

  // ===============================================
  // Set data for duration input.
  // ===============================================
  
    var zeroTo99 = [];
    for( i = 0; i < 100; ++i ){
      zeroTo99.push({name: i, id: i});
    } 
    var zeroTo59 = [];
    for( i = 0; i < 60; ++i ){
      zeroTo59.push({name: i, id: i});
    } 

    var zeroTo59Store = new LegacyMemory({ data: zeroTo59 });

    var zeroTo99Store = new LegacyMemory({ data: zeroTo99 });




  // ===============================================
  // Widget for leg/lay/station from.
  // ===============================================
    var CustomEditorOperations = declare([_WidgetBase], {
      value: null,
      buildRendering: function() {
        var self = this;
        this.inherited(arguments);

        self._buttonLeg = new Button({
          label: "New leg",
          class: "thinButton",
        });
        self._buttonLayover = new Button({
          label: "New layover",
          class: "thinButton",
        });
        self._buttonDelete = new Button({
          iconClass: "dijitIconDelete",
          class: "thinButton",
        });

        self._buttonLeg.on("click", function() {
          self.grid.collection.add({pk: self.grid.collection.nextPk, 
                                    order: self.value.order + 0.1, 
                                    type: "leg", 
                                    legType: "A",
                                    dhour: 2,
                                    dminute: 0,
                                   });
          self.grid.collection.add({pk: self.grid.collection.nextPk, 
                                    order: self.value.order + 0.2, 
                                    dhour: 0,
                                    dminute: 45,
                                    type: "sta"});
          self.grid.collection.process();
        });

        self._buttonLayover.on("click", function() {
          // prevoir le chgt de duree de la station d'avant.
          self.grid.collection.add({pk: self.grid.collection.nextPk, 
                                    order: self.value.order + 0.1, 
                                    type: "lay", 
                                    dhour: 12,
                                    dminute: 0,
                                   });
          self.grid.collection.add({pk: self.grid.collection.nextPk, 
                                    order: self.value.order + 0.2, 
                                    dhour: 0,
                                    dminute: 20,
                                    type: "sta", 
                                    station: self.value.station});
          self.grid.collection.process();
        });

        self._buttonDelete.on("click", function() {
          if( self.value.order != self.grid.collection.len -1 ) {
            self.grid.collection.filter({order: self.value.order + 1}).forEach( function (object) {
              self.grid.collection.remove(object.pk);
            });
          } 
          else {
            // as this is the last leg/layover in the ordered list, I need to delete the current
            // leg/layover and the previous station, because the next one is untouchable, required
            // as the destination station.
            self.grid.collection.filter({order: self.value.order - 1}).forEach( function (object) {
              self.grid.collection.remove(object.pk);
            });
          }

          self.grid.collection.remove(self.value.pk);
          self.grid.collection.process();
        });
 
      },
      _setValueAttr: function(value) {
        this.value = value;

        if( this.value.newLegButton ) this.domNode.appendChild(this._buttonLeg.domNode);
        if( this.value.newLayButton ) this.domNode.appendChild(this._buttonLayover.domNode);
        if( this.value.deleteButton ) this.domNode.appendChild(this._buttonDelete.domNode);
      },
      _getValueAttr: function() {
        return this.value;
      },
      destroy: function() {
        this._buttonLeg.destroy();
        this._buttonLayover.destroy();
        this._buttonDelete.destroy();
        this.inherited(arguments);
      }
    });

  // ===============================================
  // Type of leg.
  // ===============================================
    var typeLegData = {
	identifier: 'type',
	items: [
		{ 'type': 'A', 'name': 'Active' },
		{ 'type': 'D', 'name': 'Deadhead' },
               ]
    };

    typeLegStore = new ObjectStore({
      objectStore: LegacyObservable(new LegacyMemory({data: typeLegData})),
      labelProperty: "name"
    });



  parser.parse().then(function(){ 
    dom.byId("loader").style.display = "none";
    dom.byId("content").style.display = "block";
  });


  registry.byId("TrainingRestBeforeH").set("store", zeroTo99Store);
  registry.byId("TrainingRestAfterH").set("store", zeroTo99Store);
  registry.byId("TrainingDurationHour").set("store", zeroTo99Store);
  
  registry.byId("TrainingRestBeforeH").set("regExp", '[0-9]+');
  registry.byId("TrainingRestAfterH").set("regExp", '[0-9]+');
  registry.byId("TrainingDurationHour").set("regExp", '[0-9]+');

  registry.byId("TrainingRestBeforeM").set("store", zeroTo59Store);
  registry.byId("TrainingRestAfterM").set("store", zeroTo59Store);
  registry.byId("TrainingDurationMinute").set("store", zeroTo59Store);

  registry.byId("TrainingRestBeforeM").set("value", 0);
  registry.byId("TrainingRestAfterM").set("value", 0);


  registry.byId("TripRestBeforeH").set("store", zeroTo99Store);
  registry.byId("TripRestAfterH").set("store", zeroTo99Store);
  
  registry.byId("TripRestBeforeH").set("regExp", '[0-9]+');
  registry.byId("TripRestAfterH").set("regExp", '[0-9]+');

  registry.byId("TripRestBeforeM").set("store", zeroTo59Store);
  registry.byId("TripRestAfterM").set("store", zeroTo59Store);



  registry.byId("transportationTime").set("store", zeroTo99Store);
  registry.byId("reportTime").set("store", zeroTo99Store);
  registry.byId("releaseTime").set("store", zeroTo99Store);
  registry.byId("midnightOffset").set("store", zeroTo99Store);

  registry.byId("transportationTime").set("regExp", '[0-9]+');
  registry.byId("reportTime").set("regExp", '[0-9]+');
  registry.byId("releaseTime").set("regExp", '[0-9]+');
  registry.byId("midnightOffset").set("regExp", '[0-9]+');

  // ===============================================
  // Install gantt svg data at the right place.
  // ===============================================
  on.emit(window, "resize", {bubbles: true,cancelable: true});


  // ===============================================
  // Load timezones.
  // ===============================================
  var array = timezone.tz.names();

  var timezoneStore = new Memory({
    idProperty: "id"
  });

  for( i = 0; i < array.length; i++){
    timezoneStore.addSync({
      id: i,
      name: array[i],
    });
  }

  var timezoneStoreAdapter = new DstoreAdapter(timezoneStore);
  registry.byId("CalendarTimezone").set("store", timezoneStoreAdapter);



  // ===============================================
  // Display "details" of an activity.
  // ===============================================
  function PopupDetails(activityId) {
    var myDialog = new Dialog({
        title: "Detail activity",
        style: "width: 300px",
        content: "Activitiy id: " + activityId
    });

    myDialog.show();
  }


  // ===============================================
  // Start Date Time + duration Hour Minute => 
  // End Date Time (readonly).
  // Here, dojo/date is used, as only local dates
  // are handled. 
  // ===============================================
  function UpdateEndDateTime(prefixId){
    var mydate = moment(registry.byId(prefixId + "StartDate").get("value"));
    var mytime = moment(registry.byId(prefixId + "StartTime").get("value"));
    
    // rebuild the start date from StartDate and StartTime field values, 
    mydate.minutes(mytime.minutes());
    mydate.hours(mytime.hours());

    // add duration to determine end datetime of the activity..
    var duration = moment.duration({
      hours: registry.byId(prefixId + "DurationHour").get("value"), 
      minutes: registry.byId(prefixId + "DurationMinute").get("value")
    });
    mydate.add(duration);
    
    // update end date and time fields.
    registry.byId(prefixId + "EndDate").set("value", mydate.toDate());
    registry.byId(prefixId + "EndTime").set("value", mydate.toDate());
  } 


  
  // ===============================================
  // return the X position in SVG, based on starting
  // calendar and the date provided in argument.
  // ===============================================
  function getPositionX(date) {
    return (date.unix() - Xorig) / 60;
  }

  // ===============================================
  //  apply the compression factor on axe X.
  // ===============================================
  function CompressX(x) {
    return x / config.XGraphCompression;
  }

  // ===============================================
  // SVG drawing
  // ===============================================

  // Assumption on the SVG:
  // - One pixel per minute, so a day is 1440px width.
  // - Group node (g) is generally used to be able to shift concept in the 
  //   right position, so drawing the inner concept is logically simpler.
  //
  // An attempt to use dojox.gfx module to draw SVG was done, but some problems 
  // occured to identify existing node, in order to add new objects.

  var svg     = dom.byId("graph"); // .getSVGDocument();
  var svgNS   = "http://www.w3.org/2000/svg";
  var xlinkNS = "http://www.w3.org/1999/xlink";

  var Xorig          = 0; // unix time of the start of the calendar.
  var HEIGHT_CM_LINE = 200;
  var IsDrawingEnable = true; // flag used to disable the drawing.

  // Draw a rectangle.
  function SVG_drawRect(type, x, y, width, height){
    var Rect = document.createElementNS(svgNS,"rect");
    Rect.setAttributeNS(null, "class", type);
    Rect.setAttributeNS(null, "x", CompressX(x));
    Rect.setAttributeNS(null, "y", y);
    Rect.setAttributeNS(null, "width", CompressX(width));
    Rect.setAttributeNS(null, "height", height);
    return Rect;
  }

  // Draw a line.
  function SVG_drawLine(type, x1, y1, x2, y2){
    var Line = document.createElementNS(svgNS,"line");
    Line.setAttributeNS(null, "class", type);
    Line.setAttributeNS(null, "x1", CompressX(x1));
    Line.setAttributeNS(null, "y1", y1);
    Line.setAttributeNS(null, "x2", CompressX(x2));
    Line.setAttributeNS(null, "y2", y2);


    return Line;
  }


  // Draw a text. 
  function SVG_drawText(type, x, y, label){
    var Text = document.createElementNS(svgNS, "text");
    Text.setAttributeNS(null, "class", type);
    Text.setAttributeNS(null, "x", CompressX(x));
    Text.setAttributeNS(null, "y", y);
    
    Text.appendChild(document.createTextNode(label));
    
    return Text;
  }


  // Draw a highlight in calendar.
  function SVG_drawHighlightSpecific(item){
    var calendarId    = svg.getElementById("calendar");
    var calendarBarId = svg.getElementById("calendar_bar");

    var G       = document.createElementNS(svgNS, "g");
    G.setAttributeNS(null, "id", item.get("ident"));
    calendarId.appendChild(G);

    G.appendChild(SVG_drawText("highlight_label", item.x, 60, item.get("message")));

    // a scale is used to extend the bars, that"s why they are defined into
    // a specific group.
    var Gbar     = document.createElementNS(svgNS, "g");
    Gbar.setAttributeNS(null, "id", item.get("barident"));
    calendarBarId.appendChild(Gbar);

    Gbar.appendChild(SVG_drawRect("highlight", item.x, 0, 1, 1));
  }

  function getActivityDistancePosition(event, activity) {
    var x = activity.x;
 
    switch( event ) {
      case 1: x = x - activity.tp - activity.restb; break;
      case 2: x = x - activity.tp; break;
      case 4: x = x + activity.width; break;
      case 5: x = x + activity.width + activity.tp; break;
      case 6: x = x + activity.width + activity.tp + activity.resta; break;
    }

    return x;
  }

  // Draw a distance in calendar.
  function SVG_drawHighlightDistance(item){
    var calendarId    = svg.getElementById("calendar");

    var G       = document.createElementNS(svgNS, "g");
    G.setAttributeNS(null, "id", item.get("ident"));
    calendarId.appendChild(G);

    var from = activityStore.getSync(item.fk_act1);
    var to   = activityStore.getSync(item.fk_act2);

    console.log(item);

    var x1 = getActivityDistancePosition(item.act1_event, from);
    var x2 = getActivityDistancePosition(item.act2_event, to);

    var y1 = crewMemberStore.getSync(from.fk_cm).y;
    var y2 = crewMemberStore.getSync(to.fk_cm).y; 

    var y = Math.max(y1, y2);

    if( x2 < x1 ) {
      var tmp = x1;
      x1 = x2;
      x2 = tmp;
      
      tmp = y1;
      y1 = y2;
      y2 = tmp;
    }
    
    var dur = x2 - x1;
    var min = dur % 60;

    var label = Math.floor(dur / 60) + "h";
    label += min > 9 ? min : "0" + min;
 
    G.appendChild(SVG_drawText("distance_label", (x1 + x2) / 2 , y, label));
    G.appendChild(SVG_drawLine("distance", x1, y, x2, y));

    var inc = HEIGHT_CM_LINE / 20;
    var xinc = inc * config.XGraphCompression; 

    // draw arrow.
    G.appendChild(SVG_drawLine("distance", x1, y, x1 + xinc, y + inc));
    G.appendChild(SVG_drawLine("distance", x1, y, x1 + xinc, y - inc ));

    // draw second arrow.
    G.appendChild(SVG_drawLine("distance", x2, y, x2 - xinc, y + inc));
    G.appendChild(SVG_drawLine("distance", x2, y, x2 - xinc, y - inc));

    // draw vertical lines.
    if( y1 < y ) {
      G.appendChild(SVG_drawLine("distance", x1, y1 - HEIGHT_CM_LINE / 2, x1, y + 2 * inc));
    }
    else {
      G.appendChild(SVG_drawLine("distance", x1, y1 + HEIGHT_CM_LINE / 2, x1, y - 2 * inc));
    }

    if( y2 < y ) {
      G.appendChild(SVG_drawLine("distance", x2, y2 - HEIGHT_CM_LINE / 2, x2, y + 2 * inc));
    }
    else {
      G.appendChild(SVG_drawLine("distance", x2, y2 + HEIGHT_CM_LINE / 2, x2, y - 2 * inc));
    }


  }

  function SVG_drawHighlight(item){
    if( item.type == "specific" ) {
      SVG_drawHighlightSpecific(item);
    }
    else if( item.type == "distance" ) {
      SVG_drawHighlightDistance(item);
    }
  }



  // Draw a calendar date. The drawing belongs to id calendar in the SVG.
  // Each "date" is embedded in a g node, with a translation on X, according
  // to the position. This way, each drawing into the g node is strictly the 
  // same for each day, except labels.
  function SVG_drawCalendarDate(item){
    var calendarId    = svg.getElementById("calendar");
    var calendarBarId = svg.getElementById("calendar_bar");

    var G       = document.createElementNS(svgNS, "g");
    G.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
    G.setAttributeNS(null, "id", item.get("ident"));
    calendarId.appendChild(G);

    G.appendChild(SVG_drawText("day_label relative", 720, -70, "Day " + item.get("relative")));

    G.appendChild(SVG_drawText("day_label yyyymmdd", 720, -20, item.get("name")));

    var minutes = 120;
    var time = moment(item.get("name"));
    var duration = moment.duration(minutes, "minutes");

    for(var i = 0; i < item.width; i += minutes){ 
      G.appendChild(SVG_drawText("hour_label", i, 0, time.format("H:mm")));
      time.add(duration);   
    }

    // a scale is used to extend the bars, that's why they are defined into
    // a specific group.
    var Gbar     = document.createElementNS(svgNS, "g");
    Gbar.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
    Gbar.setAttributeNS(null, "class", item.get("startperiod") ? "start_period" : item.get("type"));
    Gbar.setAttributeNS(null, "id", item.get("barident"));
    calendarBarId.appendChild(Gbar);

    Gbar.appendChild(SVG_drawRect("day_bar", 0, 0, item.width, 1));
    Gbar.appendChild(SVG_drawRect("line", 0, 0, 1, 1));
    Gbar.appendChild(SVG_drawRect("line", item.width, 0, 1, 1));

    for(var i = 60; i < item.width; i += minutes){ 
      Gbar.appendChild(SVG_drawRect("hour_bar", i, 0, 60, 1));
    }
  }

  // Draw a crewmember. The drawing is embedded into a g node 
  // with a translation on y, and belongs to crewmembers id.
  // There is no x translation, so every activity attached to the 
  // crewmember will be add into the g node.
  function SVG_drawCrewMember(item){
    var crewMemberId    = svg.getElementById("crewmembers");
    var crewMemberBarId = svg.getElementById("crewmember_bar");

    var G = document.createElementNS(svgNS, "g");
    G.setAttributeNS(null,"transform","translate(0, " + item.y + ")");
    G.setAttributeNS(null,"id", item.get("ident"));
    crewMemberId.appendChild(G);

    G.appendChild(SVG_drawText("crewmember", -50, HEIGHT_CM_LINE / 2, item.get("name")));

    
    var Gbar = document.createElementNS(svgNS, "g");
    Gbar.setAttributeNS(null,"transform","translate(0, " + item.y + ")");
    Gbar.setAttributeNS(null,"id", item.get("barident"));
    crewMemberBarId.appendChild(Gbar);

    Gbar.appendChild(SVG_drawRect("line", 0,   0, 1, 1));
    Gbar.appendChild(SVG_drawRect("line", 0, HEIGHT_CM_LINE, 1, 1));


    // scale vertically the calendar to fit the number of crewmember.
    var bar = svg.getElementById("calendar_bar");
    var y = item.y + item.height;
    bar.setAttribute("transform", "scale(1," + y + ")");
  }

  // Draw an activity. As the others, the drawing is embedded into a g node 
  // with a translation on y, and belongs to crewmember or opentime line.
  // Therefore no y translation is necessary, a x is used to draw the activity on
  // the rigth place in the calendar.
  function SVG_drawActivity(activity, line){

    var parentId = svg.getElementById(line.get("ident"));

    var G = document.createElementNS(svgNS, "g");
    G.setAttributeNS(null, "transform", "translate(" + CompressX(activity.x) + "," + HEIGHT_CM_LINE / 4 +")");
    G.setAttributeNS(null, "id", activity.get("ident"));

    on(G, "click", function(evt){
      PopupDetails(activity.pk);
    });
       
    parentId.appendChild(G);

    var Rect = document.createElementNS(svgNS,"rect");
    Rect.setAttributeNS(null, "class", activity.get("type"));
    Rect.setAttributeNS(null, "x", 0);
    Rect.setAttributeNS(null, "y", 0);
    Rect.setAttributeNS(null, "rx", CompressX(HEIGHT_CM_LINE / 10));
    Rect.setAttributeNS(null, "ry", CompressX(HEIGHT_CM_LINE / 10));
    Rect.setAttributeNS(null, "width", CompressX(activity.width));
    Rect.setAttributeNS(null, "height", HEIGHT_CM_LINE / 2);
    G.appendChild(Rect);

    G.appendChild(SVG_drawText("label", 10, 50, activity.get("name")));

    var startActivity = moment(activity.get("lbtStart"));
    var endActivity   = startActivity.clone();
    endActivity.add(activity.width, "m");
    
    G.appendChild(SVG_drawText("start_hour", 0 , 0, startActivity.format("HH:mm")));
    G.appendChild(SVG_drawText("end_hour", activity.width , 110, endActivity.format("HH:mm")));

    // transporation time
    if( activity.tp > 0 ){
      // before.
      G.appendChild(SVG_drawRect("TP", activity.tp * -1, 20, activity.tp, 30));
      startActivity.subtract(activity.tp, "m");
      G.appendChild(SVG_drawText("start_hour", activity.tp * -1, 20, startActivity.format("HH:mm")));

      // after.
      G.appendChild(SVG_drawRect("TP", activity.width, 50, activity.tp, 30));
      endActivity.add(activity.tp, "m");
      G.appendChild(SVG_drawText("end_hour", activity.width + activity.tp , 90, endActivity.format("HH:mm")));
    }

    // rest before
    if( activity.restb > 0 ){
      G.appendChild(SVG_drawRect("REST", ( activity.restb + activity.tp ) * -1, 20, activity.restb, 30));
      startActivity.subtract(activity.restb, "m");
      G.appendChild(SVG_drawText("start_hour", ( activity.restb + activity.tp ) * -1 , 20, startActivity.format("HH:mm")));
    }
    
    // rest after. 
    if( activity.resta > 0 ){
      G.appendChild(SVG_drawRect("REST", activity.width + activity.tp, 50, activity.resta, 30));
      endActivity.add(activity.resta, "m");
      G.appendChild(SVG_drawText("end_hour", activity.width + activity.tp + activity.resta, 90, endActivity.format("HH:mm")));
    }

  }

  // ===============================================
  // Data MODELs
  // ===============================================


  var ConfigurationModel = declare(Model, {
    schema: {
      id: { type: "numeric", default: 0 },
      transportationTime: { type: "numeric", default: 0},
      midnightOffset: { type: "numeric", default: 0},
      reportTime: { type: "numeric", default: 0},
      releaseTime: { type: "numeric", default: 0},
      timezone: { type: "string", default: ""},
      station: { type: "string", default: ""},
      calendarStart: { type: "string", default: ""},
      calendarEnd: { type: "string", default: ""},
      MenuFile: { type: "boolean", default: false, },
      MenuFileLoadSVGFile: { type: "boolean", default: false, },
      MenuFileLoadXMLStationFile: { type: "boolean", default: false, },
      MenuFileSaveSVGFile: { type: "boolean", default: true, },
      MenuCalendar: { type: "boolean", default: true, },
      MenuCalendarSetStartEnd: { type: "boolean", default: true, },
      MenuCalendarSetStartPeriods: { type: "boolean", default: true, },
      MenuBusinessObject: { type: "boolean", default: true, },
      MenuBusinessObjectShowConstants: { type: "boolean", default: false, },
      MenuBusinessObjectCreateCrewMember: { type: "boolean", default: false, },
      MenuBusinessObjectCreateActivity: { type: "boolean", default: false, },
      MenuBusinessObjectCreateActivityDayOff: { type: "boolean", default: false, },
      MenuBusinessObjectCreateActivityTrip: { type: "boolean", default: false, },
      MenuBusinessObjectCreateActivityTraining: { type: "boolean", default: false, },
      MenuBusinessObjectCreateActivityOtherActivity: { type: "boolean", default: true, },
      MenuGraphOption: { type: "boolean", default: true, },
      MenuGraphOptionCalendarDateHour: { type: "boolean", default: false, },
      MenuGraphOptionActivities: { type: "boolean", default: true, },
      MenuHighLights: { type: "boolean", default: true, },
      MenuHighLightsSpecificDateTime: { type: "boolean", default: false, },
      MenuHighLightsDistance: { type: "boolean", default: false, },
      MenuHighLightsWindow: { type: "boolean", default: true, },
      SHCoordinates: { type: "boolean", default: true, },
      SHCalendarHours: { type: "boolean", default: true, },
      SHCalendarHourBars: { type: "boolean", default: true, },
      SHCalendarDayX: { type: "boolean", default: true, },
      SHCalendarDayYYYYMMDD: { type: "boolean", default: true, },
      SHCalendarDayBars: { type: "boolean", default: true, },
      XGraphCompression: { type: "numeric", default: 1, },
    },
    validateOnSet: false,
  });


  var CalendarModel = declare(Model, {
    schema: {
      name: "string",
      relative: "numeric",
      pk: "numeric",
      startperiod: { type: "boolean", default: false},
      type: new ComputedProperty({
        dependsOn: ["pk"],
        getValue: function(pk){
          return pk % 2 ? "uneven" : "even";
        }
      }),
      ident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "cd" + pk;  // cd stands for Calendar Day.
        }
      }),
      barident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "bcd" + pk;  // bcd stands for Bar Calendar Day.
        }
      }),
      x: "numeric",
      width: "numeric",
    },
    validateOnSet: false,
    DrawSVG: function(){ 
      if( IsDrawingEnable ) SVG_drawCalendarDate(this); 
    },
    ClearSVG: function(){
      var item_lbl = svg.getElementById(this.get("ident"));
      var item_bar = svg.getElementById(this.get("barident"));
      
      if( item_lbl) item_lbl.parentNode.removeChild(item_lbl);
      if( item_bar) item_bar.parentNode.removeChild(item_bar);
    },
  });

  var CrewMemberModel = declare(Model, {
    schema: {
      name: "string",
      birthdate: "string",
      pk: "numeric",
      ident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "cm" + pk; // cm stands for CrewMember.
        }
      }),
      barident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "bcm" + pk; // bcm stands for Bar CrewMember.
        }
      }),
      y: "numeric",
      height: "numeric",
    },
    validateOnSet: false,
    DrawSVG: function(){ 
      if( IsDrawingEnable ) SVG_drawCrewMember(this); 
    },
    ClearSVG: function(){
      var item_lbl = svg.getElementById(this.get("ident"));
      var item_bar = svg.getElementById(this.get("barident"));
      
      if( item_lbl) item_lbl.parentNode.removeChild(item_lbl);
      if( item_bar) item_bar.parentNode.removeChild(item_bar);
    },
  });

  var ActivityModel = declare(Model, {
    schema: {
      name: "string",
      fullname: "string", 
      pk: "numeric",
      x: "numeric",
      width: "numeric",
      tp: "numeric",
      resta: "numeric",
      restb: "numeric",
      type: "string",
      lbtStart: "string", 
      utcStart: "string",
      utcEnd: "string",
      fk_cm: "numeric", // foreign key to CrewMember.
      ident: new ComputedProperty({ 
        dependsOn: ["pk", "type"],
        getValue: function(pk, type){
          return type.toLowerCase() + pk;  // DOxxx or TRPxxx or  .. 
        }
      }),
    },
    validateOnSet: false,
    DrawSVG: function(crewmember){ 
      if( IsDrawingEnable ) SVG_drawActivity(this, crewmember); 
    },
    ClearSVG: function(){
      var item = svg.getElementById(this.get("ident"));
    
      // an activity belongs to a crewmember. If the crewmember was cleared,
      // then the activity is also cleared !  
      if( item ) item.parentNode.removeChild(item);
    },
  });
 
  var TripDetailModel = declare(Model, {
    schema: {
      pk: "numeric",
      order: "numeric",
      type: "string",
      station: "string", 
      status: "string",
      legType: "string",

      startDateTime: "string",
      dhour: "numeric",
      dminute: "numeric",
      endDateTime: "string",

      fk_activity: "numeric",

      stationSelect: "numeric",
      legTypeSelect: "numeric",
      durationSelect: "numeric",
      newLegButton: "numeric",
      newLayButton: "numeric",
      deleteButton: "numeric",

    },
    validateOnSet: false,
  });

  var StationModel = declare(Model, {
    schema: {
      id: "string",
      code: "string",
      name: "string",
      dstShift: "string",
      dstStartLst: "string",
      dstEndLst: "string",
      utcOffset: "string",
      offset: "numeric",
      regionList: "array",
      /* do not work with query !!!
      offset: new ComputedProperty({ 
        dependsOn: ["utcOffet"],
        getValue: function(utcOffset){
          var data = offsetRegex.exec(utcOffset);

          return moment.duration({hours: data[1], minutes: data[2]}).asMinutes() * -1;
        }
      }),*/
    },
    validateOnSet: false
  });

  var HighLightModel = declare(Model, {
    schema: {
      message: "string",
      pk: "numeric",
      type: "string",
      x: "numeric",
      fk_act1: "numeric",
      act1_event: "numeric",
      fk_act2: "numeric",
      act2_event: "numeric",
      ident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "hl" + pk;  // hl stands for HighLight
        }
      }),
      barident: new ComputedProperty({ 
        dependsOn: ["pk"],
        getValue: function(pk){
          return "bhl" + pk;  // bhl stands for Bar HighLight
        }
      }),
    },
    validateOnSet: false,
    DrawSVG: function(){ 
      if( IsDrawingEnable ) SVG_drawHighlight(this); 
    },
    ClearSVG: function(){
      var item_lbl = svg.getElementById(this.get("ident"));
      var item_bar = svg.getElementById(this.get("barident"));
      
      // a hightligh  belongs to a calendar day. If a day was cleared,
      // then the hightlight is also cleared !  
      if( item_lbl ) item_lbl.parentNode.removeChild(item_lbl);
      if( item_bar ) item_bar.parentNode.removeChild(item_bar);
    },

  });
 
  // ===============================================
  // Data STOREs and events.
  // ===============================================

  
  // -----------------------------------------------
  // configurationStore

  // -----------------------------------------------
  var configurationStore = new Memory({
    Model: ConfigurationModel,
    idProperty: "id",

  });

  configurationStore.on("add, update", function(event){
    var cfg     = event.target;
    var pattern = new RegExp("^Menu");

    for(var property in cfg) {
      if( pattern.test(property) ) {
        registry.byId(property).set("disabled", cfg.get(property));
      }
    }
  });

  var config = configurationStore.Model();

  configurationStore.addSync(config);

  // -----------------------------------------------
  // calendarStore
  // -----------------------------------------------
  var TrackableMemory = declare([Memory, Trackable]);


  var calendarStore = new TrackableMemory({
    Model: CalendarModel,
    idProperty: "pk",
  });

  calendarStore.on("add", function(event){
    event.target.DrawSVG();
  });

  calendarStore.on("update", function(event){
    event.target.ClearSVG();
    event.target.DrawSVG();
  });

  calendarStore.on("delete", function(event){
    event.target.ClearSVG();
  });

  var calendarStoreAdapter = new DstoreAdapter(calendarStore);
  registry.byId("CalendarStartPeriods").set("labelAttr", "name");

  registry.byId("DayOffDatesSelect").set("labelAttr", "name");
  registry.byId("DayOffDatesSelect").setStore(calendarStoreAdapter);
  registry.byId("HighlightDatesSelect").set("labelAttr", "name");
  registry.byId("HighlightDatesSelect").setStore(calendarStoreAdapter);


  // -----------------------------------------------
  // crewMemberStore
  // -----------------------------------------------
  var crewMemberStore = new TrackableMemory({
    Model: CrewMemberModel,
    idProperty: "pk",
  });

  crewMemberStore.on("add", function(event){
    event.target.DrawSVG();
  });
  
  crewMemberStore.on("update", function(event){
    event.target.ClearSVG();
    event.target.DrawSVG();
  });

  crewMemberStore.on("delete", function(event){
    event.target.ClearSVG();
  });

  var crewMemberStoreAdapter = new DstoreAdapter(crewMemberStore);
  registry.byId("DayOffCrewMemberSelect").set("store", crewMemberStoreAdapter);
  registry.byId("TrainingCrewMemberSelect").set("store", crewMemberStoreAdapter);
  registry.byId("TripCrewMemberSelect").set("store", crewMemberStoreAdapter);


  // -----------------------------------------------
  // activityStore
  // -----------------------------------------------
  var activityStore = new TrackableMemory({
    Model: ActivityModel,
    idProperty: "pk",
  });

  activityStore.on("add", function(event){
    event.target.DrawSVG(crewMemberStore.getSync(event.target.fk_cm));
  });

  activityStore.on("update", function(event){
    event.target.ClearSVG();
    event.target.DrawSVG(crewMemberStore.getSync(event.target.fk_cm));
  });

  activityStore.on("delete", function(event){
    event.target.ClearSVG();
  });

  function IsActivityOverlap(crewmember, x , width){
    var isOverlap = false;
    
    activityStore.filter({fk_cm: crewmember}).forEach(function(object){
      var A = x;
      var B = x + width;

      var C = object.x;
      var D = object.x + object.width;

      if( !(( B <= C ) || ( A >= D ))) {    
        isOverlap = true;
      }
    });

    return isOverlap;
  }

  var activityStoreAdapter = new DstoreAdapter(activityStore);

  registry.byId("DistanceFromSelect").set("labelAttr", "fullname");
  registry.byId("DistanceFromSelect").set("searchAttr", "fullname");
  registry.byId("DistanceFromSelect").set("store", activityStoreAdapter);
  registry.byId("DistanceToSelect").set("labelAttr", "fullname");
  registry.byId("DistanceToSelect").set("searchAttr", "fullname");
  registry.byId("DistanceToSelect").set("store", activityStoreAdapter);


  // -----------------------------------------------
  // tripDetailStore
  // -----------------------------------------------
 
   var tripDetailStore = new TrackableMemory({
    Model: TripDetailModel,
    idProperty: "pk",
    len: 0,
    nextPk: 1,
    reportTime: 20,
    releaseTime: 15,
    startDateTime: new moment(),

    _updDur: function(array){
      var self = this;

      var currentDate = moment(self.startDateTime);
      for( i = 0; i < array.length ; ++i ) {
        array[i].startDateTime = currentDate.format("YYYY-MM-DD HH:mm");
        currentDate.add(array[i].dminute, "m");
        currentDate.add(array[i].dhour  , "h");
        array[i].endDateTime = currentDate.format("YYYY-MM-DD HH:mm");
      }

      console.log("_udpDur ....");
      console.log(currentDate);
      registry.byId("TripEndDate").set("value", currentDate.toDate());
      registry.byId("TripEndTime").set("value", currentDate.toDate());
    },
 
    updateDuration : function(){
      var self = this; 
      // based on the assumption that the store will have a reasonable size,
      // there is no need to re 
      self.sort('order').fetch().then(function (objects) {
        self._updDur(objects);

        for( i = 0; i < objects.length ; ++i ) {
          self.putSync(objects[i]);
        }
      });
    },

    process : function() {
      // based on the assumption that the store will have a reasonable size,
      // there is no need to re 
      var self = this; 

      self.sort('order').fetch().then(function (objects) {
        for( i = 0; i < objects.length ; ++i ) {
          objects[i].newLegButton   = 1;
          objects[i].newLayButton   = 1;
          objects[i].deleteButton   = 1;
          objects[i].stationSelect  = 1;
          objects[i].durationSelect = 1;
          objects[i].legTypeSelect  = 1;

          objects[i].order = i + 1;
        }

        for( i = 0; i < objects.length ; ++i ) {
          if( i == 0 ) { // first station
            objects[i].newLayButton   = 0;
            objects[i].deleteButton   = 0;
            objects[i].stationSelect  = 0;
            objects[i].durationSelect = 0;
            objects[i].legTypeSelect  = 0;

            objects[i].lblType        = "Report time";
            objects[i].dhour          = parseInt(self.reportTime / 60);
            objects[i].dminute        = self.reportTime % 60;
          } 
          else if( i == objects.length - 1) { // last station
            objects[i].newLegButton   = 0;
            objects[i].newLayButton   = 0;
            objects[i].deleteButton   = 0;
            objects[i].stationSelect  = 0;
            objects[i].durationSelect = 0;
            objects[i].legTypeSelect  = 0;

            objects[i].lblType        = "Release time";
            objects[i].dhour          = parseInt(self.releaseTime / 60);
            objects[i].dminute        = self.releaseTime % 60;
          }
          else if( i % 2 == 0 ) { // a station
            objects[i].deleteButton   = 0;
            objects[i].legTypeSelect  = 0;

            objects[i].lblType = "Ground time";

            if( objects[i+1].type == "lay" ) {
              objects[i].durationSelect = 0;
              objects[i].newLayButton   = 0;

              objects[i].lblType = "Release time";
              objects[i].dhour   = parseInt(self.releaseTime / 60);
              objects[i].dminute = self.releaseTime % 60;
            }
            if( objects[i-1].type == "lay" ) {
              objects[i].durationSelect = 0;
              objects[i].stationSelect  = 0;
              objects[i].newLayButton   = 0;

              objects[i].lblType = "Report time";
              objects[i].dhour   = parseInt(self.reportTime / 60);
              objects[i].dminute = self.reportTime % 60;
            }

          }
          else { // a leg or a lay.
            objects[i].newLegButton  = 0;
            objects[i].newLayButton  = 0;
            objects[i].stationSelect = 0;

            objects[i].lblType = objects[i].type == "leg" ? "Leg" : "Lay over";

            if( objects.length <= 3 ){
              objects[i].deleteButton = 0; 
            }

            // can not delete a leg when it is the first, and it is followed by a lay.
            if( i == 1 && i + 2 < objects.length && objects[i+2].type == "lay" ) {
              objects[i].deleteButton = 0; 
            }
            // can not delete a leg when it is the last, and it is preceded by a lay.
            if( i == objects.length - 2 && i > 2 && objects[i-2].type == "lay" ) {
              objects[i].deleteButton = 0; 
            }
          }
        }
        self._updDur(objects);

        for( i = 0; i < objects.length ; ++i ) {
          self.putSync(objects[i]);
        }
      });
    }
  });

  tripDetailStore.on('add', function(event){
     tripDetailStore.len += 1;
     tripDetailStore.nextPk += 1;
   }); 
   tripDetailStore.on('delete', function(event){
     tripDetailStore.len -= 1;
   }); 




  // -----------------------------------------------
  // stationStore
  // -----------------------------------------------
  var stationStore = new Memory({
    Model: StationModel,
    idProperty: "id",
  });

  // -----------------------------------------------
  // highLightStore
  // -----------------------------------------------
  var highLightStore = new Memory({
    Model: HighLightModel,
    idProperty: "pk",
  });

  highLightStore.on("add", function(event){
    event.target.DrawSVG();
  });
  
  highLightStore.on("update", function(event){
    event.target.ClearSVG();
    event.target.DrawSVG();
  });

  highLightStore.on("delete", function(event){
    event.target.ClearSVG();
  });




  // ===============================================
  // Redraw SVG
  // ===============================================
  function RemoveIntroMessage(){
    var intro = svg.getElementById("intro");
    if(intro){
      intro.parentNode.removeChild(intro);
    } 
  }

  function AdjustCrewmemberBarScaleX(x){
    var bar = svg.getElementById("crewmember_bar");
    bar.setAttribute("transform", "scale(" + x + ",1)");
  }

  function RedrawSVG(){
    IsDrawingEnable = true;

    RemoveIntroMessage();

    var x = 0;
    calendarStore.forEach(function(item){
      // on.emit(item, "update", { bubbles: true, cancelable: true });
      item.ClearSVG();
      item.DrawSVG();
      x = Math.max(x, item.get("x") + item.get("width")); 
    });
    AdjustCrewmemberBarScaleX(x);

    highLightStore.forEach(function(item){
      item.ClearSVG();
      item.DrawSVG();
    });
    crewMemberStore.forEach(function(item){
      item.ClearSVG();
      item.DrawSVG();
    });
    activityStore.forEach(function(item){
      item.ClearSVG();
      item.DrawSVG(crewMemberStore.getSync(item.fk_cm));
    });
  }

  // ===============================================
  // SAVING STORES TO SVG
  // ===============================================
  function SaveStore(store, id, obj_name){
    var InsertionPointId = svg.getElementById(id);
    var schema           = store.Model().schema;

    store.forEach(function(item){
      var objNode = document.createElementNS("", obj_name);

      InsertionPointId.appendChild(objNode);

      for(var property in schema) {
        if( schema.hasOwnProperty(property) ) {
          
          var node = document.createElementNS("", property);
          var data = item.get(property);

          if( data instanceof Array ){

            data = item.get(property).slice();

            for(var j = 0; j < data.length; j++) {
              var item = document.createElementNS("", "item");
              var t = document.createTextNode(data[j]); 
              item.appendChild(t);
              node.appendChild(item);
            }
          }
          else {
            var t = document.createTextNode(data);
            node.appendChild(t);
          }
          objNode.appendChild(node);
        }
      }    
    });
  }

  function LoadStore(store, svgNode, nodeName){
    var childrenNodes = svgNode.childNodes; // getElementsByTagName(nodeName);
    var schema = store.Model().schema;

    for(var i = 0; i < childrenNodes.length; i ++){
      var data = childrenNodes[i];
      var def = {};

      for(var property in schema) {
        if( schema.hasOwnProperty(property) ) {
          var type = typeof(schema[property]) == "object" ? schema[property].type : schema[property];
          var elements = data.getElementsByTagName(property); // [0].textContent;

          if( elements.length > 0 ){ 
            if( type == "numeric" ) def[property] = Number(elements[0].textContent);
            else if( type == "boolean") def[property] = elements[0].textContent == 'true'
            else def[property] = elements[0].textContent;
          }
        }
      }
      store.putSync(def);
    }
  }

  function SaveStores(){
   
    SaveStore(configurationStore, "ConfigurationStore", "configuration");
    SaveStore(calendarStore, "CalendarStore", "calendar");
    SaveStore(crewMemberStore, "CrewMemberStore", "crew");
    SaveStore(activityStore, "ActivityStore", "activity");
    SaveStore(highLightStore, "HighLightStore", "highligth");
    SaveStore(stationStore, "StationStore" , "station"); 
  }

  function LoadSvgStores(svgNode){
    RemoveIntroMessage();

    IsDrawingEnable = false;

    LoadStore(configurationStore, svgNode.getElementById("ConfigurationStore"),"configuration");
    // load single object (id 0) in config.
    config = configurationStore.getSync(0);
    console.log(config);          
    
    registry.byId("CalendarStart").set("value", config.calendarStart);
    registry.byId("CalendarEnd").set("value", config.calendarEnd);

    var start = moment(config.calendarStart);
    Xorig = start.unix();

    timezoneStore.filter({name: config.timezone}).fetchRange({start: 0, end: 1}).then(function(results){
      if( results.length > 0 ) {
        registry.byId("CalendarTimezone").set("value", results[0].id);
      }
    });

    LoadStore(calendarStore, svgNode.getElementById("CalendarStore"),"calendar");
    LoadStore(crewMemberStore, svgNode.getElementById("CrewMemberStore"), "crew");
    LoadStore(activityStore, svgNode.getElementById("ActivityStore"), "activity");
    LoadStore(highLightStore, svgNode.getElementById("HighLightStore"), "highligth");
    LoadStationStore(svgNode.getElementById("StationStore"), MODE_SVG);

    stationStore.filter({name: config.station}).fetchRange({start: 0, end: 1}).then(function(results){
      if( results.length > 0 ) {
        registry.byId("CalendarStation").set("value", results[0].id);
      }
    });


    RedrawSVG();
  }


  // ===============================================
  // LOADING STORES FROM SVG
  // ===============================================

  mappingStationSvgXml = { 
    "id": "id",
    "code": "code",
    "name": "name",
    "dstShift": "dst-shift",
    "dstStartLst": "dst-start-lst",
    "dstEndLst": "dst-end-lst",
    "utcOffset": "utc-offset",
    "regionList": "region-list", 
    "item": "region"
  };

  MODE_SVG = 0;
  MODE_XML = 1;
  
  // Some tags are not exactly the same in svg def and xml def of a station.
  // The xml introduce some dash character in word which is not compliant with 
  // variable name.
  function convertionSvgXml(key, mode) {
    return mode == MODE_SVG ? key : mappingStationSvgXml[key];
  }

  function LoadStationStore(parentNode, mode){
    var rootStationStoreChildren = parentNode.getElementsByTagName("station");
    var offsetRegex = /^(-?\d{2})h(\d{2})$/;
 
    for(var i = 0; i < rootStationStoreChildren.length; i ++){
      var obj = rootStationStoreChildren[i];

      var data = offsetRegex.exec(obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent);
      var offset = moment.duration({hours: data[1], minutes: data[2]}).asMinutes() * -1;
  
      var id = mode == MODE_SVG ? obj.getElementsByTagName("id")[0].textContent : obj.getAttribute("id"); 

      var regionList = obj.getElementsByTagName(convertionSvgXml("item", mode)); 

      var regions = [];
      for(var j = 0; j < regionList.length; j++){
        regions.push(regionList[j].textContent);
      }

      console.log("station code:   " + obj.getElementsByTagName(convertionSvgXml("code", mode))[0].textContent ); 
      console.log("station name:   " + obj.getElementsByTagName(convertionSvgXml("name", mode))[0].textContent );          
      console.log("station offset: " + offset );          
      
      stationStore.addSync({
        id: id,
        code: obj.getElementsByTagName(convertionSvgXml("code", mode))[0].textContent,
        name: obj.getElementsByTagName(convertionSvgXml("name", mode))[0].textContent,
        dstShift: obj.getElementsByTagName(convertionSvgXml("dstShift", mode))[0].textContent, 
        dstStartLst: obj.getElementsByTagName(convertionSvgXml("dstStartLst", mode))[0].textContent,
        dstEndLst: obj.getElementsByTagName(convertionSvgXml("dstEndLst", mode))[0].textContent,
        utcOffset: obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent,
        offset: offset,
        regionList: regions,
      });
    }
  }


  var stationStoreAdapter = new DstoreAdapter(stationStore);
  registry.byId("CalendarStation").set("store", stationStoreAdapter);



  // ===============================================
  // 
  // ===============================================

  var grid = new (declare([OnDemandGrid, Selection, Keyboard, Editor, CompoundColumns]))(
                     { collection: tripDetailStore,
                       showHeader: true,
                       noDataMessage: 'Please fill in the "Start date time" field first.',
                     },
                     'TripGrid'
                   );

     
     grid.on('dgrid-datachange', function (event) {
       var cell = grid.cell(event);
       
       var columnName =  cell.column.field;

       if( columnName == "station") {
         var nextRow = grid.down(cell.row, 1);
         if( nextRow.data.type == "lay" ){
           nextRow = grid.down(cell.row, 2);
           nextRow.data.station = event.value;
           grid.collection.putSync(nextRow.data);
         }
       }
       else if( columnName == "dhour" ) {
         cell.row.data.dhour  = event.value;
         grid.collection.putSync(cell.row.data);
         grid.collection.updateDuration();
       } 
       else if( columnName == "dminute" ) {
         cell.row.data.dminute = event.value;
         grid.collection.putSync(cell.row.data);
         grid.collection.updateDuration();
       }

     });

 var columns = [
      {
        label: "Station",
        field: "station",
        sortable: false,
        editor: FilteringSelect,
        editorArgs: {
          store: stationStoreAdapter,
          maxHeight: 150,
          style: "width:5em;",
          labelAttr: "code",
          searchAttr: "code",
          required: true,
        },
        canEdit: function (object, value) {
          return object.stationSelect;
        },
        autoSave: true,
      },
      {
        label: "Type",
        field: "lblType",
        sortable: false,
      },
      {
        label: "Leg type",
        field: "legType",
        sortable: false,
        editor: FilteringSelect,
        editorArgs: {
          store: typeLegStore,
          maxHeight: 150,
          style: "width:7em;",
          required: true,
        },
        canEdit: function (object, value) {
          return object.type == "leg";
        },
        autoSave: true,
      },
      { label: 'Start',
        field: 'startDateTime',
        sortable: false,
      },

      {
        label: 'Duration',
        children: [
          { field: 'dhour', 
            label: 'Hour', 
            sortable: false,
            editor: ComboBox,
            editorArgs: {
              store: zeroTo99Store,
              regExp: "[0-9]+",
              style: "width:5em;",
              required: true,
            },
            autoSave: true,
            canEdit: function( object, value) {
              return object.durationSelect;
            },
          },
          { field: 'dminute', 
            label: 'Minute', 
            sortable: false,
            editor: FilteringSelect,
            editorArgs: {
              store: zeroTo59Store,
              style: "width:5em;",
              required: true,
            },
            autoSave: true,
            canEdit: function( object, value) {
              return object.durationSelect;
            },
          },
        ],
      },
      { label: 'End',
        field: 'endDateTime',
        sortable: false,
      },
      {
        label: 'Operations',
        sortable: false,
        editor: CustomEditorOperations,
        editorArgs:{
          grid: grid 
        },
      },
     ];

    grid.set("columns", columns);
    grid.set('sort', 'order');

   grid.startup();          


  // ===============================================
  // EVENTS on dijit
  // ===============================================
  
  // -----------------------------------------------
  // Show/Hide dialog
  // -----------------------------------------------
  registry.byId("SHCoordinates").on("change", function(isChecked){
    svg.getElementById("coordinateX").setAttribute("display", isChecked ? "block" : "none");
    svg.getElementById("coordinateY").setAttribute("display", isChecked ? "block" : "none");
  }, true);
  
  registry.byId("SHCalendarHours").on("change", function(isChecked){
    var divs = svg.getElementsByClassName("hour_label");

    for (var i = 0; i < divs.length; i++) {
      divs[i].setAttribute("display", isChecked ? "block" : "none");
    }
  }, true);
  
  registry.byId("SHCalendarDayX").on("change", function(isChecked){
    var divs = svg.getElementsByClassName("relative");

    for (var i = 0; i < divs.length; i++) {
      divs[i].setAttribute("display", isChecked ? "block" : "none");
    }
  }, true);
  
  registry.byId("SHCalendarDayYYYYMMDD").on("change", function(isChecked){
    var divs = svg.getElementsByClassName("yyyymmdd");

    for (var i = 0; i < divs.length; i++) {
      divs[i].setAttribute("display", isChecked ? "block" : "none");
    }
  }, true);

  registry.byId("SHCalendarDayBars").on("change", function(isChecked){
    var divs = svg.getElementsByClassName("day_bar");

    for (var i = 0; i < divs.length; i++) {
      divs[i].setAttribute("display", isChecked ? "block" : "none");
    }
  }, true);

  registry.byId("SHCalendarHourBars").on("change", function(isChecked){
    var divs = svg.getElementsByClassName("hour_bar");

    for (var i = 0; i < divs.length; i++) {
      divs[i].setAttribute("display", isChecked ? "block" : "none");
    }
  }, true);

  registry.byId("XGraphCompression").on("change", function(value){
    config.XGraphCompression = value;

    configurationStore.putSync(config);          
          
    RedrawSVG();
  }, true);


  // -----------------------------------------------
  // Load XML station file dialog
  // -----------------------------------------------
  registry.byId("LoadStation").on("click", function(){
    var upload = registry.byId("uploader");

    var f = upload._files[0];
          
    if( f.type != "text/xml" ){
      alert("Please provide an xml file");
      return;
    }          

    var reader = new FileReader();

    // Closure to capture the file information and save it in the store.
    reader.onload = (function(theFile) {
      return function(e) {
        xmlDom = xmlparser.parse(e.target.result);
          
        LoadStationStore(xmlDom, MODE_XML);
      };
    })(f);

    // Read in the file as a text.
    reader.readAsText(f);

    LoadStationDialog.hide();
    
    config.MenuCalendar = false;
    config.MenuCalendarSetStartEnd = false;

    configurationStore.putSync(config);

  });

  // -----------------------------------------------
  // Load SVG file dialog
  // -----------------------------------------------
  registry.byId("LoadSvg").on("click", function(){
    var upload = registry.byId("uploader2");

    var f = upload._files[0];
          
    if( f.type != "image/svg+xml" ){
      alert("Please provide an svg file");
      return;
    }          

    var reader = new FileReader();

    // Closure to capture the file information and save it in the store.
    reader.onload = (function(theFile) {
      return function(e) {
        xmlDom = xmlparser.parse(e.target.result);
          
        LoadSvgStores(xmlDom);
      };
    })(f);

    // Read in the file as a text.
    reader.readAsText(f);

    LoadSvgDialog.hide();
  });

   
  // -----------------------------------------------
  // Constants dialog
  // -----------------------------------------------

  registry.byId("ShowConstantsDialog").on("show", function(){
    viewInForm(config, dom.byId("ShowConstantsForm"));
  }, true);

  registry.byId("SaveConstants").on("click", function(){
    if( !registry.byId("ShowConstantsForm").validate() ){
      return;
    }

    ShowConstantsDialog.hide();

    setFromForm(config, dom.byId("ShowConstantsForm"));

    configurationStore.putSync(config);
  });

  // -----------------------------------------------
  // Show/Hide dialog
  // -----------------------------------------------

  registry.byId("ShowHideDialog").on("show", function(){
    viewInForm(config, dom.byId("ShowHideForm"));
  }, true);

  registry.byId("SaveShowHide").on("click", function(){
    if( !registry.byId("ShowHideForm").validate() ){
      return;
    }

    ShowHideDialog.hide();

    setFromForm(config, dom.byId("ShowHideForm"));

    configurationStore.putSync(config);
  });

  // -----------------------------------------------
  // Save file dialog
  // -----------------------------------------------
  registry.byId("SaveFile").on("click", function(){

    SaveStores();

          
    var a           = document.createElement("a");
    var contentType = "data:application/octet-stream,";

    //get svg source.
    var serializer = new XMLSerializer();
    var source = serializer.serializeToString(svg);

    var uriContent  = contentType + encodeURIComponent(source);

    a.setAttribute("href", uriContent);
    a.setAttribute("download", registry.byId("filename").value);

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    SaveFileDialog.hide();
  }, true);

  // -----------------------------------------------
  // Calendar range set up dialog
  // -----------------------------------------------
  registry.byId("CalendarTimezone").on("focus", function(){
    if( this.get("value") ) {
      registry.byId("CalendarStation").set("disabled", false);
    }          
  }, true);

  registry.byId("CalendarTimezone").on("change", function(){
    var item = timezoneStore.getSync(this.get("value"));

    console.log("timezone :" + item); 

    if( item ) {          
      registry.byId("CalendarStation").set("disabled", false);

      if( !registry.byId("CalendarStation").get("value") ) {
//        moment.tz.setDefault(item.name);
        var zone = moment.tz.zone(item.name);

        console.log("zone: ");  
        console.log(zone);  


        var dateOutsideDST = moment();

        while( dateOutsideDST.isDST() ) {
          dateOutsideDST.subtract(1, 'months');
        }

        var offsetZone = zone.offset(dateOutsideDST.valueOf());         
        console.log("offsetZone: " + offsetZone);

        registry.byId("CalendarStation").set("value", "");
        registry.byId("CalendarStation").set("query", {offset: offsetZone});
      }
    }
  }, true);


  registry.byId("CalendarStart").on("change", function(){
    registry.byId("CalendarEnd").constraints.min = date.add(this.get("value"), "day", 1);
    registry.byId("CalendarEnd").dropDownDefaultValue = this.get("value");     

    registry.byId("TrainingStartDate").constraints.min = this.get("value");
    registry.byId("TrainingStartDate").dropDownDefaultValue = this.get("value");
    registry.byId("TripStartDate").constraints.min = this.get("value");
    registry.byId("TripStartDate").dropDownDefaultValue = this.get("value");
  }, true);
  
  registry.byId("CalendarEnd").on("change", function(){
    var maxDate = date.add(this.get("value"), "day", -1);

    registry.byId("CalendarStart").constraints.max = maxDate;

    registry.byId("TrainingStartDate").constraints.max = maxDate;
    registry.byId("TripStartDate").constraints.max = maxDate;
  }, true);

  registry.byId("SetCalendarDialog").on("show", function(){
    viewInForm(config, dom.byId("SetCalendarForm"));
  }, true);

  registry.byId("SetCalendar").on("click", function(){
    if( !registry.byId("SetCalendarForm").validate() ){
      return;
    }
    RemoveIntroMessage();

    setFromForm(config, dom.byId("SetCalendarForm"));

    var start = moment(config.calendarStart);
    Xorig = start.unix();
    var end   = moment(config.calendarEnd); 
    var range = end.diff(start, "days");

    calendarStore.fetch().then(function (days){
      for (var i = days.length - 1; i >= 0; i--) {
        calendarStore.remove(days[i].pk);
      }
    });        

    var dstStatus = start.isDST();

    var x = 0;
    var width = 0;

    for(i = 0; i < range; i++) {
      
      var nextDay = moment(start).add(1, "days");   
      width = nextDay.diff(start, "hours") * 60;

      calendarStore.addSync({
        name: start.format().substring(0, 10),
        relative: i,
        pk: i+1, // for unknown reason, checkedmultiselect does not work with 0. 
        x: x, 
        width: width - 1, 
      });

      // look for DST
      if( width != 1440 ){ 
        var InitialState =  start.isDST();

        while( start.isDST() == InitialState ){
          start.add(1, "minutes");
        }

        var pos = 0;

        // Compute the size of the store.
        highLightStore.forEach(function(item){
          pos += 1;
        }); 
     
        highLightStore.addSync({
          message: InitialState ? "End DST" : "Start DST",
          type: "specific",
          x: getPositionX(start),
          pk: pos,
        });
      }

      x += width;
      start = nextDay;
    }

    AdjustCrewmemberBarScaleX(x);

    // enabled some menu items.
    config.MenuCalendarSetStartPeriods = false;
    config.MenuBusinessObject = false;
    config.MenuGraphOption = false;
    config.MenuHighLights = false;
    config.MenuFileSaveSVGFile = false;

    configurationStore.putSync(config);

    SetCalendarDialog.hide();
  });
  

  // -----------------------------------------------
  // Manage Set Start Periods dialog
  // -----------------------------------------------
  registry.byId("SetStartPeriodsDialog").on("show", function(){
    var arrChecked = [];
    calendarStore.forEach(function(item){
      if( item.startperiod ) {
        arrChecked.push(item.pk);
      }
    });
    arrChecked.push(0);          
    console.log(arrChecked);
    registry.byId("CalendarStartPeriods").setStore(calendarStoreAdapter, arrChecked);
  }, true);

  // Redraw start periods
  registry.byId("SetStartPeriods").on("click", function(){


    var newStarts = registry.byId("CalendarStartPeriods").value;
    console.log("newStarts ");
    console.log( newStarts);          
    var ref =  newStarts.length > 0 ? newStarts[0] : 0; 

    var i = 0; 

    calendarStore.forEach(function(item){
      item.set("relative", item.pk - ref);
      if( i < newStarts.length && newStarts[i] == item.pk ) {
        item.set("startperiod", true);
        i+=1;
      }
      else {
        item.set("startperiod", false);
      }
      calendarStore.put(item);
    });

    SetStartPeriodsDialog.hide();
  });

  // -----------------------------------------------
  // Create Crewmember dialog
  // -----------------------------------------------
  registry.byId("CreateCrewMember").on("click", function(){
    var coordY = 100;
    var pos = 0;

    // Compute the position and Y coordinate of the new crewmember based on 
    // existing data.
    crewMemberStore.sort("pk").forEach(function(item){
      pos += 1;
      coordY += item.get("height");
    }); 

    // Add the new crew in the store. Event will trigger the drawing.
    crewMemberStore.addSync({
      name: registry.byId("CrewMemberName").get("value"),
      birthdate: registry.byId("CrewMemberBirthDate").get("value").toISOString().substring(0, 10),
      pk: pos,
      y: coordY,
      height: HEIGHT_CM_LINE,
    });

    CreateCrewMemberDialog.hide();
  });


  // -----------------------------------------------
  // Create Day Off dialog
  // -----------------------------------------------
  registry.byId("CreateDayOff").on("click", function(){
    if( !registry.byId("CreateDayOffForm").validate() ){
      return;
    }

    CreateDayOffDialog.hide();
    var crewmemberId = parseInt(registry.byId("DayOffCrewMemberSelect").get("value"));
    var days = registry.byId("DayOffDatesSelect").value; 

    // to avoid the "at least one item must be selected" message, form data are save in 
    // local variables before reseting the form.
    registry.byId("CreateDayOffForm").reset();
    
    var pos = 0;

    // Compute the position and Y coordinate of the new crewmember based on 
    // existing data.
    activityStore.forEach(function(item){
      pos += 1;
    }); 

    days.forEach(function(day){
      var calendarDay = calendarStore.getSync(day); 

      var x     = calendarDay.get("x");
      var width = calendarDay.get("width") + 1;

      if( IsActivityOverlap(crewmemberId, x, width) ){
        alert("Cannot create activity starting " + calendarDay.get("name") + " because of an overlap with another activity."); 
      }
      else { 
        activityStore.addSync({
          name: "DO",
          fullname: crewMemberStore.getSync(crewmemberId).name + " -- " + moment(calendarDay.get("name")).format("YYYY-MM-DD") + " -- DO",  
          type: "DO",
          pk: pos,
          fk_cm: crewmemberId,
          x: x,
          lbtStart: moment(calendarDay.get("name")).format("YYYY-MM-DD HH:mm"), 
          utcStart: moment(calendarDay.get("name")).utc().format("YYYY-MM-DD HH:mm"), 
          utcEnd: moment(calendarDay.get("name")).add(width, 'm').utc().format("YYYY-MM-DD HH:mm"), 
          width: width,
          tp: 0,
          resta: 0,
          restb: 0,
        });
        pos += 1;
      }
    });
  });

  // -----------------------------------------------
  // Create Training dialog
  // -----------------------------------------------
  function TryEnableDuration() {
    if(   registry.byId("TrainingStartTime").get("value") != null 
       && registry.byId("TrainingStartDate").get("value") != null ){
      registry.byId("TrainingDurationHour").readOnly = false;
      registry.byId("TrainingDurationHour").set("value", 0);
      registry.byId("TrainingDurationMinute").readOnly = false;
      registry.byId("TrainingDurationMinute").set("value", 0);

      UpdateEndDateTime("Training");
    }
  }

  registry.byId("TrainingStartDate").on("click,mousedown", function(){
    TryEnableDuration();          
  });

  registry.byId("TrainingStartDate").on("change", function(value){
    TryEnableDuration();          
  });

  registry.byId("TrainingStartTime").on("click,mousedown", function(){
    TryEnableDuration();          
  });

  registry.byId("TrainingStartTime").on("change", function(value){
    TryEnableDuration();          
  });

  registry.byId("TrainingDurationHour").on("click,change", function(){
    UpdateEndDateTime("Training");
  });
  
  registry.byId("TrainingDurationMinute").on("click,change", function(){
    UpdateEndDateTime("Training");
  });

  registry.byId("CreateTraining").on("click", function(){
    if( !registry.byId("CreateTrainingForm").validate() ){
      return;
    }

    CreateTrainingDialog.hide();

    var pos = 0;

    // Compute the position and Y coordinate of the new crewmember based on 
    // existing data.
    activityStore.forEach(function(item){
      pos += 1;
    }); 

    var lbtStartTraining = registry.byId("TrainingStartDate").get("value");

    var mydate = moment(registry.byId("TrainingStartDate").get("value"));
    var mytime = moment(registry.byId("TrainingStartTime").get("value"));

    // rebuild the start date from StartDate and StartTime field values, 
    mydate.hours(mytime.hours());
    mydate.minutes(mytime.minutes());
    var x                = getPositionX(mydate);
    var startTraining    = moment.tz(mydate, timezoneStore.get(config.timezone).name);

    var width = Number(registry.byId("TrainingDurationHour").get("value")) * 60 + Number(registry.byId("TrainingDurationMinute").get("value"));

    var endTraining = startTraining.clone().add(width, 'm');
    var crewmemberId = Number(registry.byId("TrainingCrewMemberSelect").get("value"));

    if( IsActivityOverlap(crewmemberId, x, width) ){
      alert("Cannot create training because of an overlap with another activity."); 
    }
    else { 
      activityStore.addSync({
        name: registry.byId("TrainingName").get("value"),
        fullname: crewMemberStore.getSync(crewmemberId).name + " -- " + mydate.format("YYYY-MM-DD HH:mm") + " -- " + registry.byId("TrainingName").get("value"),  
        type: "TRN",
        pk: pos,
        fk_cm: crewmemberId,
        x: x,
        lbtStart: mydate.format("YYYY-MM-DD HH:mm"),
        utcStart: startTraining.utc().format("YYYY-MM-DD HH:mm"),
        utcEnd: endTraining.utc().format("YYYY-MM-DD HH:mm"), 
        width: width,
        tp: registry.byId("TrainingTransportationTime").checked ? Number(config.transportationTime) : 0,  // registry.byId("TransportationTimeDuration").get("value") : 0,
        resta: Number(registry.byId("TrainingRestAfterH").get("value")) * 60 + Number(registry.byId("TrainingRestAfterM").get("value")),
        restb: Number(registry.byId("TrainingRestBeforeH").get("value")) * 60 + Number(registry.byId("TrainingRestBeforeM").get("value")),
      });
    }
  });

 
  // -----------------------------------------------
  // Create Highlight dialog
  // -----------------------------------------------
   
  registry.byId("CreateHighlight").on("click", function(){
    if( !registry.byId("CreateHighlightForm").validate() ){
      return;
    }

    CreateHighlightDialog.hide();
    var label   = registry.byId("HighlightLabel").get("value");
    var days    = registry.byId("HighlightDatesSelect").value; 
    var time    = registry.byId("HighlightTime").value; 

    // to avoid the "at least one item must be selected" message, form data are save in 
    // local variables before reseting the form.
    registry.byId("CreateHighlightForm").reset();

    var pos = 0;

    // Compute the size of the store.
    highLightStore.forEach(function(item){
      pos += 1;
    }); 
 
    if( days.length == 0 ){
      calendarStore.forEach(function(item){
        days.push(item.pk);
      }); 
    }

    for(i = 0; i < days.length; i++){
      var calDay = calendarStore.getSync(days[i]);
      
      var when = moment(calDay.get("name"));
      when.hour(time.getHours());
      when.minute(time.getMinutes());

      if( when.isValid() ){   
        highLightStore.addSync({
          message: label,
          type: "specific",
          x: getPositionX(when),
          pk: pos,
        });
        pos += 1;
      }
    }
  });  


  // -----------------------------------------------
  // Create Distance dialog
  // -----------------------------------------------
  function UpdateEvent(val, idEventSelect) {
    var activity = activityStore.getSync(val);
    if( activity ) {      
      var when = registry.byId(idEventSelect);

      when.set("disabled", false);
      when.getOptions("1").disabled = activity.restb > 0 ? false : true;
      when.getOptions("2").disabled = activity.tp > 0 ? false : true;
      when.getOptions("5").disabled = activity.tp > 0 ? false : true;
      when.getOptions("6").disabled = activity.resta > 0 ? false : true;
    }
  }
          
  registry.byId("DistanceFromSelect").on("change", function(val) {
    UpdateEvent(val, "DistanceFromEventSelect");
  });
  registry.byId("DistanceToSelect").on("change", function(val) {
    UpdateEvent(val, "DistanceToEventSelect");
  });
   
  registry.byId("CreateDistance").on("click", function(){
    if( !registry.byId("CreateDistanceForm").validate() ){
      return;
    }

    CreateDistanceDialog.hide();

    var from      = registry.byId("DistanceFromSelect").value;
    var to        = registry.byId("DistanceToSelect").value;
    var fromEvent = registry.byId("DistanceFromEventSelect").value;
    var toEvent   = registry.byId("DistanceToEventSelect").value;

    var pos = 0;

    // Compute the size of the store.
    highLightStore.forEach(function(item){
      pos += 1;
    }); 
 
    highLightStore.addSync({
      type: "distance",
      fk_act1: from,
      act1_event: Number(fromEvent),
      fk_act2: to,
      act2_event: Number(toEvent),
      pk: pos,
    });
  });  























  function TryEnableGrid() {
    console.log("TryEnableGrid");
    if(   registry.byId("TripStartTime").get("value") != null 
       && registry.byId("TripStartDate").get("value") != null ){
      console.log("computation");
      tripDetailStore.reportTime = config.reportTime;
      tripDetailStore.releaseTime = config.releaseTime;

      var mydate = moment(registry.byId("TripStartDate").get("value"));
      var mytime = moment(registry.byId("TripStartTime").get("value"));

      // rebuild the start date from StartDate and StartTime field values, 
      mydate.hours(mytime.hours());
      mydate.minutes(mytime.minutes());

      tripDetailStore.startDateTime = mydate;

      if( tripDetailStore.len == 0 ) {
        console.log("trip detail store empty, so add....");
       
        tripDetailStore.addSync({
          pk: 1,
          order: 1,
          type: "sta",
          station: config.station,
        });
        tripDetailStore.addSync({
          pk: 2,
          order: 2,
          type: "leg",
          legType: "A",
          dhour: 2,
          dminute: 0,
        });
        tripDetailStore.addSync({
          pk: 3,
          order: 3,
          type: "sta",
          station: config.station,
        });
      }
      // console.log(tripDetailStore);
      // allow to recompute end date time.
      tripDetailStore.process();
    }
  }


  registry.byId("TripStartDate").on("click,mousedown", function(){
    TryEnableGrid();          
  });

  registry.byId("TripStartDate").on("change", function(value){
    TryEnableGrid();          
  });

  registry.byId("TripStartTime").on("click,mousedown", function(){
    TryEnableGrid();          
  });

  registry.byId("TripStartTime").on("change", function(value){
    TryEnableGrid();          
  });

  registry.byId("MenuBusinessObjectCreateActivityTrip").on("click", function(){
    registry.byId("TripRestBeforeM").set("value", 0);
    registry.byId("TripRestAfterM").set("value", 0);
   
    registry.byId("CreateTripDialog").show();

    grid.resize();
  });




 registry.byId("CreateTripDialog").on("hide", function(){

    tripDetailStore.fetch().then(function (items){
      for (var i = items.length - 1; i >= 0; i--) {
        tripDetailStore.remove(items[i].pk);
      }           

      console.log("hide....");
      console.log(tripDetailStore);

      grid.refresh();
    });
 });


















  function viewInForm(object, form){
    for(var i = 0; i < form.elements.length; i++ ) {
      if(form.elements[i].name) {
        var element = form.elements[i];
        var name = element.name;
        var value = object[name];

        console.log(name);
        console.log(element.type);
        console.log(element.checked);
        console.log(object[name]);

        if( element.type == "checkbox" ) {
          console.log('on checked');
          console.log(registry.byId(name));
          registry.byId(name).set("checked", value);
        }
        else {
          console.log('on value');
          console.log(registry.byId(name));
          if( registry.byId(name) ) {
            registry.byId(name).set("value", value);
          }
          else  {
            var input = query("input[name=" + name + "]", form)[0];
            if(input){
              console.log(name + "---" + value);
              // here is a little hack. dijit dialog create an hidden input with the right name.
              // but the one used to display is the sibling before. So I reference the parent and
              // pick the first child with the right class.
              var dijitInputInner  = query(".dijitInputInner", input.parentNode)[0];
              var dijitPlaceHolder = query(".dijitPlaceHolder", input.parentNode)[0];

              console.log(dijitInputInner);

              if( dijitInputInner ) dijitInputInner.value = value;
              if( dijitPlaceHolder ) dijitPlaceHolder.style.display = "none";  
            }
          }
        }
      }
    }
  }
          
  function setFromForm(object, form){
    for(var i = 0; i < form.elements.length; i++ ) {
      if(form.elements[i].name) {
        // console.log(form.elements[i].name);
        // console.log(form.elements[i].value);
        // console.log(form.elements[i].type);
        // console.log(form.elements[i].checked);
        object[form.elements[i].name] =form.elements[i].type == "checkbox" ?  form.elements[i].checked : form.elements[i].value;
      }
    }
  }



    /** 
     *  SVGPan library 1.2.1
     * ======================
     *
     * Given an unique existing element with id "viewport" (or when missing, the first g 
     * element), including the the library into any SVG adds the following capabilities:
     *
     *  - Mouse panning
     *  - Mouse zooming (using the wheel)
     *  - Object dragging
     *
     * You can configure the behaviour of the pan/zoom/drag with the variables
     * listed in the CONFIGURATION section of this file.
     *
     * Known issues:
     *
     *  - Zooming (while panning) on Safari has still some issues
     *
     * Releases:
     *
     * 1.2.1, Mon Jul  4 00:33:18 CEST 2011, Andrea Leofreddi
     *	- Fixed a regression with mouse wheel (now working on Firefox 5)
     *	- Working with viewBox attribute (#4)
     *	- Added "use strict;" and fixed resulting warnings (#5)
     *	- Added configuration variables, dragging is disabled by default (#3)
     *
     * 1.2, Sat Mar 20 08:42:50 GMT 2010, Zeng Xiaohui
     *	Fixed a bug with browser mouse handler interaction
     *
     * 1.1, Wed Feb  3 17:39:33 GMT 2010, Zeng Xiaohui
     *	Updated the zoom code to support the mouse wheel on Safari/Chrome
     *
     * 1.0, Andrea Leofreddi
     *	First release
     *
     * This code is licensed under the following BSD license:
     *
     * Copyright 2009-2010 Andrea Leofreddi <a.leofreddi@itcharm.com>. All rights reserved.
     * 
     * Redistribution and use in source and binary forms, with or without modification, are
     * permitted provided that the following conditions are met:
     * 
     *    1. Redistributions of source code must retain the above copyright notice, this list of
     *       conditions and the following disclaimer.
     * 
     *    2. Redistributions in binary form must reproduce the above copyright notice, this list
     *       of conditions and the following disclaimer in the documentation and/or other materials
     *       provided with the distribution.
     * 
     * THIS SOFTWARE IS PROVIDED BY Andrea Leofreddi ``AS IS'' AND ANY EXPRESS OR IMPLIED
     * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
     * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL Andrea Leofreddi OR
     * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
     * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
     * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
     * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
     * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     * 
     * The views and conclusions contained in the software and documentation are those of the
     * authors and should not be interpreted as representing official policies, either expressed
     * or implied, of Andrea Leofreddi.
     */

    /// CONFIGURATION 
    /// ====>

    var enablePan = 1; // 1 or 0: enable or disable panning (default enabled)
    var enableZoom = 1; // 1 or 0: enable or disable zooming (default enabled)
    var enableDrag = 0; // 1 or 0: enable or disable dragging (default disabled)

    /// <====
    /// END OF CONFIGURATION 

    var root = dom.byId("graph");

    var state = "none", svgRoot, stateTarget, stateOrigin, stateTf;

    /**
     * Retrieves the root element for SVG manipulation. The element is then cached into the svgRoot global variable.
     */
    function getRoot(root) {
      if(typeof(svgRoot) == "undefined") {
        var g = null;

        g = dom.byId("viewport");

        if(g == null)
          alert("Unable to obtain SVG root element");

        setCTM(g, g.getCTM());

        g.removeAttribute("viewBox");

        svgRoot = g;
      }

      return svgRoot;
    }

    /**
     * Instance an SVGPoint object with given event coordinates.
     */
    function getEventPoint(evt) {
      var p = root.createSVGPoint();

      p.x = evt.clientX;
      p.y = evt.clientY;

      return p;
    }

    /**
     * Sets the current transform matrix of an element.
     */
    function setCTM(element, matrix) {
      var s = "matrix(" + matrix.a + "," + matrix.b + "," + matrix.c + "," + matrix.d + "," + matrix.e + "," + matrix.f + ")";

      element.setAttribute("transform", s);
    }

    /**
     * Dumps a matrix to a string (useful for debug).
     */
    function dumpMatrix(matrix) {
      var s = "[ " + matrix.a + ", " + matrix.c + ", " + matrix.e + "\n  " + matrix.b + ", " + matrix.d + ", " + matrix.f + "\n  0, 0, 1 ]";

      return s;
    }

    /**
     * Sets attributes of an element.
     */
    function setAttributes(element, attributes){
      for (var i in attributes)
        element.setAttributeNS(null, i, attributes[i]);
    }

    /**
     * Handle mouse wheel event.
     */
    on(root, (!has("mozilla") ? "mousewheel" : "DOMMouseScroll"), function(evt){
      if(!enableZoom)
        return;

      if(evt.preventDefault)
        evt.preventDefault();

      evt.returnValue = false;

      var svgDoc = evt.target.ownerDocument;

      var delta;

      if(evt.wheelDelta)
        delta = evt.wheelDelta / 3600; // Chrome/Safari
      else
        delta = evt.detail / -90; // Mozilla

      var z = 1 + delta; // Zoom factor: 0.9/1.1

      var g = getRoot(svgDoc);

      var p = getEventPoint(evt);

      p = p.matrixTransform(g.getCTM().inverse());

      // Compute new scale matrix in current mouse position
      var k = root.createSVGMatrix().translate(p.x, p.y).scale(z).translate(-p.x, -p.y);

      setCTM(g, g.getCTM().multiply(k));

      if(typeof(stateTf) == "undefined")
        stateTf = g.getCTM().inverse();

      stateTf = stateTf.multiply(k.inverse());
    });

    /**
     * Handle mouse move event.
     */
    on(root, touch.move, function(evt){
      if( evt.preventDefault ){
        evt.preventDefault();
      }

      evt.returnValue = false;

      var svgDoc = evt.target.ownerDocument;

      var g = getRoot(svgDoc);

      // This is the section added to be able to display coordinates.
      var pt = getEventPoint(evt).matrixTransform(g.getCTM().inverse());
      var coordinateX = document.getElementById("coordinateX");
      var coordinateY = document.getElementById("coordinateY");
      coordinateX.firstChild.nodeValue = "X: " + Math.floor(pt.x);
      coordinateY.firstChild.nodeValue = "Y: " + Math.floor(pt.y);

      if(state == "pan" && enablePan) {
        // Pan mode
        var p = getEventPoint(evt).matrixTransform(stateTf);

        setCTM(g, stateTf.inverse().translate(p.x - stateOrigin.x, p.y - stateOrigin.y));
      } else if(state == "drag" && enableDrag) {
        // Drag mode
        var p = getEventPoint(evt).matrixTransform(g.getCTM().inverse());

        setCTM(stateTarget, root.createSVGMatrix().translate(p.x - stateOrigin.x, p.y - stateOrigin.y).multiply(g.getCTM().inverse()).multiply(stateTarget.getCTM()));

        stateOrigin = p;
      }
    });

    /**
     * Handle click event.
     */
    on(root, touch.press, function(evt){
      if( evt.preventDefault ){
        evt.preventDefault();
      }

      evt.returnValue = false;

      var svgDoc = evt.target.ownerDocument;

      var g = getRoot(svgDoc);

      if(
          evt.target.tagName == "svg" 
          || !enableDrag // Pan anyway when drag is disabled and the user clicked on an element 
        ) {
        // Pan mode
        state = "pan";

        stateTf = g.getCTM().inverse();

        stateOrigin = getEventPoint(evt).matrixTransform(stateTf);
      } else {
        // Drag mode
        state = "drag";

        stateTarget = evt.target;

        stateTf = g.getCTM().inverse();

        stateOrigin = getEventPoint(evt).matrixTransform(stateTf);
      }
    });

    /**
     * Handle mouse button release event.
     */
    on(root, touch.release, function(evt){
      if( evt.preventDefault ){ 
        evt.preventDefault();
      }

      evt.returnValue = false;

      var svgDoc = evt.target.ownerDocument;

      if( state == "pan" || state == "drag" ){
        // Quit pan mode
        state = "";
      }
    });

});

  </script>

</head>
<body class="claro">
  <div id="loader">
    <div id="loaderInner" style="direction:ltr;">Loading libraries ...
      <!-- <div id="basicStandby1" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'basic'"> --> 
    </div> 
  </div> 
  <div id="content" style="display:none;">
  <div data-dojo-type="dijit/MenuBar" id="navMenu" style="margin-bottom: 8px;">
    <div id="MenuFile" data-dojo-type="dijit/PopupMenuBarItem">
      <span>File</span>
      <div data-dojo-type="dijit/DropDownMenu">
        <div id="MenuFileLoadSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){LoadSvgDialog.show();}">Load SVG file</div>
        <div id="MenuFileLoadXMLStationFile" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){LoadStationDialog.show();}">Load XML station file</div>
        <div id="MenuFileSaveSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){SaveFileDialog.show();}">Save SVG file</div>
      </div>
    </div>
    <div id="MenuCalendar" data-dojo-type="dijit/PopupMenuBarItem">
      <span>Calendar</span>
      <div data-dojo-type="dijit/DropDownMenu">
        <div id="MenuCalendarSetStartEnd"     data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){SetCalendarDialog.show();}">Set [Start, End[</div>
        <div id="MenuCalendarSetStartPeriods" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){SetStartPeriodsDialog.show();}">Set start period(s)</div>
      </div>
    </div>
    <div id="MenuBusinessObject" data-dojo-type="dijit/PopupMenuBarItem">
      <span>Business objects</span>
      <div data-dojo-type="dijit/DropDownMenu">
        <div id="MenuBusinessObjectShowConstants"    data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){ShowConstantsDialog.show();}">Show constants</div>
        <div id="MenuBusinessObjectCreateCrewMember" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateCrewMemberDialog.show();}">Create crewmember</div>
        <div data-dojo-type="dijit/PopupMenuItem">
          <span>Create activity</span>
          <div id="MenuBusinessObjectCreateActivity" data-dojo-type="dijit/DropDownMenu">
            <div id="MenuBusinessObjectCreateActivityDayOff"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateDayOffDialog.show();}">Day off</div>
            <div id="MenuBusinessObjectCreateActivityTrip"          data-dojo-type="dijit/MenuItem" data-dojo-props="">Trip</div>
            <div id="MenuBusinessObjectCreateActivityTraining"      data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateTrainingDialog.show();}">Training</div>
            <div id="MenuBusinessObjectCreateActivityOtherActivity" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){alert('not yet available');}">Other activity</div>
          </div>
        </div>
      </div>
    </div>
    <div id="MenuGraphOption" data-dojo-type="dijit/PopupMenuBarItem">
      <span>Graph options</span>
      <div data-dojo-type="dijit/DropDownMenu">
        <div id="MenuGraphOptionCalendarDateHour" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){ShowHideDialog.show();}">Calendar Date/Hours</div>
        <div id="MenuGraphOptionActivities"       data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){alert('not yet available');}">Activities</div>
      </div>
    </div>
    <div id="MenuHighLights" data-dojo-type="dijit/PopupMenuBarItem">
      <span>Highlights</span>
      <div data-dojo-type="dijit/DropDownMenu">
        <div id="MenuHighLightsSpecificDateTime" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateHighlightDialog.show();}">Specific datetime(s)</div>
        <div id="MenuHighLightsDistance"         data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateDistanceDialog.show();}">Distance</div>
        <div id="MenuHighLightsWindow"           data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){alert('not yet available');}">Window</div>
      </div>
    </div>

  </div>


  <!-- SVG code -->
  <div id="gantt">
    <svg id="graph" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" height="100%" width="100%">
      <style>
.day_bar {
  fill-opacity: 0.2;
}

.line {
  fill: gray;
  fill-opacity: 0.5;
}

.start_period {
  fill: green;
}

.hour_bar {
  fill-opacity: 0.1;
}

.even {
  fill: yellow;
}
.uneven {
  fill: blue;
}

.day_label {
  text-anchor: middle; 
  font-size: 40px;
  fill: gray;
}

.hour_label {
  fill: gray;
}

.crewmember {
  text-anchor: end; 
  font-size: 40px;
  fill: black;
}

.highlight {
  fill: red;
}

.highlight_label {
  fill: red;
  font-weight: bold;
}

.start_hour {
  font-size: 9px;
  fill: gray;
  text-anchor: start; 
}

.end_hour {
  font-size: 9px;
  fill: gray;
  text-anchor: end; 
}

/* text inside a box */
.label {
  text-anchor: start; 
  font-size: 50px;
  fill: black;
}

.distance {
  stroke: black;
  stroke-width: 1px;
}

.DO {
  fill: orange;
}

.TRN {
  fill: green;
}

.SBY {
  fill: cyan;
}

.TRP {
  fill: blue;
}

.LEG {
  fill: magenta;
}
.LAYOVER {
  fill: yellow;
}
.DEADHEAD {
  fill: white;
}
.TP {
  fill: pink;
}
.REST {
  fill: purple;
}
      </style>
      <title>SVG rule demo</title>
      <desc>an awesome graph</desc>

      <g id="viewport">
        <!--
        ====================================================================================
        CALENDAR
        ====================================================================================
        -->
        <g id="calendar">
          <g id="intro">
            <image x="220" y="20" width="140" height="195" xlink:href="https://i.ebayimg.com/00/s/MzkwWDI4MA==/z/YKQAAOSwYqxXi7cf/$_86.JPG" />

            <text x="400" y="50"  style="fill:black;font-size:40px;">Bob, the "problem" builder v0.1</text>
            <text x="400" y="90"  style="fill:black;font-size:20px;">To start, please do one of: </text>
            <text x="420" y="120" style="fill:black;font-size:20px;">- Use File menu to load an XML station file and then Calendar menu to set a period or</text>
            <text x="420" y="150" style="fill:black;font-size:20px;">- Use File menu to load a SVG file.</text>
          </g>
          <g id="calendar_bar" transform="scale(1,100)"></g>
        </g>

        <!--
        ====================================================================================
        CREWMEMBERS
        ====================================================================================
        -->
        <g id="crewmembers">
          <g id="crewmember_bar" transform="scale(1,1)"></g>
        </g>

        <!--
        ====================================================================================
        ACTIVITIES
        ====================================================================================
        -->
        <g id="activities"></g>
      </g>

      <!--
      ====================================================================================
      COORDINATES
      ====================================================================================
      -->
      <g id="coordinate">
        <text x="10" y="20" id="coordinateX" style="position:fixed;"> </text> <!-- the white space is mandatatory. -->
        <text x="10" y="40" id="coordinateY" style="position:fixed;"> </text>
      </g>

      <!--
      ====================================================================================
      DSTORE
      ====================================================================================
      -->
       <!-- Those stores are managed automatically by the graph editor. -->
       <g id="ConfigurationStore"></g>
       <g id="CalendarStore"></g>
       <g id="CrewMemberStore"></g>
       <g id="ActivityStore"></g>
       <g id="HighLightStore"></g>
       <g id="StationStore"></g>
      </g>
    </svg>
  </div>
  
  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateTrainingDialog" title="Create training" style="display: none;" data-dojo-props="onHide: function(){CreateTrainingForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateTrainingForm" data-dojo-id="CreateTrainingForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="name">Name</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TrainingName" required="true"></td>
        </tr>
        <tr>
          <td><label for="TrnCm">Crew member</label></td>
          <td><select data-dojo-type="dijit/form/FilteringSelect" name="TrnCm" id="TrainingCrewMemberSelect" required="true"></td>
        </tr>
        <tr>
          <td><label for="transportationtime">Transportation time apply</label></td>
          <td><input data-dojo-type="dijit/form/CheckBox" name="transportationtime" id="TrainingTransportationTime" value="true" required="true"></td>
        </tr>
        <tr>
          <td><label for="restbefore">Rest before</label></td>
          <td>
            <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restbefore" id="TrainingRestBeforeH" value="0" data-dojo-props="" required="true">
            <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restbefore" id="TrainingRestBeforeM" value="0" data-dojo-props="" required="true">
          </td>
        </tr>
        <tr>
          <td><label for="start">Start date time</label></td>
          <td class="datetime">
            <input id="TrainingStartDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
            <input id="TrainingStartTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
          </td>
        </tr>
        <tr>
          <td><label for="duration">Duration</label></td>
          <td>
            <input id="TrainingDurationHour"   class="durationHour" data-dojo-type="dijit/form/ComboBox" name="duration" data-dojo-props="placeHolder:'hhh'" required="true" readonly="true">
            <input id="TrainingDurationMinute" class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="duration" data-dojo-props="placeHolder:'mm'" required="true" readonly="true">
          </td>
        </tr>
        <tr>
          <td><label for="end">End date time</label></td>
          <td class="datetime">
            <input id="TrainingEndDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true" />
            <input id="TrainingEndTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'" readonly="true" disabled="true" />
          </td>
        </tr>
        <tr>
          <td><label for="restafter">Rest after</label></td>
          <td>
            <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restafter" id="TrainingRestAfterH" value="0" data-dojo-props="" required="true">
            <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restafter" id="TrainingRestAfterM" value="0" data-dojo-props="" required="true">
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateTraining">Create</button>
      </div>
    </div>
  </div>




  <div data-dojo-type="dijit/Dialog" id="ShowHideDialog" data-dojo-id="ShowHideDialog" title="Show/hide SVG items" style="display: none;">
    <div data-dojo-type="dijit/form/Form" id="ShowHideForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="SHCoordinates">Show coordinates X and Y</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCoordinates" id="SHCoordinates" checked></td>
        </tr>
        <tr>
          <td><label for="SHCalendarHours">Show calendar hour label</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHours" id="SHCalendarHours" checked></td>
        </tr>
        <tr>
          <td><label for="SHCalendarHourBars">Show calendar hour bars</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHourBars" id="SHCalendarHourBars" checked></td>
        </tr>
        <tr>
          <td><label for="SHCalendarDayX">Show calendar Day X</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayX" id="SHCalendarDayX"></td>
        </tr>
        <tr>
          <td><label for="SHCalendarDayYYYYMMDD">Show calendar day YYYY-MM-DD</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayYYYYMMDD" id="SHCalendarDayYYYYMMDD"></td>
        </tr>
        <tr>
          <td><label for="SHCalendarDayBars">Show calendar day bars</label></td>
          <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayBars" id="SHCalendarDayBars"></td>
        </tr>
        <tr>
          <td><label for="XGraphCompression">Graph factor compression on axe X</label></td>
          <td>
            <select data-dojo-type="dijit/form/Select" name="XGraphCompression" id="XGraphCompression" style="width: 3em;">
              <option value="1" selected="selected">1</option>
              <option value="2">2</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
            </select>
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveShowHide">Save</button>
      </div>
    </div>
  </div>


  <!-- TODO: create a tpl, since LoadSvgDialog and LoadStationDialog look the same -->
  <div data-dojo-type="dijit/Dialog" data-dojo-id="LoadSvgDialog" title="Load SVG file" style="display: none; width: 300px;">
    <div data-dojo-type="dijit/form/Form" id="LoadSvgForm" data-dojo-id="LoadSvgForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td>
            <input name="uploadedfile" multiple="false" type="file" id="uploader2" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an SVG File'"/> 
          </td>
        </tr>
        <tr>
          <td>
            <div id="files2" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploader2"></div>
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="LoadSvg">Load file</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="LoadStationDialog" title="Load XML station file" style="display: none; width: 300px;">
    <div data-dojo-type="dijit/form/Form" id="LoadStationForm" data-dojo-id="LoadStationForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td>
            <input name="uploadedfile" multiple="false" type="file" id="uploader" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an XML File'"/> 
          </td>
        </tr>
        <tr>
          <td>
            <div id="files" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploader"></div>
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="LoadStation">Load file</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileDialog" title="Save SVG graph as a file" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="filename">Filename:</label></td>
        <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="filename" value=".svg" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="button" id="SaveFile">Save file</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" id="SetCalendarDialog" data-dojo-id="SetCalendarDialog" title="Set calendar" style="display: none;">
    <div data-dojo-type="dijit/form/Form" id="SetCalendarForm" data-dojo-id="SetCalendarForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="timezone">Timezone</label></td>
          <td><input data-dojo-type="dijit/form/FilteringSelect" name="timezone" id="CalendarTimezone" required="true"></td>
        </tr>
        <tr>
          <td><label for="station">Station</label></td>
          <td><input data-dojo-type="dijit/form/FilteringSelect" name="station" id="CalendarStation" required="true" disabled="true"></td>
        </tr>
        <tr>
          <td><label for="calendarStart">Start date</label></td>
          <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="calendarStart" id="CalendarStart" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
        </tr>
        <tr>
          <td><label for="calendarEnd">End date (excluded)</label></td>
          <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="calendarEnd" id="CalendarEnd" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SetCalendar">Set</button>
      </div>
    </div>
  </div>



  <div data-dojo-type="dijit/Dialog" id="SetStartPeriodsDialog" data-dojo-id="SetStartPeriodsDialog" title="Set start period(s)" style="display: none;">
    <div data-dojo-type="dijit/form/Form" id="SetStartPeriodsForm" data-dojo-id="SetStartPeriodsForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="start">Start period date(s)</label></td>
          <td><input multiple="true" data-dojo-type="dojox/form/CheckedMultiSelect" name="start" id="CalendarStartPeriods" size="14"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SetStartPeriods">Set</button>
      </div>
    </div>
  </div>



  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDayOffDialog" title="Create day off" style="display: none;" data-dojo-props="onHide: function(){CreateDayOffForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateDayOffForm" data-dojo-id="CreateDayOffForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="crewmemeber">Crew member</label></td>
          <td><select data-dojo-type="dijit/form/FilteringSelect" name="crewmember" id="DayOffCrewMemberSelect" required="true"></td>
        </tr>
        <tr>
          <td><label for="start">date(s)</label></td>
          <td><select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="start" id="DayOffDatesSelect" required="true"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateDayOff">Create</button>
      </div>
    </div>
  </div>



  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateCrewMemberDialog" title="Create crew member" style="display: none;" data-dojo-props="onHide: function(){CreateCrewMemberForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateCrewMemberForm" data-dojo-id="CreateCrewMemberForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="name">Name</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="name" id="CrewMemberName" required="true"></td>
        </tr>
        <tr>
          <td><label for="start">Birth date</label></td>
          <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="day" id="CrewMemberBirthDate" required="true"  data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"   ></td>
        </tr>
      </table>


      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateCrewMember">Create</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" id="ShowConstantsDialog" data-dojo-id="ShowConstantsDialog" title="Set constants" style="display: none;">
    <div data-dojo-type="dijit/form/Form" id="ShowConstantsForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="transportationTime">Transportation time duration (in minutes)</label></td>
          <td><input data-dojo-type="dijit/form/ComboBox" name="transportationTime" id="transportationTime" value="0" data-dojo-props="" required="true" style="width: 5em;"></td>
        </tr>
        <tr>
          <td><label for="reportTime">Report time (in minutes)</label></td>
          <td><input data-dojo-type="dijit/form/ComboBox" name="reportTime" id="reportTime" value="20" data-dojo-props="" required="true" style="width: 5em;"></td>
        </tr>
        <tr>
          <td><label for="releaseTime">Release time (in minutes)</label></td>
          <td><input data-dojo-type="dijit/form/ComboBox" name="releaseTime" id="releaseTime" value="15" data-dojo-props="" required="true" style="width: 5em;"></td>
        </tr>
        <tr>
          <td><label for="midnightOffset">Midnight offset (in minutes)</label></td>
          <td><input data-dojo-type="dijit/form/ComboBox" name="midnightOffset" id="midnightOffset" value="0" data-dojo-props="constraints:{max: 1440}" required="true" style="width: 5em;"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveConstants">Save</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateHighlightDialog" title="Create highlight" style="display: none;" data-dojo-props="onHide: function(){CreateHighlightForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateHighlightForm" data-dojo-id="CreateHighlightForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="lbl">Label</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="lbl" id="HighlightLabel"></td>
        </tr>
        <tr>
          <td><label for="days">Date(s)</label></td>
          <td><select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="days" id="HighlightDatesSelect"></td>
        </tr>
        <tr>
          <td><label for="time">Time</label></td>
          <td class="datetime">
            <input id="HighlightTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateHighlight">Create</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDistanceDialog" title="Distance" style="display: none;" data-dojo-props="onHide: function(){CreateDistanceForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateDistanceForm" data-dojo-id="CreateDistanceForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="From">From activity</label></td>
          <td><select data-dojo-type="dijit/form/FilteringSelect" name="From" id="DistanceFromSelect" style="width: 30em;" required="true"></td>
          <td>
            <select data-dojo-type="dijit/form/Select" id="DistanceFromEventSelect" disabled="true" required="true">
              <option value="1">rest before start</option>
              <option value="2">transp. time before start</option>
              <option value="3" selected="selected">activity start</option>
              <option value="4">activity end</option>
              <option value="5">transp. time after end</option>
              <option value="6">rest after end</option>
            </select>
          </td>
        </tr>
        <tr>
          <td><label for="To">To activity</label></td>
          <td><select data-dojo-type="dijit/form/FilteringSelect" name="To" id="DistanceToSelect" style="width: 30em;" required="true"></td>
          <td>
            <select data-dojo-type="dijit/form/Select" id="DistanceToEventSelect" disabled="true" required="true">
              <option value="1">rest before start</option>
              <option value="2">transp. time before start</option>
              <option value="3" selected="selected">activity start</option>
              <option value="4">activity end</option>
              <option value="5">transp. time after end</option>
              <option value="6">rest after end</option>
            </select>
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateDistance">Create</button>
      </div>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" id="CreateTripDialog" title="Create trip" style="display: none;" data-dojo-props="onHide: function(){CreateTripForm.reset();}" >
    <div data-dojo-type="dijit/form/Form" id="CreateTripForm" data-dojo-id="CreateTripForm" encType="multipart/form-data" action="" method="">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="name">Name</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TripName" required="true"></td>
        </tr>
        <tr>
          <td><label for="TrnCm">Crew member</label></td>
          <td><select data-dojo-type="dijit/form/FilteringSelect" name="TrnCm" id="TripCrewMemberSelect" /></td>
        </tr>
        <tr>
          <td><label for="transportationtime">Transportation time apply</label></td>
          <td><input data-dojo-type="dijit/form/CheckBox" name="transportationtime" id="TripTransportationTime" value="true" required="true"></td>
        </tr>
        <tr>
          <td><label for="restbefore">Rest before</label></td>
          <td>
            <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restbefore" id="TripRestBeforeH" value="0" data-dojo-props="" required="true">
            <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restbefore" id="TripRestBeforeM" value="0" data-dojo-props="" required="true">
          </td>
        </tr>
        <tr>
          <td><label for="start">Start date time</label></td>
          <td class="datetime">
            <input id="TripStartDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
            <input id="TripStartTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
          </td>
        </tr>
        <tr>
          <td><label>Details</label></td>
          <td><div id="TripGrid"></div></td>
        </tr>
        <tr>
          <td><label for="end">End date time</label></td>
          <td class="datetime">
            <input id="TripEndDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true" />
            <input id="TripEndTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'" readonly="true" disabled="true" />
          </td>
        </tr>
        <tr>
          <td><label for="restafter">Rest after</label></td>
          <td>
            <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restafter" id="TripRestAfterH" value="0" data-dojo-props="" required="true">
            <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restafter" id="TripRestAfterM" value="0" data-dojo-props="" required="true">
          </td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="CreateTrip">Create</button>
      </div>
    </div>
  </div>


  <!-- 
  <script type="text/template" id="activity-dialog-template">
    <div style="width:300px;">
      
      <div class="dijitDialogPaneContentArea">
        <div data-dojo-attach-point="contentNode">
            ${message}              
        </div>
      </div>
    
      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" data-dojo-attach-point="closeButton" >Close</button>
        <button data-dojo-type="dijit.form.Button" data-dojo-attach-point="cancelButton" >DELETE </button> 
      </div>
      
    </div>
  </script>
  -->

  </div> <!-- id=content>
</html>
