<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /> 
  
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css" />
  <script>
var dojoConfig = {
  async: true,
  parseOnLoad: true,
  packages: [{
    name: 'dstore',
    location: 'http://cdn.rawgit.com/SitePen/dstore/v1.0.0'
  }, {
    name: 'dmodel',
    location: 'http://cdn.rawgit.com/SitePen/dmodel/master'
  }]
};
  </script>

  <script src='http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js'></script>

  <script>

require([
  "dojo/on",
  "dojo/dom",
  "dojo/dom-construct",
  "dojo/parser",
  "dijit/registry",
  "dijit/MenuBar",
  "dijit/PopupMenuBarItem",
  "dijit/Menu",
  "dijit/MenuItem",
  "dijit/MenuBarItem",
  "dijit/DropDownMenu",
  "dijit/CheckedMenuItem",
  "dijit/Dialog",
  "dijit/form/CheckBox",
  "dijit/form/TextBox",
  "dijit/form/Button",
  "dijit/form/DateTextBox",
  "dijit/form/Select",
  "dijit/form/MultiSelect",
  "dijit/layout/TabContainer", 
  "dijit/layout/ContentPane", 
  "dojox/layout/TableContainer",
  "dojo/date",
  "dstore/Memory",
  "dmodel/Model",
  "dojo/domReady!"
], function(
  on, 
  dom, 
  domConstruct, 
  parser, 
  registry, 
  MenuBar, 
  PopupMenuBarItem, 
  Menu, 
  MenuItem, 
  MenuBarItem, 
  DropDownMenu,
  CheckedMenuItem, 
  Dialog, 
  CheckBox, 
  TextBox, 
  Button, 
  DateTextBox, 
  Select,
  MultiSelect,
  TabContainer,
  ContentPane,
  TableContainer, 
  Date,
  Memory,
  Model){

  parser.parse();

  // ===============================================
  // Resize graph size
  // ===============================================

  // set the right height of the object holding the svg graph. for unknown reason, the width works well 
  // with 100%, but not the height. So it needs to be evaluated each time the window size changes.
  function browserResize(){
    // the 8 comes from the margin (2 times) value on body, and margin-bottom (one time) on id navMenu.
    dom.byId("graph").height = window.innerHeight - 3 * 8 - dom.byId("navMenu").offsetHeight;
  }


  if (window.addEventListener) {              
    window.addEventListener("resize", browserResize);
  } else if (window.attachEvent) {                 
    window.attachEvent("onresize", browserResize);
  }
  browserResize();



  // ===============================================
  // SVG drawing
  // ===============================================
  var svgNS   = "http://www.w3.org/2000/svg";
  var xlinkNS = "http://www.w3.org/1999/xlink";

  function SVG_drawCalendarDate(calendarId, iDate, date){
    var G       = document.createElementNS(svgNS,"g");
    G.setAttributeNS(null,"transform","translate(" + 1440 * iDate + ",0)");
    G.setAttributeNS(null,"class", iDate % 2 ? "even" : "uneven" );
    G.setAttributeNS(null,"id", date);
    calendarId.appendChild(G);

    var UseDay = document.createElementNS(svgNS, "use");
    UseDay.setAttributeNS(xlinkNS, 'href', "#day");
    G.appendChild(UseDay);

    var TextRelativeDate = document.createElementNS(svgNS,"text");
    TextRelativeDate.setAttributeNS(null,"class","day_label relative");
    TextRelativeDate.setAttributeNS(null,"x","720");
    TextRelativeDate.setAttributeNS(null,"y","-70");
    G.appendChild(TextRelativeDate);

    var TextNodeRelativeDate = document.createTextNode("Day " + iDate );
    TextRelativeDate.appendChild(TextNodeRelativeDate);

    var TextYYYYMMDDDate = document.createElementNS(svgNS,"text");
    TextYYYYMMDDDate.setAttributeNS(null,"class","day_label yyyymmdd");
    TextYYYYMMDDDate.setAttributeNS(null,"x","720");
    TextYYYYMMDDDate.setAttributeNS(null,"y","-20");
    G.appendChild(TextYYYYMMDDDate);
    
    var TextNodeYYYYMMDDDate = document.createTextNode(date);
    TextYYYYMMDDDate.appendChild(TextNodeYYYYMMDDDate);

    var UseHours = document.createElementNS(svgNS,"use");
    UseHours.setAttributeNS(xlinkNS, 'href', "#hours");
    G.appendChild(UseHours);
  }


  function SVG_drawDO(activitiesId, iDate){
    var G = document.createElementNS(svgNS,"g");
    G.setAttributeNS(null,"transform","translate(" + iDate * 1440 + ",500)");
    G.setAttributeNS(null,"id","do_1");
    G.setAttributeNS(null,"onclick","alert('click! do_1');");
    activitiesId.appendChild(G);

    var Rect = document.createElementNS(svgNS,"rect");
    Rect.setAttributeNS(null,"class","DO");
    Rect.setAttributeNS(null,"x","0");
    Rect.setAttributeNS(null,"y","0");
    Rect.setAttributeNS(null,"rx","20");
    Rect.setAttributeNS(null,"ry","20");
    Rect.setAttributeNS(null,"width","1440");
    Rect.setAttributeNS(null,"height","100");
    G.appendChild(Rect);

    var Text = document.createElementNS(svgNS,"text");
    Text.setAttributeNS(null,"class","label");
    Text.setAttributeNS(null,"x","10");
    Text.setAttributeNS(null,"y","50");
    Text.setAttributeNS(null,"font-size","50");
    Text.setAttributeNS(null,"text-anchor","start");
    G.appendChild(Text);

    var TextNode = document.createTextNode("DO");
    Text.appendChild(TextNode);
  }

  // ===============================================
  // MODELs AND STOREs
  // ===============================================

  // for every object created, this value should be incremeted.
  var indexDStoreObject = 0;

  CalendarModel = new Model({
      schema: {
          label: 'string',
          relative: 'numeric',
          position: 'numeric',
      }
  });

  CalendarStore = new Memory({
      model: CalendarModel,
      idProperty: "position",
  });





  // ===============================================
  // DIALOGs
  // ===============================================

  // -----------------------------------------------
  // Show/Hide dialog
  // -----------------------------------------------
  registry.byId("SHCoordinates").on("change", function(isChecked){
    var svg = dom.byId("graph").getSVGDocument();
    if( isChecked ) {
      svg.getElementById("coordinateX").setAttribute("display", "block");
      svg.getElementById("coordinateY").setAttribute("display", "block");
    }
    else {
      svg.getElementById("coordinateX").setAttribute("display", "none");
      svg.getElementById("coordinateY").setAttribute("display", "none");
    }
  }, true);
  
  registry.byId("SHCalendarHours").on("change", function(isChecked){
    var svg = dom.byId("graph").getSVGDocument();
    var divs = svg.getElementsByClassName('hour_label');

    if( isChecked ) {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "block");
      }
    }
    else {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "none");
      }
    }
  }, true);
  
  registry.byId("SHCalendarDayX").on("change", function(isChecked){
    var svg = dom.byId("graph").getSVGDocument();
    var divs = svg.getElementsByClassName('relative');

    if( isChecked ) {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "block");
      }
    }
    else {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "none");
      }
    }
  }, true);
  
  registry.byId("SHCalendarDayYYYYMMDD").on("change", function(isChecked){
    var svg = dom.byId("graph").getSVGDocument();
    var divs = svg.getElementsByClassName('yyyymmdd');

    if( isChecked ) {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "block");
      }
    }
    else {
      for (var i = 0; i < divs.length; i++) {
        divs[i].setAttribute("display", "none");
      }
    }
  }, true);

  // -----------------------------------------------
  // Save file dialog
  // -----------------------------------------------
  registry.byId("SaveFile").on("click", function(){
    var svg         = dom.byId("graph").getSVGDocument();
    var a           = document.createElement('a');
    var contentType = 'data:application/octet-stream,';

    //get svg source.
    var serializer = new XMLSerializer();
    var source = serializer.serializeToString(svg);

    var uriContent  = contentType + encodeURIComponent(source);

    a.setAttribute('href', uriContent);
    a.setAttribute('download', registry.byId("filename").value);

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    SaveFileDialog.hide();
  }, true);

  // -----------------------------------------------
  // Calendar range set up dialog
  // -----------------------------------------------

  registry.byId("CalendarStart").on("change", function(){
    registry.byId("CalendarEnd").constraints.min = Date.add(this.get("value"), "day", 1);
    registry.byId("DayOffDate").constraints.min = this.get("value");
  }, true);
  
  registry.byId("CalendarEnd").on("change", function(){
    registry.byId("CalendarStart").constraints.max = Date.add(this.get("value"), "day", -1);
    registry.byId("DayOffDate").constraints.max = Date.add(this.get("value"), "day", -1);
  }, true);

  registry.byId("SetCalendar").on("click", function(){
    var start = registry.byId("CalendarStart");
    var end   = registry.byId("CalendarEnd");

    if( start.get("value") != null && end.get("value") != null ) {
      SetCalendarDialog.hide();

      var range = Date.difference(start.get("value"), end.get("value"), "day");
      var date = start.get("value");

      var svg      = dom.byId("graph").getSVGDocument();
      var calendarId = svg.getElementById("calendar");

      // remove old calendar.
      while (calendarId.firstChild) {
        calendarId.removeChild(calendarId.firstChild);
      }


      for(i = 0; i < range; i++) {
        CalendarStore.add({
          label: date.toISOString().substring(0, 10),
          relative: i,
          position: i
        });

        SVG_drawCalendarDate(calendarId, i, date.toISOString().substring(0, 10));
        date = Date.add(date, "day", 1); 
      }

      function addOption(selectbox,text,value )
      {
        var optn = document.createElement("OPTION");
        optn.text = text;
        optn.value = value;
        selectbox.options.add(optn);
      };

      var selectbox = registry.byId("CalendarStartPeriods").domNode;
      for(i=selectbox.options.length-1;i>=0;i--)
      {
        selectbox.remove(i);
      }

      dojo.forEach(CalendarStore.data, function(item) {
        addOption(selectbox, item.label, item.position);
      });


      // enabled some menu items.
      registry.byId("FileSaveMenu").set('disabled', false);
      registry.byId("CalendarSetStartPeriodsMenu").set('disabled', false);
      registry.byId("BusinessObjectMenu").set('disabled', false);
      registry.byId("GraphOptionMenu").set('disabled', false);
      registry.byId("HighlightsMenu").set('disabled', false);
    }
  });

  registry.byId("SetStartPeriods").on("click", function(){
    var svg      = dom.byId("graph").getSVGDocument();

    // remove old start period                         
    var oldStarts = svg.getElementsByClassName('start_period_uneven');
    for (var i = 0; i < oldStarts.length; i++) {
      oldStarts[i].setAttribute("class", "uneven");
    }
    var oldStarts2 = svg.getElementsByClassName('start_period_even');
    for (var i = 0; i < oldStarts2.length; i++) {
      oldStarts2[i].setAttribute("class", "even");
    }

    // install new start period.                         
    var starts    = registry.byId("CalendarStartPeriods").get("value");
    var start     = registry.byId("CalendarStart").get("value");
    var start_str = start.toISOString().substring(0, 10);
    var end_str   = registry.byId("CalendarEnd").get("value").toISOString().substring(0, 10);
 
    var calendarId = svg.getElementById("calendar");

    for(i = 0; i < starts.length; i++) {
      var current = starts[i];

      if( current >= start_str && current < end_str ){
        var id = svg.getElementById(current);                        
        var currentClassName = id.getAttribute("class"); // className; // getAttribute("class");
        var newClassName = "start_period_" + currentClassName;
        
        id.setAttribute("class", newClassName);
      }
    }

                         
    SetStartPeriodsDialog.hide();

  });


  // -----------------------------------------------
  // Create Day Off dialog
  // -----------------------------------------------
  registry.byId("CreateDayOff").on("click", function(){
    var svg          = dom.byId("graph").getSVGDocument();
    var activitiesId = svg.getElementById("activities");
    var iDate        = Date.difference(registry.byId("CalendarStart").get("value"), registry.byId("DayOffDate").get("value"), "day");

    SVG_drawDO(activitiesId, iDate);
  }, true);
});
  </script>

</head>
<body class="claro">
  
  <div data-dojo-type="dijit/MenuBar" id="navMenu" style="margin-bottom: 8px;">
    <div data-dojo-type="dijit/PopupMenuBarItem">
      <span>File</span>
      <div data-dojo-type="dijit/DropDownMenu" id="fileMenu">
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Load SVG file</div>
        <div id="FileSaveMenu" data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){SaveFileDialog.show();}">Save SVG file</div>
      </div>
    </div>
    <div data-dojo-type="dijit/PopupMenuBarItem">
      <span>Calendar</span>
      <div data-dojo-type="dijit/DropDownMenu" id="calendarMenu">
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){SetCalendarDialog.show();}">Set [Start, End[</div>
        <div id="CalendarSetStartPeriodsMenu" data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){SetStartPeriodsDialog.show();}">Set start period(s)</div>
      </div>
    </div>
    <div id="BusinessObjectMenu" data-dojo-type="dijit/PopupMenuBarItem" data-dojo-props="disabled:true">
      <span>Business objects</span>
      <div data-dojo-type="dijit/DropDownMenu" id="businessObjectMenu">
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateCrewMemberDialog.show();}">Create crewmember</div>
        <div data-dojo-type="dijit/PopupMenuItem">
          <span>Create activity</span>
          <div data-dojo-type="dijit/DropDownMenu" id="submenu2">
            <div data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){CreateDayOffDialog.show();}">Day off</div>
            <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Trip</div>
            <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){CreateTrainingDialog.show();}">Training</div>
            <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Other activity</div>
          </div>
        </div>
      </div>
    </div>
    <div id="GraphOptionMenu" data-dojo-type="dijit/PopupMenuBarItem" data-dojo-props="disabled:true">
      <span>Graph options</span>
      <div data-dojo-type="dijit/DropDownMenu" id="graphOptionMenu">
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function(){ShowHideDialog.show();}">Calendar Date/Hours</div>
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Activities</div>
      </div>
    </div>
    <div id="HighlightsMenu" data-dojo-type="dijit/PopupMenuBarItem" data-dojo-props="disabled:true">
      <span>Highlights</span>
      <div data-dojo-type="dijit/DropDownMenu" id="highlightsMenu">
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Specific date(s)</div>
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Distance</div>
        <div data-dojo-type="dijit/MenuItem" data-dojo-props="disabled:true, onClick:function(){alert('not yet available');}">Window</div>
      </div>
    </div>

  </div>


  <!-- SVG code -->
  <object id="graph" type="image/svg+xml" data="gantt.svg" width="100%">
    Sorry, your browser does not support SVG.
  </object>
  
  <div data-dojo-type="dijit/Dialog" data-dojo-id="ShowHideDialog" title="Show/hide SVG items" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="SHCoordinates">Show coordinates X and Y</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCoordinates" id="SHCoordinates" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarHours">Show calendar hours</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHours" id="SHCalendarHours" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarDayX">Show calendar Day X</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayX" id="SHCalendarDayX" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarDayYYYYMMDD">Show calendar day YYYY-MM-DD</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayYYYYMMDD" id="SHCalendarDayYYYYMMDD" checked></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){ShowHideDialog.hide();}">Close</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileDialog" title="Save SVG graph as a file" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="filename">Filename:</label></td>
        <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="filename" value=".svg" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="SaveFile">Save file</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SetCalendarDialog" title="Set calendar" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="start">Start date</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="start" id="CalendarStart" required="true"></td>
      </tr>
      <tr>
        <td><label for="end">End date (excluded)</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="end" id="CalendarEnd" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="SetCalendar">Set</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SetStartPeriodsDialog" title="Set start period(s)" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="start">Start period date(s)</label></td>
        <td><select data-dojo-type="dijit/form/MultiSelect" name="start" id="CalendarStartPeriods" size="15"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="SetStartPeriods">Set</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDayOffDialog" title="Create day off" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="day">Date</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="day" id="DayOffDate" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="CreateDayOff">Create</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateTrainingDialog" title="Create training" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="name">Name</label></td>
        <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TrainingName" required="true"></td>
      </tr>
      <tr>
        <td><label for="start">Date</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="day" id="DayOffDate" required="true"></td>
      </tr>
      <tr>
        <td><label for="start">Time</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="day" id="DayOffDate" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="CreateDayOff">Create</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateCrewMemberDialog" title="Create crew member" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="name">Name</label></td>
        <td><input data-dojo-type="dijit/form/TextBox" name="name" id="CrewMemberName" required="true"></td>
      </tr>
      <tr>
        <td><label for="start">Birth date</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="day" id="CrewMemberBirthDate" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="CreateCrewMember">Create</button>
    </div>
  </div>



</html>
