<!DOCTYPE html>
<html lang="en">
  <head>
  
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/claro/claro.css">
  
  <script>dojoConfig = {async: true, parseOnLoad: true}</script>
  <script src='http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js'></script>

  <script>
    require([
    "dojo/on",
    "dojo/dom",
    "dojo/dom-construct",
    "dojo/parser",
    "dijit/registry",
    "dijit/MenuBar",
    "dijit/PopupMenuBarItem",
    "dijit/Menu",
    "dijit/MenuItem",
    "dijit/MenuBarItem",
    "dijit/DropDownMenu",
    "dijit/CheckedMenuItem",
    "dijit/Dialog",
    "dijit/form/CheckBox",
    "dijit/form/TextBox",
    "dijit/form/Button",
    "dijit/form/DateTextBox",
    "dijit/layout/TabContainer", 
    "dijit/layout/ContentPane", 
    "dojox/layout/TableContainer",
    "dojo/date",
    "dojo/domReady!"
    ], function(on, 
                dom, 
                domConstruct, 
                parser, 
                registry, 
                MenuBar, 
                PopupMenuBarItem, 
                Menu, 
                MenuItem, 
                MenuBarItem, 
                DropDownMenu,
                CheckedMenuItem, 
                Dialog, 
                CheckBox, 
                TextBox, 
                Button, 
                DateTextBox, 
                TabContainer,
                ContentPane,
                TableContainer, 
                Date){
      parser.parse();
      // ===============================================
      // DIALOG
      // ===============================================

      // -----------------------------------------------
      // Show/Hide dialog
      // -----------------------------------------------
      registry.byId("SHCoordinates").on("change", function(isChecked){
        var svg = dom.byId("graph").getSVGDocument();
        if( isChecked ) {
          svg.getElementById("coordinateX").setAttribute("display", "block");
          svg.getElementById("coordinateY").setAttribute("display", "block");
        }
        else {
          svg.getElementById("coordinateX").setAttribute("display", "none");
          svg.getElementById("coordinateY").setAttribute("display", "none");
        }
      }, true);
      
      registry.byId("SHCalendarHours").on("change", function(isChecked){
        var svg = dom.byId("graph").getSVGDocument();
        var divs = svg.getElementsByClassName('hour_label');

        if( isChecked ) {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "block");
          }
        }
        else {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "none");
          }
        }
      }, true);
      
      registry.byId("SHCalendarDayX").on("change", function(isChecked){
        var svg = dom.byId("graph").getSVGDocument();
        var divs = svg.getElementsByClassName('relative');

        if( isChecked ) {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "block");
          }
        }
        else {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "none");
          }
        }
      }, true);
      
      registry.byId("SHCalendarDayYYYYMMDD").on("change", function(isChecked){
        var svg = dom.byId("graph").getSVGDocument();
        var divs = svg.getElementsByClassName('yyyymmdd');

        if( isChecked ) {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "block");
          }
        }
        else {
          for (var i = 0; i < divs.length; i++) {
            divs[i].setAttribute("display", "none");
          }
        }
      }, true);

      // -----------------------------------------------
      // Save file dialog
      // -----------------------------------------------
      registry.byId("SaveFile").on("click", function(){
        var svg         = dom.byId("graph").getSVGDocument();
        var a           = document.createElement('a');
        var contentType = 'data:application/octet-stream,';

        //get svg source.
        var serializer = new XMLSerializer();
        var source = serializer.serializeToString(svg);

        var uriContent  = contentType + encodeURIComponent(source);

        a.setAttribute('href', uriContent);
        a.setAttribute('download', registry.byId("filename").value);

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        SaveFileDialog.hide();
      }, true);

      // -----------------------------------------------
      // Calendar range set up dialog
      // -----------------------------------------------

      registry.byId("CalendarStart").on("change", function(){
        var end   = registry.byId("CalendarEnd");
        end.constraints.min = Date.add(this.get("value"), "day", 1);
      }, true);
      
      registry.byId("CalendarEnd").on("change", function(){
        var start = registry.byId("CalendarStart");
        start.constraints.max = Date.add(this.get("value"), "day", -1);
      }, true);

      registry.byId("SetCalendar").on("click", function(){
        var start = registry.byId("CalendarStart");
        var end   = registry.byId("CalendarEnd");
        

        if( start.get("value") != null && end.get("value") != null ) {
          SetCalendarDialog.hide();

          var range = Date.difference(start.get("value"), end.get("value"), "day");
          var date = start.get("value");

          var svg    = dom.byId("graph").getSVGDocument();
          var insert = svg.getElementById("calendar");

          // remove old calendar.
          while (insert.firstChild) {
            insert.removeChild(insert.firstChild);
          }

          var svgNS = "http://www.w3.org/2000/svg";
          var xlinkNS = "http://www.w3.org/1999/xlink";

          for(i = 0; i < range; i++) {
//      <g class="start_period" transform="translate(0,0)">
//        <use xlink:href="#day"/>
//        <text class="day_label relative" x="720" y="20" text-anchor="middle">Day 0</text>
//        <text class="day_label calendar" x="720" y="40" text-anchor="middle">2003/08/05</text>
//        <use xlink:href="#hours"/>
//      </g>
            var myG = document.createElementNS(svgNS,"g");
            myG.setAttributeNS(null,"transform","translate(" + 1440 * i + ",0)");
            myG.setAttributeNS(null,"class", i % 2 ? "even" : "uneven" );
            insert.appendChild(myG);

            var myUseDay = document.createElementNS(svgNS, "use");
            myUseDay.setAttributeNS(xlinkNS, 'href', "#day");
            myG.appendChild(myUseDay);

            var myText1 = document.createElementNS(svgNS,"text");
            myText1.setAttributeNS(null,"class","day_label relative");
            myText1.setAttributeNS(null,"x","720");
            myText1.setAttributeNS(null,"y","-70");
            var t1 = document.createTextNode("Day " + i );
            myText1.appendChild(t1);
            myG.appendChild(myText1);

            var myText2 = document.createElementNS(svgNS,"text");
            myText2.setAttributeNS(null,"class","day_label yyyymmdd");
            myText2.setAttributeNS(null,"x","720");
            myText2.setAttributeNS(null,"y","-20");
            var t2 = document.createTextNode(date.toISOString().substring(0, 10));
            myText2.appendChild(t2);
            myG.appendChild(myText2);

            var myUseHours = document.createElementNS(svgNS,"use");
            myUseHours.setAttributeNS(xlinkNS, 'href', "#hours");
            myG.appendChild(myUseHours);

            date = Date.add(date, "day", 1); 
          }
        }
      });

      // ===============================================
      // Menu.
      // ===============================================
      var pMenuBar = new MenuBar({});

      var pSubMenu = new DropDownMenu({});
      pSubMenu.addChild(new MenuItem({
        label: "Load file"
      }));
      pSubMenu.addChild(new MenuItem({
        label: "Save file",
        onClick: function(){
          SaveFileDialog.show();
        }
      }));
      pMenuBar.addChild(new PopupMenuBarItem({
        label: "File",
        popup: pSubMenu
      }));

      var pSubMenu4 = new DropDownMenu({});
      pSubMenu4.addChild(new MenuItem({
        label: "Range set up",
        onClick: function(){
          SetCalendarDialog.show();
        }
      }));
      pSubMenu4.addChild(new MenuItem({
        label: "Period start set up",
      }));
      pMenuBar.addChild(new PopupMenuBarItem({
        label: "Calendar",
        popup: pSubMenu4
      }));


      var pSubMenu3 = new DropDownMenu({});
      pSubMenu3.addChild(new MenuItem({
        label: "Create activity",
        onClick: function(){
          CreateActivityDialog.show();
        }
      }));
      pSubMenu3.addChild(new MenuItem({
        label: "Create fix DO",
        onClick: function(){
          var svg    = dom.byId("graph").getSVGDocument();
          var insert = svg.getElementById("activities");

          var svgNS = "http://www.w3.org/2000/svg";

//    <g transform="translate(4320,300)"><g id="use_2"><g id="do">
//      <rect class="DO" x="0" y="0" rx="20" ry="20" width="1440" height="100"/>
//      <text class="label" x="10" y="50" font-size="50" text-anchor="start" content-value="param(label)">DO</text>
//    </g></g></g>


          var myG = document.createElementNS(svgNS,"g");
          myG.setAttributeNS(null,"transform","translate(0,500)");
          myG.setAttributeNS(null,"id","do_1");
          myG.setAttributeNS(null,"onclick","alert('click! do_1');");
          insert.appendChild(myG);
          var myRect = document.createElementNS(svgNS,"rect");
          myRect.setAttributeNS(null,"class","DO");
          myRect.setAttributeNS(null,"x","0");
          myRect.setAttributeNS(null,"y","0");
          myRect.setAttributeNS(null,"rx","20");
          myRect.setAttributeNS(null,"ry","20");
          myRect.setAttributeNS(null,"width","1440");
          myRect.setAttributeNS(null,"height","100");
          myG.appendChild(myRect);
          var myText = document.createElementNS(svgNS,"text");
          myText.setAttributeNS(null,"class","label");
          myText.setAttributeNS(null,"x","10");
          myText.setAttributeNS(null,"y","50");
          myText.setAttributeNS(null,"font-size","50");
          myText.setAttributeNS(null,"text-anchor","start");
          var t = document.createTextNode("This is a paragraph.");
          myText.appendChild(t);
          myG.appendChild(myText);

        }
      }));



      pSubMenu3.addChild(new MenuItem({
        label: "Create crew",
      }));
      pMenuBar.addChild(new PopupMenuBarItem({
        label: "Objects",
        popup: pSubMenu3
      }));


      var pSubMenu2 = new DropDownMenu({});
      pSubMenu2.addChild(new MenuItem({
        label: "Cut",
        iconClass: "dijitEditorIcon dijitEditorIconCut"
      }));
      pSubMenu2.addChild(new MenuItem({
        label: "Copy",
        iconClass: "dijitEditorIcon dijitEditorIconCopy"
      }));
      pSubMenu2.addChild(new MenuItem({
        label: "Paste",
        iconClass: "dijitEditorIcon dijitEditorIconPaste"
      }));
      pMenuBar.addChild(new PopupMenuBarItem({
        label: "Edit",
        popup: pSubMenu2
      }));

      pMenuBar.addChild(new MenuBarItem({
        label: "Show/Hide",
        onClick: function(){
          ShowHideDialog.show();
        }
      }));

      pMenuBar.placeAt("navMenu");
      pMenuBar.startup();

      // events
      /*
      var checkbox = dijit.byId("ShowHideCoordinates");
      on(checkbox, "change", function(evt){
        alert(evt);
      });
      /*
      on(dijit.byId("ShowHideCoordinates"), "change", function(evt){
        alert(evt);
      });
      */

    });
  </script>

  <script>
    if (window.addEventListener) {              
      window.addEventListener("resize", browserResize);
    } else if (window.attachEvent) {                 
      window.attachEvent("onresize", browserResize);
    }
    browserResize();

    // set the right height of the object holding the svg graph. for unknown reason, the width works well 
    // with 100%, but not the height. So it needs to be evaluated each time the window size changes.
    function browserResize() {
      // the 8 comes from the margin (2 times) value on body, and margin-bottom (one time) on id navMenu.
      document.getElementById("graph").height = window.innerHeight - 3 * 8 - document.getElementById("navMenu").offsetHeight;
    }

  </script>

</head>
<body class="claro" onload="browserResize()">
  <div id="navMenu" style="margin-bottom: 8px;"></div>
  
  <!-- SVG code -->
  <object id="graph" type="image/svg+xml" data="gantt.svg" width="100%">
    Sorry, your browser does not support SVG.
  </object>
  
  <div data-dojo-type="dijit/Dialog" data-dojo-id="ShowHideDialog" title="Show/hide SVG items" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="SHCoordinates">Show coordinates X and Y</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCoordinates" id="SHCoordinates" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarHours">Show calendar hours</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHours" id="SHCalendarHours" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarDayX">Show calendar Day X</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayX" id="SHCalendarDayX" checked></td>
      </tr>
      <tr>
        <td><label for="SHCalendarDayYYYYMMDD">Show calendar day YYYY-MM-DD</label></td>
        <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayYYYYMMDD" id="SHCalendarDayYYYYMMDD" checked></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){ShowHideDialog.hide();}" id="close">Close</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileDialog" title="Save SVG graph as a file" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="filename">Filename:</label></td>
        <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="filename" value=".svg" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="SaveFile">Save file</button>
      <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){SaveFileDialog.hide();}" id="cancel">Cancel</button>
    </div>
  </div>


  <div data-dojo-type="dijit/Dialog" data-dojo-id="SetCalendarDialog" title="Set calendar" style="display: none;">
    <table class="dijitDialogPaneContentArea">
      <tr>
        <td><label for="start">Start date</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="start" id="CalendarStart" required="true"></td>
      </tr>
      <tr>
        <td><label for="end">End date (excluded)</label></td>
        <td><input data-dojo-type="dijit/form/DateTextBox" name="end" id="CalendarEnd" required="true"></td>
      </tr>
    </table>

    <div class="dijitDialogPaneActionBar">
      <button data-dojo-type="dijit/form/Button" type="submit" id="SetCalendar">Set calendar</button>
      <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){SetCalendarDialog.hide();}" id="cancel2">Cancel</button>
    </div>
  </div>

  <!-- http://archive.dojotoolkit.org/nightly/checkout/dijit/tests/layout/test_TabContainer.html -->
<!--
  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateActivityDialog" title="Create an activity" style="display: none;" >
    <div data-dojo-type="dijit/layout/TabContainer" style="width: 400px;height: 20em;">
        <div data-dojo-type="dijit/layout/ContentPane" title="My first tab" data-dojo-props="selected:true" style="height: 100%;">
            Lorem ipsum and all around...
        </div>
        <div data-dojo-type="dijit/layout/ContentPane" title="My second tab" data-dojo-props="closable:true">
            Lorem ipsum and all around - second...<br />
            Hmmm expanding tabs......
        </div>
        <div data-dojo-type="dijit/layout/ContentPane" title="My last tab">
            Lorem ipsum and all around - last...<br />
            <br />
            <br />
            Hmmm even more expanding tabs......
        </div>
    </div>
</div>
-->
  <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateActivityDialog" title="Create an activity" style="display: none;">
    <div data-dojo-type="dijit/layout/TabContainer" style="width: 900px; height: 20em;">
      <div data-dojo-type="dijit/layout/ContentPane" title="Trip">
        Lorem ipsum and all around - second...
        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){CreateActivityDialog.hide();}">Cancel</button>
        </div>
      </div>
      <div data-dojo-type="dijit/layout/ContentPane" title="Training">
        Lorem ipsum and all around - last...
        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){CreateActivityDialog.hide();}">Cancel</button>
        </div>
      </div>
      <div data-dojo-type="dijit/layout/ContentPane" title="Other activity type">
        Lorem ipsum and all around - last...
        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){CreateActivityDialog.hide();}">Cancel</button>
        </div>
      </div>
      <div data-dojo-type="dijit/layout/ContentPane" title="Day Off" data-dojo-props="selected:true">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="start">Start date</label></td>
            <td><input data-dojo-type="dijit/form/DateTextBox" name="start" id="CalendarStart2" required="true"></td>
          </tr>
          <tr>
            <td><label for="end">End date (excluded)</label></td>
            <td><input data-dojo-type="dijit/form/DateTextBox" name="end" id="CalendarEnd2" required="true"></td>
          </tr>
        </table>
        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){CreateActivityDialog.hide();}">Cancel</button>
        </div>
      </div>
    </div>
  </div>

</html>
