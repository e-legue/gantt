<html lang="en">

<!-- TODO LIST 
 2 - find a nice way to reorganize activities regarding empty lines.
 3 - Add note linked with an event.
 6 - See what can be done with Remi's tool (python).
 8 - Provide a widget about duration, instead of 2 selects (hours and minutes).
 9 - Generate a station file with the right date about dst, regarding the dataset.
11 - Use Object inheritance.
12 - Use XltTransform.js iso load which is deprecated.
-->

<head>
  <meta charset="UTF-8"/> 
  
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dijit/themes/claro/claro.css"/>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/CheckedMultiSelect.css"/>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/UploaderFileList.css"/>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/editor/plugins/resources/editorPlugins.css"/>
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/dgrid.css"/>
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/skins/claro.css"/>
  <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css"/>
  <link rel="stylesheet" href="http://codemirror.net/addon/fold/foldgutter.css"/>
  <link rel="stylesheet" href="css/pbs_gantt.css"/>

  <script>
var dojoConfig = {
  async: true, 
  debug: true,
  packages: [{
    name: "dstore",
    location: "https://cdn.rawgit.com/SitePen/dstore/v1.1.1"
  }, {
    name: "dmodel",
    location: "https://cdn.rawgit.com/SitePen/dmodel/master"
  }, {
    name: "dgrid",
    location: "https://cdn.rawgit.com/SitePen/dgrid/v1.1.0"
  }, {
    name: "moment",
    location: "https://cdn.rawgit.com/moment/moment/2.17.1",
    main: "moment"
  }, {
    name: "moment-timezone",
    location: "https://cdn.rawgit.com/moment/moment-timezone/0.5.10",
    main: "timezone"
  }, {
    name: "codemirror",
    location: "http://codemirror.net/",
  }, {
    name: "vkbeautify",
    location: "https://cdn.rawgit.com/vkiryukhin/vkBeautify/0a238953",
  }, {
    name: "jszip",
    location: "https://cdn.rawgit.com/Stuk/jszip/v3.1.3/dist/",
  }, {
    name: "filesaver",
    location: "https://cdn.rawgit.com/eligrey/FileSaver.js/1.3.3",
  }, {
    name: "my", 
    location: location.pathname.replace(/\/[^/]+$/, '') + "/js/my",
  },

  ]
};
  </script>

  <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojo/dojo.js"></script>

  <script>
var hours0To99Data = [];
for( i = 0; i < 100; ++i ) {
  hours0To99Data.push({id: i, name: i});
} 
var minutes0To59Data = [];
for( i = 0; i < 60; ++i ) {
  minutes0To59Data.push({id: i, name: i});
}

  var timezoneData = []; 

require([
  "moment/moment",
  "moment-timezone/builds/moment-timezone-with-data",
], 
function(
  moment,
  timezone) {

  /*
   * Load timezones.
   */ 
  var array = timezone.tz.names();

  for( i = 0; i < array.length; i++) {
    timezoneData.push({id: i, name: array[i]});
  }



});

  </script>  

  <script>
require([
  "dojo/_base/declare",
  "dojo/window",
  "dojo/sniff",
  "dojo/on",
  "dojo/topic",
  "dojo/touch",
  "dojo/dom",
  "dojo/dom-style",
  "dojo/dom-construct",
  "dojo/dom-geometry",
  "dojo/dom-form",
  "dojo/dom-class",
  "dojo/json",
  "dojo/parser",
  "dojo/request/xhr",
  "dojo/date",
  "dojo/Stateful", 
  "dojo/query", 
  "dojo/data/ObjectStore", 
  "dojo/store/Memory", 
  "dojo/store/Observable",
  "dijit/_Widget",
  "dijit/registry",
  "dijit/Dialog",
  "dijit/form/Button",
  "dijit/form/Select",
  "dijit/form/FilteringSelect",
  "dijit/form/ComboBox",
  "dojox/xml/parser", 
  "dojox/widget/Standby",
  "dojox/form/CheckedMultiSelect",
  "dstore/Memory",
  "dstore/Trackable",
  "dstore/legacy/DstoreAdapter",
  "dmodel/Model",
  "dmodel/ComputedProperty",
  "dgrid/OnDemandGrid", 
  "dgrid/Selection", 
  "dgrid/Keyboard", 
  "dgrid/Editor", 
  "dgrid/extensions/CompoundColumns",
  "moment/moment",
  "moment-timezone/builds/moment-timezone-with-data",
  "codemirror/lib/codemirror",
  "jszip/jszip",
  "filesaver/FileSaver",
  "my/FixedCheckedMultiSelect",
  "my/CustomEditorLegLayover",
  "my/XslTransform",
  
  "dojo/domReady!",

  "dijit/MenuBar",
  "dijit/PopupMenuBarItem",
  "dijit/Menu",
  "dijit/MenuItem",
  "dijit/MenuBarItem",
  "dijit/DropDownMenu",
  "dijit/RadioMenuItem",
  "dijit/CheckedMenuItem",
  "dijit/ColorPalette",
  "dijit/form/Form",
  "dijit/form/CheckBox",
  "dijit/form/TextBox",
  "dijit/form/DateTextBox",
  "dijit/form/TimeTextBox",
  "dijit/form/DropDownButton",
  "dijit/form/RadioButton",
  "dijit/layout/TabContainer", 
  "dijit/layout/ContentPane", 
  "dijit/Editor",
  "dijit/_editor/plugins/ViewSource",
  "dijit/_editor/plugins/FontChoice", 
  "dijit/_editor/plugins/TextColor",
  "dijit/ColorPalette",
  "dijit/TooltipDialog",
  "dojox/layout/TableContainer",
  "dojox/form/Uploader",
  "dojox/form/uploader/FileList",
  "dojox/editor/plugins/TablePlugins",
  "codemirror/mode/xml/xml",
  "codemirror/addon/fold/xml-fold",
  "codemirror/addon/edit/matchtags",
  "codemirror/addon/fold/foldgutter",
  "codemirror/addon/fold/brace-fold",
  "vkbeautify/vkbeautify",
], 
function(
  declare,
  win,
  has,
  on, 
  topic,
  touch,
  dom, 
  domStyle,
  domConstruct,
  domGeom,
  domForm,
  domClass,
  json,
  parser, 
  xhr,
  date,
  Stateful,
  query,
  ObjectStore, 
  LegacyMemory,
  LegacyObservable,
  // dijit section
  _WidgetBase,
  registry, 
  Dialog,
  Button,
  Select,
  FilteringSelect,
  ComboBox,
  // dojox section
  xmlparser,
  Standby,
  CheckedMultiSelect,
  // dstore section
  Memory,
  Trackable,
  DstoreAdapter,
  // dmodel section
  Model,
  ComputedProperty,
  // dgrid section
  OnDemandGrid, 
  Selection, 
  Keyboard, 
  Editor, 
  CompoundColumns,
  // moment section
  moment,
  timezone,
  // other section 
  CodeMirror,
  JSZip,
  FileSaver,
  FixedCheckedMultiSelect,
  CustomEditorLegLayover,
  XslTransform) {


var TRIP     = "TRP";
var TRAINING = "TRN";
var RESERVE  = "RSV";
var LEAVE    = "LVE";
var DAY_OFF  = "DO";

// About the coordinates:
// X axis is the datetime. the first day of the graph start at 0. and a day is 1440 long (except dst ones).

var XStartPeriod      = -1;  // X position of the start period. -1 means not set yet.
var XStartNextPeriod  = -1;  // X position of the next start periode.
// The two previous variables are used to compute InPeriod data as credit, block
// tafb, etc...

var OpenTimeLineCount = 0;   // Number of lines required to draw opentime activities without overlaps.

var svg = {
  minX              : 0,      // lowest   coordinate on axis X
  maxX              : 1000,   // greatest coordinate on axis X
  minY              : 0,      // lowest   coordinate on axis Y
  maxY              : 300,    // greatest coordinate on axis Y
  Scale             : 1,      // Scaling SVG factor
  dom               : dom.byId("graph"),
  domCalendar       : dom.byId("calendar"),
  domCalendarBar    : dom.byId("calendar_bar"),
  domCrewMembers    : dom.byId("crewmembers"),
  domCrewMemberBar  : dom.byId("crewmember_bar"),
  domNotes          : dom.byId("notes"),
  domOpenTime       : dom.byId("opentime"),
  domViewport       : dom.byId("viewport"),

  // TODO documentation
  SetSizeAttributes : function() {
    var self   = this;
    var matrix = self.domViewport.getCTM();

    self.dom.setAttribute("width", (self.maxX / config.XGraphCompression - self.minX) * matrix.a ); 
    self.dom.setAttribute("height", (self.maxY - self.minY) * matrix.a );

    matrix.e = self.minX * -1;
    matrix.f = self.minY * -1;

    self.SetCTM(matrix);
  },

  // TODO documentation
  SetCTM            : function(matrix) {
    var self      = this;
    var transform = "matrix(" + matrix.a + "," + matrix.b + "," + matrix.c + "," + matrix.d + "," + matrix.e + "," + matrix.f + ")";

    self.domViewport.setAttribute("transform", transform);
  }
};

                             
/*
 * Callback used to update gantt size according to window size.
 */
on(window, "resize", function() {
  var windowSize = win.getBox();

  domStyle.set("gantt", { height: windowSize.h - 6 - 3 * 8 - dom.byId("navMenu").offsetHeight + "px" });
});


/* 
 * As soon as everything is parsed, then remove "loading librairies ..." message and display
 * the content div, with the rigth 'size' on the svg tag which id is "gantt".
 */
parser.parse().then(function() { 
  dom.byId("loader").style.display = "none";
  dom.byId("content").style.display = "block";

  // Send an event resize on window to force the call of the previous callback.
  on.emit(window, "resize", {bubbles: true,cancelable: true});
});


/*
 * Start Date Time + duration Hour:Minute => End Date Time (readonly).
 */
function UpdateEndDateTime(prefixId) {
  var startDate = registry.byId(prefixId + "StartDate").get("value");
  var startTime = registry.byId(prefixId + "StartTime").get("value");
  if( startDate == null || startTime == null ) {
    return;
  }

  var mydate = moment.tz([startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), startTime.getHours(), startTime.getMinutes()], config.CalendarTimezoneName);

  var duration = moment.duration({
    hours: registry.byId(prefixId + "DurationHour").get("value"), 
    minutes: registry.byId(prefixId + "DurationMinute").get("value")
  });

  mydate.add(duration);

  var endDate = new Date(mydate.year(), mydate.month(), mydate.date(), mydate.hour(), mydate.minute());

  registry.byId(prefixId + "EndDate").set("value", endDate);
  registry.byId(prefixId + "EndTime").set("value", endDate);
} 







// ===============================================
// Display "detail" of activity, or event.
// ===============================================
function PopupActivityDetail(activityId) {
  var object = activityStore.getSync(activityId);

  if( object.type == TRIP ) {
    SetUpTripDialog(object);
  }
  else if( object.type == TRAINING ) {
    SetUpTrainingDialog(object);
  }
  else if( object.type == RESERVE ) {
    SetUpReserveDialog(object);
  }
  else if( object.type == LEAVE ) {
    SetUpVacationDialog(object);
  }
  else {
    var myDialog = new Dialog({
      title: "Detail activity",
      style: "width: 300px",
      content: "Activitiy pk : " + activityId + "<br/>name: " + activityStore.getSync(activityId).name + "<br/>",
    });

    var myButton = new Button({
      label: "Delete",
      class: "delete",
      onClick: function() {
        activityStore.removeSync(activityId);

        myDialog.hide();

        topic.publish("refreshGraph");
      }
    }).placeAt(myDialog);

    myDialog.show();
  }
}
//     
//   _____ __      __ _____  
//  / ____|\ \    / // ____| 
// | (___   \ \  / /| |  __  
//  \___ \   \ \/ / | | |_ | 
//  ____) |   \  /  | |__| | 
// |_____/     \/    \_____| 
//                           
//                            

// ===============================================
// return the X position in SVG, based on starting
// calendar and the date provided in argument.
// ===============================================
function getPositionX(date) {
  return (date.unix() - Xorig) / 60;
}


// ===============================================
// return the datetime based on x position.
// this method is the opposite of getPositionX.c
// ===============================================
function getDateTime(x) {
  return moment.tz((Xorig + x * 60) * 1000, config.CalendarTimezoneName);
}


// ===============================================
//  apply the compression factor on axe X.
// ===============================================
function CompressX(x) {
  return x / config.XGraphCompression;
}

// ===============================================
// SVG drawing
// ===============================================

// Assumption on the SVG:
// - One pixel per minute, so a day is 1440px width.
// - Group node (g) is generally used to be able to shift concept in the 
//   right position, so drawing the inner concept is logically simpler.
//
// An attempt to use dojox.gfx module to draw SVG was done, but some problems 
// occured to identify existing node, in order to add new objects.

var svgNS   = "http://www.w3.org/2000/svg";
var xlinkNS = "http://www.w3.org/1999/xlink";

var Xorig            = 0; // unix time of the start of the calendar.
var MARGIN_TOP_CM    = 20;
var HEIGHT_LINE_CM   = 140;
var MARGIN_BOTTOM_CM = 20;
var HEIGHT_LINE_HL   = 40;


// Draw a rectangle.
function SVG_drawRect(className, x, y, width, height) {
  var rectangle = document.createElementNS(svgNS, "rect");

  rectangle.setAttributeNS(null, "class", className);
  rectangle.setAttributeNS(null, "x", CompressX(x));
  rectangle.setAttributeNS(null, "y", y);
  rectangle.setAttributeNS(null, "width", CompressX(width));
  rectangle.setAttributeNS(null, "height", height);

  return rectangle;
}

// Draw a line.
function SVG_drawLine(className, x1, y1, x2, y2) {
  var line = document.createElementNS(svgNS, "line");

  line.setAttributeNS(null, "class", className);
  line.setAttributeNS(null, "x1", CompressX(x1));
  line.setAttributeNS(null, "y1", y1);
  line.setAttributeNS(null, "x2", CompressX(x2));
  line.setAttributeNS(null, "y2", y2);

  return line;
}


// Draw a text. 
function SVG_drawText(className, x, y, label) {
  var text = document.createElementNS(svgNS, "text");

  text.setAttributeNS(null, "class", className);
  text.setAttributeNS(null, "x", CompressX(x));
  text.setAttributeNS(null, "y", y);

  text.appendChild(document.createTextNode(label));

  return text;
}


// Draw a event in calendar.
function SVG_drawEvent(item) {
  var group         = document.createElementNS(svgNS, "g");

  group.setAttributeNS(null,"transform","translate(0, " + item.GetYCoord() + ")");
  group.setAttributeNS(null, "id", item.get("ident"));
  group.setAttributeNS(null, "fill", item.color);
  svg.domCalendar.appendChild(group);


  var lblText = SVG_drawText("event_label", item.x + 10, HEIGHT_LINE_HL / 2, item.get("label"));
  on(lblText, "click", function(evt) {
    SetUpEventDialog(item.pk);
  });
  group.appendChild(lblText);

  // a scale is used to extend the bars, that"s why they are defined into
  // a specific group.
  var groupBar     = document.createElementNS(svgNS, "g");
  groupBar.setAttributeNS(null, "id", item.get("barident"));
  groupBar.setAttributeNS(null, "fill", item.color);
  svg.domCalendarBar.appendChild(groupBar);

  groupBar.appendChild(SVG_drawRect("event", item.x, 0, item.thickness, 1));
}


// Convert a duration (in minutes) into a hour-minutes string.
// The minutes are on 2 digits.
function GetFormatedDuration(dur) {
  var min = dur % 60;

  var label = Math.floor(dur / 60) + "h";
  label += min > 9 ? min : "0" + min;

  return label;
}


// Draw a dimesion line, with the duration. If the width is not
// large enough to insert the duration, the dimension line is
// extended.
function SVG_drawDimensionLine(G, pk, xFrom, xTo, y) {
  var duration        = Math.abs(xTo - xFrom);
  var yHorizontalLine = y + HEIGHT_LINE_HL / 2;

  // draw measure  <-------  dst -------->
  var lblText = SVG_drawText("distance_label", (xFrom + xTo) / 2 , yHorizontalLine - 3, GetFormatedDuration(duration));

  on(lblText, "click", function(evt) {
    SetUpDistanceDialog(pk);
  });
  G.appendChild(lblText);

  var lblTextLength = lblText.getComputedTextLength();
  var xExtension = 0;
  var inc   = HEIGHT_LINE_CM / 20;
  var xinc  = inc * config.XGraphCompression; 

  if( lblTextLength + 2 * inc > CompressX(duration) ){
    xExtension = (lblTextLength + 2 * inc) * config.XGraphCompression;
  }

  G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xTo + xExtension, yHorizontalLine));

  if( xExtension ) {
    xinc = xinc * -1;
    lblText.setAttributeNS(null,"x", CompressX(xTo - 2 * xinc));
    lblText.setAttributeNS(null,"style", "text-anchor: start");
  }

  var orientation = xFrom < xTo ? 1 : -1; 

  // draw arrow.
  G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xFrom + orientation * xinc, yHorizontalLine + inc));
  G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xFrom + orientation * xinc, yHorizontalLine - inc ));

  // draw second arrow.
  G.appendChild(SVG_drawLine("distance", xTo, yHorizontalLine, xTo - orientation * xinc, yHorizontalLine + inc));
  G.appendChild(SVG_drawLine("distance", xTo, yHorizontalLine, xTo - orientation * xinc, yHorizontalLine - inc));
}


// Draw an extension line, used to link activity with dimension line.
function SVG_drawExtensionLine(G, x, y, origin) {
  if( typeof(origin) != 'undefined' ){
    var yHorizontalLine = y + HEIGHT_LINE_HL / 2;
    var inc             = HEIGHT_LINE_CM / 20;

    var cm        = origin.GetCrewMember();
    var ycm       = cm ? cm.GetYCoord() : yCoordStore.nextY;
    var LineCount = cm ? cm.lineCount : OpenTimeLineCount;
    var Y         = MARGIN_TOP_CM + HEIGHT_LINE_CM * LineCount + MARGIN_BOTTOM_CM; 
    G.appendChild(SVG_drawLine("extension", x, ycm < y ? ycm - Y : ycm + Y, x, ycm < y ? yHorizontalLine + inc : yHorizontalLine - inc));
  }
}


// Draw a distance in calendar.
function SVG_drawDistance(item) {
  var G = document.createElementNS(svgNS, "g");
  G.setAttributeNS(null, "id", item.get("ident"));
  svg.domCalendar.appendChild(G);

  var xFrom = item.GetEventFrom().GetX();
  var xTo   = item.GetEventTo().GetX();

  var y = item.GetYCoord();

  SVG_drawDimensionLine(G, item.pk, xFrom, xTo, y);

  SVG_drawExtensionLine(G, xFrom, y, item.GetActFrom());
  SVG_drawExtensionLine(G, xTo  , y, item.GetActTo  ());
}


// Get the hour inc to fit with graph compression.
function GetIncHour() {
  if( config.XGraphCompression < 1 ) return 60;
  if( config.XGraphCompression <= 2 ) return 120;
  if( config.XGraphCompression <= 4 ) return 240;
  if( config.XGraphCompression <= 6 ) return 360;
  if( config.XGraphCompression <= 10 )return 720;
  return 1440;
}


// Get a size font to fit with graph compression.
function GetFontSize() {
  if( config.XGraphCompression <  5 ) return "40";
  if( config.XGraphCompression <  8 ) return "30";
  if( config.XGraphCompression < 15 ) return "20";
  return "8";
}     


// Draw a calendar date. The drawing belongs to id calendar in the SVG.
// Each "date" is embedded in a g node, with a translation on X, according
// to the position. This way, each drawing into the g node is strictly the 
// same for each day, except labels.
function SVG_drawCalendarDate(item) {
  var G       = document.createElementNS(svgNS, "g");
  G.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
  G.setAttributeNS(null, "id", item.get("ident"));
  G.setAttributeNS(null, "class", item.get("dayweek"));
  svg.domCalendar.appendChild(G);

  var day_r = SVG_drawText(item.get("startperiod") ? "day_label relative day_start_period" : "day_label relative", 720, -70, "Day " + item.get("relative"));
  day_r.setAttributeNS(null, "style", "font-size: " + ( GetFontSize() * 1.5) );
  G.appendChild(day_r);

  var day_label = SVG_drawText(item.get("startperiod") ? "day_label yyyymmdd day_start_period" : "day_label yyyymmdd", 720, -20, item.get("name"));
  day_label.setAttributeNS(null, "style", "font-size: " + GetFontSize());
  G.appendChild(day_label);

  var minutes = GetIncHour();
  var time = moment.tz(item.get("name"), config.CalendarTimezoneName);
  var duration = moment.duration(minutes, "minutes");

  for(var i = 0; i < item.width; i += minutes) { 
    G.appendChild(SVG_drawText("hour_label", i, 0, time.format("H:mm")));
    time.add(duration);   
  }

  // a scale is used to extend the bars, that's why they are defined into
  // a specific group.
  var Gbar     = document.createElementNS(svgNS, "g");
  Gbar.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
  Gbar.setAttributeNS(null, "class", item.get("type"));
  Gbar.setAttributeNS(null, "id", item.get("barident"));
  svg.domCalendarBar.appendChild(Gbar);

  var classValues = "day_bar " + item.get("dayweek");
  if( item.get("startperiod") ) {
    classValues += " start_period";
  }
  Gbar.appendChild(SVG_drawRect(classValues, 0, 0, item.width, 1));

  Gbar.appendChild(SVG_drawRect("line", 0, 0, 1, 1));
  Gbar.appendChild(SVG_drawRect("line", item.width, 0, 1, 1));


  for(var i = 60; i < item.width; i += 120) { 
    Gbar.appendChild(SVG_drawRect("hour_bar", i, 0, 60, 1));
  }

  svg.minY = Math.min(svg.minY, -110); // -70 - 40 (line952).
  svg.maxX = Math.max(svg.maxX, item.x + item.width);
}


// Draw a crewmember. The drawing is embedded into a g node 
// with a translation on y, and belongs to crewmembers id.
// There is no x translation, so every activity attached to the 
// crewmember will be add into the g node.
function SVG_drawCrewMember(item) {
  var crewText = SVG_drawText("crewmember", -50 * config.XGraphCompression, MARGIN_TOP_CM + HEIGHT_LINE_CM / 2, item.name);

  on(crewText, "click", function(evt) {
    SetUpCrewMemberDialog(item.pk);
  }); 

  var group = document.createElementNS(svgNS, "g");
  var y     = item.GetYCoord();

  group.appendChild(crewText);

  group.setAttributeNS(null,"transform","translate(0, " + y + ")");
  group.setAttributeNS(null,"id", item.get("ident"));

  svg.domCrewMembers.appendChild(group);

  var groupBar = document.createElementNS(svgNS, "g");

  groupBar.setAttributeNS(null,"transform","translate(0, " + y + ")");
  groupBar.setAttributeNS(null,"id", item.get("barident"));
  groupBar.appendChild(SVG_drawRect("line", 0, 0               , 1, 1));
  groupBar.appendChild(SVG_drawRect("line", 0, item.GetHeight(), 1, 1));

  svg.domCrewMemberBar.appendChild(groupBar);

  svg.minX = Math.min(svg.minX, -50 - crewText.getComputedTextLength());
}

/*
 * Draw a curly brace to delimit duties on a trip.
 * original code: http://bl.ocks.org/alexhornbake/6005176
 */
function SVG_drawDuty(x1, x2, iDuty) {
  //Calculate unit vector
  var len = x1-x2;
  var w = -10;
  var q = .5;
  var unitY = HEIGHT_LINE_CM / 14;
  var y1 = 5 * unitY;

  //Calculate Control Points of path,
  var qy1 = y1 - q*w;
  var qx2 = (x1 - .25*len);
  var qy2 = y1 - (1-q)*w;
  var tx1 = (x1 - .5*len);
  var ty1 = y1 - w;
  var qy3 = y1 - q*w;
  var qx4 = x1 - .75*len;
  var qy4 = y1 - (1-q)*w;

  var group = document.createElementNS(svgNS, "g");
  group.setAttributeNS(null,"class", "DUTY");

  var path = document.createElementNS(svgNS, "path");

  path.setAttributeNS(null,"class", "brace");
  path.setAttributeNS(null, "d", "M " +  CompressX(x1) + " " +  y1 +
         " Q " + CompressX(x1) + " " + qy1 + " " + CompressX(qx2) + " " + qy2 + 
         " T " + CompressX(tx1) + " " + ty1 +
         " M " + CompressX(x2) + " " +  y1 +
         " Q " + CompressX(x2) + " " + qy3 + " " + CompressX(qx4) + " " + qy4 + 
         " T " + CompressX(tx1) + " " + ty1 );

  group.appendChild(path);
  group.appendChild(SVG_drawText("lbl_duty", tx1, 7 * unitY, "duty " + iDuty));

  return group;
}


/*
 * Draw detail of a trip. Only TRIP activities have details.
 */ 
function SVG_drawActivityDetail(activity, G, hourSize, endMargin) { 
  activityStore.filter({fk_parent: activity.pk}).sort('x').fetch().then(function(objects) {
    if( objects.length == 0 ) { 
      // skip drawing duty curly braces.
      return; 
    }

    var unitY = HEIGHT_LINE_CM / 14; 

    var endDetailActivity = moment.tz(activity.get("lbtStart"), config.CalendarTimezoneName);

    var Gdetails = document.createElementNS(svgNS, "g");
    Gdetails.setAttributeNS(null, "transform", "translate(0," + 6 * unitY +")");
    Gdetails.setAttributeNS(null, "class", "details");

    G.appendChild(Gdetails);

    var xDutyStart = 0;
    var iDuty      = 1;


    for(i = 0; i < objects.length; i++) {
      var Rect = document.createElementNS(svgNS,"rect");
      var x    = objects[i].x -activity.x;
       
      Rect.setAttributeNS(null, "class", objects[i].get("type"));
      Rect.setAttributeNS(null, "x", CompressX(x));
      Rect.setAttributeNS(null, "y", unitY);
      Rect.setAttributeNS(null, "rx", 1);
      Rect.setAttributeNS(null, "ry", 1);
      Rect.setAttributeNS(null, "width", CompressX(objects[i].duration));
      Rect.setAttributeNS(null, "height", 4 * unitY);

      if( objects[i].type == "LAY" ) {
        Gdetails.appendChild(SVG_drawDuty(xDutyStart, x, iDuty));
        iDuty += 1;
        xDutyStart = objects[i+1].x - activity.x;
      }

      Gdetails.appendChild(Rect);

      if( i % 2 == 0 && i != 0 && i != objects.length -1 ) {
        Gdetails.appendChild(SVG_drawText("dtl_station", objects[i].x + objects[i].duration / 2 - activity.x, unitY -2, objects[i].station ));
      }
      if( i % 2 == 1 ) {
        Gdetails.appendChild(SVG_drawText("dtl_hour start_hour", objects[i].x - activity.x, unitY + hourSize, endDetailActivity.format("HH:mm")));
        // useless since the distance tool allows to measure duration !          
        //          Gdetails.appendChild(SVG_drawText("duration", objects[i].x + objects[i].duration / 2 - activity.x, 3 * unitY , "<- " + formatDurationInHoursMinutes(objects[i].duration) + " ->"));
      }

      endDetailActivity.add(objects[i].duration, "m");

      if( i % 2 == 1 ) {
        Gdetails.appendChild(SVG_drawText("dtl_hour end_hour" , objects[i].x + objects[i].duration - activity.x, 5 * unitY - endMargin, endDetailActivity.format("HH:mm")));
      }

    }
    Gdetails.appendChild(SVG_drawDuty(xDutyStart, activity.duration, iDuty));
  });
}

// Draw an activity. As the others, the drawing is embedded into a g node 
// with a translation on y, and belongs to crewmember or opentime line.
// Therefore no y translation is necessary, a x is used to draw the activity on
// the rigth place in the calendar.
function SVG_drawActivity(activity) { 
  var unitY = HEIGHT_LINE_CM / 14; 
  var parentId = svg.dom.getElementById(activity.GetCrewMemberIdent());

  var G = document.createElementNS(svgNS, "g");
  var yLine = MARGIN_TOP_CM + HEIGHT_LINE_CM * ( activity.lineNb - 1 );

  var midnightOffset = activity.midnightOffset ? Number(config.midnightOffset) : 0;       
  G.setAttributeNS(null, "transform", "translate(" + CompressX(activity.x + midnightOffset) + "," + yLine +")");
  G.setAttributeNS(null, "id", activity.get("ident"));

  on(G, "click", function(evt) {
    PopupActivityDetail(activity.pk);
  });

  parentId.appendChild(G);

  var Rect = document.createElementNS(svgNS,"rect");
  Rect.setAttributeNS(null, "class", activity.get("type"));
  Rect.setAttributeNS(null, "x", 0);
  Rect.setAttributeNS(null, "y", 0);
  Rect.setAttributeNS(null, "rx", Math.min(CompressX(2 * unitY), 20));
  Rect.setAttributeNS(null, "ry", Math.min(CompressX(2 * unitY), 20));
  Rect.setAttributeNS(null, "width", CompressX(activity.duration));
  Rect.setAttributeNS(null, "height", HEIGHT_LINE_CM);
  G.appendChild(Rect);

  G.appendChild(SVG_drawText("label", 10, 5 * unitY, activity.name));

  var startActivity = moment.tz(activity.lbtStart, config.CalendarTimezoneName);
  startActivity.add(midnightOffset, "m");
  var endActivity   = startActivity.clone();
  endActivity.add(activity.duration, "m");
  var hourSize = 9;  // see font-size of class .hour_start.
  var endMargin = 2;

  G.appendChild(SVG_drawText("act_hour start_hour", 0 , hourSize, startActivity.format("HH:mm")));
  G.appendChild(SVG_drawText("act_hour end_hour", activity.duration, 14 * unitY - endMargin, endActivity.format("HH:mm")));

  var transportationTime = 0;
  if( activity.transportationTime ) {
    transportationTime = Number(config.transportationTime);
    if( transportationTime > 0 ) {
      // before.
      G.appendChild(SVG_drawRect("TP", transportationTime * -1, 3 * unitY, transportationTime, 4 * unitY));
      startActivity.subtract(transportationTime, "m");
      G.appendChild(SVG_drawText("act_hour start_hour", transportationTime * -1, 3 * unitY + hourSize, startActivity.format("HH:mm")));

      // after.
      G.appendChild(SVG_drawRect("TP", activity.duration, 7 * unitY, transportationTime, 4 * unitY));
      endActivity.add(transportationTime, "m");
      G.appendChild(SVG_drawText("act_hour end_hour", activity.duration + transportationTime , 11 * unitY - endMargin, endActivity.format("HH:mm")));
    }
  }

  // rest before
  if( activity.restBefore > 0 ) {
    G.appendChild(SVG_drawRect("REST", ( activity.restBefore + transportationTime ) * -1, 3 * unitY, activity.restBefore, 4 * unitY));
    startActivity.subtract(activity.restBefore, "m");
    G.appendChild(SVG_drawText("act_hour start_hour", ( activity.restBefore + transportationTime ) * -1 , 3 * unitY + hourSize, startActivity.format("HH:mm")));
  }

  // rest after. 
  if( activity.restAfter > 0 ) {
    G.appendChild(SVG_drawRect("REST", activity.duration + transportationTime, 7 * unitY, activity.restAfter, 4 * unitY));
    endActivity.add(activity.restAfter, "m");
    G.appendChild(SVG_drawText("act_hour end_hour", activity.duration + transportationTime + Number(activity.restAfter), 11 * unitY - endMargin, endActivity.format("HH:mm")));
  }

  SVG_drawActivityDetail(activity, G, hourSize, endMargin);  
}

var selectedElement = 0;
var currentX = 0;
var currentY = 0;
var currentMatrix = 0;
var sig1;
var sig2;

function selectElement(evt) {
  if( evt.ctrlKey || evt.altKey ){
    selectedElement = evt.target.parentNode; // I don't know why target points to body. 
    currentX = evt.clientX;
    currentY = evt.clientY;
    currentMatrix = selectedElement.getAttributeNS(null, "transform").slice(7,-1).split(' ');

    for(var i=0; i<currentMatrix.length; i++) {
      currentMatrix[i] = parseFloat(currentMatrix[i]);
    }

    sig1 = on(selectedElement, "mousemove"         , function(evt) { moveElement(evt); });
    sig2 = on(selectedElement, "mouseout, mouseup" , function(evt) { deselectElement(evt); });
  } 
  else {
    // The idea is to find the parent container which name is foreignObject. Then the ID
    // can be used to extract the primary key of the note.      
    var target = evt.target;          
    while( target.nodeName != 'foreignObject' ) {
      target = target.parentNode;
    }
          
    var pkNote = target.id.replace( /^\D+/g, '');
    if( pkNote ) {
      SetUpNoteDialog(pkNote);
    }
  }
}

function moveElement(evt) {
  var viewFactor = svg.domViewport.getCTM().a;
  var dx = evt.clientX - currentX;
  var dy = evt.clientY - currentY;
  currentMatrix[4] += dx / viewFactor;
  currentMatrix[5] += dy / viewFactor;
  selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");
  currentX = evt.clientX;
  currentY = evt.clientY;
}

function deselectElement(evt) {
  if(selectedElement != 0){
    var viewFactor = svg.domViewport.getCTM().a;
    var pkNote = evt.target.id.replace( /^\D+/g, '');
    var note = noteStore.getSync(pkNote);
    note.x += currentMatrix[4] * config.XGraphCompression;
    note.y += currentMatrix[5];
    currentMatrix[4] = 0;
    currentMatrix[5] = 0;

    selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");
    selectedElement.setAttributeNS(null, "x", CompressX(note.x));
    selectedElement.setAttributeNS(null, "y", note.y);

    noteStore.putSync(note);

    sig1.remove();
    sig2.remove();
    selectedElement = 0;
  }
}



// The challenge is to manage html formatting into svg, and to get the right box size.
// The foreignObject is created with a huge size, then the user html note is encapsulated 
// into a span tag. A span tag is used insteaf of a div, because it is not greedy in 
// term of width. As soon as every new tags are appended into the document, the width and
// the height of the span tag is used to update the size of the foreignObject. Due to 
// zoom factor, the computation needs the ratio factor to compute the real size, not the
// rendered one. 
function SVG_drawNote(item) {
  var foreignObject = document.createElementNS(svgNS, "foreignObject");
  foreignObject.setAttributeNS(null,"id", "fo" + item.get("ident"));
  foreignObject.setAttributeNS(null,"x", CompressX(item.x));
  foreignObject.setAttributeNS(null,"y", item.y);
  foreignObject.setAttributeNS(null,"width", "4000px");
  foreignObject.setAttributeNS(null,"height", "100%");
  foreignObject.setAttributeNS(null,"transform", "matrix(1 0 0 1 0 0)");
  on(foreignObject, "mousedown", function(evt) {
    selectElement(evt);
  });



  svg.domNotes.appendChild(foreignObject);

  var body = document.createElement("body");
  body.setAttributeNS(null,"id", "body" + item.get("ident"));
  body.setAttributeNS(null,"style", "padding: 10; margin: 0; background-color:" + item.color);   
  body.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml');

  // span is not greedy as a div. so logically
  var span = document.createElement("span");
  span.setAttributeNS(null,"id", "span" + item.get("ident"));
  span.setAttributeNS(null,"style", "padding: 10px; background-color: white");   

  span.innerHTML = item.note;

  body.appendChild(span);

  foreignObject.appendChild(body);

  var pos = domGeom.position(dom.byId("span" + item.get("ident")));
  var viewFactor = svg.domViewport.getCTM().a;

  var width  = ( ( pos.w / viewFactor) + 12 + 10 ) * 1.1;
  var height = ( ( pos.h / viewFactor) + 12 + 20 ) * 1.1;
  foreignObject.setAttributeNS(null, "width", width);
  foreignObject.setAttributeNS(null, "height", height);

  // div is not greedy as a div. so logically
  var div = document.createElement("div");
  div.setAttributeNS(null,"id", "div" + item.get("ident"));
  div.setAttributeNS(null,"style", "padding: 10px; background-color: white");   

  div.innerHTML = item.note;

  body.removeChild(span);
  body.appendChild(div);

  /*
  var img = document.createElement("img");
  img.setAttributeNS(null, "src", "images/icon-move.png");
  img.setAttributeNS(null, "height", "30");
  img.setAttributeNS(null, "width", "30");
  img.setAttributeNS(null, "style", "position: absolute; top: 0; right: 0");
  body.appendChild(img);
  */
}

// 
//  __  __   ____   _____   ______  _                  _____  _______  ____   _____   ______ 
// |  \/  | / __ \ |  __ \ |  ____|| |        ___     / ____||__   __|/ __ \ |  __ \ |  ____|
// | \  / || |  | || |  | || |__   | |       ( _ )   | (___     | |  | |  | || |__) || |__   
// | |\/| || |  | || |  | ||  __|  | |       / _ \/\  \___ \    | |  | |  | ||  _  / |  __|  
// | |  | || |__| || |__| || |____ | |____  | (_>  <  ____) |   | |  | |__| || | \ \ | |____ 
// |_|  |_| \____/ |_____/ |______||______|  \___/\/ |_____/    |_|   \____/ |_|  \_\|______|
//                                                                                           
//                                                                                          

var TrackableMemory = declare([Memory, Trackable]); 

//
//  _          _                               
// /   _  ._ _|_ o  _      ._ _. _|_ o  _  ._  
// \_ (_) | | |  | (_| |_| | (_|  |_ | (_) | | 
//                  _|                         
//
//
var configurationModel = declare(Model, {
  validateOnSet : false,

  schema        : {
    id                                            : { type : "numeric", default : 0, },
    transportationTime                            : { type : "numeric", default : 0, },
    midnightOffset                                : { type : "numeric", default : 0, },
    reportTime                                    : { type : "numeric", default : 0, },
    releaseTime                                   : { type : "numeric", default : 0, },
    CalendarTimezone                              : { type : "numeric", default : -1, },
    CalendarTimezoneName                          : { type : "string",  default : "", },
    CalendarStation                               : { type : "string",  default : "", },
    CalendarStart                                 : { type : "string",  default : undefined, },
    CalendarEnd                                   : { type : "string",  default : undefined, },
    MenuFile                                      : { type : "boolean", default : false, },
    MenuFileLoadSVGFile                           : { type : "boolean", default : false, },
    MenuFileLoadXMLStationFile                    : { type : "boolean", default : false, },
    MenuFileSaveSVGFile                           : { type : "boolean", default : true, },
    MenuFileExportToPI                            : { type : "boolean", default : true, },
    MenuCalendar                                  : { type : "boolean", default : true, },
    MenuCalendarSetStartEnd                       : { type : "boolean", default : true, },
    MenuCalendarSetStartPeriods                   : { type : "boolean", default : true, },
    MenuBusinessObject                            : { type : "boolean", default : true, },
    MenuBusinessObjectShowConstants               : { type : "boolean", default : false, },
    MenuBusinessObjectCreateCrewMember            : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivity              : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityDayOff        : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityVacation      : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityTrip          : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityTraining      : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityReserve       : { type : "boolean", default : false, },
    MenuBusinessObjectCreateActivityTaskGroup     : { type : "boolean", default : true, },
    MenuGraphOption                               : { type : "boolean", default : true, },
    MenuGraphOptionCalendar                       : { type : "boolean", default : false, },
    MenuGraphOptionActivity                       : { type : "boolean", default : false, },
    MenuHighLights                                : { type : "boolean", default : true, },
    MenuHighLightsEvent                           : { type : "boolean", default : false, },
    MenuHighLightsDistance                        : { type : "boolean", default : false, },
    MenuHighLightsWindow                          : { type : "boolean", default : true, },
    MenuHighLightsNote                            : { type : "boolean", default : false, },
    MenuResolution                                : { type : "boolean", default : true, },
    SHCalendarHours                               : { type : "boolean", default : true, },
    SHCalendarHourBars                            : { type : "boolean", default : true, },
    SHCalendarDayX                                : { type : "boolean", default : true, },
    SHCalendarDayYYYYMMDD                         : { type : "boolean", default : true, },
    SHCalendarDayBars                             : { type : "boolean", default : true, },
    SHCalendarMon                                 : { type : "boolean", default : false, },
    SHCalendarTue                                 : { type : "boolean", default : false, },
    SHCalendarWed                                 : { type : "boolean", default : false, },
    SHCalendarThu                                 : { type : "boolean", default : false, },
    SHCalendarFri                                 : { type : "boolean", default : false, },
    SHCalendarSat                                 : { type : "boolean", default : true, },
    SHCalendarSun                                 : { type : "boolean", default : true, },
    XGraphCompression                             : { type : "numeric", default : 1, },
    SHActivityHours                               : { type : "boolean", default : true, },
    SHActivityDetails                             : { type : "boolean", default : true, },
    SHActivityDetailHours                         : { type : "boolean", default : true, },
    SHActivityDetailStations                      : { type : "boolean", default : true, },
    SHActivityDuties                              : { type : "boolean", default : true, },
  },
  /*
   * After loading the configuration from svg file (store), set up the UI interface, and 
   * some calendar and timezone UI items.
   */
  UpdateForBackwardCompatibility : function() {
    var self = this;

    // CalendarTimezoneName has been introduced after CalendarTimezone (id). Thus for backward compatibility,
    // the first one is set by using the second one.
    if( typeof(self.CalendarTimezoneName) == "undefined" && typeof(self.CalendarTimezone) != "undefined" ) {
      self.CalendarTimezoneName = TimezoneStore.get(self.CalendarTimezone).name;
      configurationStore.putSync(self);          
    }
  },

  UpdateUI : function() {
    var self = this;

    registry.byId("CalendarStart").set("value", self.CalendarStart);      
    registry.byId("CalendarEnd").set("value", self.CalendarEnd);     

    // Set resolution.
    var id = "xgc" + self.XGraphCompression.toString().replace(".", "_");
    registry.byId(id).set("checked", true);
    
    registry.byId("SHCalendarHours").set("checked", self.SHCalendarHours);
    registry.byId("SHCalendarDayX").set("checked", self.SHCalendarDayX);
    registry.byId("SHCalendarDayYYYYMMDD").set("checked", self.SHCalendarDayYYYYMMDD);
    registry.byId("SHCalendarDayBars").set("checked", self.SHCalendarDayBars);
    registry.byId("SHCalendarHourBars").set("checked", self.SHCalendarHourBars);
    registry.byId("SHCalendarMon").set("checked", self.SHCalendarMon);
    registry.byId("SHCalendarTue").set("checked", self.SHCalendarTue);
    registry.byId("SHCalendarWed").set("checked", self.SHCalendarWed);
    registry.byId("SHCalendarThu").set("checked", self.SHCalendarThu);
    registry.byId("SHCalendarFri").set("checked", self.SHCalendarFri);
    registry.byId("SHCalendarSat").set("checked", self.SHCalendarSat);
    registry.byId("SHCalendarSun").set("checked", self.SHCalendarSun);

    registry.byId("SHActivityHours").set("checked", self.SHActivityHours);
    registry.byId("SHActivityDetails").set("checked", self.SHActivityDetails);
    registry.byId("SHActivityDetailHours").set("checked", self.SHActivityDetailHours);
    registry.byId("SHActivityDetailStations").set("checked", self.SHActivityDetailStations);
    registry.byId("SHActivityDuties").set("checked", self.SHActivityDuties);
  },

  updateCheckboxProperty : function(property, isChecked) {
    var self = this;
    
    self[property] = isChecked;
    configurationStore.putSync(self);
  }, 

  updateXGraphCompression : function(value) {
    var self = this; 
          
    self.XGraphCompression = value;

    configurationStore.putSync(self);

    topic.publish("refreshGraph");
  },

  updateFromForm : function(strFormId) {
    var self       = this;
    var formObject = domForm.toObject(strFormId);
         
    for(var key in formObject){
      if(formObject.hasOwnProperty(key)) {
        self[key] = formObject[key]; 
      }
    }

    configurationStore.putSync(self);
  },

  enableMenusAfterLoadingStationFile : function() {
    var self = this;

    self.MenuCalendar                = false;
    self.MenuCalendarSetStartEnd     = false;
    self.MenuBusinessObject          = true;
    self.MenuGraphOption             = true;
    self.MenuHighLights              = true;
    self.MenuResolution              = true;
    self.MenuFileSaveSVGFile         = true;
    self.MenuFileExportToPI          = true;
    self.MenuCalendarSetStartPeriods = true;

    configurationStore.putSync(self);
  
    topic.publish("refreshGraph");
  },


});

var configurationStore = new Memory({
  Model           : configurationModel,
  idProperty      : "id",
  svgId           : "ConfigurationStore",
  svgItemNodeName : "configuration",
});

// Change MenuItem visibility base on config updates.
configurationStore.on("add, update", function(event) {
  var cfg     = event.target;
  var pattern = new RegExp("^Menu");

  for(var property in cfg) {
    if( pattern.test(property) ) {
      var menuItem = registry.byId(property);

      if( menuItem ) {
        menuItem.set("disabled", cfg.get(property));
      } 
      else {
        alert("unknown MenuItem: " + property);
      }
    }
  }
});

var config = configurationStore.Model();

configurationStore.addSync(config);

config.UpdateUI();


//
//  __                      
// (_ _|_  _. _|_ o  _  ._  
// __) |_ (_|  |_ | (_) | | 
//                        
//
var StationModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    id             : "string",
    code           : "string",
    name           : "string",
    dstShift       : "string",
    dstStartLst    : "string",
    dstEndLst      : "string",
    utcOffset      : "string",
    offset         : "numeric",
    regionList     : "array",
  },
});


var stationStore = new Memory({
  Model           : StationModel,
  idProperty      : "id",
  svgId           : "StationStore",
  svgItemNodeName : "station",
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
});


//
//     _                 
//    /   _   _  ._ _|   
// \/ \_ (_) (_) | (_|   
// /                     
//
//
var yCoordModel = declare(Model, {
  schema        : {
    pk     : "numeric",
    y      : "numeric",
    height : "numeric",
    fk_hl  : "numeric",
    fk_dst : "numeric",
    fk_cm  : "numeric",
  },
  validateOnSet : false,
});

var yCoordStore = new TrackableMemory({
  Model             : yCoordModel,
  idProperty        : "pk",
  nextPk            : 1,
  nextY             : 0,
  nextYCM           : 0,
  svgId             : "YCoordStore",
  svgItemNodeName   : "ycoord",
  StretchSVGHeight  : function() {
    var self = this;
    // scale vertically the calendar to fit the number of crewmember.
    var height = self.nextY;

    if( OpenTimeLineCount > 0 ) {
      height += MARGIN_TOP_CM + HEIGHT_LINE_CM * OpenTimeLineCount + MARGIN_BOTTOM_CM;
    }
    svg.domCalendarBar.setAttribute("transform", "scale(1," + height + ")");
    svg.domOpenTime.setAttribute("transform","translate(0, " + self.nextY + ")");
    svg.maxY = Math.max(svg.maxY, height);
  },
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  GetNextYCM        : function() { // get the y coordinate for the next crewmember, ie before opentime and distance among opentime activities.
    var self = this;

    return self.nextYCM;
  },  
  ComputeYAndHeigth : function() {
    var self = this;

    yCoordStore.sort('y').fetch().then(function(items) {
      var nextY   = 0;
      var nextYCM = 0;
      for (var i = 0 ; i < items.length ; i++) {
        items[i].y = nextY;
        if( typeof(items[i].fk_cm) == 'undefined' ) {
          nextYCM = nextY;
        }
        nextY += items[i].height;
      }
      self.nextY = nextY;
      self.nextYCM = nextYCM;
    });    
  },
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
});


yCoordStore.on("add", function(event) {
  // 1 - increment primary key sequence.
  yCoordStore.nextPk = Math.max(event.target.pk + 1, yCoordStore.nextPk); 

  if( event.target.load != true ) {
    // 2 - recompute y and height of each item.
    yCoordStore.ComputeYAndHeigth();
  }
});


yCoordStore.on("update", function(event) {
  // 1 - set next primary key value.
  yCoordStore.nextPk = Math.max(event.target.pk + 1, yCoordStore.nextPk); 

  // 2 - recompute y and height of each item.
  yCoordStore.ComputeYAndHeigth();
});


yCoordStore.on("delete", function(event) {
  // 1 - recompute y and height of each item.
  yCoordStore.ComputeYAndHeigth();
});


//
//  _                          
// /   _. |  _  ._   _|  _. ._ 
// \_ (_| | (/_ | | (_| (_| |  
//                              
//
var calendarModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    pk            : "numeric",
    x             : "numeric",
    width         : "numeric",
    name          : "string",
    dayweek       : "string",
    relative      : "numeric",
    startperiod   : { type : "boolean", default : false },
    type          : new ComputedProperty({
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return pk % 2 ? "uneven" : "even";
      }
    }),
    ident         : new ComputedProperty({ 
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "cd" + pk;  // cd stands for Calendar Day.
      }
    }),
    barident      : new ComputedProperty({ 
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "bcd" + pk;  // bcd stands for Bar Calendar Day.
      }
    }),
  },
  DrawSVG       : function() { 
    var self = this;

    SVG_drawCalendarDate(self); 
  },
});


var calendarStore = new TrackableMemory({
  Model             : calendarModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "CalendarStore",
  svgItemNodeName   : "calendar",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  GetPkFromX : function(x) {
    var self = this;

    var pk = -1;
    self.sort('x').fetch().then(function(items) {
      for (var i = 0 ; i < items.length ; i++) {
        if( x >= items[i].x && x < items[i].x + items[i].width) {
          pk = items[i].pk;
          return;
        } 
      } 
    });
    return pk;  
  },


});


calendarStore.on("add", function(event) {
  calendarStore.nextPk = Math.max(event.target.pk + 1, calendarStore.nextPk); 
});


calendarStore.on("update", function(event) {
  calendarStore.nextPk = Math.max(event.target.pk + 1, calendarStore.nextPk); 
});


var calendarStoreAdapter = new DstoreAdapter(calendarStore);
registry.byId("CalendarStartPeriods").set("labelAttr", "name");

registry.byId("DayOffDatesSelect").set("labelAttr", "name");
registry.byId("DayOffDatesSelect").setStore(calendarStoreAdapter);
registry.byId("EventDatesSelect").set("labelAttr", "name");
registry.byId("EventDatesSelect").setStore(calendarStoreAdapter);


//
//  _                                      
// /  ._ _       |\/|  _  ._ _  |_   _  ._ 
// \_ | (/_ \/\/ |  | (/_ | | | |_) (/_ |  
//                                             
//
var crewMemberModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    name      : "string",
    birthdate : "string",
    pk        : "numeric",
    fk_yc     : "numeric",
    lineCount : "numeric",
    ident     : new ComputedProperty({
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "cm" + pk; // cm stands for CrewMember.
      }
    }),
    barident  : new ComputedProperty({ 
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "bcm" + pk; // bcm stands for Bar CrewMember.
      }
    }),
  },
  DrawSVG : function() { 
    var self = this;

    SVG_drawCrewMember(self); 
  },
  GetYCoord : function() {
    var self = this;

    return yCoordStore.getSync(self.fk_yc).y;
  },
  GetHeight : function() {
    var self = this;

    return yCoordStore.getSync(self.fk_yc).height;
  },
  ConvertModelToForm : function() {
    var self = this;

    registry.byId('CrewMemberForm').set('value', self);
  },  
  ConvertFormToModel : function() {
    var self = this;
    
    if( !self.pk ) {
      self.pk        = crewMemberStore.GetNextPKSequence();
      self.lineCount = 1;
    }

    var formObject = domForm.toObject("CrewMemberForm");

    self.name      = formObject.name;
    self.birthdate = formObject.birthdate; 

  },
});


var crewMemberStore = new TrackableMemory({
  Model             : crewMemberModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "CrewMemberStore",
  svgItemNodeName   : "crew",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  SaveOrUpdate : function() {
    var self = this;

    var pk = Number(registry.byId("CrewMemberPk").get("value"));

    var item = pk ? self.getSync(pk): new crewMemberModel();

    item.ConvertFormToModel();
   
    self.putSync(item);

    registry.byId("CrewMemberForm").reset();
    CrewMemberDialog.hide();

    topic.publish("refreshGraph");
  },
});


crewMemberStore.on("add", function(event) {
  // 1 - inc pk sequence.
  crewMemberStore.nextPk = Math.max(event.target.pk + 1, crewMemberStore.nextPk);

  if( typeof(event.target.fk_yc) == 'undefined' ) {
    // 2 - create y coord object.
    var yCoordinate = yCoordStore.addSync({
      pk     : yCoordStore.GetNextPKSequence(),
      fk_cm  : event.target.pk,
      y      : yCoordStore.GetNextYCM(),
      height : MARGIN_TOP_CM + HEIGHT_LINE_CM + MARGIN_BOTTOM_CM,
    });

    // 3 - save foreign key of the Y coordinate object.
    event.target.fk_yc = yCoordinate.pk;
  }
});


crewMemberStore.on("update", function(event) {
  crewMemberStore.nextPk = Math.max(event.target.pk + 1, crewMemberStore.nextPk);

  var yCoordinate = yCoordStore.getSync(event.target.fk_yc); 

  var lineCount = Math.max(1, event.target.lineCount);

  yCoordinate.height = MARGIN_TOP_CM + HEIGHT_LINE_CM * lineCount + MARGIN_BOTTOM_CM; 

  yCoordStore.putSync(yCoordinate);      
});


crewMemberStore.on("delete", function(event) {
  // Remove 
  activityStore.filter({fk_cm: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length - 1; i >= 0; i--) {
      activityStore.removeSync(items[i].pk);
    }
  });

  // Remove coords that reference this distance.
  yCoordStore.filter({fk_cm: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length - 1; i >= 0; i--) {
      yCoordStore.removeSync(items[i].pk);
    }
  });
});


var crewMemberStoreAdapter = new DstoreAdapter(crewMemberStore);

registry.byId("DayOffCrewMemberSelect").set("store", crewMemberStoreAdapter);
registry.byId("TrainingCrewMemberSelect").set("store", crewMemberStoreAdapter);
registry.byId("TripCrewMemberSelect").set("store", crewMemberStoreAdapter);
registry.byId("VacationCrewMemberSelect").set("store", crewMemberStoreAdapter);
registry.byId("ReserveCrewMemberSelect").set("store", crewMemberStoreAdapter);


//
//
//  /\   _ _|_ o    o _|_    
// /--\ (_  |_ | \/ |  |_ \/ 
//                        /  
//
//
var activityModel = declare(Model, {
  validateOnSet      : false,
  schema             : {
    pk                 : "numeric",
    fk_cm              : "numeric", // foreign key to CrewMember.
    fk_parent          : "numeric", // foreign key to parent activity.
    name               : "string",
    fullName           : "string",
    x                  : "numeric",
    xRefUTC            : "numeric",
    duration           : "numeric",
    midnightOffset     : "boolean",
    transportationTime : "boolean",
    restBefore         : "numeric",
    restAfter          : "numeric",
    type               : "string", // main type of activity TRP, TRN, RSV, LVE
    activityType       : "string",  // for RSV, could be ASBY, HSBY, etc...
    lbtStart           : "string",
    lbtEnd             : "string",
    utcStart           : "string",
    utcEnd             : "string",
    block              : "numeric",
    credit             : "numeric",
    duty               : "numeric",
    tafbInPeriod       : "numeric",
    blockInPeriod      : "numeric",
    creditInPeriod     : "numeric",
    dutyInPeriod       : "numeric",
    station            : "string",
    lineNb             : "numeric",
    ident          : new ComputedProperty({
      dependsOn    : ["pk", "type"],
      getValue     : function(pk, type) {
        return type.toLowerCase() + pk;  // DOxxx or TRPxxx or  .. 
      }
    }),
  },
  DrawSVG : function() { 
    var self = this;

    if( typeof(this.fk_parent) == "undefined" ) {
      SVG_drawActivity(self);
    }
  },
  GetYCoord : function() {
    var self = this;

    return self.fk_cm ? crewMemberStore.getSync(self.fk_cm).GetYCoord() : yCoordStore.nextY;
  },
  GetCrewMember : function() {
    var self = this;

    return self.fk_cm ? crewMemberStore.getSync(self.fk_cm) : undefined;
  },

  GetCrewMemberIdent : function() {
    var self = this;

    return self.fk_cm ? crewMemberStore.getSync(self.fk_cm).get("ident") : "opentime"; 
  },
  CreateEvents : function() {
    var self = this;

    var x = self.x; 
    if( self.midnightOffset ) x += config.midnightOffset;
    var tp = self.transportationTime ? config.transportationTime : 0;
    if( self.restBefore > 0 && !eventStore.RetrieveActivityEvent(-1, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -1,
        long_label : "Rest before activity start",
        fk_act : self.pk,
        order: 1,
      });
    }
    if( self.transportationTime && !eventStore.RetrieveActivityEvent(-2, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -2,
        long_label : "Transportation time before activity start",
        fk_act : self.pk,
        order: 2,
      });
    }

    if( !eventStore.RetrieveActivityEvent(-3, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -3,
        long_label : "Activity start",
        fk_act : self.pk,
        start : 1,
        order: 3,
      });
    }
 
    var iOrder = 100; 

    activityStore.filter({fk_parent: self.pk}).sort('x').fetch().then(function(objects) {
      for(i = 0; i < objects.length; i++) {
        var event = eventStore.RetrieveActivityEvent(-10, self.pk,  objects[i].pk);
        if( !event ) {  
          event = new eventModel();

          event.pk            = eventStore.GetNextPKSequence();
          event.x             = -10;
          event.fk_act        = self.pk;
          event.fk_act_detail = objects[i].pk;
        }
        event.order         = iOrder++;
        event.long_label    = objects[i].fullname + " start";

        eventStore.putSync(event);  
      }
    });

           
    if( !eventStore.RetrieveActivityEvent(-4, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -4,
        long_label : "Activity end",
        fk_act : self.pk,
        order: 100001,
      });
    }
    if( self.transportationTime && !eventStore.RetrieveActivityEvent(-5, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -5,
        long_label : "Transportation time after activity end",
        fk_act : self.pk,
        order: 100002,
      });
    }
    if( self.restAfter > 0 && !eventStore.RetrieveActivityEvent(-6, self.pk) ) {
      eventStore.addSync({
        pk : eventStore.GetNextPKSequence(),
        x  : -6,
        long_label : "Rest after activity end",
        fk_act : self.pk,
        order: 100003,
      });
    }
  },          

  ConvertModelToForm : function () {
    var self = this;
    var copy = Object.create(self);

    if( copy.type == RESERVE ) {
      var start = new Date(copy.lbtStart);

      copy.set({
        start_date: start,
        start_time: start,
        rest_before_hour: parseInt(copy.restBefore / 60),
        rest_before_minute: copy.restBefore % 60,
        rest_after_hour: parseInt(copy.restAfter / 60),
        rest_after_minute: copy.restAfter % 60,
        duration_hour: parseInt(copy.duration / 60),
        duration_minute: copy.duration % 60,
      });
      if( copy.transportationTime ){
        copy.transportationTime = "true";
      }
      registry.byId('ReserveForm').set('value', copy);
    }
    else if( copy.type == TRAINING ) {
      var start =  new Date(copy.lbtStart);

      copy.set({
        start_date: start,
        start_time: start,
        rest_before_hour: parseInt(copy.restBefore / 60),
        rest_before_minute: copy.restBefore % 60,
        rest_after_hour: parseInt(copy.restAfter / 60),
        rest_after_minute: copy.restAfter % 60,
        duration_hour: parseInt(copy.duration / 60),
        duration_minute: copy.duration % 60,
      });
      if( copy.transportationTime ){
        copy.transportationTime = "true";
      }
      registry.byId('TrainingForm').set('value', copy);
    }
    else if( copy.type == LEAVE ) {
      copy.set({
        start_date: new Date(copy.lbtStart),
        end_date: new Date(copy.lbtEnd),
      });
      registry.byId('VacationForm').set('value', copy);
    }
    else if( copy.type == TRIP ) {
      var start = new Date(copy.lbtStart);

      copy.set({
        start_date: start,
        start_time: start,
        rest_before_hour: parseInt(copy.restBefore / 60),
        rest_before_minute: copy.restBefore % 60,
        rest_after_hour: parseInt(copy.restAfter / 60),
        rest_after_minute: copy.restAfter % 60,
        duration_hour: parseInt(copy.duration / 60),
        duration_minute: copy.duration % 60,
      });
      if( copy.transportationTime ){
        copy.transportationTime = "true";
      }

      activityStore.filter({fk_parent: copy.pk}).forEach(function(item) {
        var detail = new TripDetailModel();

        detail.pk    = item.pk;
        detail.order = item.x; 
        detail.type  = item.type.substring(0,3).toLowerCase();
        detail.dhour = parseInt(item.duration / 60);
        detail.dminute = item.duration % 60;
        if( detail.type == "sta" ) {
          detail.station = item.station;
        } 
        else { // that's a leg.
          detail.legType = item.type.substring(3,4);
        }

        tripDetailStore.addSync(detail);
      });

      registry.byId('TripForm').set('value', copy);
    }
  },
  ConvertFormToModel : function (type) {
    var self = this;

    if( type == "Training" ){
      self.ConvertTrainingFormToModel();
    }
    else if( type == "Reserve"){
      self.ConvertReserveFormToModel();
    }
    else if( type == "Trip"){
      self.ConvertTripFormToModel();
    }
    else if( type == "Vacation" ){
      self.ConvertVacationFormToModel();
    }
    else {
      alert(type + " is not yet implemented.");
    }
  },

  ConvertTrainingFormToModel : function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.type = TRAINING;
      self.pk = activityStore.GetNextPKSequence();
    }

    var formObject = domForm.toObject("TrainingForm");

    self.name = formObject.name;         

    var fk_cm = Number(formObject.fk_cm);

    self.fk_cm = fk_cm;
    self.midnightOffset = false;
    self.transportationTime = formObject.transportationTime == "true";

    var duration = Number(formObject.duration_hour) * 60 + Number(formObject.duration_minute);

    self.duration   = duration;
    self.restBefore = Number(formObject.rest_before_hour) * 60 + Number(formObject.rest_before_minute);
    self.restAfter  = Number(formObject.rest_after_hour) * 60 + Number(formObject.rest_after_minute);

    var startDateTimeTraining  = moment.tz(formObject.start_date + formObject.start_time, config.CalendarTimezoneName);
    var endDateTimeTraining    = startDateTimeTraining.clone().add(self.duration, 'm');

    self.lbtStart = startDateTimeTraining.format("YYYY-MM-DD HH:mm");
    self.lbtEnd   = endDateTimeTraining.format("YYYY-MM-DD HH:mm");
    self.utcStart = startDateTimeTraining.utc().format("YYYY-MM-DD HH:mm");
    self.utcEnd   = endDateTimeTraining.utc().format("YYYY-MM-DD HH:mm");
    self.x        = getPositionX(startDateTimeTraining);

    var fullName = fk_cm ? crewMemberStore.getSync(fk_cm).name : "Open time";
    fullName += " -- " + self.lbtStart + " -- " + self.name;

    self.fullName = fullName;
    self.SetLineNb();
  },

  ConvertReserveFormToModel : function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.type = RESERVE;
      self.pk = activityStore.GetNextPKSequence();
    }

    var formObject = domForm.toObject("ReserveForm");

    self.name         = formObject.activityType;         
    self.activityType = formObject.activityType;

    var fk_cm = Number(formObject.fk_cm);

    self.fk_cm = fk_cm;
    self.midnightOffset = false;
    self.transportationTime = formObject.transportationTime == "true";


    var duration = Number(formObject.duration_hour) * 60 + Number(formObject.duration_minute);

    self.duration   = duration;
    self.restBefore = Number(formObject.rest_before_hour) * 60 + Number(formObject.rest_before_minute);
    self.restAfter  = Number(formObject.rest_after_hour) * 60 + Number(formObject.rest_after_minute);

    var startDateTimeReserve  = moment.tz(formObject.start_date + formObject.start_time, config.CalendarTimezoneName);
    var endDateTimeReserve    = startDateTimeReserve.clone().add(self.duration, 'm');


    self.lbtStart = startDateTimeReserve.format("YYYY-MM-DD HH:mm");
    self.lbtEnd   = endDateTimeReserve.format("YYYY-MM-DD HH:mm");
    self.utcStart = startDateTimeReserve.utc().format("YYYY-MM-DD HH:mm");
    self.utcEnd   = endDateTimeReserve.utc().format("YYYY-MM-DD HH:mm");
    self.x        = getPositionX(startDateTimeReserve);

    var fullName = fk_cm ? crewMemberStore.getSync(fk_cm).name : "Open time";
    fullName += " -- " + self.lbtStart + " -- " + self.name;

    self.fullName = fullName;
    self.SetLineNb();
  },

  ConvertVacationFormToModel : function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.type = LEAVE;
      self.pk = activityStore.GetNextPKSequence();
    }

    var formObject = domForm.toObject("VacationForm");

    self.name         = formObject.activityType;
    self.activityType = formObject.activityType;

    self.fk_cm = Number(formObject.fk_cm);

    self.midnightOffset = true;
    self.transportationTime = false;
    self.restBefore = 0;
    self.restAfter  = 0;

    var startDate  = moment.tz(formObject.start_date, config.CalendarTimezoneName);
    var endDate    = moment.tz(formObject.end_date, config.CalendarTimezoneName);

    self.lbtStart = startDate.format("YYYY-MM-DD HH:mm");
    self.lbtEnd   = endDate.format("YYYY-MM-DD HH:mm");
    self.utcStart = startDate.utc().format("YYYY-MM-DD HH:mm");
    self.utcEnd   = endDate.utc().format("YYYY-MM-DD HH:mm");
    self.duration = endDate.diff(startDate, "minutes");
    self.x        = getPositionX(startDate);
    self.fullName = crewMemberStore.getSync(self.fk_cm).name + " -- " + self.lbtStart.substring(0, 10) + " -- " + self.name;

    self.SetLineNb();
  },

  ConvertTripFormToModel : function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.type = TRIP;
      self.pk = activityStore.GetNextPKSequence();
    }

    var formObject = domForm.toObject("TripForm");

    self.name = formObject.name;         

    var fk_cm = Number(formObject.fk_cm);

    self.fk_cm              = fk_cm;
    self.midnightOffset     = false;
    self.transportationTime = formObject.transportationTime == "true";
    self.restBefore         = Number(formObject.rest_before_hour) * 60 + Number(formObject.rest_before_minute);
    self.restAfter          = Number(formObject.rest_after_hour) * 60 + Number(formObject.rest_after_minute);

    var startDateTimeTrip = moment.tz(formObject.start_date + formObject.start_time, config.CalendarTimezoneName);

    self.lbtStart = startDateTimeTrip.format("YYYY-MM-DD HH:mm");
    self.x        = getPositionX(startDateTimeTrip);

    var fullName = fk_cm ? crewMemberStore.getSync(fk_cm).name : "Open time";
    fullName += " -- " + self.lbtStart + " -- " + self.name;

    self.fullName = fullName;

    var xDetail        = self.x;
    var credit         = 0;
    var block          = 0;
    var duty           = 0;
    var creditInPeriod = 0;
    var blockInPeriod  = 0;
    var dutyInPeriod   = 0;


    tripDetailStore.sort('order').fetch().then(function(items) {
      for (var i = 0; i < items.length ; i++) {
        var width = Number(items[i].dhour * 60) + Number(items[i].dminute);
        var inPeriod = getInPeriod(xDetail, width);
        var type = items[i].type;
        if( type == "leg" ) {
          type += items[i].legType;
          if( items[i].legType == "A" ) {
            credit         += width;
            creditInPeriod += inPeriod;
          }
          block         += width;
          blockInPeriod += inPeriod;
        }
        if( type != "lay" ) {
          duty         += width;
          dutyInPeriod += inPeriod;
        } 

        xDetail += width;
      }           
    });

    self.duration = xDetail - self.x;

    var endDateTimeTrip = startDateTimeTrip.clone().add(self.duration, 'm');

    self.lbtEnd         = endDateTimeTrip.format("YYYY-MM-DD HH:mm");
    // computation on startDateTimeTrip should be done before using utc()....
    self.utcStart       = startDateTimeTrip.utc().format("YYYY-MM-DD HH:mm");
    self.utcEnd         = endDateTimeTrip.utc().format("YYYY-MM-DD HH:mm");
    self.block          = block;
    self.credit         = credit;
    self.duty           = duty;
    self.tafbInPeriod   = getInPeriod(self.x, self.duration);
    self.blockInPeriod  = blockInPeriod;
    self.creditInPeriod = creditInPeriod;
    self.dutyInPeriod   = dutyInPeriod;

    self.xRefUTC = getPositionX(moment.tz(self.utcStart.substring(0, 10), "UTC"));

    self.SetLineNb();
  },
  SaveDetails : function(fEdit){
    var self = this; // current trip.
    var xDetail = self.x;

    var arrPkDetail = [];

    activityStore.filter({fk_parent: self.pk}).forEach(function(item) {
      arrPkDetail.push(item.pk);
    });
    tripDetailStore.sort('order').fetch().then(function(items) {
      var iLeg = 0;
      var iLay = 0;
      var name, fullname, width, type;
      for (var i = 0; i < items.length ; i++) {
        width = Number(items[i].dhour * 60) + Number(items[i].dminute);
        type = items[i].type;
        if( type == "leg" ) {
          type += items[i].legType;
          iLeg += 1;
          name = items[i].lblType + iLeg;
          fullname = items[i].lblType + " " + iLeg;
          if( items[i].legType == "D" ) {
            fullname += " (D)";
          }
          fullname += " from " + items[i - 1].station + " to " + items[i + 1].station;
        }
        else {
          if( type == "lay" ) {
            iLay += 1;
            name = items[i].lblType + iLay;
            fullname = items[i].lblType + " " + iLay + " at " + items[i - 1].station;
          }
          else {
            name = "n/a";
            fullname = items[i].lblType + " " + items[i].station;
          }
        }

        var item = fEdit ? activityStore.RetrieveDetailActivity(self.pk, items[i].pk) : new activityModel();
        if( !item) { 
          // it is possible that RetrieveDetailActivity return an undefined object, when a new detail is added
          // in edit mode.
          item = new activityModel();
        }
        if( !item.pk ) {
          item = new activityModel();
            
          item.pk        = activityStore.GetNextPKSequence();
          item.fk_parent = self.pk;
          item.fk_cm     = self.fk_cm;
        }

        item.name      = name;
        item.fullname  = fullname;
        item.type      = type.toUpperCase();
        item.x         = xDetail;
        item.duration  = width;
        item.station   = items[i].station;

        activityStore.putSync(item);

        // find pk detail in original list and remove it.
        var index = arrPkDetail.indexOf(item.pk);
        if( index >= 0 ) {
          arrPkDetail.splice(index, 1);
        }

        xDetail += width;
      }           
    });

    // delete details no more relevant.
    for(var i = arrPkDetail.length - 1; i >= 0; i--) {
      activityStore.removeSync(arrPkDetail[i]);
    }
  },
  InitDayOff : function(fk_cm, day, type) {
  // this form is not working in edition, only creation.
    var self = this;

    var calendarDay = calendarStore.getSync(day); 

    self.type               = DAY_OFF;
    self.activityType       = type; 
    self.name               = type;
    self.pk                 = activityStore.GetNextPKSequence();
    self.fk_cm              = fk_cm;
    self.midnightOffset     = true;
    self.transportationTime = false;
    self.restBefore         = 0;
    self.restAfter          = 0;
    self.duration           = calendarDay.width;
    self.x                  = calendarDay.x;

    var startDate  = moment.tz(calendarDay.name, config.CalendarTimezoneName);
    var endDate    = startDate.clone().add(self.duration, 'm');

    self.lbtStart = startDate.format("YYYY-MM-DD HH:mm");
    self.lbtEnd   = endDate.format("YYYY-MM-DD HH:mm");
    self.utcStart = startDate.utc().format("YYYY-MM-DD HH:mm");
    self.utcEnd   = endDate.utc().format("YYYY-MM-DD HH:mm");
    self.fullName = crewMemberStore.getSync(self.fk_cm).name + " -- " + calendarDay.name + " -- " + self.name;

    self.SetLineNb();
  },


  /* 
  * Determine if the new activity is overlapping with other activities
  * related to a specific crewmember. If there is a collision, then
  * the new activity will be assigned a new line. 
  * @param crewMemberPk crew member primary key. if 0, that's opentime.
  * @param x            new activity starting datetime.
  * @param width        new activity length.
  * @param pk           
  * @return The line number where the new activity will be drawn.
  */
  SetLineNb: function() {
    var self = this;

    var fIsNew = self.lineNb ? false : true;

    // Due to duplicate option, this give the chance when the duplicated activity is modified to 
    // draw it on the first line, if there is no overlap with another activity
    // var lineNb = fIsNew ? 1 : self.lineNb;
    var lineNb = 1;

    activityStore.filter({fk_cm: self.fk_cm}).sort('lineNb').fetch().then( function(items) {
      for(var i = 0; i < items.length; i++) {
        if( items[i].pk != self.pk && !items[i].fk_parent ) {
          if( !fIsNew && items[i].lineNb > lineNb ) {
            break; 
          }

          var A = self.x;
          if( self.midnightOffset ) {
            A += Number(config.midnightOffset);
          }
          var B = A + self.duration;

          var C = items[i].x;
          if( items[i].midnightOffset ) {
            C += Number(config.midnightOffset);
          }
          var D = C + items[i].duration;

          if( !(( B <= C ) || ( A >= D ))) { // detect an intersection.   
            lineNb = items[i].lineNb + 1;
          }
        }
      }
    });


    // Est ce que je dois trouver le plus grand des lineNb qui ne soit pas 
    // l'activite courante pour mettre le nombre de lineCount du crew ?

    if ( self.fk_cm ) { // a true crewMember.
      var cm = crewMemberStore.getSync(self.fk_cm);
      if( cm.lineCount < lineNb ) {
        cm.lineCount = lineNb;
        crewMemberStore.putSync(cm);
      }
    }
    else { // opentime
      if( OpenTimeLineCount < lineNb ) {    
        OpenTimeLineCount = lineNb;          
      }  
    }

    self.lineNb = lineNb;
  },
});


var activityStore = new TrackableMemory({
  Model             : activityModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "ActivityStore",
  svgItemNodeName   : "activity",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset           : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  SaveOrUpdate : function(type) {
    var self = this;

    if( !registry.byId(type + "Form").validate() ) {
      return;
    }
    registry.byId(type + "Dialog").hide();

    var pk = Number(registry.byId(type + "Pk").get("value"));

    var item = pk ? activityStore.getSync(pk): new activityModel();

    item.ConvertFormToModel(type);

    self.putSync(item);

    if( type == "Trip" ) {
      var fEdit = pk ? true : false; 
      item.SaveDetails(fEdit);
    }

    item.CreateEvents();

    topic.publish("refreshGraph");
  },
  RetrieveDetailActivity : function(pk_activity, pk_detail_activity) {
    var self = this;

    var filter           = new self.Filter();
    var activityStoreFilter = filter.eq('pk', pk_detail_activity).eq('fk_parent', pk_activity);
    var detail; 

    self.filter(activityStoreFilter).fetch().then(function(items) {
      if( items.length == 1 ) {
        detail = items[0]; 
      }
    });
    return detail;
  },
});

activityStore.on("add", function(event) {
  activityStore.nextPk = Math.max(event.target.pk + 1, activityStore.nextPk); 
  if( event.target.fk_cm == 0 ) {
    if( typeof(event.target.lineNb) != 'undefined') {
      OpenTimeLineCount = Math.max(event.target.lineNb, OpenTimeLineCount);
    }
  }
});


activityStore.on("update", function(event) {
  activityStore.nextPk = Math.max(event.target.pk + 1, activityStore.nextPk); 

  var cmRef = event.target.fk_cm;

  var iMax = 0;
  activityStore.filter({fk_cm: cmRef, fk_parent: undefined}).sort('lineNb').forEach( function(item) {
    iMax = item.lineNb;
  });

  if( cmRef ) {
    var cm = crewMemberStore.getSync(event.target.fk_cm);
    cm.lineCount = iMax;
    crewMemberStore.putSync(cm);
  }
  else {
    OpenTimeLineCount = iMax;
  }
});


activityStore.on("delete", function(event) {
  activityStore.filter({lineNb: event.target.lineNb}).fetch().then( function(items) {
    if( items.length == 0 ) {
      var filter = new activityStore.Filter();
      var activityStoreFilter = filter.eq('fk_cm', event.target.fk_cm).gt('lineNb', event.target.lineNb);

      activityStore.filter(activityStoreFilter).forEach( function(item) {
        item.lineNb -= 1;
      });

      if( event.target.fk_cm) {
        var cm = crewMemberStore.getSync(event.target.fk_cm);
   
        if( cm.lineCount > 1 ) {
          cm.lineCount -= 1;
          crewMemberStore.putSync(cm);
        }
      }
      else {
        OpenTimeLineCount -= 1;
      }
    }
  });

  // Remove distance that reference this activity.
  distanceStore.filter({fk_actFrom: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length -1; i >= 0; i-- ) {
      distanceStore.removeSync(items[i].pk);
    }
  });
  distanceStore.filter({fk_actTo: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length -1; i >= 0; i-- ) {
      distanceStore.removeSync(items[i].pk);
    }
  });
  eventStore.filter({fk_act: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length -1; i >= 0; i-- ) {
      eventStore.removeSync(items[i].pk);
    }
  }); 

  // Remove details (legs, layovers and stations) in case of trip.
  activityStore.filter({fk_parent: event.target.pk}).fetch().then( function(items) {
    for( var i = items.length -1; i >= 0; i-- ) {
      activityStore.removeSync(items[i].pk);
    }
  });

  yCoordStore.ComputeYAndHeigth();
});


var activityStoreAdapter = new DstoreAdapter(activityStore.filter({fk_parent: undefined}));

registry.byId("DistanceFromActSelect").set("labelAttr", "fullName");
registry.byId("DistanceFromActSelect").set("searchAttr", "fullName");
registry.byId("DistanceFromActSelect").set("store", activityStoreAdapter);
registry.byId("DistanceToActSelect").set("labelAttr", "fullName");
registry.byId("DistanceToActSelect").set("searchAttr", "fullName");
registry.byId("DistanceToActSelect").set("store", activityStoreAdapter);


//     
//  _                          
// | \ o  _ _|_  _. ._   _  _  
// |_/ | _>  |_ (_| | | (_ (/_ 
//                              
//
var distanceModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    pk         : "numeric",
    fk_actFrom : "numeric",
    fk_evtFrom : "numeric",
    fk_actTo   : "numeric",
    fk_evtTo   : "numeric",
    fk_yc      : "numeric",
    ident      : new ComputedProperty({
      dependsOn : ["pk"],
      getValue: function(pk) {
        return "dst" + pk;  // dst stands for distance
      }
    }),
  },
  DrawSVG       : function() {
    var self = this;

    SVG_drawDistance(self); 
  },
  GetYCoord     : function() {
    var self = this;

    return yCoordStore.getSync(self.fk_yc).y;
  },
  GetActFrom    : function() {
    var self = this;

    return activityStore.getSync(self.fk_actFrom);
  },
  GetActTo      : function() {
    var self = this;

    return activityStore.getSync(self.fk_actTo);
  },
  GetEventFrom  : function() {          
    var self = this;

    return eventStore.getSync(self.fk_evtFrom);
  },
  GetEventTo    : function() {          
    var self = this;

    return eventStore.getSync(self.fk_evtTo);
  },
  ConvertModelToForm : function() {

  },

  ConvertFormToModel : function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.pk = distanceStore.GetNextPKSequence();
    }
    else {
      yCoordStore.removeSync(self.fk_yc);
    }

    var yFrom = 0;
    var yTo   = 0;

    if( registry.byId("DistanceFromActivity").selected ) {
      self.fk_actFrom = registry.byId("DistanceFromActSelect").value;
      self.fk_evtFrom = registry.byId("DistanceFromActEventSelect").value;
      yFrom = activityStore.getSync(registry.byId("DistanceFromActSelect").value).GetYCoord();
    }
    else {
      self.fk_evtFrom = registry.byId("DistanceFromEventSelect").value;
    }
    if( registry.byId("DistanceToActivity").selected ) {
      self.fk_actTo = registry.byId("DistanceToActSelect").value;
      self.fk_evtTo = registry.byId("DistanceToActEventSelect").value;
      yTo = activityStore.getSync(registry.byId("DistanceToActSelect").value).GetYCoord();
    }
    else {
      self.fk_evtTo = registry.byId("DistanceToEventSelect").value;
    }

    // Add the new entry in the y coord store.
    var yCoord = yCoordStore.addSync({
      pk     : yCoordStore.GetNextPKSequence(),
      y      : Math.min(yFrom, yTo) - 1,
      height : HEIGHT_LINE_HL,
    });

    self.fk_yc = yCoord.pk;
  },
  ConvertModelToForm : function() {
    var self       = this;
    var fEmitEvent = false;

    registry.byId("DistancePk").set("value", self.pk);
    if( self.fk_actFrom ) {

      registry.byId("DistanceFromTabContainer").selectChild(registry.byId("DistanceFromActivity"));
      registry.byId("DistanceFromActSelect").set("value", self.fk_actFrom, fEmitEvent);
      UpdateEvent(self.fk_actFrom, "DistanceFromActEventSelect", self.fk_evtFrom);
    }
    else {
      registry.byId("DistanceFromTabContainer").selectChild(registry.byId("DistanceFromEvent"));
      registry.byId("DistanceFromEventSelect").set("value", self.fk_evtFrom);
    }
    if( self.fk_actTo ) {
      registry.byId("DistanceToTabContainer").selectChild(registry.byId("DistanceToActivity"));
      registry.byId("DistanceToActSelect").set("value", self.fk_actTo, fEmitEvent);
      UpdateEvent(self.fk_actTo, "DistanceToActEventSelect", self.fk_evtTo);
    }
    else {
      registry.byId("DistanceToTabContainer").selectChild(registry.byId("DistanceToEvent"));
      registry.byId("DistanceToEventSelect").set("value", self.fk_evtTo);
    }
  },

});


var distanceStore = new Memory({
  Model             : distanceModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "DistanceStore",
  svgItemNodeName   : "distance",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  SaveOrUpdate : function() {
    var self = this;

    var pk = Number(registry.byId("DistancePk").get("value"));

    var item = pk ? self.getSync(pk): new distanceModel();

    item.ConvertFormToModel();
   
    self.putSync(item);

    registry.byId("DistanceForm").reset();
    DistanceDialog.hide();

    topic.publish("refreshGraph");
  },
});


distanceStore.on("add", function(event) {
  distanceStore.nextPk += 1;
});


distanceStore.on("update", function(event) {
  distanceStore.nextPk = Math.max(event.target.pk + 1, distanceStore.nextPk);
});


distanceStore.on("delete", function(event) {
  // Remove coords that reference this distance.
  yCoordStore.removeSync(event.target.fk_yc);
});


//
//  _               
// |_     _  ._ _|_ 
// |_ \/ (/_ | | |_ 
//                   
//
var eventModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    pk            : "numeric",
    x             : "numeric", // for activity, negative value.
    long_label    : "string",
    label         : "string",
    fk_act        : "numeric", // 0 means no activity.
    fk_act_detail : "numeric", // 0 means no activity detail.
    fk_yc         : "numeric",
    order         : "numeric",
    thickness     : { type: "numeric", default: 1, },
    color         : { type: "string", default: "#ff0000", }, 
    ident         : new ComputedProperty({
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "evt" + pk;  // evt stands for Event
      }
    }),
    barident      : new ComputedProperty({ 
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "bevt" + pk;  // bevt stands for Bar Event
      }
    }),
  },
  DrawSVG       : function() { 
    var self = this;

    if( typeof(self.fk_act) == 'undefined' ){
      SVG_drawEvent(self); 
    }
  },
  GetYCoord     : function() {
    var self = this;

    return yCoordStore.getSync(self.fk_yc).y;
  },
  GetX : function() {
    var self = this;
    if( typeof(self.fk_act) == 'undefined' ){
    // if( self.x >= 0 ) {
      return self.x;
    }
    var activity = activityStore.getSync(self.fk_act);
    var tp       = activity.transportationTime ? Number(config.transportationTime) : 0;
    var x        = activity.x;
    x += activity.midnightOffset ? Number(config.midnightOffset) : 0;
    if( self.x == -1 ) return x - tp - activity.restBefore;
    if( self.x == -2 ) return x - tp;
    if( self.x == -3 ) return x;
    if( self.x == -4 ) return x + activity.duration;
    if( self.x == -5 ) return x + activity.duration + tp;
    if( self.x == -6 ) return x + activity.duration + tp + activity.restAfter;

    if( self.x == -10 ) { // that means a activity detail.
      x = activityStore.getSync(self.fk_act_detail).x;
      x += activity.midnightOffset ? Number(config.midnightOffset) : 0;
      return x;
    }
    alert("GetX - should never pass here.");
    return 0;
  }
});

var eventStore = new TrackableMemory({
  Model             : eventModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "EventStore",
  svgItemNodeName   : "event",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset           : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  RetrieveActivityEvent : function(x, pk_activity, pk_detail_activity) {
    var self = this;

    if( x >= 0 ) {
      alert("Bad usage of eventStore.RetrieveEvent() function.");
    }
    var filter           = new self.Filter();
    var eventStoreFilter = pk_detail_activity ?  filter.eq('fk_act', pk_activity).eq('x', x).eq('fk_act_detail', pk_detail_activity) : filter.eq('fk_act', pk_activity).eq('x', x);
    var event; 

    self.filter(eventStoreFilter).fetch().then(function(items) {
      if( items.length == 1 ) {
        event = items[0]; 
      }
      else if( items.length > 1 ) {
        alert("There is duplicate event....");
      }
    });
    return event;
  },
  SaveOrUpdate: function(type) {
    var self = this;

    if( !registry.byId("EventForm").validate() ) {
      return;
    }
    registry.byId("EventDialog").hide();

    var pk = Number(registry.byId("EventPk").get("value"));

    var item = pk ? self.getSync(pk): new eventModel();

    var label     = registry.byId("EventLabel").get("value");
    var days      = registry.byId("EventDatesSelect").value; 
    var time      = registry.byId("EventTime").value; 
    var color     = registry.byId("EventColorPaletteWidget").get("value");
    var thickness = registry.byId("EventThickness").get("value");

    // to avoid the "at least one item must be selected" message, form data are save in 
    // local variables before reseting the form.
    registry.byId("EventForm").reset();

    if( !item.pk ) { // create
      var yCoordinate = yCoordStore.addSync({
        pk     : yCoordStore.GetNextPKSequence(),
        y      : -1,
        height : HEIGHT_LINE_HL,
      });


      for(i = 0; i < days.length; i++) {
        var calDay = calendarStore.getSync(days[i]);

        var when = moment.tz(calDay.get("name"), config.CalendarTimezoneName);
        when.hour(time.getHours());
        when.minute(time.getMinutes());

        if( when.isValid() ) {   
          self.addSync({
            pk          : self.GetNextPKSequence(),
            label       : label,
            long_label  : when.format("YYYY-MM-DD HH:mm") + " -- " + label, 
            x           : getPositionX(when),
            fk_yc       : yCoordinate.pk,
            color       : color,
            thickness   : thickness,
          });
        }
      }
    }
    else { // update
      self.filter({fk_yc: item.fk_yc}).fetch().then( function(items) {
        for( var i = 0; i < items.length ; i++ ) {
          var pk_calendar = calendarStore.GetPkFromX(items[i].x);             
          var index = days.indexOf(pk_calendar);
          if( index == -1 ) {
            self.removeSync(items[i].pk);
          }
          else {
            var calDay = calendarStore.getSync(pk_calendar);

            var when = moment.tz(calDay.get("name"), config.CalendarTimezoneName);
            when.hour(time.getHours());
            when.minute(time.getMinutes());

            if( when.isValid() ) {
              items[i].label = label;
              items[i].long_label = when.format("YYYY-MM-DD HH:mm") + " -- " + label;
              items[i].x = getPositionX(when);
              items[i].color = color;
              items[i].thickness = thickness;

              self.putSync(items[i]);
              days.splice(index, 1);
            }
          }
        }
        for(i = 0; i < days.length; i++) {
          var calDay = calendarStore.getSync(days[i]);

          var when = moment.tz(calDay.get("name"), config.CalendarTimezoneName);
          when.hour(time.getHours());
          when.minute(time.getMinutes());

          if( when.isValid() ) {   
            self.addSync({
              pk          : self.GetNextPKSequence(),
              label       : label,
              long_label  : when.format("YYYY-MM-DD HH:mm") + " -- " + label, 
              x           : getPositionX(when),
              fk_yc       : item.fk_yc,
              color       : color,
              thickness   : thickness,
            });
          }
        }
      });
    }
    topic.publish("refreshGraph");
  },
});


eventStore.on("add", function(event) {
  // 1 - increment primary key sequence.
  eventStore.nextPk = Math.max(event.target.pk + 1, eventStore.nextPk); 

  // for recurent hl, there is only one yCoord object, created before the creation
  // of each recurent hl. So there is no need for the following.
  if( typeof(event.target.fk_yc) == 'undefined' && typeof(event.target.fk_act) == 'undefined'){
    // 3 - create y coord object.
    var yCoordinate = yCoordStore.addSync({
      pk     : yCoordStore.GetNextPKSequence(),
      fk_hl  : event.target.pk,
      y      : 0,
      height : HEIGHT_LINE_HL,
    });

    // 4 - save coordinate primary key into event object.
    event.target.fk_yc = yCoordinate.pk;
  }


});


eventStore.on("update", function(event) {
  eventStore.nextPk = Math.max(event.target.pk + 1, eventStore.nextPk); 
});


eventStore.on("delete", function(event) {
  // If there is no more event on the same yCoordStore, then it can be deleted.
  eventStore.filter({fk_yc: event.target.fk_yc}).fetch().then( function(items) {
    if( items.length == 0 ) {
      yCoordStore.removeSync(event.target.fk_yc);
    }
  });
});


var eventStoreAdapter = new DstoreAdapter(eventStore.filter({fk_act: undefined}));
var eventActivityStoreAdapter = new DstoreAdapter(eventStore.filter({fk_yc: undefined}).sort('order'));

registry.byId("DistanceFromActEventSelect").set("labelAttr", "long_label");
registry.byId("DistanceFromActEventSelect").set("store", eventActivityStoreAdapter);
registry.byId("DistanceToActEventSelect").set("labelAttr", "long_label");
registry.byId("DistanceToActEventSelect").set("store", eventActivityStoreAdapter);

registry.byId("DistanceFromEventSelect").set("labelAttr", "long_label");
registry.byId("DistanceFromEventSelect").set("store", eventStoreAdapter);
registry.byId("DistanceToEventSelect").set("labelAttr", "long_label");
registry.byId("DistanceToEventSelect").set("store", eventStoreAdapter);


//     
//                 
//       |\ |  _ _|_  _  
//       | \| (_) |_ (/_ 
//                        
//
var noteModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    pk     : "numeric",
    x      : "numeric",
    y      : "numeric",
    note   : "string",
    color  : "string",
    fk_evt : "numeric",
    ident  : new ComputedProperty({
      dependsOn : ["pk"],
      getValue  : function(pk) {
        return "note" + pk;  // evt stands for Event
      }
    }),

  },
  DrawSVG       : function() { 
    var self = this;

    SVG_drawNote(self); 
  },
  ConvertFormToModel: function() {
    var self = this;

    if( typeof(self.pk) == 'undefined' ) {
      self.pk = noteStore.GetNextPKSequence();
      self.x = 0;
      self.y = 0;
    }

    self.note  = registry.byId("NoteEditor").get("value");
    self.color = registry.byId("NoteColorPaletteWidget").get("value");
  },

});


var noteStore = new TrackableMemory({
  Model             : noteModel,
  idProperty        : "pk",
  nextPk            : 1,
  svgId             : "NoteStore",
  svgItemNodeName   : "note",
  GetNextPKSequence : function() {
    var self = this;

    return self.nextPk;
  },
  Reset : function () {
    var self = this;

    // 1 - empty svg store.
    dojo.query(self.svgId).forEach(dojo.empty);

    // 2 - empty store.
    self.fetch().then(function(items) {
      for( var i = items.length - 1; i >= 0; i-- ) {
        self.removeSync(items[i].pk);
      }           
    });

    // 3 - reset pk
    self.nextPk = 1;
  },
  SaveOrUpdate : function() {
    var self = this;

    if( !registry.byId("NoteForm").validate() ) {
      return;
    }

    var pk = Number(registry.byId("NotePk").get("value"));

    var item = pk ? self.getSync(pk): new noteModel();

    item.ConvertFormToModel();
    self.putSync(item);

    NoteDialog.hide();
    topic.publish("refreshGraph");
  },

});


noteStore.on("add", function(event) {
  noteStore.nextPk = Math.max(event.target.pk + 1, noteStore.nextPk); 
});


noteStore.on("update", function(event) {
  noteStore.nextPk = Math.max(event.target.pk + 1, noteStore.nextPk); 
});


noteStore.on("delete", function(event) {
});


//
//   ___                              
//    | ._ o ._     _|  _ _|_  _. o | 
//    | |  | |_)   (_| (/_ |_ (_| | | 
//           |                       
//
var TripDetailModel = declare(Model, {
  validateOnSet : false,
  schema        : {
    pk             : "numeric",
    order          : "numeric",
    type           : "string",
    station        : "string",
    legType        : "string",
    startDateTime  : "string",
    dhour          : "numeric",
    dminute        : "numeric",
    endDateTime    : "string",
    fk_activity    : "numeric",
    stationSelect  : "numeric",
    legTypeSelect  : "numeric",
    durationSelect : "numeric",
    newLegButton   : "numeric",
    newLayButton   : "numeric",
    deleteButton   : "numeric",
  },
});


var tripDetailStore = new TrackableMemory({
  Model           : TripDetailModel,
  idProperty      : "pk",
  len             : 0,
  nextPk          : 1,
  reportTime      : 20,
  releaseTime     : 15,
  startDateTime   : new moment(),

  _updDur         : function(array) {
    var self = this;

    var currentDate = moment.tz(self.startDateTime, config.CalendarTimezoneName);
    for( i = 0; i < array.length ; ++i ) {
      array[i].startDateTime = currentDate.format("YYYY-MM-DD HH:mm");
      currentDate.add(array[i].dminute, "m");
      currentDate.add(array[i].dhour  , "h");
      array[i].endDateTime = currentDate.format("YYYY-MM-DD HH:mm");
    }

    var endDate = new Date(currentDate.year(), currentDate.month(), currentDate.date(), currentDate.hour(), currentDate.minute());

    registry.byId("TripEndDate").set("value", endDate);
    registry.byId("TripEndTime").set("value", endDate);
  },
  updateDuration  : function() {
    var self = this; 
    // based on the assumption that the store will have a reasonable size,
    // there is no need to re 
    self.sort('order').fetch().then(function(objects) {
      self._updDur(objects);

      for( i = 0; i < objects.length ; ++i ) {
        self.putSync(objects[i]);
      }
    });
  },
  process         : function() {
    // based on the assumption that the store will have a reasonable size,
    // there is no need to re 
    var self = this; 

    self.sort('order').fetch().then(function(objects) {
      for( i = 0; i < objects.length ; ++i ) {
        objects[i].newLegButton   = 1;
        objects[i].newLayButton   = 1;
        objects[i].deleteButton   = 1;
        objects[i].stationSelect  = 1;
        objects[i].durationSelect = 1;
        objects[i].legTypeSelect  = 1;

        objects[i].order = i + 1;
      }

      for( i = 0; i < objects.length ; ++i ) {
        if( i == 0 ) { // first station
          objects[i].newLayButton   = 0;
          objects[i].deleteButton   = 0;
          objects[i].stationSelect  = 0;
          objects[i].durationSelect = 0;
          objects[i].legTypeSelect  = 0;

          objects[i].lblType        = "Report time";
          objects[i].dhour          = parseInt(self.reportTime / 60);
          objects[i].dminute        = self.reportTime % 60;
        } 
        else if( i == objects.length - 1) { // last station
          objects[i].newLegButton   = 0;
          objects[i].newLayButton   = 0;
          objects[i].deleteButton   = 0;
          objects[i].stationSelect  = 0;
          objects[i].durationSelect = 0;
          objects[i].legTypeSelect  = 0;

          objects[i].lblType        = "Release time";
          objects[i].dhour          = parseInt(self.releaseTime / 60);
          objects[i].dminute        = self.releaseTime % 60;
        }
        else if( i % 2 == 0 ) { // a station
          objects[i].deleteButton   = 0;
          objects[i].legTypeSelect  = 0;

          objects[i].lblType = "Ground time";

          if( objects[i+1].type == "lay" ) {
            objects[i].durationSelect = 0;
            objects[i].newLayButton   = 0;

            objects[i].lblType = "Release time";
            objects[i].dhour   = parseInt(self.releaseTime / 60);
            objects[i].dminute = self.releaseTime % 60;
          }
          if( objects[i-1].type == "lay" ) {
            objects[i].durationSelect = 0;
            objects[i].stationSelect  = 0;
            objects[i].newLayButton   = 0;

            objects[i].lblType = "Report time";
            objects[i].dhour   = parseInt(self.reportTime / 60);
            objects[i].dminute = self.reportTime % 60;
          }

        }
        else { // a leg or a lay.
          objects[i].newLegButton  = 0;
          objects[i].newLayButton  = 0;
          objects[i].stationSelect = 0;

          objects[i].lblType = objects[i].type == "leg" ? "Leg" : "Lay over";

          if( objects.length <= 3 ) {
            objects[i].deleteButton = 0; 
          }

          // can not delete a leg when it is the first, and it is followed by a lay.
          if( i == 1 && i + 2 < objects.length && objects[i+2].type == "lay" ) {
            objects[i].deleteButton = 0; 
          }
          // can not delete a leg when it is the last, and it is preceded by a lay.
          if( i == objects.length - 2 && i > 2 && objects[i-2].type == "lay" ) {
            objects[i].deleteButton = 0; 
          }
        }
      }
      self._updDur(objects);

      for( i = 0; i < objects.length ; ++i ) {
        self.putSync(objects[i]);
      }
    });
  },
});

tripDetailStore.on('add', function(event) {
  tripDetailStore.len += 1;
  tripDetailStore.nextPk += 1;
}); 

tripDetailStore.on('delete', function(event) {
  tripDetailStore.len -= 1;
}); 



// ===============================================
// Redraw SVG
// ===============================================
function RemoveIntroMessage() {
  dojo.query("#calendar").forEach(dojo.empty);
}


function AdjustCrewmemberBarScaleX(x) {
  svg.domCrewMemberBar.setAttribute("transform", "scale(" + x + ",1)");
}


topic.subscribe("refreshGraph", function() {
  yCoordStore.StretchSVGHeight();

  dojo.query("#calendar").forEach(dojo.empty);
  dojo.query("#calendar_bar").forEach(dojo.empty);
  dojo.query("#crewmembers").forEach(dojo.empty);
  dojo.query("#crewmember_bar").forEach(dojo.empty);
  dojo.query("#opentime").forEach(dojo.empty);
  dojo.query("#notes").forEach(dojo.empty);

  var x = 0;
  calendarStore.forEach(function(item) {
    // on.emit(item, "update", { bubbles: true, cancelable: true });
    item.DrawSVG();
    x = Math.max(x, item.get("x") + item.get("width")); 
  });
  AdjustCrewmemberBarScaleX(x);

  eventStore.forEach(function(item) {
    item.DrawSVG();
  });
  distanceStore.forEach(function(item) {
    item.DrawSVG();
  });
  crewMemberStore.forEach(function(item) {
    item.DrawSVG();
  });
  activityStore.forEach(function(item) {
    item.DrawSVG(crewMemberStore.getSync(item.fk_cm));
  });

  noteStore.forEach(function(item) {
    item.DrawSVG();
  });

  if( !config.SHCalendarHours ) {
    registry.byId("SHCalendarHours").set("checked", !config.SHCalendarHours);
    registry.byId("SHCalendarHours").set("checked", config.SHCalendarHours);
  }
  if( !config.SHCalendarDayX ) {
    registry.byId("SHCalendarDayX").set("checked", !config.SHCalendarDayX);
    registry.byId("SHCalendarDayX").set("checked", config.SHCalendarDayX);
  }
  if( !config.SHCalendarDayYYYYMMDD ) {
    registry.byId("SHCalendarDayYYYYMMDD").set("checked", !config.SHCalendarDayYYYYMMDD);
    registry.byId("SHCalendarDayYYYYMMDD").set("checked", config.SHCalendarDayYYYYMMDD);
  }
  if( !config.SHCalendarDayBars ) {
    registry.byId("SHCalendarDayBars").set("checked", !config.SHCalendarDayBars);
    registry.byId("SHCalendarDayBars").set("checked", config.SHCalendarDayBars);
  }
  if( !config.SHCalendarHourBars ) {
    registry.byId("SHCalendarHourBars").set("checked", !config.SHCalendarHourBars);
    registry.byId("SHCalendarHourBars").set("checked", config.SHCalendarHourBars);
  }

  if( config.SHCalendarMon ) {
    registry.byId("SHCalendarMon").set("checked", !config.SHCalendarMon);
    registry.byId("SHCalendarMon").set("checked", config.SHCalendarMon);
  }
  if( config.SHCalendarTue ) {
    registry.byId("SHCalendarTue").set("checked", !config.SHCalendarTue);
    registry.byId("SHCalendarTue").set("checked", config.SHCalendarTue);
  }
  if( config.SHCalendarWed ) {
    registry.byId("SHCalendarWed").set("checked", !config.SHCalendarWed);
    registry.byId("SHCalendarWed").set("checked", config.SHCalendarWed);
  }
  if( config.SHCalendarThu ) {
    registry.byId("SHCalendarThu").set("checked", !config.SHCalendarThu);
    registry.byId("SHCalendarThu").set("checked", config.SHCalendarThu);
  }
  if( config.SHCalendarFri ) {
    registry.byId("SHCalendarFri").set("checked", !config.SHCalendarFri);
    registry.byId("SHCalendarFri").set("checked", config.SHCalendarFri);
  }
  if( config.SHCalendarSat ) {
    registry.byId("SHCalendarSat").set("checked", !config.SHCalendarSat);
    registry.byId("SHCalendarSat").set("checked", config.SHCalendarSat);
  }
  if( config.SHCalendarSun ) {
    registry.byId("SHCalendarSun").set("checked", !config.SHCalendarSun);
    registry.byId("SHCalendarSun").set("checked", config.SHCalendarSun);
  }

  if( !config.SHActivityHours ) {
    registry.byId("SHActivityHours").set("checked", !config.SHActivityHours);
    registry.byId("SHActivityHours").set("checked", config.SHActivityHours);
  }
  if( !config.SHActivityDetails ) {
    registry.byId("SHActivityDetails").set("checked", !config.SHActivityDetails);
    registry.byId("SHActivityDetails").set("checked", config.SHActivityDetails);
  }
  if( !config.SHActivityDetailHours ) {
    registry.byId("SHActivityDetailHours").set("checked", !config.SHActivityDetailHours);
    registry.byId("SHActivityDetailHours").set("checked", config.SHActivityDetailHours);
  }
  if( !config.SHActivityDetailStations ) {
    registry.byId("SHActivityDetailStations").set("checked", !config.SHActivityDetailStations);
    registry.byId("SHActivityDetailStations").set("checked", config.SHActivityDetailStations);
  }
  if( !config.SHActivityDuties ) {
    registry.byId("SHActivityDuties").set("checked", !config.SHActivityDuties);
    registry.byId("SHActivityDuties").set("checked", config.SHActivityDuties);
  }
  svg.SetSizeAttributes();
});


// ===============================================
// SAVING STORES TO SVG
// ===============================================
function SaveStore(store) {
  // clean/empty the children.
  dojo.query("#" + store.svgId).forEach(dojo.empty);

  var InsertionPointId = svg.dom.getElementById(store.svgId);
  var schema           = store.Model().schema;

  store.forEach(function(item) {
    var objNode = document.createElementNS("", store.svgItemNodeName);

    InsertionPointId.appendChild(objNode);

    for(var property in schema) {
      if( schema.hasOwnProperty(property) ) {

        var node = document.createElementNS("", property);
        var data = item.get(property);

        if( data instanceof Array ) {

          data = item.get(property).slice();

          for(var j = 0; j < data.length; j++) {
            var item = document.createElementNS("", "item");
            var t = document.createTextNode(data[j]); 
            item.appendChild(t);
            node.appendChild(item);
          }
        }
        else {
          var t = document.createTextNode(data);
          node.appendChild(t);
        }
        objNode.appendChild(node);
      }
    }    
  });
}


function LoadStore(svgDoc, store) {
  var svgNode = svgDoc.getElementById(store.svgId);    

  if ( !svgNode ) { 
    return;
  }  

  var childrenNodes = svgNode.childNodes; // getElementsByTagName(store.svgItemNodeName);
  var schema = store.Model().schema;

  for(var i = 0; i < childrenNodes.length; i ++) {
    var data = childrenNodes[i];
    var def = new store.Model(); // allow to get default values.

    if( data.nodeType == 3) {  // allow to edit svg and put white characters.
      continue;
    }

    for(var property in schema) {
      if( schema.hasOwnProperty(property) ) {
        var type = typeof(schema[property]) == "object" ? schema[property].type : schema[property];
        var elements = data.getElementsByTagName(property); // [0].textContent;

        if( elements.length > 0 ) { 
          if( type == "numeric" ) {
            if( !isNaN(elements[0].textContent) ) def[property] = Number(elements[0].textContent);
          }
          else if( type == "boolean") def[property] = elements[0].textContent == 'true';
          else def[property] = elements[0].textContent;
        }
      }
    }
    def["load"] = true; // attribute used to flag that this is the load step, to avoid recomputing y coordinate.
    store.putSync(def);
  }
}


function SaveStores() {
  SaveStore(configurationStore);
  SaveStore(calendarStore);
  SaveStore(yCoordStore);
  SaveStore(crewMemberStore);
  SaveStore(activityStore);
  SaveStore(eventStore);
  SaveStore(distanceStore);
  SaveStore(stationStore); 
  SaveStore(noteStore); 
}


function LoadSvgStores(svgNode) {
  RemoveIntroMessage();

  LoadStore(svgNode, configurationStore);
  // load single object (id 0) in config.
  config = configurationStore.getSync(0);

  config.UpdateForBackwardCompatibility();
  config.UpdateUI();

  LoadStore(svgNode, calendarStore);
  LoadStore(svgNode, yCoordStore);
  yCoordStore.ComputeYAndHeigth();
  LoadStore(svgNode, crewMemberStore);
  LoadStore(svgNode, activityStore);
  LoadStore(svgNode, eventStore);
  LoadStore(svgNode, distanceStore);
  LoadStationStore(svgNode.getElementById("StationStore"), MODE_SVG);
  LoadStore(svgNode, noteStore);

  stationStore.filter({name: config.CalendarStation}).fetchRange({start: 0, end: 1}).then(function(results) {
    if( results.length > 0 ) {
      registry.byId("CalendarStation").set("value", "" + results[0].id);
    }
  });
}


// ===============================================
// LOADING STORES FROM SVG
// ===============================================

mappingStationSvgXml = { 
  "id"          : "id",
  "code"        : "code",
  "name"        : "name",
  "dstShift"    : "dst-shift",
  "dstStartLst" : "dst-start-lst",
  "dstEndLst"   : "dst-end-lst",
  "utcOffset"   : "utc-offset",
  "regionList"  : "region-list",
  "item"        : "region"
};

MODE_SVG = 0;
MODE_XML = 1;

// Some tags are not exactly the same in svg def and xml def of a station.
// The xml introduce some dash character in word which is not compliant with 
// variable name.
function convertionSvgXml(key, mode) {
  return mode == MODE_SVG ? key : mappingStationSvgXml[key];
}


function LoadStationStore(parentNode, mode) {
  var rootStationStoreChildren = parentNode.getElementsByTagName("station");
  var offsetRegex = /^(-?\d{2})h(\d{2})$/;

  for(var i = 0; i < rootStationStoreChildren.length; i ++) {
    var obj = rootStationStoreChildren[i];

    var data = offsetRegex.exec(obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent);
    var offset = moment.duration({hours: data[1], minutes: data[2]}).asMinutes() * -1;

    var id = mode == MODE_SVG ? obj.getElementsByTagName("id")[0].textContent : obj.getAttribute("id"); 

    var regionList = obj.getElementsByTagName(convertionSvgXml("item", mode)); 

    var regions = [];
    for(var j = 0; j < regionList.length; j++) {
      regions.push(regionList[j].textContent);
    }

    stationStore.putSync({
      id: id,
      code: obj.getElementsByTagName(convertionSvgXml("code", mode))[0].textContent,
      name: obj.getElementsByTagName(convertionSvgXml("name", mode))[0].textContent,
      dstShift: obj.getElementsByTagName(convertionSvgXml("dstShift", mode))[0].textContent, 
      dstStartLst: obj.getElementsByTagName(convertionSvgXml("dstStartLst", mode))[0].textContent,
      dstEndLst: obj.getElementsByTagName(convertionSvgXml("dstEndLst", mode))[0].textContent,
      utcOffset: obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent,
      offset: offset,
      regionList: regions,
    });
  }
}


var stationStoreAdapter = new DstoreAdapter(stationStore);

registry.byId("CalendarStation").set("store", stationStoreAdapter);



// ===============================================
// 
// ===============================================

var grid = new (declare([OnDemandGrid, Selection, Keyboard, Editor, CompoundColumns]))({ 
  collection    : tripDetailStore,
  showHeader    : true,
  noDataMessage : 'Please fill in the "Start date time" field first.',
},
'TripGrid'
);


grid.on('dgrid-datachange', function(event) {
  var cell = grid.cell(event);

  var columnName =  cell.column.field;

  if( columnName == "station") {
    var nextRow = grid.down(cell.row, 1);
    if( nextRow.data.type == "lay" ) {
      nextRow = grid.down(cell.row, 2);
      nextRow.data.station = event.value;
      grid.collection.putSync(nextRow.data);
    }
  }
  else if( columnName == "dhour" ) {
    cell.row.data.dhour  = event.value;
    grid.collection.putSync(cell.row.data);
    grid.collection.updateDuration();
  } 
  else if( columnName == "dminute" ) {
    cell.row.data.dminute = event.value;
    grid.collection.putSync(cell.row.data);
    grid.collection.updateDuration();
  }
});


/*
 * dojo memory for setting store in duration hour and minute widget.
 */          
var zeroTo59Store = new LegacyMemory({ data: minutes0To59Data });
var zeroTo99Store = new LegacyMemory({ data: hours0To99Data });


/*
 * Type of leg
 */
typeLegStore = new ObjectStore({
  objectStore: LegacyObservable(new LegacyMemory({
    data: {
      identifier: 'type',
      items: [
        { 'type': 'A', 'name': 'Active' },
        { 'type': 'D', 'name': 'Deadhead' },
      ],
    }
  })),
  labelProperty: "name"
});


var columns = [{
  label      : "Station",
  field      : "station",
  sortable   : false,
  editor     : FilteringSelect,
  autoSave   : true,
  editorArgs : {
    store      : stationStoreAdapter,
    maxHeight  : 150,
    style      : "width:5em;",
    labelAttr  : "code",
    searchAttr : "code",
    required   : true,
  },
  canEdit    : function(object, value) {
    return object.stationSelect;
  },
},
{
  label    : "Type",
  field    : "lblType",
  sortable : false,
},
{
  label      : "Leg type",
  field      : "legType",
  sortable   : false,
  editor     : FilteringSelect,
  autoSave   : true,
  editorArgs : {
    store     : typeLegStore,
    maxHeight : 150,
    style     : "width:7em;",
    required  : true,
  },
  canEdit    : function(object, value) {
    return object.type == "leg";
  },
},
{ 
  label    : 'Start',
  field    : 'startDateTime',
  sortable : false,
},
{
  label    : 'Duration',
  children : [{ 
    field      : 'dhour',
    label      : 'Hour',
    sortable   : false,
    editor     : ComboBox,
    autoSave   : true,
    editorArgs : {
      store      : zeroTo99Store,
      regExp     : "[0-9]+",
      style      : "width         : 5em;",
      required   : true,
    },
    canEdit    : function(object, value) {
      return object.durationSelect;
    },
  },
  { 
    field      : 'dminute',
    label      : 'Minute',
    sortable   : false,
    editor     : FilteringSelect,
    autoSave   : true,
    editorArgs : {
      store      : zeroTo59Store,
      style      : "width         : 5em;",
      required   : true,
    },
    canEdit    : function( object, value) {
      return object.durationSelect;
    },
  },
  ],
},
{ 
  label    : 'End',
  field    : 'endDateTime',
  sortable : false,
},
{
  label      : 'Operations',
  sortable   : false,
  editor     : CustomEditorLegLayover,
  editorArgs : {
    grid : grid 
  },
}];

grid.set("columns", columns);
grid.set('sort', 'order');

grid.startup();          


// ===============================================
// EVENTS on dijit
// ===============================================

function updateDisplay(isChecked, nodes) {
  for(var i = 0; i < nodes.length; i++) {
    nodes[i].setAttribute("display", isChecked ? "block" : "none");
  }
}

registry.byId("SHCalendarHours").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("hour_label"));
  config.updateCheckboxProperty("SHCalendarHours", isChecked);  
}, true);

registry.byId("SHCalendarDayX").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("relative"));
  config.updateCheckboxProperty("SHCalendarDayX", isChecked);  
}, true);

registry.byId("SHCalendarDayYYYYMMDD").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("yyyymmdd"));
  config.updateCheckboxProperty("SHCalendarDayYYYYMMDD", isChecked);  
}, true);

registry.byId("SHCalendarDayBars").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("day_bar"));
  config.updateCheckboxProperty("SHCalendarDayBars", isChecked);  
}, true);

registry.byId("SHCalendarHourBars").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("hour_bar"));
  config.updateCheckboxProperty("SHCalendarHourBars", isChecked);  
}, true);


function updateWeekend(isChecked, nodes) {
  for(var i = 0; i < nodes.length; i++) {
    if( isChecked ) {
      nodes[i].classList.add("weekend");
    } 
    else {
      nodes[i].classList.remove("weekend");
    }
  }
}

registry.byId("SHCalendarMon").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Mon"));
  config.updateCheckboxProperty("SHCalendarMon", isChecked);  
}, true);
registry.byId("SHCalendarTue").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Tue"));
  config.updateCheckboxProperty("SHCalendarTue", isChecked);  
}, true);
registry.byId("SHCalendarWed").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Wed"));
  config.updateCheckboxProperty("SHCalendarWed", isChecked);  
}, true);
registry.byId("SHCalendarThu").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Thu"));
  config.updateCheckboxProperty("SHCalendarThu", isChecked);  
}, true);
registry.byId("SHCalendarFri").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Fri"));
  config.updateCheckboxProperty("SHCalendarFri", isChecked);  
}, true);
registry.byId("SHCalendarSat").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Sat"));
  config.updateCheckboxProperty("SHCalendarSat", isChecked);  
}, true);
registry.byId("SHCalendarSun").on("change", function(isChecked) {
  updateWeekend(isChecked, svg.dom.getElementsByClassName("Sun"));
  config.updateCheckboxProperty("SHCalendarSun", isChecked);  
}, true);



          
registry.byId("xgc0_25").on("change", function(value) { config.updateXGraphCompression(0.25); });
registry.byId("xgc0_5" ).on("change", function(value) { config.updateXGraphCompression(0.5); });
registry.byId("xgc1"   ).on("change", function(value) { config.updateXGraphCompression(1); });
registry.byId("xgc2"   ).on("change", function(value) { config.updateXGraphCompression(2); });
registry.byId("xgc4"   ).on("change", function(value) { config.updateXGraphCompression(4); });
registry.byId("xgc5"   ).on("change", function(value) { config.updateXGraphCompression(5); });
registry.byId("xgc6"   ).on("change", function(value) { config.updateXGraphCompression(6); });
registry.byId("xgc8"   ).on("change", function(value) { config.updateXGraphCompression(8); });
registry.byId("xgc10"  ).on("change", function(value) { config.updateXGraphCompression(10); });
registry.byId("xgc12"  ).on("change", function(value) { config.updateXGraphCompression(12); });
registry.byId("xgc15"  ).on("change", function(value) { config.updateXGraphCompression(15); });
registry.byId("xgc18"  ).on("change", function(value) { config.updateXGraphCompression(18); });
registry.byId("xgc20"  ).on("change", function(value) { config.updateXGraphCompression(20); });
registry.byId("xgc30"  ).on("change", function(value) { config.updateXGraphCompression(30); });
  


// -----------------------------------------------
// Show/Hide activity dialog
// -----------------------------------------------
registry.byId("SHActivityHours").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("act_hour"));
  config.updateCheckboxProperty("SHActivityHours", isChecked);  
}, true);

registry.byId("SHActivityDetails").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("details"));
  config.updateCheckboxProperty("SHActivityDetails", isChecked);  
}, true);

registry.byId("SHActivityDetailHours").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("dtl_hour"));
  config.updateCheckboxProperty("SHActivityDetailHours", isChecked);  
}, true);

registry.byId("SHActivityDetailStations").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("dtl_station"));
  config.updateCheckboxProperty("SHActivityDetailStations", isChecked);  
}, true);

registry.byId("SHActivityDuties").on("change", function(isChecked) {
  updateDisplay(isChecked, svg.dom.getElementsByClassName("DUTY"));
  config.updateCheckboxProperty("SHActivityDuties", isChecked);  
}, true);




/*
 * Reset business object stores.
 */
function ResetStores() {
  calendarStore.Reset();
  activityStore.Reset();
  crewMemberStore.Reset();
  eventStore.Reset();
  distanceStore.Reset();
  stationStore.Reset(); 
  noteStore.Reset(); 
  yCoordStore.Reset();
}


/* 
 * When a new station file is processed, the config need to be reinitialized, and
 * some UI too as the MenuCurrentFile and the SetCalendarForm.
 * Then the graph is refreshed.
 */          
function PreCleanupLoadStationFile() {          
  config = configurationStore.Model();

  configurationStore.putSync(config);          

  registry.byId("MenuCurrentFile").set("label", "No file");
  registry.byId("SetCalendarForm").reset();

  topic.publish("refreshGraph");
}


/*
 * Load a template XML Station file
 * 
 * Before processing file, some cleanup is done, then the template
 * file is fetched and the station store is initialized. On completion,
 * menu configuration is updated.
 */
registry.byId("UseStation").on("click", function() {
  var formObject = domForm.toObject("LoadStationForm");

  if( formObject.tplStation == undefined ){
    alert("Please select a template file");
    return;
  }
    
  var s = registry.byId("basicStandby");
  s.show();

  ResetStores();
  PreCleanupLoadStationFile();

  xhr("references/" + formObject.tplStation, {
    handleAs: "xml"
  }).then(function(data){
    LoadStationStore(data, MODE_XML);

    config.enableMenusAfterLoadingStationFile();

    s.hide();
    LoadStationDialog.hide();
  }); 
});


/*
 * Load a user defined XML Station file
 * 
 * This is exactly the same fonctionality as for template file, but now the
 * station file is uploaded.
 */
registry.byId("LoadStation").on("click", function() {
  var upload = registry.byId("uploaderStation");

  if( typeof(upload) == 'undefined' || typeof(upload._files) == 'undefined' ) {
    alert("Please select an XML file");
    return;
  }

  var f = upload._files[0];
  if( f.type != "text/xml" ) {
    alert("Please select an XML file");
    return;
  }          

  var s = registry.byId("basicStandby");
  s.show();

  ResetStores();
  PreCleanupLoadStationFile();

  var reader = new FileReader();

  // Closure to capture the file information and save it in the store.
  reader.onload = (function(theFile) {
    return function(e) {
      xmlDom = xmlparser.parse(e.target.result);

      LoadStationStore(xmlDom, MODE_XML);
      
      config.enableMenusAfterLoadingStationFile();

      s.hide();
      LoadStationDialog.hide();
    };
  })(f);

  // Read in the file as a text.
  reader.readAsText(f);
});


// -----------------------------------------------
// Load SVG file dialog
// -----------------------------------------------
registry.byId("LoadSvg").on("click", function() {
  var upload = registry.byId("uploaderSVG");

  if( typeof(upload) == 'undefined' || typeof(upload._files) == 'undefined' ) {
    alert("Please select an SVG file");
    return;
  }

  var f = upload._files[0];
  if( f.type != "image/svg+xml" ) {
    alert("Please select an SVG file");
    return;
  }          

  var s = registry.byId("basicStandby");
  s.show();

  ResetStores();

  var reader = new FileReader();

  // Closure to capture the file information and save it in the store.
  reader.onload = (function(theFile) {
    return function(e) {
      xmlDom = xmlparser.parse(e.target.result);

      LoadSvgStores(xmlDom);

      topic.publish("refreshGraph");
    };
  })(f);

  // Read in the file as a text.
  reader.readAsText(f);

  registry.byId("MenuCurrentFile").set("label", f.name);

  s.hide();
  LoadSvgDialog.hide();

});


// -----------------------------------------------
// Constants dialog
// -----------------------------------------------

registry.byId("ShowConstantsDialog").on("show", function() {
  registry.byId("ShowConstantsForm").set('value', config);
}, true);


registry.byId("SaveConstants").on("click", function() {
  if( !registry.byId("ShowConstantsForm").validate() ) {
    return;
  }

  ShowConstantsDialog.hide();
  
  config.updateFromForm("ShowConstantsForm");

  registry.byId("ShowConstantsForm").reset();

  topic.publish("refreshGraph");
});

// -----------------------------------------------
// Save file dialog
// -----------------------------------------------
registry.byId("SaveFile").on("click", function() {

  SaveStores();

  //get svg source.
  var serializer = new XMLSerializer();
  var source = vkbeautify.xml(serializer.serializeToString(svg.dom));
  var blob = new Blob([source], {type: "text/plain;charset=utf-8"});

  var filename = registry.byId("filename").value;

  saveAs(blob, filename);   

  SaveFileDialog.hide();

  registry.byId("MenuCurrentFile").set("label", filename);
}, true);

// -----------------------------------------------
// Calendar range set up dialog
// -----------------------------------------------
registry.byId("CalendarTimezone").on("focus", function() {
  if( this.get("value") ) {
    registry.byId("CalendarStation").set("disabled", false);
  }          
}, true);

registry.byId("CalendarTimezone").on("change", function(value) {
  // var item = TimezoneStore.get(this.get("value"));
  var item = TimezoneStore.get(value);

  // Set default time zone, based on user input.

  if( item ) {
    config.CalendarTimezone     = item.id;
    config.CalendarTimezoneName = item.name;
    
    configurationStore.putSync(config);          

    moment.tz.setDefault(config.CalendarTimezoneName);

    registry.byId("CalendarStation").set("disabled", false);

    if( !registry.byId("CalendarStation").get("value") ) {

      var zone = moment.tz.zone(item.name);

      // Need to find a date outside of the DST to find a match with
      // station definitions.
      var dateOutsideDST = moment();

      while( dateOutsideDST.isDST() ) {
        dateOutsideDST.subtract(1, 'months');
      }

      var offsetZone = zone.offset(dateOutsideDST.valueOf());         

      registry.byId("CalendarStation").set("value", "");
      registry.byId("CalendarStation").set("query", {offset: offsetZone});
    }

    // restore default timezone. otherwise, the duration computation does not work very well.
    moment.tz.setDefault();
  }
}, true);

/*
 * Event change on CalendarStart.
 *
 * On change, the Xorig is updated and XXXStartDate minimum constraints are
 * updated. XXXX is member of Training, Reserve, Trip, Vacation set.
 */
registry.byId("CalendarStart").on("change", function(value) {
  if( value == null ) {
    return;
  }

  // Here, the date is in local time. So, to avoid any problem, year, month and date are 
  // used to generate a moment timezone date in the right timezone.
  Xorig = moment.tz([value.getFullYear(), value.getMonth(), value.getDate()], config.CalendarTimezoneName).unix();

  registry.byId("CalendarEnd").constraints.min = date.add(value, "day", 1);
  registry.byId("CalendarEnd").dropDownDefaultValue = value;     

  registry.byId("TrainingStartDate").constraints.min = value;
  registry.byId("TrainingStartDate").dropDownDefaultValue = value;
  registry.byId("ReserveStartDate").constraints.min = value;
  registry.byId("ReserveStartDate").dropDownDefaultValue = value;
  registry.byId("TripStartDate").constraints.min = value;
  registry.byId("TripStartDate").dropDownDefaultValue = value;
  registry.byId("VacationStartDate").constraints.min = value;
  registry.byId("VacationStartDate").dropDownDefaultValue = value;
}, true);


/*
 * Event change on CalendarEnd.
 *
 * On change, XXXStartDate maximum constraints are
 * updated with this end date, minus one day. XXXX is member of 
 * Training, Reserve, Trip, Vacation set.
 * Also, VacationEndDate constraint maximum is updated.
 */
registry.byId("CalendarEnd").on("change", function(value) {
  if( value == null ) {
    return;
  }
  var maxDate = date.add(value, "day", -1);

  registry.byId("CalendarStart").constraints.max = maxDate;

  registry.byId("TrainingStartDate").constraints.max = maxDate;
  registry.byId("ReserveStartDate").constraints.max = maxDate;
  registry.byId("TripStartDate").constraints.max = maxDate;
  registry.byId("VacationStartDate").constraints.max = maxDate;
  registry.byId("VacationEndDate").constraints.max = value;
}, true);

registry.byId("SetCalendarDialog").on("show", function() {
  registry.byId("SetCalendarForm").set('value', config);
  console.log(config);
}, true);


registry.byId("SetCalendar").on("click", function() {
  if( !registry.byId("SetCalendarForm").validate() ) {
    return;
  }
  
  var s = registry.byId("basicStandby");
  s.show();

  RemoveIntroMessage();

  config.updateFromForm("SetCalendarForm");
  
  registry.byId("SetCalendarForm").reset();

  var start = moment.tz(config.CalendarStart, config.CalendarTimezoneName);
  var end   = moment.tz(config.CalendarEnd, config.CalendarTimezoneName);
  var range = end.diff(start, "days");

  calendarStore.fetch().then(function(days) {
    for (var i = days.length - 1; i >= 0; i--) {
      calendarStore.removeSync(days[i].pk);
    }
  });        

  var dstStatus = start.isDST();

  var x = 0;
  var width = 0;

  XStartPeriod = 0;

  for(i = 0; i < range; i++) {
    
    var nextDay = moment(start).add(1, "days");   
    width = nextDay.diff(start, "hours") * 60;



    calendarStore.addSync({
      name     : start.format().substring(0, 10),
      dayweek  : start.format("ddd"),
      relative : i,
      pk       : calendarStore.GetNextPKSequence(),
      x        : x,
      width    : width,
    });

    // look for DST
    if( width != 1440 ) { 
      var InitialState =  start.isDST();

      while( start.isDST() == InitialState ) {
        start.add(1, "minutes");
      }
      var dstEvent =  new eventModel();    

      dstEvent.pk         = eventStore.GetNextPKSequence();
      dstEvent.label      = InitialState ? "End DST" : "Start DST";
      dstEvent.long_label = InitialState ? "End DST" : "Start DST";
      dstEvent.x          = getPositionX(start);

      eventStore.addSync(dstEvent);
    }

    x += width;
    start = nextDay;
    XStartNextPeriod = x;
  }

  AdjustCrewmemberBarScaleX(x);

  // enabled some menu items.
  config.MenuCalendarSetStartPeriods = false;
  config.MenuBusinessObject          = false;
  config.MenuGraphOption             = false;
  config.MenuHighLights              = false;
  config.MenuResolution              = false;        
  config.MenuFileSaveSVGFile         = false;
  config.MenuFileExportToPI          = false;

  configurationStore.putSync(config);

  topic.publish("refreshGraph");
  
  s.hide();
  SetCalendarDialog.hide();
});


//    
//   _____            _       ______  _   _  _____            _____  
//  / ____|    /\    | |     |  ____|| \ | ||  __ \    /\    |  __ \ 
// | |        /  \   | |     | |__   |  \| || |  | |  /  \   | |__) |
// | |       / /\ \  | |     |  __|  | . ` || |  | | / /\ \  |  _  / 
// | |____  / ____ \ | |____ | |____ | |\  || |__| |/ ____ \ | | \ \ 
//  \_____|/_/    \_\|______||______||_| \_||_____//_/    \_\|_|  \_\
//                                                                            
//                 
registry.byId("SetStartPeriodsDialog").on("show", function() {
  var arrChecked = [];
  calendarStore.forEach(function(item) {
    if( item.startperiod ) {
      arrChecked.push(item.pk);
    }
  });
  arrChecked.push(0);          
  registry.byId("CalendarStartPeriods").setStore(calendarStoreAdapter, arrChecked);
}, true);

// Redraw start periods
registry.byId("SetStartPeriods").on("click", function() {
  var newStarts = registry.byId("CalendarStartPeriods").value;
  var ref =  newStarts.length > 0 ? newStarts[0] : 0; 

  var i = 0;

  var fCreateEvent = registry.byId("CalendarStartCreateEvent").value;

  var yCoord;

  if( fCreateEvent ) {
    yCoord = yCoordStore.addSync({
        pk     : yCoordStore.GetNextPKSequence(),
        y      : -1,
        height : HEIGHT_LINE_HL,
    });


  }

  calendarStore.forEach(function(item) {
    item.set("relative", item.pk - ref);
    if( i < newStarts.length && newStarts[i] == item.pk ) {
      item.set("startperiod", true);
      if( i == 0 ) XStartPeriod = item.x;
      if( i == 1 ) XStartNextPeriod = item.x;  
      i+=1;

      if( fCreateEvent ) {
        var startPeriodEvent = new eventModel();

        startPeriodEvent.pk          = eventStore.GetNextPKSequence();
        startPeriodEvent.label       = "Start period ";
        startPeriodEvent.long_label  = item.name + " -- Start period"; 
        startPeriodEvent.x           = item.x;
        startPeriodEvent.fk_yc       = yCoord.pk;

        eventStore.addSync(startPeriodEvent);
      }
    }
    else {
      item.set("startperiod", false);
    }
    calendarStore.put(item);
  });

  if( fCreateEvent ) {
    yCoordStore.ComputeYAndHeigth();
  }

  SetStartPeriodsDialog.hide();

  topic.publish("refreshGraph");
});


//      
//      
//   _____  _____   ______ __          __ __  __  ______  __  __  ____   ______  _____  
//  / ____||  __ \ |  ____|\ \        / /|  \/  ||  ____||  \/  ||  _ \ |  ____||  __ \ 
// | |     | |__) || |__    \ \  /\  / / | \  / || |__   | \  / || |_) || |__   | |__) |
// | |     |  _  / |  __|    \ \/  \/ /  | |\/| ||  __|  | |\/| ||  _ < |  __|  |  _  / 
// | |____ | | \ \ | |____    \  /\  /   | |  | || |____ | |  | || |_) || |____ | | \ \ 
//  \_____||_|  \_\|______|    \/  \/    |_|  |_||______||_|  |_||____/ |______||_|  \_\
//                                                                                           
// 


function SetUpCrewMemberDialog(pk_item) {
  if( pk_item ) {
    CrewMemberDialog.set("title", "Edit crewmember");

    domStyle.set(registry.byId("CreateCrewMember").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteCrewMember").domNode,    "display", "inline");
    domStyle.set(registry.byId("SaveCrewMember").domNode,      "display", "inline");

    domStyle.set("PkCrewMember", "display", "table-row");

    var item = crewMemberStore.getSync(pk_item);

    item.ConvertModelToForm() 
  } 
  else {
    CrewMemberDialog.set("title", "Create a crewmember");

    domStyle.set(registry.byId("CreateCrewMember").domNode,    "display", "inline");
    domStyle.set(registry.byId("DeleteCrewMember").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveCrewMember").domNode,      "display", "none");
    
    domStyle.set("PkCrewMember", "display", "none");
  }

  CrewMemberDialog.show();
}


// connect menu creation crew member to crewmember dialog
registry.byId("MenuBusinessObjectCreateCrewMember").on("click", function() {
  SetUpCrewMemberDialog(); 
});


registry.byId("DeleteCrewMember").on("click", function() {
  crewMemberStore.removeSync(registry.byId("CrewMemberPk").get("value"));

  CrewMemberDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("SaveCrewMember").on("click", function() {
  crewMemberStore.SaveOrUpdate();
});

registry.byId("CreateCrewMember").on("click", function() {
  crewMemberStore.SaveOrUpdate();
});


//
//  _____        __     __     ____   ______  ______ 
// |  __ \    /\ \ \   / /    / __ \ |  ____||  ____|
// | |  | |  /  \ \ \_/ /    | |  | || |__   | |__   
// | |  | | / /\ \ \   /     | |  | ||  __|  |  __|  
// | |__| |/ ____ \ | |      | |__| || |     | |     
// |_____//_/    \_\|_|       \____/ |_|     |_|     
//                                                   
//
registry.byId("CreateDayOff").on("click", function() {
  if( !registry.byId("CreateDayOffForm").validate() ) {
    return;
  }

  CreateDayOffDialog.hide();
  var crewMemberPk = parseInt(registry.byId("DayOffCrewMemberSelect").value);
  var days         = registry.byId("DayOffDatesSelect").value; 
  var type         = registry.byId("DayOffType").value;

  // to avoid the "at least one item must be selected" message, form data are save in 
  // local variables before reseting the form.
  registry.byId("CreateDayOffForm").reset();

  days.forEach(function(day) {
    var activity = new activityModel();

    activity.InitDayOff(crewMemberPk, day, type);

    activityStore.addSync(activity);

    activity.CreateEvents();
  });

  topic.publish("refreshGraph");
});


//     
//  _       ______       __      __ ______ 
// | |     |  ____|    /\\ \    / /|  ____|
// | |     | |__      /  \\ \  / / | |__   
// | |     |  __|    / /\ \\ \/ /  |  __|  
// | |____ | |____  / ____ \\  /   | |____ 
// |______||______|/_/    \_\\/    |______|
//                                        
//
registry.byId("VacationStartDate").on("change", function() {
  var nextDay = date.add(this.get("value"), "day", 1);
  registry.byId("VacationEndDate").set("disabled", false);
  registry.byId("VacationEndDate").constraints.min = nextDay;
  registry.byId("VacationEndDate").dropDownDefaultValue = nextDay;
}, true);


registry.byId("VacationEndDate").on("change", function() {
  var self = this;
  if( self.get("value") < registry.byId("CalendarEnd").get("value") ) {
    registry.byId("VacationStartDate").constraints.max = self.get("value"); 
  } 
  else {
    registry.byId("VacationStartDate").constraints.max = registry.byId("CalendarEnd").get("value");
  }
}, true);


function SetUpVacationDialog(item) {
  if( item ) {
    VacationDialog.set("title", "Edit vacation");

    domStyle.set(registry.byId("CreateVacation").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteVacation").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateVacation").domNode, "display", "inline");
    domStyle.set(registry.byId("SaveVacation").domNode,      "display", "inline");

    domStyle.set("PkVacation", "display", "table-row");

    item.ConvertModelToForm() 
  } 
  else {
    VacationDialog.set("title", "Create a vacation");

    var CalStart = registry.byId("CalendarStart").get("value");
    var CalEnd   = date.add(registry.byId("CalendarEnd").get("value"), "day", 1);

    registry.byId("VacationStartDate").constraints.min = CalStart;
    registry.byId("VacationStartDate").constraints.max = CalEnd;
    registry.byId("VacationStartDate").dropDownDefaultValue = CalStart;

    domStyle.set(registry.byId("CreateVacation").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateVacation").domNode, "display", "none");
    domStyle.set(registry.byId("DeleteVacation").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveVacation").domNode,      "display", "none");

    domStyle.set("PkVacation", "display", "none");
  }

  VacationDialog.show();
}


registry.byId("MenuBusinessObjectCreateActivityVacation").on("click", function() {
  SetUpVacationDialog(); 
});


registry.byId("DeleteVacation").on("click", function() {
  activityStore.removeSync(registry.byId("VacationPk").get("value"));

  VacationDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("DuplicateVacation").on("click", function() {
  registry.byId("VacationPk").set("value", "");        
  activityStore.SaveOrUpdate("Vacation");
});


registry.byId("CreateVacation").on("click", function() {
  activityStore.SaveOrUpdate("Vacation");
});


registry.byId("SaveVacation").on("click", function() {
  activityStore.SaveOrUpdate("Vacation");
});


//     
//  _______  _____             _____  _   _  _____  _   _   _____ 
// |__   __||  __ \     /\    |_   _|| \ | ||_   _|| \ | | / ____|
//    | |   | |__) |   /  \     | |  |  \| |  | |  |  \| || |  __ 
//    | |   |  _  /   / /\ \    | |  | . ` |  | |  | . ` || | |_ |
//    | |   | | \ \  / ____ \  _| |_ | |\  | _| |_ | |\  || |__| |
//    |_|   |_|  \_\/_/    \_\|_____||_| \_||_____||_| \_| \_____|
//                                                        
//       

// type can be "Training" or "Reserve".
function TryEnableDuration(type) {
  if(   registry.byId(type + "StartTime").get("value") != null 
     && registry.byId(type + "StartDate").get("value") != null ) {
    registry.byId(type + "DurationHour").set("disabled", false);
    registry.byId(type + "DurationMinute").set("disabled" , false);
    registry.byId(type + "DurationHour").set("readOnly", false);
    registry.byId(type + "DurationMinute").set("readOnly", false);

    UpdateEndDateTime(type);
  }
}


registry.byId("TrainingStartDate").on("click,mousedown", function() {
  TryEnableDuration("Training");          
});


registry.byId("TrainingStartDate").on("change", function(value) {
  TryEnableDuration("Training");          
});


registry.byId("TrainingStartTime").on("click,mousedown", function() {
  TryEnableDuration("Training");          
});


registry.byId("TrainingStartTime").on("change", function(value) {
  TryEnableDuration("Training");          
});


registry.byId("TrainingDurationHour").on("click", function() {
  UpdateEndDateTime("Training");
});


registry.byId("TrainingDurationHour").on("change", function(value) {
  UpdateEndDateTime("Training");
});


registry.byId("TrainingDurationMinute").on("click", function() {
  UpdateEndDateTime("Training");
});


registry.byId("TrainingDurationMinute").on("change", function(value) {
  UpdateEndDateTime("Training");
});


function SetUpTrainingDialog(item) {
  if( item ) {
    TrainingDialog.set("title", "Edit training");

    domStyle.set(registry.byId("CreateTraining").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteTraining").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateTraining").domNode, "display", "inline");
    domStyle.set(registry.byId("SaveTraining").domNode,      "display", "inline");

    domStyle.set("PkTraining", "display", "table-row");

    item.ConvertModelToForm() 
  } 
  else {
    TrainingDialog.set("title", "Create a training");

    domStyle.set(registry.byId("CreateTraining").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateTraining").domNode, "display", "none");
    domStyle.set(registry.byId("DeleteTraining").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveTraining").domNode,      "display", "none");

    registry.byId("TrainingDurationHour").set("value", 0);
    registry.byId("TrainingDurationHour").set("readonly", true);
    registry.byId("TrainingDurationHour").set("disabled", true);
    registry.byId("TrainingDurationMinute").set("value", 0);
    registry.byId("TrainingDurationMinute").set("readonly", true);
    registry.byId("TrainingDurationMinute").set("disabled", true);


    domStyle.set("PkTraining", "display", "none");

    // reset filteringselect Minute of rest before and after. Those two are not set to zero.
    registry.byId("TrainingRestBeforeM").set("value", 0);
    registry.byId("TrainingRestAfterM").set("value", 0);
  }

  TrainingDialog.show();
}


// connect menu creation training to training dialog
registry.byId("MenuBusinessObjectCreateActivityTraining").on("click", function() {
  SetUpTrainingDialog(); 
});


registry.byId("DeleteTraining").on("click", function() {
  activityStore.removeSync(registry.byId("TrainingPk").get("value"));

  TrainingDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("DuplicateTraining").on("click", function() {
  registry.byId("TrainingPk").set("value", "");
  activityStore.SaveOrUpdate("Training");
});


registry.byId("CreateTraining").on("click", function() {
  activityStore.SaveOrUpdate("Training");
});


registry.byId("SaveTraining").on("click", function() {
  activityStore.SaveOrUpdate("Training");
});


//                                                        
//  _____   ______   _____  ______  _____ __      __ ______ 
// |  __ \ |  ____| / ____||  ____||  __ \\ \    / /|  ____|
// | |__) || |__   | (___  | |__   | |__) |\ \  / / | |__   
// |  _  / |  __|   \___ \ |  __|  |  _  /  \ \/ /  |  __|  
// | | \ \ | |____  ____) || |____ | | \ \   \  /   | |____ 
// |_|  \_\|______||_____/ |______||_|  \_\   \/    |______|
//                                                         
//                                                           

registry.byId("ReserveStartDate").on("click,mousedown", function() {
  TryEnableDuration("Reserve");          
});


registry.byId("ReserveStartDate").on("change", function(value) {
  TryEnableDuration("Reserve");          
});


registry.byId("ReserveStartTime").on("click,mousedown", function() {
  TryEnableDuration("Reserve");          
});


registry.byId("ReserveStartTime").on("change", function(value) {
  TryEnableDuration("Reserve");          
});


registry.byId("ReserveDurationHour").on("click", function() {
  UpdateEndDateTime("Reserve");
});


registry.byId("ReserveDurationHour").on("change", function(value) {
  UpdateEndDateTime("Reserve");
});


registry.byId("ReserveDurationMinute").on("click", function() {
  UpdateEndDateTime("Reserve");
});


registry.byId("ReserveDurationMinute").on("change", function(value) {
  UpdateEndDateTime("Reserve");
});


function SetUpReserveDialog(item) {
  if( item ) {
    ReserveDialog.set("title", "Edit reserve");

    domStyle.set(registry.byId("CreateReserve").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteReserve").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateReserve").domNode, "display", "inline");
    domStyle.set(registry.byId("SaveReserve").domNode,      "display", "inline");

    domStyle.set("PkReserve", "display", "table-row");

    item.ConvertModelToForm() 
  } 
  else {
    ReserveDialog.set("title", "Create a reserve");

    domStyle.set(registry.byId("CreateReserve").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateReserve").domNode, "display", "none");
    domStyle.set(registry.byId("DeleteReserve").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveReserve").domNode,      "display", "none");

    registry.byId("ReserveDurationHour").set("value", 0);
    registry.byId("ReserveDurationHour").set("readonly", true);
    registry.byId("ReserveDurationHour").set("disabled", true);
    registry.byId("ReserveDurationMinute").set("value", 0);
    registry.byId("ReserveDurationMinute").set("readonly", true);
    registry.byId("ReserveDurationMinute").set("disabled", true);


    domStyle.set("PkReserve", "display", "none");

    // reset filteringselect Minute of rest before and after. Those two are not set to zero.
    registry.byId("ReserveRestBeforeM").set("value", 0);
    registry.byId("ReserveRestAfterM").set("value", 0);
  }

  ReserveDialog.show();
}


// connect menu creation reserve to reserve dialog
registry.byId("MenuBusinessObjectCreateActivityReserve").on("click", function() {
  SetUpReserveDialog(); 
});


registry.byId("DeleteReserve").on("click", function() {
  activityStore.removeSync(registry.byId("ReservePk").get("value"));

  ReserveDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("DuplicateReserve").on("click", function() {
  registry.byId("ReservePk").set("value", "");        
  activityStore.SaveOrUpdate("Reserve");
});


registry.byId("CreateReserve").on("click", function() {
  activityStore.SaveOrUpdate("Reserve");
});


registry.byId("SaveReserve").on("click", function() {
  activityStore.SaveOrUpdate("Reserve");
});

     
//
//  ______ __      __ ______  _   _  _______ 
// |  ____|\ \    / /|  ____|| \ | ||__   __|
// | |__    \ \  / / | |__   |  \| |   | |   
// |  __|    \ \/ /  |  __|  | . ` |   | |   
// | |____    \  /   | |____ | |\  |   | |   
// |______|    \/    |______||_| \_|   |_|   
//                                           
//    
function SetUpEventDialog(pk_item) {
  if( pk_item ) {
    EventDialog.set("title", "Edit event");

    domStyle.set(registry.byId("CreateEvent").domNode,     "display", "none");
    domStyle.set(registry.byId("DeleteAllEvents").domNode, "display", "inline");
    domStyle.set(registry.byId("DeleteEvent").domNode,     "display", "inline");
    domStyle.set(registry.byId("SaveEvent").domNode,       "display", "inline");

    domStyle.set("PkEvent", "display", "table-row");

    FillInEventForm(pk_item);
  } 
  else {
    EventDialog.set("title", "Create event(s)");

    domStyle.set(registry.byId("CreateEvent").domNode,     "display", "inline");
    domStyle.set(registry.byId("DeleteAllEvents").domNode, "display", "none");
    domStyle.set(registry.byId("DeleteEvent").domNode,     "display", "none");
    domStyle.set(registry.byId("SaveEvent").domNode,       "display", "none");

    domStyle.set("PkEvent", "display", "none");
  }

  EventDialog.show();
}


function FillInEventForm(pk_item) {
  var item = eventStore.getSync(pk_item);

  registry.byId('EventForm').set('value', item);
  // var eventTime = moment.tz(getDateTime(item.x).format("YYYY-MM-DD HH:mm"), config.CalendarTimezoneName);
  var eventTime = moment(getDateTime(item.x).format("YYYY-MM-DD HH:mm"));
  registry.byId('EventTime').set('value', eventTime.toDate());

  var days = [];
  eventStore.filter({fk_yc: item.fk_yc}).forEach(function(object) {
    days.push(calendarStore.GetPkFromX(object.x));
  }); 

  registry.byId("EventDatesSelect").set("value", days);

  registry.byId("EventColorPaletteWidget").set("value", item.color);
}


// connect menu creation Event to Event dialog
registry.byId("MenuHighLightsEvent").on("click", function() {
  SetUpEventDialog(); 
});


registry.byId("DeleteEvent").on("click", function() {
  eventStore.removeSync(registry.byId("EventPk").get("value"));

  EventDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("DeleteAllEvents").on("click", function() {
  var item = eventStore.getSync(registry.byId("EventPk").get("value"));
  eventStore.filter({fk_yc: item.fk_yc}).fetch().then(function(items) {
    for (var i = items.length - 1; i >= 0; i--) {
      eventStore.removeSync(items[i].pk);
    }           
  }); 

  EventDialog.hide();

  topic.publish("refreshGraph");
});

registry.byId("CreateEvent").on("click", function() {
  eventStore.SaveOrUpdate();
});

registry.byId("SaveEvent").on("click", function() {
  eventStore.SaveOrUpdate();
});


registry.byId("EventInvertSelectionDates").on("click", function() {
  registry.byId("EventDatesSelect").invertSelection(); 
});

registry.byId("EventColorPaletteWidget").on("change", function(value) {
  domStyle.set(dom.byId("EventColorSwatch"), "backgroundColor", value);
  dijit.popup.close(registry.byId("EventColorPaletteDialog"));
});



//                                         
//  _____  _____   _____  _______         _   _   _____  ______ 
// |  __ \|_   _| / ____||__   __| /\    | \ | | / ____||  ____|
// | |  | | | |  | (___     | |   /  \   |  \| || |     | |__   
// | |  | | | |   \___ \    | |  / /\ \  | . ` || |     |  __|  
// | |__| |_| |_  ____) |   | | / ____ \ | |\  || |____ | |____ 
// |_____/|_____||_____/    |_|/_/    \_\|_| \_| \_____||______|
//                              
//


// connect menu creation Event to Event dialog
registry.byId("MenuHighLightsDistance").on("click", function() {
  SetUpDistanceDialog(); 
});


registry.byId("DeleteDistance").on("click", function() {
  distanceStore.removeSync(registry.byId("DistancePk").get("value"));

  DistanceDialog.hide();

  topic.publish("refreshGraph");
});


function SetUpDistanceDialog(pk_item) {
  if( pk_item ) {
    DistanceDialog.set("title", "Edit distance");

    domStyle.set(registry.byId("CreateDistance").domNode,     "display", "none");
    domStyle.set(registry.byId("DeleteDistance").domNode,     "display", "inline");
    domStyle.set(registry.byId("SaveDistance").domNode,       "display", "inline");

    domStyle.set("PkDistance", "display", "table-row");

    var item = distanceStore.getSync(pk_item);
    
    item.ConvertModelToForm();
  } 
  else {
    DistanceDialog.set("title", "Create distance");

    domStyle.set(registry.byId("CreateDistance").domNode,     "display", "inline");
    domStyle.set(registry.byId("DeleteDistance").domNode,     "display", "none");
    domStyle.set(registry.byId("SaveDistance").domNode,       "display", "none");

    domStyle.set("PkDistance", "display", "none");
  }

  DistanceDialog.show();
}



// pkEvent is optional.
function UpdateEvent(pk_activity, idEventSelect, pkEvent) {
  var filter = new eventStore.Filter();
  var selectInput = registry.byId(idEventSelect);   

  selectInput.set("sortByLabel", false);
  selectInput.set("query", {fk_act: pk_activity}); 
  
  if( pkEvent ) {
    selectInput.set("value", pkEvent);
  }
  else {
    var event = eventStore.RetrieveActivityEvent(-3, pk_activity);

    // if( typeof(event) != 'undefined' ) {
    if( event ) {
      selectInput.set("value", event.pk);
    }
  }
  selectInput.set("disabled", false);
}


registry.byId("DistanceFromActSelect").on("change", function(pk_activity) {
  UpdateEvent(pk_activity, "DistanceFromActEventSelect");
});


registry.byId("DistanceToActSelect").on("change", function(pk_activity) {
  UpdateEvent(pk_activity, "DistanceToActEventSelect");
});



registry.byId("CreateDistance").on("click", function() {
  distanceStore.SaveOrUpdate();
});


registry.byId("SaveDistance").on("click", function() {
  distanceStore.SaveOrUpdate();
});


//     
//  _______  _____   _____  _____  
// |__   __||  __ \ |_   _||  __ \ 
//    | |   | |__) |  | |  | |__) |
//    | |   |  _  /   | |  |  ___/ 
//    | |   | | \ \  _| |_ | |     
//    |_|   |_|  \_\|_____||_|  
// 
//
function SetUpTripDialog(item) {
  grid.refresh();

  if( item ) {
    TripDialog.set("title", "Edit trip");

    domStyle.set(registry.byId("CreateTrip").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteTrip").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateTrip").domNode, "display", "inline");
    domStyle.set(registry.byId("SaveTrip").domNode,      "display", "inline");

    domStyle.set("PkTrip", "display", "table-row");

    item.ConvertModelToForm() 
  } 
  else {
    TripDialog.set("title", "Create a trip");

    domStyle.set(registry.byId("CreateTrip").domNode,    "display", "inline");
    domStyle.set(registry.byId("DuplicateTrip").domNode, "display", "none");
    domStyle.set(registry.byId("DeleteTrip").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveTrip").domNode,      "display", "none");

    domStyle.set("PkTrip", "display", "none");

    // reset filteringselect Minute of rest before and after. Those two are not set to zero.
    registry.byId("TripRestBeforeM").set("value", 0);
    registry.byId("TripRestAfterM").set("value", 0);
  }


  TripDialog.show();
  grid.resize();
}


// connect menu creation trip to trip dialog
registry.byId("MenuBusinessObjectCreateActivityTrip").on("click", function() {
  SetUpTripDialog(); 
});


function TryEnableGrid() {
  var startDate = registry.byId("TripStartDate").get("value");
  var startTime = registry.byId("TripStartTime").get("value");
  if( startDate == null || startTime == null ) {
    return;   
  }

  tripDetailStore.reportTime    = config.reportTime;
  tripDetailStore.releaseTime   = config.releaseTime;
  tripDetailStore.startDateTime = moment.tz([startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), startTime.getHours(), startTime.getMinutes()], config.CalendarTimezoneName);

  if( tripDetailStore.len == 0 ) {

    tripDetailStore.addSync({
      pk      : 1,
      order   : 1,
      type    : "sta",
      station : config.CalendarStation,
    });
    tripDetailStore.addSync({
      pk      : 2,
      order   : 2,
      type    : "leg",
      legType : "A",
      dhour   : 2,
      dminute : 0,
    });
    tripDetailStore.addSync({
      pk      : 3,
      order   : 3,
      type    : "sta",
      station : config.CalendarStation,
    });
  }
  // allow to recompute end date time.
  tripDetailStore.process();
 
}


registry.byId("TripStartDate").on("click,mousedown", function() {
  TryEnableGrid();          
});

registry.byId("TripStartDate").on("change", function(value) {
  TryEnableGrid();          
});

registry.byId("TripStartTime").on("click,mousedown", function() {
  TryEnableGrid();          
});

registry.byId("TripStartTime").on("change", function(value) {
  TryEnableGrid();          
});


registry.byId("TripDialog").on("hide", function() {

  tripDetailStore.fetch().then(function(items) {
    for (var i = items.length - 1; i >= 0; i--) {
      tripDetailStore.removeSync(items[i].pk);
    }           

    grid.refresh();
  });
});


function formatDurationInHoursMinutes(width) {
  return parseInt(width / 60) + "h" + ("0" + width % 60).slice(-2);
}


function getInPeriod(x, width) {
  var tafbInPeriod = 0;

  var Xstart = Math.max(x, XStartPeriod);
  var Xend   = Math.min(x + width, XStartNextPeriod);

  return Math.max(Xend - Xstart, 0);
}


registry.byId("DeleteTrip").on("click", function() {
  activityStore.removeSync(registry.byId("TripPk").get("value"));

  TripDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("DuplicateTrip").on("click", function() {
  registry.byId("TripPk").set("value", "");        
  activityStore.SaveOrUpdate("Trip");
});


registry.byId("CreateTrip").on("click", function() {
  activityStore.SaveOrUpdate("Trip");
});


registry.byId("SaveTrip").on("click", function() {
  activityStore.SaveOrUpdate("Trip");
});


//     
//  _   _   ____  _______  ______ 
// | \ | | / __ \|__   __||  ____|
// |  \| || |  | |  | |   | |__   
// | . ` || |  | |  | |   |  __|  
// | |\  || |__| |  | |   | |____ 
// |_| \_| \____/   |_|   |______|
//                               
//     
registry.byId("NoteDialog").on("hide", function() {
  registry.byId("NoteForm").reset();
  registry.byId("NoteEditor").set("value", "");
  registry.byId("NoteColorPaletteWidget").set("value", "#fff5ee");
});

registry.byId("NoteColorPaletteWidget").on("change", function(value) {
  domStyle.set(dom.byId("NoteColorSwatch"), "backgroundColor", value);
  dijit.popup.close(registry.byId("NoteColorPaletteDialog"));
});

registry.byId("CreateNote").on("click", function() {
  noteStore.SaveOrUpdate();       
});


registry.byId("DeleteNote").on("click", function() {
  noteStore.removeSync(registry.byId("NotePk").get("value"));

  NoteDialog.hide();

  topic.publish("refreshGraph");
});


registry.byId("SaveNote").on("click", function() {
  noteStore.SaveOrUpdate();       
});


// connect menu creation note to note dialog
registry.byId("MenuHighLightsNote").on("click", function() {
  SetUpNoteDialog(); 
});


function SetUpNoteDialog(pkNote) {
  if( pkNote ) {

    NoteDialog.set("title", "Edit note");

    domStyle.set(registry.byId("CreateNote").domNode,    "display", "none");
    domStyle.set(registry.byId("DeleteNote").domNode,    "display", "inline");
    domStyle.set(registry.byId("SaveNote").domNode,      "display", "inline");

    domStyle.set("PkNote", "display", "table-row");

    var note = noteStore.getSync(pkNote);

    registry.byId('NoteForm').set('value', note);
    registry.byId("NoteColorPaletteWidget").set("value", note.get("color"));
  } 
  else {
    NoteDialog.set("title", "Create a note");

    domStyle.set(registry.byId("CreateNote").domNode,    "display", "inline");
    domStyle.set(registry.byId("DeleteNote").domNode,    "display", "none");
    domStyle.set(registry.byId("SaveNote").domNode,      "display", "none");

    domStyle.set("PkNote", "display", "none");
  }

  NoteDialog.show();
}


//     
// __   __  _____  _    _______ 
// \ \ / / / ____|| |  |__   __|
//  \ V / | (___  | |     | |   
//   > <   \___ \ | |     | |   
//  / . \  ____) || |____ | |   
// /_/ \_\|_____/ |______||_|   
//                           
//     

function ProcessXslt(id, strXml, strXslt) {
  if (dojo.IsIE ) {
    alert("IE is not yet supported");
    return;
  }          
  var domParser = new DOMParser();

  var xml  = domParser.parseFromString(strXml,  "text/xml");

  var xsltProcessor = new XSLTProcessor();

  var testTransform = document.implementation.createDocument("", "", null);
  testTransform.addEventListener("load", onload, false);
  testTransform.load(strXslt);

  function onload() {
    xsltProcessor.importStylesheet(testTransform);
          
    var fragment = xsltProcessor.transformToDocument(xml);

    var serializer = new XMLSerializer();

    dom.byId(id).nextSibling.CodeMirror.getDoc().setValue(vkbeautify.xml(serializer.serializeToString(fragment))); 
  }

/*
          // Does not load full xsl Gantt2Trip.xsl file. This file has one include to another file !

  // to transform
  var xslTransform = new XslTransform(strXslt);
  var fragment     = xslTransform.transformXMLDocument(strXml);
  var serializer   = new XMLSerializer();

  dom.byId(id).nextSibling.CodeMirror.getDoc().setValue(vkbeautify.xml(serializer.serializeToString(fragment))); 
*/

}


function SetXslEditor(id) {
  var textarea = dom.byId(id);   

  var editor = CodeMirror.fromTextArea(textarea, {
    lineNumbers: true,
    smartIndent: true,
    mode: "xml",
    indentUnit: 2,
    matchTags: {bothTags: true},
    extraKeys: {"Ctrl-J": "toMatchingTag", 
      "Ctrl-F": function(cm){ cm.foldCode(cm.getCursor()); }},
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    onCursorActivity: function () {
      editor.setLineClass(hlLine, null);
      hlLine = editor.setLineClass(editor.getCursor().line, "activeline");
    },
  });

  editor.on('change', function (cm) {
    textarea.value = cm.getValue();
  });
}



SetXslEditor('XMLqual');
SetXslEditor('XMLacts'); 
SetXslEditor('XMLtrip'); 
SetXslEditor('XMLtrip_sup'); 
SetXslEditor('XMLstation'); 




SaveFileToPIDialog.on("show", function() {
  var s = registry.byId("basicStandby");
  s.show();

  var windowSize = win.getBox();
  var w = Math.floor(windowSize.w * 0.8);
  var h = Math.floor(windowSize.h * 0.6);

  domStyle.set("ici", {
    width: w + "px", 
    height: h + "px",
  });

  SaveStores();

  //get svg source.
  var serializer = new XMLSerializer();
  var strXml = serializer.serializeToString(svg.dom);

  ProcessXslt('XMLqual',     strXml, "xsl/Gantt2Qual.xsl");
  ProcessXslt('XMLacts',     strXml, "xsl/Gantt2Acts.xsl"); 
  ProcessXslt('XMLtrip',     strXml, "xsl/Gantt2Trip.xsl"); 
  ProcessXslt('XMLtrip_sup', strXml, "xsl/Gantt2Trip_sup.xsl"); 
  ProcessXslt('XMLstation',  strXml, "xsl/Gantt2Station.xsl"); 

  s.hide();
});

registry.byId("SaveZipFile").on("click", function() {
  if( !registry.byId("SaveFileToPIForm").validate() ) {
    return;
  }

  SaveFileToPIDialog.hide();   

  var zip = new JSZip();
  zip.file("qual.xml",     dom.byId("XMLqual").value);
  zip.file("acts.xml",     dom.byId("XMLacts").value);
  zip.file("trip.xml",     dom.byId("XMLtrip").value);
  zip.file("trip_sup.xml", dom.byId("XMLtrip_sup").value);
  zip.file("station.xml",  dom.byId("XMLstation").value);

  //get svg source.
  var serializer = new XMLSerializer();
  zip.file("data.svg", serializer.serializeToString(svg.dom));

  var zipFilename = registry.byId("zipFilename").value;

  zip.generateAsync({type:"blob"}).then(function(content) {
    saveAs(content, zipFilename);
  });

  registry.byId("SaveFileToPIForm").reset();
});







/*
 * On mousewheel event, and ctrl or alt keypressed, change the zoom factor.
 */        
on(svg.dom, (!has("mozilla") ? "mousewheel" : "DOMMouseScroll"), function(evt) {
  // check that ctrl or alt key is pressed.             
  if( !evt.ctrlKey && !evt.altKey ) {
    return;
  }

  if(evt.preventDefault) {
    evt.preventDefault();
  }          

//   evt.returnValue = false;

  var delta = evt.wheelDelta ? evt.wheelDelta / 3600 : evt.detail / -90;

  var p = svg.dom.createSVGPoint();

  p.x = evt.clientX;
  p.y = evt.clientY;

  p = p.matrixTransform(svg.domViewport.getCTM().inverse());

  // Compute new scale matrix in current mouse position
  var k = svg.dom.createSVGMatrix().translate(p.x, p.y).scale(1 + delta).translate(-p.x, -p.y);

  var matrix = svg.domViewport.getCTM().multiply(k);

  svg.SetCTM(matrix);

  svg.SetSizeAttributes();

  // update zoom factor, display it, and set fade out in 5 seconds.
  dom.byId("zoom").innerHTML = (matrix.a).toFixed(3);
  domStyle.set("zoom", {opacity: 1});        
  dojo.fadeOut({node: "zoom", duratin: 5000}).play();
});


});

  </script>

</head>
<body class="claro">

  <div id="loader">
    <div id="loaderInner" style="direction:ltr;">Loading libraries ...</div> 
  </div>
  <div id="zoom"></div> <!-- placeholder to display zoom ratio -->
  <div id="basicStandby" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'content', zIndex:1000"></div>
  <div id="content" style="display:none;">
    <div data-dojo-type="dijit/MenuBar" id="navMenu" style="margin-bottom: 8px;">
      <div id="MenuFile" data-dojo-type="dijit/PopupMenuBarItem">
        <span>File</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuFileLoadSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {LoadSvgDialog.show();}">Load an SVG file</div>
          <div id="MenuFileLoadXMLStationFile" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {LoadStationDialog.show();}">Load an XML station file</div>
          <div data-dojo-type="dijit/MenuSeparator"></div>
          <div id="MenuFileSaveSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SaveFileDialog.show();}">Save as SVG file</div>
          <div data-dojo-type="dijit/MenuSeparator"></div>
          <div id="MenuFileExportToPI"         data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SaveFileToPIDialog.show();}">Export to Planner Interface</div>
        </div>
      </div>
      <div id="MenuCalendar" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Calendar</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuCalendarSetStartEnd"     data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SetCalendarDialog.show();}">Set [Start, End[</div>
          <div id="MenuCalendarSetStartPeriods" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SetStartPeriodsDialog.show();}">Set start period(s)</div>
        </div>
      </div>
      <div id="MenuBusinessObject" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Business objects</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuBusinessObjectShowConstants"    data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowConstantsDialog.show();}">Show constants</div>
          <div id="MenuBusinessObjectCreateCrewMember" data-dojo-type="dijit/MenuItem">Create crewmember</div>
          <div data-dojo-type="dijit/PopupMenuItem">
            <span>Create activity</span>
            <div id="MenuBusinessObjectCreateActivity" data-dojo-type="dijit/DropDownMenu">
              <div id="MenuBusinessObjectCreateActivityDayOff"   data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateDayOffDialog.show();}">Day off</div>
              <div id="MenuBusinessObjectCreateActivityVacation" data-dojo-type="dijit/MenuItem">Vacation</div>
              <div data-dojo-type="dijit/MenuSeparator"></div>
              <div id="MenuBusinessObjectCreateActivityTraining"  data-dojo-type="dijit/MenuItem">Training</div>
              <div id="MenuBusinessObjectCreateActivityTrip"      data-dojo-type="dijit/MenuItem">Trip</div>
              <div id="MenuBusinessObjectCreateActivityReserve"   data-dojo-type="dijit/MenuItem">Reserve</div>
              <div id="MenuBusinessObjectCreateActivityTaskGroup" data-dojo-type="dijit/MenuItem" display="none">TaskGroup</div> 
            </div>
          </div>
        </div>
      </div>
      <div id="MenuHighLights" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Highlights</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuHighLightsEvent"    data-dojo-type="dijit/MenuItem">Event(s)</div>
          <div id="MenuHighLightsDistance" data-dojo-type="dijit/MenuItem">Distance</div>
          <div id="MenuHighLightsWindow"   data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {alert('not yet available');}">Window</div>
          <div id="MenuHighLightsNote"     data-dojo-type="dijit/MenuItem">Note</div>
        </div>
      </div>
      <div id="MenuGraphOption" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Graph options</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuGraphOptionCalendar" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowHideCalendarDialog.show();}">Calendar Date/Hours</div>
          <div id="MenuGraphOptionActivity" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowHideActivityDialog.show();}">Activity details</div>
        </div>
      </div>
      <div id="MenuResolution" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Resolution</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="xgc0_25" data-dojo-id="xgcr1" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">0.25</div>
          <div id="xgc0_5" data-dojo-id="xgcr2" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">0.5</div>
          <div id="xgc1" data-dojo-id="xgcr3" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc', checked:true">1</div>
          <div id="xgc2" data-dojo-id="xgcr4" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">2</div>
          <div id="xgc4" data-dojo-id="xgcr5" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">4</div>
          <div id="xgc5" data-dojo-id="xgcr6" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">5</div>
          <div id="xgc6" data-dojo-id="xgcr7" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">6</div>
          <div id="xgc8" data-dojo-id="xgcr8" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">8</div>
          <div id="xgc10" data-dojo-id="xgcr9" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">10</div>
          <div id="xgc12" data-dojo-id="xgcr10" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">12</div>
          <div id="xgc15" data-dojo-id="xgcr11" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">15</div>
          <div id="xgc18" data-dojo-id="xgcr12" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">18</div>
          <div id="xgc20" data-dojo-id="xgcr13" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">20</div>
          <div id="xgc30" data-dojo-id="xgcr14" data-dojo-type="dijit/RadioMenuItem" data-dojo-props="group: 'xgc'">30</div>
        </div>
      </div>
      <div id="MenuCurrentFile" data-dojo-type="dijit/MenuBarItem" data-dojo-props="disabled:true">No file</div>
    </div>

    <!-- SVG code -->
    <div id="gantt">
      <svg id="graph" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" height="300" width="1000">
        <style>
.day_bar {
  fill-opacity : 0.1;
}

.line {
  fill         : gray;
  fill-opacity : 0.5;
}

.day_start_period {
  fill : green;
}

.start_period {
  fill         : green !important;
  fill-opacity : 0.4;
}

.hour_bar {
}

.even {
  fill         : yellow;
  fill-opacity : 0.5;
}
.uneven {
  fill         : blue;
  fill-opacity : 0.1;
}

.day_label {
  text-anchor : middle; 
  font-size   : 40px;
}

.hour_label {
}

.distance_label {
  text-anchor : middle; 
}

.crewmember {
  text-anchor : end; 
  font-size   : 40px;
  fill        : black;
}

.event_label {
  font-weight : bold;
}

/* text inside a box */
.label {
  text-anchor : start; 
  font-size   : 50px;
  fill        : black;
}

.act_hour, .dtl_hour {
  font-size : 9px;
  fill      : black;
}

.start_hour {
  text-anchor : start; 
}

.end_hour {
  text-anchor : end; 
}

.dtl_station, .lbl_duty {
  font-size   : 11px;
  fill        : black;
  text-anchor : middle; 
}

.distance {
  stroke       : gray;
  stroke-width : 1px;
}

.extension {
  stroke       : gray;
  stroke-width : 1px;
}

.LVE {
  fill         : red;
  fill-opacity : 0.5;
}

.DO {
  fill         : orange;
  fill-opacity : 0.8;
}

.TRN {
  fill         : green;
  fill-opacity : 0.6;
}

.RSV {
  fill         : cyan;
  fill-opacity : 0.8;
}

.TRP {
  fill         : blue;
  fill-opacity : 0.6;
}

.LEGA {
  fill         : magenta;
  fill-opacity : 0.6;
}

.LEGD {
  fill         : white;
  fill-opacity : 0.6;
}

.LAY {
  fill         : yellow;
  fill-opacity : 0.7;
}

.STA {
  fill         : gray;
  fill-opacity : 0.6;
}

.TP {
  fill         : pink;
  fill-opacity : 0.6;
}
.REST {
  fill         : purple;
  fill-opacity : 0.6;
}

.brace {
  stroke       : black;
  stroke-width : 1px;
  fill         : none;
}

#calendar_bar >  g > .weekend {
  fill : red;
}

#calendar {
  fill : gray;
}

#calendar > .weekend > .day_label{
  fill : black;
  font-weight: bold;
}
        </style>

        <g id="viewport" transform="matrix(1, 0, 0, 1, 0, 0)">
          <!--
          ====================================================================================
          CALENDAR
          ====================================================================================
          -->
          <g id="calendar_bar" transform="scale(1,1)"></g>
          <g id="calendar">
            <g id="intro">
              <image x="20" y="20" width="140" height="195" xlink:href="images/bob.jpg"/>

              <text x="200" y="50"  style="fill:black;font-size:30px;">Bob, the "problem" builder v0.1</text>
              <text x="200" y="90"  style="fill:black;font-size:15px;">To start, please do one of: </text>
              <text x="220" y="120" style="fill:black;font-size:15px;">- Use File menu to load an XML station file and then Calendar menu to set a period or</text>
              <text x="220" y="150" style="fill:black;font-size:15px;">- Use File menu to load an SVG file.</text>
            </g>
          </g>

          <!--
          ====================================================================================
          CREWMEMBERS
          ====================================================================================
          -->
          <g id="crewmember_bar" transform="scale(1,1)"></g>
          <g id="crewmembers"></g>

          <!--
          ====================================================================================
          OPENTIME
          ====================================================================================
          -->
          <g id="opentime"></g>

          <!--
          ====================================================================================
          NOTES
          ====================================================================================
          -->
          <g id="notes"></g>
        </g>
        <!--
        ====================================================================================
        DSTORE
        ====================================================================================
        -->
        <!-- Those stores are managed automatically by the graph editor. -->
        <g id="ConfigurationStore"></g>
        <g id="CalendarStore"></g>
        <g id="YCoordStore"></g>
        <g id="DistanceStore"></g>
        <g id="CrewMemberStore"></g>
        <g id="ActivityStore"></g>
        <g id="StationStore"></g>
        <g id="EventStore"></g>
        <g id="NoteStore"></g>
      </svg>
    </div>

    <div data-dojo-type="dojo/store/Memory" data-dojo-props="data: hours0To99Data"   data-dojo-id="HourStore"></div>
    <div data-dojo-type="dojo/store/Memory" data-dojo-props="data: minutes0To59Data" data-dojo-id="MinuteStore"></div>
    <div data-dojo-type="dojo/store/Memory" data-dojo-props="data: timezoneData"     data-dojo-id="TimezoneStore"></div>


    <div data-dojo-type="dijit/Dialog" id="TrainingDialog" data-dojo-id="TrainingDialog" title="Create training" style="display: none;" data-dojo-props="onHide: function() {TrainingForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="TrainingForm" data-dojo-id="TrainingForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkTraining">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="TrainingPk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TrainingName" required="true"></td>
          </tr>
          <tr>
            <td><label for="fk_cm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="fk_cm" id="TrainingCrewMemberSelect" required="false"/></td>
          </tr>
          <tr>
            <td><label for="transportationTime">Transportation time apply</label></td>
            <td><input data-dojo-type="dijit/form/CheckBox" name="transportationTime" id="TrainingTransportationTime" value="true" required="true"></td>
          </tr>
          <tr>
            <td><label for="restbefore">Rest before</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_before_hour" id="TrainingRestBeforeH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_before_minute" id="TrainingRestBeforeM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
          <tr>
            <td><label for="start">Start date time</label></td>
            <td class="datetime">
              <input id="TrainingStartDate" name="start_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
              <input id="TrainingStartTime" name="start_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'"/></td>
          </tr>
          <tr>
            <td><label for="duration">Duration</label></td>
            <td>
              <input id="TrainingDurationHour"   class="durationHour" data-dojo-type="dijit/form/ComboBox" name="duration_hour" data-dojo-props="regExp: '\\d+', store: HourStore, placeHolder:'0'" required="true" readonly="true"/>h&nbsp;
              <input id="TrainingDurationMinute" class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="duration_minute" data-dojo-props="store: MinuteStore, placeHolder:'0'" required="true" readonly="true"/>m
            </td>
          </tr>
          <tr>
            <td><label for="end">End date time</label></td>
            <td class="datetime">
              <input id="TrainingEndDate" name="end_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true"/>
              <input id="TrainingEndTime" name="end_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'" readonly="true" disabled="true"/>
            </td>
          </tr>
          <tr>
            <td><label for="restafter">Rest after</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_after_hour" id="TrainingRestAfterH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_after_minute" id="TrainingRestAfterM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateTraining">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteTraining" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DuplicateTraining">Duplicate</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveTraining">Save</button>
        </div>
      </div>
    </div>

    <!-- this is a copy of training, for reserve. -->
    <div data-dojo-type="dijit/Dialog" id="ReserveDialog" data-dojo-id="ReserveDialog" title="Create reserve" style="display: none;" data-dojo-props="onHide: function() {ReserveForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="ReserveForm" data-dojo-id="ReserveForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkReserve">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="ReservePk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="fk_cm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="fk_cm" id="ReserveCrewMemberSelect" required="false"/></td>
          </tr>
          <tr>
            <td><label for="activityType">Type</label></td>
            <td>
              <select data-dojo-type="dijit/form/FilteringSelect" name="activityType" id="ReserveType" required="true">
                <option value="RSV">Reserve (RSV)</option>
                <option value="SBY">Home standby (SBY)</option>
                <option value="ASBY">Airport standby (ASBY)</option>
                <option value="TSBY">Standby for training (TSBY)</option>
                <option value="USBY">ULR standby (USBY)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="transportationTime">Transportation time apply</label></td>
            <td><input data-dojo-type="dijit/form/CheckBox" name="transportationTime" id="ReserveTransportationTime" value="true" required="true"></td>
          </tr>
          <tr>
            <td><label for="restbefore">Rest before</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_before_hour" id="ReserveRestBeforeH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_before_minute" id="ReserveRestBeforeM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
          <tr>
            <td><label for="start">Start date time</label></td>
            <td class="datetime">
              <input id="ReserveStartDate" name="start_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
              <input id="ReserveStartTime" name="start_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'"/></td>
          </tr>
          <tr>
            <td><label for="duration">Duration</label></td>
            <td>
              <input id="ReserveDurationHour"   class="durationHour" data-dojo-type="dijit/form/ComboBox" name="duration_hour" data-dojo-props="regExp: '\\d+', store: HourStore, placeHolder:'0'" required="true" readonly="true"/>h&nbsp;
              <input id="ReserveDurationMinute" class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="duration_minute" data-dojo-props="store: MinuteStore, placeHolder:'0'" required="true" readonly="true"/>m
            </td>
          </tr>
          <tr>
            <td><label for="end">End date time</label></td>
            <td class="datetime">
              <input id="ReserveEndDate" name="end_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true"/>
              <input id="ReserveEndTime" name="end_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'" readonly="true" disabled="true"/>
            </td>
          </tr>
          <tr>
            <td><label for="restafter">Rest after</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_after_hour" id="ReserveRestAfterH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_after_minute" id="ReserveRestAfterM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateReserve">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteReserve" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DuplicateReserve">Duplicate</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveReserve">Save</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" id="ShowHideActivityDialog" data-dojo-id="ShowHideActivityDialog" title="Show/hide activity details" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowHideActivityForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="SHActivityHours">Show activity hour label</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityHours" id="SHActivityHours" data-dojo-id="SHActivityHours"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetails">Show activity details (leg/layover)</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetails" id="SHActivityDetails" data-dojo-id="SHActivityDetails"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetailHours">Show activity detail hours</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetailHours" id="SHActivityDetailHours" data-dojo-id="SHActivityDetailHours"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetailStations">Show activity detail stations</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetailStations" id="SHActivityDetailStations" data-dojo-id="SHActivityDetailStations"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDuties">Show activity duties</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDuties" id="SHActivityDuties" data-dojo-id="SHActivityDuties"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){ShowHideActivityDialog.hide();}">Close</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="ShowHideCalendarDialog" data-dojo-id="ShowHideCalendarDialog" title="Show/hide Calendar items" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowHideCalendarForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="SHCalendarHours">Show calendar hour label</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHours" id="SHCalendarHours" data-dojo-id="SHCalendarHours"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarHourBars">Show calendar hour bars</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHourBars" id="SHCalendarHourBars" data-dojo-id="SHCalendarHourBars"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayX">Show calendar Day X</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayX" id="SHCalendarDayX" data-dojo-id="SHCalendarDayX"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayYYYYMMDD">Show calendar day YYYY-MM-DD</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayYYYYMMDD" id="SHCalendarDayYYYYMMDD" data-dojo-id="SHCalendarDayYYYYMMDD"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayBars">Show calendar day bars</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayBars" id="SHCalendarDayBars" data-dojo-id="SHCalendarDayBars"></td>
          </tr>
          <tr>
            <td><label>Week end days</label></td>
            <td>
              <table>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarMon" id="SHCalendarMon" data-dojo-id="SHCalendarMon"></td>
                  <td><label for="SHCalendarMon">Monday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarTue" id="SHCalendarTue" data-dojo-id="SHCalendarTue"></td>
                  <td><label for="SHCalendarTue">Tuesday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarWed" id="SHCalendarWed" data-dojo-id="SHCalendarWed"></td>
                  <td><label for="SHCalendarWed">Wednesday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarThu" id="SHCalendarThu" data-dojo-id="SHCalendarThu"></td>
                  <td><label for="SHCalendarThu">Thursday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarFri" id="SHCalendarFri" data-dojo-id="SHCalendarFri"></td>
                  <td><label for="SHCalendarFri">Friday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarSat" id="SHCalendarSat" data-dojo-id="SHCalendarSat"></td>
                  <td><label for="SHCalendarSat">Saturday</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarSun" id="SHCalendarSun" data-dojo-id="SHCalendarSun"></td>
                  <td><label for="SHCalendarSun">Sunday</label></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){ShowHideCalendarDialog.hide();}">Close</button>
        </div>
      </div>
    </div>
    
    <!-- TODO: create a tpl, since LoadSvgDialog and LoadStationDialog look the same -->
    <div data-dojo-type="dijit/Dialog" data-dojo-id="LoadSvgDialog" title="Load an SVG file" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="LoadSvgForm" data-dojo-id="LoadSvgForm" encType="multipart/form-data" action="" method="">
        <p><b>Warning</b>, this operation will delete the current graph.</p>
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td>
              <input name="uploadedfile" multiple="false" type="file" id="uploaderSVG" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an SVG File'"/> 
            </td>
          </tr>
          <tr>
            <td>
              <div id="files2" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploaderSVG"></div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){LoadSvgDialog.hide();}">Cancel</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="LoadSvg">Load file</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="LoadStationDialog" data-dojo-id="LoadStationDialog" title="Load an XML station file" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="LoadStationForm" data-dojo-id="LoadStationForm" encType="multipart/form-data" action="" method="">
        <p><b>Warning</b>, this operation will delete the current graph.</p>
        <div style="width: 350px; height: 300px">
          <div data-dojo-type="dijit.layout.TabContainer" style="width: 100%; height: 100%;">
            <div data-dojo-type="dijit.layout.ContentPane" title="User selection">
              <table class="dijitDialogPaneContentArea">
                <tr>
                  <td>
                    <input name="uploadedfile" multiple="false" type="file" id="uploaderStation" data-dojo-id="uploaderStation" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an XML File'"/> 
                  </td>
                </tr>
                <tr>
                  <td>
                    <div id="files" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploaderStation"/>
                  </td>
                </tr>
              </table>
              <button data-dojo-type="dijit/form/Button" type="button" id="LoadStation" style="float:right;">Load file</button>
            </div>
            <div data-dojo-type="dijit.layout.ContentPane" title="Template stations" selected="true">
              <input type="radio" data-dojo-type="dijit/form/RadioButton" name="tplStation" id="station128" value="station128.xml" /> <label for="station128">128 stations around the world</label> <br />
              <input type="radio" data-dojo-type="dijit/form/RadioButton" name="tplStation" id="station3"   value="station3.xml"   /> <label for="station3">3 stations (AUH, BEG &amp; SEZ)</label> <br />
              <button data-dojo-type="dijit/form/Button" type="button" id="UseStation" style="float:right;">Use file</button>
            </div>
          </div>
        </div>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" data-dojo-props="onClick:function(){LoadStationDialog.hide();}">Cancel</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileDialog" title="Save SVG graph as a file" style="display: none;">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="filename">Filename:</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="filename" data-dojo-props="placeHolder: '.svg'" required="true"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveFile">Save file</button>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileToPIDialog" title="Save XML files compatible with PI" style="display: none;">
      <div id="SaveFileToPIDialogContent" class ="dijitDialogPaneContentArea">

        <div data-dojo-type="dijit/form/Form" id="SaveFileToPIForm" data-dojo-id="SaveFileToPIForm" encType="multipart/form-data" action="" method="">
          <table >
            <tr>
              <td><label for="filename">ZIP filename</label></td>
              <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="zipFilename" data-dojo-props="placeHolder: '.zip'" required="true"/></td>
            </tr>
            <tr>
              <td><label for="data">XML data</label></td>
              <td>
                <div data-dojo-type="dijit/layout/TabContainer" id="ici" style="width: 100%; height: 100%;">
                  <div data-dojo-type="dijit/layout/ContentPane" title="qual.xml" data-dojo-props="selected:true">
                    <textarea id="XMLqual"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="acts.xml">
                    <textarea id="XMLacts"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="trip.xml">
                    <textarea id="XMLtrip"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="trip_sup.xml">
                    <textarea id="XMLtrip_sup"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="station.xml">
                    <textarea id="XMLstation"></textarea>
                  </div>
                </div>
              </td>
            </tr>
          </table>
          <p style="margin-top: 0; margin-bottom: 0; font-size: small;">You can use <b>Ctrl+J</b> to go to matching tag, and <b>Ctrl+F</b> to fold/unfold the current line.</p>
        </div>
      </div>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveZipFile">Save zip file</button>
      </div>
    </div>




    <div data-dojo-type="dijit/Dialog" id="SetCalendarDialog" data-dojo-id="SetCalendarDialog" title="Set calendar" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="SetCalendarForm" data-dojo-id="SetCalendarForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="CalendarTimezone">Timezone</label></td>
            <td><input data-dojo-type="dijit/form/FilteringSelect" data-dojo-id="CalendarTimezone" name="CalendarTimezone" id="CalendarTimezone" required="true" data-dojo-props="store: TimezoneStore, labelAttr:'name', searchAttr:'name', identifier:'id'"></td>
          </tr>
          <tr>
            <td><label for="CalendarStation">Station</label></td>
            <td><input data-dojo-type="dijit/form/FilteringSelect" data-dojo-id="CalendarStation" name="CalendarStation" id="CalendarStation" required="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="CalendarStart">Start date</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="CalendarStart" id="CalendarStart" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
          <tr>
            <td><label for="CalendarEnd">End date (excluded)</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="CalendarEnd" id="CalendarEnd" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SetCalendar">Set</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" id="SetStartPeriodsDialog" data-dojo-id="SetStartPeriodsDialog" title="Set start period(s)" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="SetStartPeriodsForm" data-dojo-id="SetStartPeriodsForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="start">Start period date(s)</label></td>
            <td><input multiple="true" data-dojo-type="dojox/form/CheckedMultiSelect" name="start" id="CalendarStartPeriods" size="14"></td>
          </tr>
          <tr>
            <td><label for="create">Create related event(s)</label></td>
            <td><input id="CalendarStartCreateEvent" name="create" data-dojo-type="dijit/form/CheckBox"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SetStartPeriods">Set</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDayOffDialog" title="Create day off" style="display: none;" data-dojo-props="onHide: function() {CreateDayOffForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateDayOffForm" data-dojo-id="CreateDayOffForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="crewmemeber">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="crewmember" id="DayOffCrewMemberSelect" required="true"></td>
          </tr>
          <tr>
            <td><label for="activityType">Type</label></td>
            <td>
              <select data-dojo-type="dijit/form/FilteringSelect" name="activityType" id="DayOffType" required="true">
                <option value="OFF">Day Off (OFF)</option>
                <option value="ROFF">Requested Day Off (ROFF)</option>
                <option value="OOFF">Out of base Day Off (OOFF)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="start">date(s)</label></td>
            <td><select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="start" id="DayOffDatesSelect" required="true"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateDayOff">Create</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" id="CrewMemberDialog" data-dojo-id="CrewMemberDialog" title="Create crew member" style="display: none;" data-dojo-props="onHide: function() {CrewMemberForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CrewMemberForm" data-dojo-id="CrewMemberForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkCrewMember">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="CrewMemberPk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="CrewMemberName" required="true"></td>
          </tr>
          <tr>
            <td><label for="birthdate">Birth date</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="birthdate" id="CrewMemberBirthDate" required="true"  data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"   ></td>
          </tr>
        </table>


        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateCrewMember">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteCrewMember" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveCrewMember">Save</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="ShowConstantsDialog" data-dojo-id="ShowConstantsDialog" title="Set constants" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowConstantsForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="transportationTime">Transportation time duration (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="transportationTime" id="transportationTime" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="reportTime">Report time (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="reportTime" id="reportTime" value="20" data-dojo-props="regExp: '\\d+', store: HourStore" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="releaseTime">Release time (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="releaseTime" id="releaseTime" value="15" data-dojo-props="regExp: '\\d+', store: HourStore" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="midnightOffset">Midnight offset (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="midnightOffset" id="midnightOffset" value="0" data-dojo-props="regExp: '\\d+', store: HourStore, constraints:{max: 1440}" required="true" style="width: 5em;"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveConstants">Save</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="EventDialog" data-dojo-id="EventDialog" title="Create an event" style="display: none;" data-dojo-props="onHide: function() {EventForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="EventForm" data-dojo-id="EventForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkEvent">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="EventPk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="label">Label</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="label" id="EventLabel" required="true"></td>
          </tr>
          <tr>
            <td><label for="days">Date(s)</label></td>
            <td>
              <select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="days" id="EventDatesSelect" required="true"></select>
              <button data-dojo-type="dijit/form/Button" type="button" id="EventInvertSelectionDates">Invert selection</button>
            </td>
          </tr>
          <tr>
            <td><label for="time">Time</label></td>
            <td class="datetime">
              <input id="EventTime" name="time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'" required="true"/>
            </td>
          </tr>
          <tr>
            <td><label for="color">Color</label></td>
            <td>
              <div id="EventColor" style="background-color: FFFFFF; border-color: black; border-width: 1px;" dojoType="dijit/form/DropDownButton">
                <span id="EventColorText"><span id="EventColorSwatch" style="height: 10px; width: 80px; border: 1px solid black; background-color: #fff5ee;">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
                <div dojoType="dijit/TooltipDialog" id="EventColorPaletteDialog" title="Color Palette">
                <div dojoType="dijit/ColorPalette" name="color" id="EventColorPaletteWidget"></div>                    
              </div>
            </td>
          </tr>
          <tr>
            <td><label for="thickness">Thichness</label></td>
            <td>
              <select data-dojo-type="dijit/form/FilteringSelect" name="thickness" id="EventThickness" value="1" required="true">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="7">7</option>
              </select>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateEvent">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteEvent" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteAllEvents" class="delete">Delete all</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveEvent">Save</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="DistanceDialog" data-dojo-id="DistanceDialog" title="Distance" style="display: none;" data-dojo-props="onHide: function() {DistanceForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="DistanceForm" data-dojo-id="DistanceForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkDistance">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="DistancePk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="From">From</label></td>
            <td>
              <div style="width: 40em; height: 7em;">
                <div data-dojo-type="dijit/layout/TabContainer" id="DistanceFromTabContainer" style="width: 100%; height: 100%;">
                  <div data-dojo-type="dijit/layout/ContentPane" id="DistanceFromActivity" title="an activity" data-dojo-props="selected:true">
                    <table class="dstFromAct">
                      <tr>
                        <td><label for="From">activity name</label></td>
                        <td><select data-dojo-type="dijit/form/FilteringSelect" name="From" id="DistanceFromActSelect" style="width: 30em;"></td>
                      </tr>
                      <tr>
                        <td><label for="From">activity event</label></td>
                        <td><select data-dojo-type="dijit/form/Select" id="DistanceFromActEventSelect" disabled="true"></td>
                      </tr>
                    </table>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" id="DistanceFromEvent" title="an event">
                    <table class="dstFromEvt">
                      <tr>
                        <td><label for="From">event</label></td>
                        <td><select data-dojo-type="dijit/form/Select" id="DistanceFromEventSelect"></td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td><label for="To">To</label></td>
            <td>
              <div style="width: 40em; height: 7em;">
                <div data-dojo-type="dijit/layout/TabContainer" id="DistanceToTabContainer" style="width: 100%; height: 100%;">
                  <div data-dojo-type="dijit/layout/ContentPane" id="DistanceToActivity" title="an activity" data-dojo-props="selected:true">
                    <table class="dstToAct">
                      <tr>
                        <td><label for="To">activity name</label></td>
                        <td><select data-dojo-type="dijit/form/FilteringSelect" name="To" id="DistanceToActSelect" style="width: 30em;"></td>
                      </tr>
                      <tr>
                        <td><label for="To">activity event</label></td>
                        <td><select data-dojo-type="dijit/form/Select" id="DistanceToActEventSelect" disabled="true"></td>
                      </tr>
                    </table>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" id="DistanceToEvent" title="an event">
                    <table class="dstToEvt">
                      <tr>
                        <td><label for="To">event</label></td>
                        <td><select data-dojo-type="dijit/form/Select" id="DistanceToEventSelect"></td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateDistance">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteDistance" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveDistance">Save</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="TripDialog" data-dojo-id="TripDialog" title="Create trip" style="display: none;" data-dojo-props="onHide: function() {TripForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="TripForm" data-dojo-id="TripForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkTrip">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="TripPk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TripName" required="true"></td>
          </tr>
          <tr>
            <td><label for="fk_cm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="fk_cm" id="TripCrewMemberSelect" required="false"/></td>
          </tr>
          <tr>
            <td><label for="transportationTime">Transportation time apply</label></td>
            <td><input data-dojo-type="dijit/form/CheckBox" name="transportationTime" id="TripTransportationTime" value="true" required="true"></td>
          </tr>
          <tr>
            <td><label for="restbefore">Rest before</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_before_hour" id="TripRestBeforeH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_before_minute" id="TripRestBeforeM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
          <tr>
            <td><label for="start">Start date time</label></td>
            <td class="datetime">
              <input id="TripStartDate" name="start_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
              <input id="TripStartTime" name="start_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'"/>
            </td>
          </tr>
          <tr>
            <td><label>Details</label></td>
            <td><div id="TripGrid"></div></td>
          </tr>
          <tr>
            <td><label for="end">End date time</label></td>
            <td class="datetime">
              <input id="TripEndDate" name="end_date" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true"/>
              <input id="TripEndTime" name="end_time" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'hh:mm'" readonly="true" disabled="true"/>
            </td>
          </tr>
          <tr>
            <td><label for="restafter">Rest after</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="rest_after_hour" id="TripRestAfterH" value="0" data-dojo-props="regExp: '\\d+', store: HourStore" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="rest_after_minute" id="TripRestAfterM" value="0" data-dojo-props="store: MinuteStore" required="true">m
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateTrip">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteTrip" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DuplicateTrip">Duplicate</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveTrip">Save</button>
        </div>
      </div>
    </div>

    <div data-dojo-type="dijit/Dialog" id="NoteDialog" data-dojo-id="NoteDialog" title="Write a note" style="display: none;" data-dojo-props="onHide: function(){NoteForm.reset();}, _onKey: function(){}" >
      <div data-dojo-type="dijit/form/Form" id="NoteForm" data-dojo-id="NoteForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkNote">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="NotePk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="note">Note</label></td>
            <td>
              <div data-dojo-type="dijit/Editor" id="NoteEditor" name="note" data-dojo-props="plugins:[     'undo', 'redo', 
                                                                                                       '|', 'foreColor', 'hiliteColor', 'fontSize',
                                                                                                       '|', 'bold','italic','underline','strikethrough','subscript','superscript',
                                                                                                       '|', 'indent', 'outdent', 'justifyLeft', 'justifyCenter', 'justifyRight',
                                                                                                       '|', {name: 'insertTable'}, {name: 'modifyTable'}, {name: 'insertTableRowBefore'}, {name: 'insertTableRowAfter'}, {name: 'insertTableColumnBefore'}, {name: 'insertTableColumnAfter'}, {name: 'deleteTableRow'}, {name: 'deleteTableColumn'}, {name: 'colorTableCell'}, {name: 'tableContextMenu'},
                                                                                                       '|', 'viewsource' ]" />
              <!--div data-dojo-type="dijit/Editor" id="NoteEditor" name="note" / -->
            </td>
          </tr>
          <tr>
            <td><label for="color">Background color</label></td>
            <td>
              <div id="NoteBackgroundColor" style="background-color: FFFFFF; border-color: black; border-width: 1px;" dojoType="dijit/form/DropDownButton">
                <span id="colorText"><span id="NoteColorSwatch" style="height: 10px; width: 80px; border: 1px solid black; background-color: #fff5ee;">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
                <div dojoType="dijit/TooltipDialog" id="NoteColorPaletteDialog" title="Color Palette">
                <div dojoType="dijit/ColorPalette" name="color" id="NoteColorPaletteWidget"></div>                    
              </div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateNote">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteNote" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveNote">Save</button>
        </div>
      </div>
    </div>

    <div data-dojo-type="dijit/Dialog" id="VacationDialog" data-dojo-id="VacationDialog" title="Create vacation" style="display: none;"  data-dojo-props="onHide: function() {VacationForm.reset();}">
      <div data-dojo-type="dijit/form/Form" id="VacationForm" data-dojo-id="VacationForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr id="PkVacation">
            <td><label for="pk">Primary key</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="pk" id="VacationPk" readonly="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="fk_cm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="fk_cm" id="VacationCrewMemberSelect" required="true"/></td>
          </tr>
          <tr>
            <td><label for="activityType">Type</label></td>
            <td>
              <select data-dojo-type="dijit/form/FilteringSelect" name="activityType" id="VacationType" required="true">
                <option value="LVE">Leave (LVE)</option>
                <option value="ULVE">Unpaid leave (ULVE)</option>
                <option value="RLV">Requested leave (RLV)</option>
                <option value="ELV">Emergency leave (ELV)</option>
                <option value="MLV">Maternity/Paternity leave (MLV)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="start_date">Start date</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="start_date" id="VacationStartDate" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
          <tr>
            <td><label for="end_date">End date (excluded)</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="end_date" id="VacationEndDate" disabled="true" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateVacation">Create</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DeleteVacation" class="delete">Delete</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="DuplicateVacation">Duplicate</button>
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveVacation">Save</button>
        </div>
      </div>
    </div>


    <!-- 
      <script type="text/template" id="activity-dialog-template">
<div style="width:300px;">

      <div class="dijitDialogPaneContentArea">
        <div data-dojo-attach-point="contentNode">
            ${message}              
        </div>
      </div>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" data-dojo-attach-point="closeButton" >Close</button>
        <button data-dojo-type="dijit.form.Button" data-dojo-attach-point="cancelButton" >DELETE </button> 
      </div>

    </div>
      </script>
      -->

  </div> 
</html>
