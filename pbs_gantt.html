<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /> 
  
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dijit/themes/claro/claro.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/CheckedMultiSelect.css" />
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojox/form/resources/UploaderFileList.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/dgrid.css" />
  <link rel="stylesheet" href="http://cdn.rawgit.com/SitePen/dgrid/v1.1.0/css/skins/claro.css" />
  <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css"/>
  <link rel="stylesheet" href="http://codemirror.net/addon/fold/foldgutter.css" />

  <style type="text/css">

.thinButton .dijitButtonNode {
  padding: 0px !important;	
}

.thinButtonHover .dijitButtonNode {
  border-color:#a5beda !important;
  border-bottom-color:#5c7590 !important;
  border-right-color:#5c7590 !important;
  color:#000 !important;
  background:#fcfdff url(/dojo/dijit/themes/claro/images/buttonHover.png) repeat-x bottom !important;
}

.thinButtonActive .dijitButtonNode {
  border-color:#366dba !important;
  background: #ededed url(/dojo/dijit/themes/claro/images/buttonActive.png) bottom repeat-x !important;
}

.datetime {
  border: 1px solid #759dc0;
  background: white;
  display: inline-block;
  width: auto;
  vertical-align: middle;
}

.datetime > .dijitDateTextBox {
  border: none;
  padding-left: .25em;
  width: 10em;
}

.datetime > .dijitDateTextBox > .dijitButtonNode {
  border: none;
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAABp0lEQVQ4y43TP2hTcRAH8E/CI4QGRKSGugkiooNUhYh9k6i4COIah4JDFkclKthFUfHFvRBQqEMGQR2LoHaKfzKo7dBRFBxEHByaIkGiyz14hoIe/Ljffe9+x9337lcyIWkrW8UBpP1ue1DAP6OOI/1uez3HS2krq+AyjuEWlrEd53AeU7iG1XhzHJfwGvcSLOJCOO9PFHQyknUm8DNx9iRoFhyHcBN78Q3bAp/FAnZNJGqWUS0A13EKO/AU5cA7OIppPC7EV5O4vIpTlIe2lgeh5zCXJ1jAGxzEZr/bXktbWYLDGOPdcNAb1xrNWVSwFglelNJW9juYPY2rkXA/GlgK+yy+4m3YVzDASrnYz8R90p7aKjYpgEv4iSHW8R23w/cyfDeihUeY+SvBcND7UGs0P2HU77ZH+JK2srsY97vtjdjGDpLhoPej1mjO5JuYczAXmzjCviAwH9mJqOh9jPZiVLlSbGFn6EpsX73gq8c0cs6mixyMQy9jNzbxEb/wJOIG2IjeK3gepI5LaSvrB0F34tH/SBIfrJpgPibwrFDiv2Qcizf/B6rfbiV80qpEAAAAAElFTkSuQmCC);
  background-color: transparent;
  background-repeat: no-repeat;
  background-position: center;
  width: 22px;
  height: 22px;
}

.datetime > .dijitDateTextBox > .dijitButtonNode > .dijitArrowButtonInner,
.datetime > .dijitTimeTextBox > .dijitButtonNode > .dijitArrowButtonInner {
  display: none;
}

.datetime > .dijitTimeTextBox {
  border: none;
  padding-left: .25em;
  width: 5em;
}

.datetime > .dijitTimeTextBox > .dijitArrowButton {
  border: none;
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y7WVP2gUQRTGf1mWrSSIEYuUqcTqPAiIf1aCzXkowTKt0wSzTYoUB8oRPEhxRZpRYjGWkjZNuEaEASHVkTqF5SFyhJBKDjnSfIOTIXeXQl/1dt5737739ptv55hiZeXmgTqwqKMB0PfWnE+qmZsA9ABoAQ2gSMIjoAfseGuOpgKWlSuAXeBNdDwGhvJvA1l0vgdsemtGITlLwA4isGNgDVgAngMv5a8plin3QLWXAdVZQ34HWPbW7HtrzoAaUPfWnHlr9oFl5aCa3Usja2ff9YKOt+Yd17Cycu+Btxr/kbfmKFesJbBjoD0D5B6wCWwA28ALTdACVjNRI4za9daMo+LHZeXuJGBfgYdA5q35A3TD6GXl5nPxrFDbh0lDn4C8rNwKcFNgp8Azb81v5RyqtgDqWUTaIbBUVm49AnwF3AC+JWA/1fFr4G5Eq8Vs2r68NSfAikAHwNMAlvCUmDaDiLQ/vDV7V4DeB554a4ZJ7DNwolqAQQ70dZ0KoAl8uaLTX1MGaaqxEdDPdNF7Cm6Vlcu5pil3S489b8152OGOdlGbxcPE2qoZC+OvOJSV+xDd4w6wLZ6Fr1mE/aqztm4JwEdvzUYKGMShEYlDVzxbAnJ9gKbGrIVRgdWgOJPkaz2RqVP5t2bJ1/8V2H/xC7gA3Mu8RLBms9sAAAAASUVORK5CYII%3D);
  background-color: transparent;
  background-repeat: no-repeat;
  background-position: center;
  width: 22px;
  height: 22px;
}

.datetime > .timezone {
  display: inline-block;
  height: 22px;
  width: 2em;
  padding-left: .25em;
}

.datetime > .dijitTimeTextBox > .dijitInputContainer > span.dijitPlaceHolder {
  padding-top: 2px;
}

.durationHour {
  width: 4.25em;
}
.durationMinute {
  width: 3.25em;
}

#CalendarStartPeriods {
  height: 14em; /* DOES NOT WORK */
}

.dgrid {
  margin: 0px;
}
.dgrid-grid {
  width: 900px;
}
.dgrid-list {
  width: 200px;
}
.dgrid {
  font-size: 12px;
}

.dgrid .field-pk {
  width: 2em;
}
.dgrid .field-order {
  width: 2em;
}
.dgrid .field-station {
  width: 6em;
}
.dgrid .field-lblType {
  width: 9em;
}
.dgrid .field-legType {
  width: 8em;
}
.dgrid .field-startDateTime {
  width: 11em;
  color: gray;
}
.dgrid .field-dhour {
  width: 6em;
}
.dgrid .field-dminute {
  width: 6em;
}
.dgrid .field-endDateTime {
  width: 11em;
  color: gray;
}

.dgrid-row-even {
  background-color: ivory !important;
}

.CodeMirror {
  border: 1px solid gray;
  height: 100%;
}

  </style>

  <script>
var dojoConfig = {
  async: true, 
  debug: true,
  packages: [{
    name: "dstore",
    location: "https://cdn.rawgit.com/SitePen/dstore/v1.1.1"
  }, {
    name: "dmodel",
    location: "https://cdn.rawgit.com/SitePen/dmodel/master"
  }, {
    name: "dgrid",
    location: "https://cdn.rawgit.com/SitePen/dgrid/v1.1.0"
  }, {
    name: "moment",
    location: "https://cdn.rawgit.com/moment/moment/2.17.1",
    main: "moment"
  }, {
    name: "moment-timezone",
    location: "https://cdn.rawgit.com/moment/moment-timezone/0.5.10",
    main: "timezone"
  }, {
    name: "codemirror",
    location: "http://codemirror.net/",
  }, {
    name: "vkbeautify",
    location: "https://cdn.rawgit.com/vkiryukhin/vkBeautify/0a238953",
  }, {
    name: "jszip",
    location: "https://cdn.rawgit.com/Stuk/jszip/v3.1.3/dist/",
  }, {
    name: "filesaver",
    location: "https://cdn.rawgit.com/eligrey/FileSaver.js/1.3.3",
  }
  ]
};
  </script>

  <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.12.2/dojo/dojo.js"></script>


  <script>
require([
  "dojo/text!./xml/Gantt2Qual.xsl",
  "dojo/text!./xml/Gantt2Station.xsl",
  "dojo/text!./xml/Gantt2Trip_sup.xsl",
  "dojo/text!./xml/Gantt2Trip.xsl",
  "dojo/text!./xml/Gantt2Acts.xsl",
  "dojo/_base/declare",
  "dojo/window",
  "dojo/sniff",
  "dojo/on",
  "dojo/topic",
  "dojo/touch",
  "dojo/dom",
  "dojo/dom-style",
  "dojo/dom-construct",
  "dojo/parser",
  "dojo/request/script",
  "dojo/date",
  "dojo/Stateful", 
  "dojo/query", 
  "dojo/data/ObjectStore", 
  "dojo/store/Memory", 
  "dojo/store/Observable",
  "dijit/_Widget",
  "dijit/registry",
  "dijit/Dialog",
  "dijit/form/Button",
  "dijit/form/Select",
  "dijit/form/FilteringSelect",
  "dijit/form/ComboBox",
  "dojox/xml/parser", 
  "dojox/widget/Standby",
  "dojox/form/CheckedMultiSelect",
  "dstore/Memory",
  "dstore/Trackable",
  "dstore/legacy/DstoreAdapter",
  "dmodel/Model",
  "dmodel/ComputedProperty",
  "dgrid/OnDemandGrid", 
  "dgrid/Selection", 
  "dgrid/Keyboard", 
  "dgrid/Editor", 
  "dgrid/extensions/CompoundColumns",
  "moment/moment",
  "moment-timezone/builds/moment-timezone-with-data",
  "codemirror/lib/codemirror",
  "jszip/jszip",
  "filesaver/FileSaver",
  
  "dojo/domReady!",

  "dijit/MenuBar",
  "dijit/PopupMenuBarItem",
  "dijit/Menu",
  "dijit/MenuItem",
  "dijit/MenuBarItem",
  "dijit/DropDownMenu",
  "dijit/CheckedMenuItem",
  "dijit/ColorPalette",
  "dijit/form/Form",
  "dijit/form/CheckBox",
  "dijit/form/TextBox",
  "dijit/form/DateTextBox",
  "dijit/form/TimeTextBox",
  "dijit/form/DropDownButton",
  "dijit/form/RadioButton",
  "dijit/layout/TabContainer", 
  "dijit/layout/ContentPane", 
  "dijit/Editor",
  "dijit/ColorPalette",
  "dijit/TooltipDialog",
  "dojox/layout/TableContainer",
  "dojox/form/Uploader",
  "dojox/form/uploader/FileList",
  "codemirror/mode/xml/xml",
  "codemirror/addon/fold/xml-fold",
  "codemirror/addon/edit/matchtags",
  "codemirror/addon/fold/foldgutter",
  "codemirror/addon/fold/brace-fold",
  "vkbeautify/vkbeautify",
], function(
  Gantt2QualXsl,
  Gantt2StationXsl,
  Gantt2TripSupXsl,
  Gantt2TripXsl,
  Gantt2ActsXsl,
  // dojo section    
  declare,
  win,
  has,
  on, 
  topic,
  touch,
  dom, 
  domStyle,
  domConstruct, 
  parser, 
  script,
  date,
  Stateful,
  query,
  ObjectStore, 
  LegacyMemory,
  LegacyObservable,
  // dijit section
  _WidgetBase,
  registry, 
  Dialog,
  Button,
  Select,
  FilteringSelect,
  ComboBox,
  // dojox section
  xmlparser,
  Standby,
  CheckedMultiSelect,
  // dstore section
  Memory,
  Trackable,
  DstoreAdapter,
  // dmodel section
  Model,
  ComputedProperty,
  // dgrid section
  OnDemandGrid, 
  Selection, 
  Keyboard, 
  Editor, 
  CompoundColumns,
  // moment section
  moment,
  timezone,
  // codemirror section 
  CodeMirror,
  JSZip,
  FileSaver
//  ganttSVG
  ) {

    // About the coordinates:
    // X axis is the datetime. the first day of the graph start at 0. and a day is 1440 long (except dst ones).
    
    var XStartPeriod      = -1;  // X position of the start period. -1 means not set yet.
    var XStartNextPeriod  = -1;  // X position of the next start periode.
                                 // The two previous variables are used to compute InPeriod data as credit, block
                                 // tafb, etc...

    var OpenTimeLineCount = 0;   // Number of lines required to draw opentime activities without overlaps.
                                 
    /*
     * Resize graph size according to window size, then svg graph is the bigger it
     * is possible.
     */
    on(window, "resize", function() {
      var windowSize = win.getBox();

      domStyle.set("graph", { height: windowSize.h - 3 * 8 - dom.byId("navMenu").offsetHeight + "px" });
    });


    /*
     * Fix to support reset on CheckedMultiSelect.
     * source: http://jsfiddle.net/FNL3h/
     */
    var FixedCheckedMultiSelect = declare("dojox/form/FixedCheckedMultiSelect", [ CheckedMultiSelect ], {
      reset: function() {
        this.inherited(arguments);
        if (!this._resetValue || !this._resetValue.length) {
          this._updateSelection();
        }
      },
      validator: function() {
        if (!this.required) {
          return true;
        }
        return this.value.length > 0 ? true : false; 
      },
    });

    // ===============================================
    // Set data for duration input.
    // ===============================================
    var zeroTo99 = [];
    for( i = 0; i < 100; ++i ) {
      zeroTo99.push({name: i, id: i});
    } 
    var zeroTo59 = [];
    for( i = 0; i < 60; ++i ) {
      zeroTo59.push({name: i, id: i});
    } 

    var zeroTo59Store = new LegacyMemory({ data: zeroTo59 });
    var zeroTo99Store = new LegacyMemory({ data: zeroTo99 });




    // ===============================================
    // Widget for leg/lay/station.
    // ===============================================
    var CustomEditorOperations = declare([_WidgetBase], {
      value: null,
      buildRendering: function() {
        var self = this;
        this.inherited(arguments);

        self._buttonLeg = new Button({
          label: "New leg",
          class: "thinButton",
        });
        self._buttonLayover = new Button({
          label: "New layover",
          class: "thinButton",
        });
        self._buttonDelete = new Button({
          iconClass: "dijitIconDelete",
          class: "thinButton",
        });

        self._buttonLeg.on("click", function() {
          self.grid.collection.add({
            pk      : self.grid.collection.nextPk,
            order   : self.value.order + 0.1,
            type    : "leg",
            legType : "A",
            dhour   : 2,
            dminute : 0,
          });
          self.grid.collection.add({
            pk      : self.grid.collection.nextPk,
            order   : self.value.order + 0.2,
            dhour   : 0,
            dminute : 45,
            type    : "sta",
          });
          self.grid.collection.process();
        });

        self._buttonLayover.on("click", function() {
          // prevoir le chgt de duree de la station d'avant.
          self.grid.collection.add({
            pk      : self.grid.collection.nextPk,
            order   : self.value.order + 0.1,
            type    : "lay",
            dhour   : 12,
            dminute : 0,
          });
          self.grid.collection.add({
            pk      : self.grid.collection.nextPk,
            order   : self.value.order + 0.2,
            dhour   : 0,
            dminute : 20,
            type    : "sta",
            station : self.value.station
          });
          self.grid.collection.process();
        });

        self._buttonDelete.on("click", function() {
          if( self.value.order != self.grid.collection.len -1 ) {
            self.grid.collection.filter({order: self.value.order + 1}).forEach( function(object) {
              self.grid.collection.remove(object.pk);
            });
          } 
          else {
            // as this is the last leg/layover in the ordered list, I need to delete the current
            // leg/layover and the previous station, because the next one is untouchable, required
            // as the destination station.
            self.grid.collection.filter({order: self.value.order - 1}).forEach( function(object) {
              self.grid.collection.remove(object.pk);
            });
          }

          self.grid.collection.remove(self.value.pk);
          self.grid.collection.process();
        });

      },
      _setValueAttr: function(value) {
        this.value = value;

        if( this.value.newLegButton ) this.domNode.appendChild(this._buttonLeg.domNode);
        if( this.value.newLayButton ) this.domNode.appendChild(this._buttonLayover.domNode);
        if( this.value.deleteButton ) this.domNode.appendChild(this._buttonDelete.domNode);
      },
      _getValueAttr: function() {
        return this.value;
      },
      destroy: function() {
        this._buttonLeg.destroy();
        this._buttonLayover.destroy();
        this._buttonDelete.destroy();
        this.inherited(arguments);
      }
    });

    // ===============================================
    // Type of leg
    // ===============================================
    typeLegStore = new ObjectStore({
      objectStore: LegacyObservable(new LegacyMemory({
        data: {
          identifier: 'type',
          items: [
            { 'type': 'A', 'name': 'Active' },
            { 'type': 'D', 'name': 'Deadhead' },
          ],
        }
      })),
      labelProperty: "name"
    });



    parser.parse().then(function() { 
      dom.byId("loader").style.display = "none";
      dom.byId("content").style.display = "block";
    });


    registry.byId("TrainingRestBeforeH").set("store", zeroTo99Store);
    registry.byId("TrainingRestAfterH").set("store", zeroTo99Store);
    registry.byId("TrainingDurationHour").set("store", zeroTo99Store);

    registry.byId("TrainingRestBeforeH").set("regExp", '[0-9]+');
    registry.byId("TrainingRestAfterH").set("regExp", '[0-9]+');
    registry.byId("TrainingDurationHour").set("regExp", '[0-9]+');

    registry.byId("TrainingRestBeforeM").set("store", zeroTo59Store);
    registry.byId("TrainingRestAfterM").set("store", zeroTo59Store);
    registry.byId("TrainingDurationMinute").set("store", zeroTo59Store);

    registry.byId("TripRestBeforeH").set("store", zeroTo99Store);
    registry.byId("TripRestAfterH").set("store", zeroTo99Store);

    registry.byId("TripRestBeforeH").set("regExp", '[0-9]+');
    registry.byId("TripRestAfterH").set("regExp", '[0-9]+');

    registry.byId("TripRestBeforeM").set("store", zeroTo59Store);
    registry.byId("TripRestAfterM").set("store", zeroTo59Store);

    registry.byId("transportationTime").set("store", zeroTo99Store);
    registry.byId("reportTime").set("store", zeroTo99Store);
    registry.byId("releaseTime").set("store", zeroTo99Store);
    registry.byId("midnightOffset").set("store", zeroTo99Store);

    registry.byId("transportationTime").set("regExp", '[0-9]+');
    registry.byId("reportTime").set("regExp", '[0-9]+');
    registry.byId("releaseTime").set("regExp", '[0-9]+');
    registry.byId("midnightOffset").set("regExp", '[0-9]+');

    // ===============================================
    // Install gantt svg data at the right place.
    // ===============================================
    on.emit(window, "resize", {bubbles: true,cancelable: true});


    // ===============================================
    // Load timezones.
    // ===============================================
    var array = timezone.tz.names();

    var timezoneStore = new Memory({
      idProperty: "id",
    });

    for( i = 0; i < array.length; i++) {
      timezoneStore.addSync({
        id: i,
        name: array[i],
       });
     }

     var timezoneStoreAdapter = new DstoreAdapter(timezoneStore);
     registry.byId("CalendarTimezone").set("store", timezoneStoreAdapter);



     // ===============================================
     // Display "detail" of activity, or event.
     // ===============================================
     function PopupActivityDetail(activityId) {
       var myDialog = new Dialog({
         title: "Detail activity",
         style: "width: 300px",
         content: "Activitiy pk : " + activityId + "<br/>name: " + activityStore.getSync(activityId).name + "<br/>",
       });

       var myButton = new Button({
         label: "Delete this activity",
         onClick: function() {
           activityStore.removeSync(activityId);

           myDialog.hide();

           topic.publish("refreshGraph");
         }
       }).placeAt(myDialog);

       myDialog.show();
     }

     function PopupEventDetail(eventId) {
       var myDialog = new Dialog({
         title: "Detail event",
         style: "width: 300px",
         content: "Event pk : " + eventId + "<br/>",
       });

       var myButton = new Button({
         label: "Delete this event",
         onClick: function() {
           eventStore.removeSync(eventId);

           myDialog.hide();

           topic.publish("refreshGraph");
         }
       }).placeAt(myDialog);

       myDialog.show();
     }

     function PopupCrewMemberDetail(crewMemberPk) {
       var myDialog = new Dialog({
         title: "Detail crew member",
         style: "width: 300px",
         content: "Crewmember pk : " + crewMemberPk + "<br/>name: " + crewMemberStore.getSync(crewMemberPk).name + "<br/>",
       });

       var myButton = new Button({
         label: "Delete this crew member",
         onClick: function() {
           crewMemberStore.removeSync(crewMemberPk);

           myDialog.hide();

           topic.publish("refreshGraph");
         }
       }).placeAt(myDialog);

       myDialog.show();
     }

     function PopupDistanceDetail(distancePk) {
       var myDialog = new Dialog({
         title: "Detail distance",
         style: "width: 300px",
         content: "Distance PK: " + distancePk + "<br/>",
       });

       var myButton = new Button({
         label: "Delete this distance",
         onClick: function() {
           distanceStore.removeSync(distancePk);

           myDialog.hide();

           topic.publish("refreshGraph");
         }
       }).placeAt(myDialog);

       myDialog.show();
     }



     // ===============================================
     // Start Date Time + duration Hour Minute => 
     // End Date Time (readonly).
     // Here, dojo/date is used, as only local dates
     // are handled. 
     // ===============================================
     function UpdateEndDateTime(prefixId) {
       var mydate = moment(registry.byId(prefixId + "StartDate").get("value"));
       var mytime = moment(registry.byId(prefixId + "StartTime").get("value"));

       // rebuild the start date from StartDate and StartTime field values, 
       
       mydate.hours(mytime.hours());

       // add duration to determine end datetime of the activity..
       var duration = moment.duration({
         hours: registry.byId(prefixId + "DurationHour").get("value"), 
         minutes: registry.byId(prefixId + "DurationMinute").get("value")
       });
       mydate.add(duration);

       // update end date and time fields.
       registry.byId(prefixId + "EndDate").set("value", mydate.toDate());
       registry.byId(prefixId + "EndTime").set("value", mydate.toDate());
     } 



     // ===============================================
     // return the X position in SVG, based on starting
     // calendar and the date provided in argument.
     // ===============================================
     function getPositionX(date) {
       return (date.unix() - Xorig) / 60;
     }

     // ===============================================
     //  apply the compression factor on axe X.
     // ===============================================
     function CompressX(x) {
       return x / config.XGraphCompression;
     }

     // ===============================================
     // SVG drawing
     // ===============================================

     // Assumption on the SVG:
     // - One pixel per minute, so a day is 1440px width.
     // - Group node (g) is generally used to be able to shift concept in the 
     //   right position, so drawing the inner concept is logically simpler.
     //
     // An attempt to use dojox.gfx module to draw SVG was done, but some problems 
     // occured to identify existing node, in order to add new objects.

     var svg     = dom.byId("graph"); // .getSVGDocument();
     var svgNS   = "http://www.w3.org/2000/svg";
     var xlinkNS = "http://www.w3.org/1999/xlink";

     var Xorig            = 0; // unix time of the start of the calendar.
     var MARGIN_TOP_CM    = 20;
     var HEIGHT_LINE_CM   = 140;
     var MARGIN_BOTTOM_CM = 20;
     var HEIGHT_LINE_HL   = 40;

     // Draw a rectangle.
     function SVG_drawRect(className, x, y, width, height) {
       var rectangle = document.createElementNS(svgNS, "rect");

       rectangle.setAttributeNS(null, "class", className);
       rectangle.setAttributeNS(null, "x", CompressX(x));
       rectangle.setAttributeNS(null, "y", y);
       rectangle.setAttributeNS(null, "width", CompressX(width));
       rectangle.setAttributeNS(null, "height", height);

       return rectangle;
     }

     // Draw a line.
     function SVG_drawLine(className, x1, y1, x2, y2) {
       var line = document.createElementNS(svgNS, "line");

       line.setAttributeNS(null, "class", className);
       line.setAttributeNS(null, "x1", CompressX(x1));
       line.setAttributeNS(null, "y1", y1);
       line.setAttributeNS(null, "x2", CompressX(x2));
       line.setAttributeNS(null, "y2", y2);

       return line;
     }


     // Draw a text. 
     function SVG_drawText(className, x, y, label) {
       var text = document.createElementNS(svgNS, "text");

       text.setAttributeNS(null, "class", className);
       text.setAttributeNS(null, "x", CompressX(x));
       text.setAttributeNS(null, "y", y);

       text.appendChild(document.createTextNode(label));

       return text;
     }


     // Draw a event in calendar.
     function SVG_drawEvent(item) {
       var calendarId    = svg.getElementById("calendar");
       var calendarBarId = svg.getElementById("calendar_bar");
       var group         = document.createElementNS(svgNS, "g");
       
       group.setAttributeNS(null,"transform","translate(0, " + item.GetYCoord() + ")");
       group.setAttributeNS(null, "id", item.get("ident"));
       calendarId.appendChild(group);

       var lblText = SVG_drawText("event_label", item.x + 10, HEIGHT_LINE_HL / 2, item.get("short_label"));
       on(lblText, "dblclick", function(evt) {
         PopupEventDetail(item.pk);
       });
       group.appendChild(lblText);

       // a scale is used to extend the bars, that"s why they are defined into
       // a specific group.
       var groupBar     = document.createElementNS(svgNS, "g");
       groupBar.setAttributeNS(null, "id", item.get("barident"));
       calendarBarId.appendChild(groupBar);

       groupBar.appendChild(SVG_drawRect("event", item.x, 0, 1, 1));
     }


     // Draw a distance in calendar.
     function SVG_drawDistance(item) {
       var calendarId    = svg.getElementById("calendar");

       var G       = document.createElementNS(svgNS, "g");
       G.setAttributeNS(null, "id", item.get("ident"));
       calendarId.appendChild(G);

       var xFrom = item.GetEventFrom().x;
       var xTo = item.GetEventTo().x;

       if( xTo < xFrom ) {
         xFrom = xTo;
         xTo   = item.GetEventFrom().x;
       }

       var y = item.GetYCoord();
       var yHorizontalLine = y + HEIGHT_LINE_HL / 2;

       var dur = xTo - xFrom;
       var min = dur % 60;

       var label = Math.floor(dur / 60) + "h";
       label += min > 9 ? min : "0" + min;

       // draw measure  <-------  dst -------->
       var lblText = SVG_drawText("distance_label", (xFrom + xTo) / 2 , yHorizontalLine - 3, label);

       on(lblText, "dblclick", function(evt) {
         PopupDistanceDetail(item.pk);
       });
       G.appendChild(lblText);

console.log("lblText length");
console.log(lblText.getComputedTextLength());
console.log(dur);
console.log(CompressX(dur));
    
       var lblTextLength = lblText.getComputedTextLength();
       var extra = 0;
       var inc = HEIGHT_LINE_CM / 20;
       var xinc = inc * config.XGraphCompression; 

       if( lblTextLength + 2 * inc > CompressX(dur) ){
         extra = (lblTextLength + 2 * inc)  * config.XGraphCompression;
       }

       G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xTo + extra, yHorizontalLine));

       if( extra ) {
          xinc = xinc * -1;
          lblText.setAttributeNS(null,"x", CompressX(xTo - 2 * xinc));
          lblText.setAttributeNS(null,"style", "text-anchor: start");
        }
       
       // draw arrow.
       G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xFrom + xinc, yHorizontalLine + inc));
       G.appendChild(SVG_drawLine("distance", xFrom, yHorizontalLine, xFrom + xinc, yHorizontalLine - inc ));

       // draw second arrow.
       G.appendChild(SVG_drawLine("distance", xTo, yHorizontalLine, xTo - xinc, yHorizontalLine + inc));
       G.appendChild(SVG_drawLine("distance", xTo, yHorizontalLine, xTo - xinc, yHorizontalLine - inc));

        

       var activityFrom = item.GetActFrom();
       if( typeof(activityFrom) != 'undefined' ){
         var cmFrom = activityFrom.GetCrewMember();
         var y1 = cmFrom ? cmFrom.GetYCoord() : yCoordStore.nextY;
         var fromLineCount = cmFrom ? cmFrom.lineCount : OpenTimeLineCount;
         var Y1 = MARGIN_TOP_CM + HEIGHT_LINE_CM * fromLineCount + MARGIN_BOTTOM_CM; 
         G.appendChild(SVG_drawLine("distance", xFrom, y1 < y ? y1 - Y1 : y1 + Y1, xFrom, y1 < y ? yHorizontalLine + inc : yHorizontalLine - inc));
       }


       var activityTo   = item.GetActTo();
       if( typeof(activityTo) != 'undefined' ){
         var cmTo   = activityTo.GetCrewMember();
         var y2 = cmTo ? cmTo.GetYCoord() : yCoordStore.nextY; 
         var toLineCount = cmTo ? cmTo.lineCount : OpenTimeLineCount;
         var Y2 = MARGIN_TOP_CM + HEIGHT_LINE_CM * toLineCount + MARGIN_BOTTOM_CM; 
         G.appendChild(SVG_drawLine("distance", xTo, y2 < y ? y2 - Y2 : y2 + Y2, xTo, y2 < y ? yHorizontalLine + inc : yHorizontalLine - inc));
       }
     }


     function GetIncHour() {
       if( config.XGraphCompression < 1 ) return 60;
       if( config.XGraphCompression <= 2 ) return 120;
       if( config.XGraphCompression <= 4 ) return 240;
       if( config.XGraphCompression <= 8 ) return 360;
       return 720;
     }

     // Draw a calendar date. The drawing belongs to id calendar in the SVG.
     // Each "date" is embedded in a g node, with a translation on X, according
     // to the position. This way, each drawing into the g node is strictly the 
     // same for each day, except labels.
     function SVG_drawCalendarDate(item) {
       var calendarId    = svg.getElementById("calendar");
       var calendarBarId = svg.getElementById("calendar_bar");

       var G       = document.createElementNS(svgNS, "g");
       G.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
       G.setAttributeNS(null, "id", item.get("ident"));
       calendarId.appendChild(G);

       G.appendChild(SVG_drawText("day_label relative", 720, -70, "Day " + item.get("relative")));

       G.appendChild(SVG_drawText("day_label yyyymmdd", 720, -20, item.get("name")));

       var minutes = GetIncHour();
       var time = moment(item.get("name"));
       var duration = moment.duration(minutes, "minutes");

       for(var i = 0; i < item.width; i += minutes) { 
         G.appendChild(SVG_drawText("hour_label", i, 0, time.format("H:mm")));
         time.add(duration);   
       }

       // a scale is used to extend the bars, that's why they are defined into
       // a specific group.
       var Gbar     = document.createElementNS(svgNS, "g");
       Gbar.setAttributeNS(null, "transform", "translate(" + CompressX(item.x) + ",0)");
       Gbar.setAttributeNS(null, "class", item.get("startperiod") ? "start_period" : item.get("type"));
       Gbar.setAttributeNS(null, "id", item.get("barident"));
       calendarBarId.appendChild(Gbar);

       Gbar.appendChild(SVG_drawRect("day_bar", 0, 0, item.width, 1));
       Gbar.appendChild(SVG_drawRect("line", 0, 0, 1, 1));
       Gbar.appendChild(SVG_drawRect("line", item.width, 0, 1, 1));


       for(var i = 60; i < item.width; i += 120) { 
         Gbar.appendChild(SVG_drawRect("hour_bar", i, 0, 60, 1));
       }
     }


     // Draw a crewmember. The drawing is embedded into a g node 
     // with a translation on y, and belongs to crewmembers id.
     // There is no x translation, so every activity attached to the 
     // crewmember will be add into the g node.
     function SVG_drawCrewMember(item) {
       var crewText = SVG_drawText("crewmember", -50, MARGIN_TOP_CM + HEIGHT_LINE_CM / 2, item.name);

       on(crewText, "dblclick", function(evt) {
         PopupCrewMemberDetail(item.pk);
      });

       var group = document.createElementNS(svgNS, "g");
       var y     = item.GetYCoord();

       group.appendChild(crewText);

       group.setAttributeNS(null,"transform","translate(0, " + y + ")");
       group.setAttributeNS(null,"id", item.get("ident"));
       
       svg.getElementById("crewmembers").appendChild(group);

       var groupBar = document.createElementNS(svgNS, "g");

       groupBar.setAttributeNS(null,"transform","translate(0, " + y + ")");
       groupBar.setAttributeNS(null,"id", item.get("barident"));
       groupBar.appendChild(SVG_drawRect("line", 0, 0               , 1, 1));
       groupBar.appendChild(SVG_drawRect("line", 0, item.GetHeight(), 1, 1));

       svg.getElementById("crewmember_bar").appendChild(groupBar);
     }


     // Draw an activity. As the others, the drawing is embedded into a g node 
     // with a translation on y, and belongs to crewmember or opentime line.
     // Therefore no y translation is necessary, a x is used to draw the activity on
     // the rigth place in the calendar.
     function SVG_drawActivity(activity) { // , line) {
       var unitY = HEIGHT_LINE_CM / 14; 
       var parentId = svg.getElementById(activity.GetCrewMemberIdent()); // line ? svg.getElementById(line.get("ident")) : svg.getElementById("opentime");  

       var G = document.createElementNS(svgNS, "g");
       var yLine = MARGIN_TOP_CM + HEIGHT_LINE_CM * ( activity.lineNb - 1 );
       G.setAttributeNS(null, "transform", "translate(" + CompressX(activity.x + activity.midnightoffset) + "," + yLine +")");
       G.setAttributeNS(null, "id", activity.get("ident"));

       on(G, "dblclick", function(evt) {
         PopupActivityDetail(activity.pk);
       });

       parentId.appendChild(G);

       var Rect = document.createElementNS(svgNS,"rect");
       Rect.setAttributeNS(null, "class", activity.get("type"));
       Rect.setAttributeNS(null, "x", 0);
       Rect.setAttributeNS(null, "y", 0);
       Rect.setAttributeNS(null, "rx", Math.min(CompressX(2 * unitY), 20));
       Rect.setAttributeNS(null, "ry", Math.min(CompressX(2 * unitY), 20));
       Rect.setAttributeNS(null, "width", CompressX(activity.width));
       Rect.setAttributeNS(null, "height", HEIGHT_LINE_CM);
       G.appendChild(Rect);

       G.appendChild(SVG_drawText("label", 10, 5 * unitY, activity.get("name")));

       var startActivity = moment(activity.get("lbtStart"));
       startActivity.add(activity.midnightoffset, "m");
       var endActivity   = startActivity.clone();
       endActivity.add(activity.width, "m");
       var hourSize = 9;  // see font-size of class .hour_start.

       G.appendChild(SVG_drawText("act_hour start_hour", 0 , hourSize, startActivity.format("HH:mm")));
       G.appendChild(SVG_drawText("act_hour end_hour", activity.width , 14 * unitY, endActivity.format("HH:mm")));

       // transporation time
       if( activity.tp > 0 ) {
         // before.
         G.appendChild(SVG_drawRect("TP", activity.tp * -1, 3 * unitY, activity.tp, 4 * unitY));
         startActivity.subtract(activity.tp, "m");
         G.appendChild(SVG_drawText("act_hour start_hour", activity.tp * -1, 3 * unitY + hourSize, startActivity.format("HH:mm")));

         // after.
         G.appendChild(SVG_drawRect("TP", activity.width, 7 * unitY, activity.tp, 4 * unitY));
         endActivity.add(activity.tp, "m");
         G.appendChild(SVG_drawText("act_hour end_hour", activity.width + activity.tp , 11 * unitY, endActivity.format("HH:mm")));
       }

       // rest before
       if( activity.restb > 0 ) {
         G.appendChild(SVG_drawRect("REST", ( activity.restb + activity.tp ) * -1, 3 * unitY, activity.restb, 4 * unitY));
         startActivity.subtract(activity.restb, "m");
         G.appendChild(SVG_drawText("act_hour start_hour", ( activity.restb + activity.tp ) * -1 , 3 * unitY + hourSize, startActivity.format("HH:mm")));
       }

       // rest after. 
       if( activity.resta > 0 ) {
         G.appendChild(SVG_drawRect("REST", activity.width + activity.tp, 7 * unitY, activity.resta, 4 * unitY));
         endActivity.add(activity.resta, "m");
         G.appendChild(SVG_drawText("act_hour end_hour", activity.width + activity.tp + activity.resta, 11 * unitY, endActivity.format("HH:mm")));
       }


       activityStore.filter({fk_parent: activity.pk}).fetch().then(function(objects) {
         if( objects.length < 0 ) { 
           return; 
         }

         var endDetailActivity = moment(activity.get("lbtStart"));

         var Gdetails = document.createElementNS(svgNS, "g");
         Gdetails.setAttributeNS(null, "transform", "translate(0," + 7 * unitY +")");
         Gdetails.setAttributeNS(null, "class", "details");

         G.appendChild(Gdetails);

         for(i = 0; i < objects.length; i++) {
           var Rect = document.createElementNS(svgNS,"rect");
           Rect.setAttributeNS(null, "class", objects[i].get("type"));
           Rect.setAttributeNS(null, "x", CompressX(objects[i].x - activity.x));
           Rect.setAttributeNS(null, "y", unitY);
           Rect.setAttributeNS(null, "rx", 1);
           Rect.setAttributeNS(null, "ry", 1);
           Rect.setAttributeNS(null, "width", CompressX(objects[i].width));
           Rect.setAttributeNS(null, "height", 4 * unitY);

           Gdetails.appendChild(Rect);

           if( i % 2 == 0 && i != 0 && i != objects.length -1 ) {
             Gdetails.appendChild(SVG_drawText("dtl_station", objects[i].x + objects[i].width / 2 - activity.x, unitY -2, objects[i].station ));
           }
           if( i % 2 == 1 ) {
             Gdetails.appendChild(SVG_drawText("dtl_hour start_hour", objects[i].x - activity.x, unitY + hourSize, endDetailActivity.format("HH:mm")));
             // useless since the distance tool allows to measure duration !          
             //          Gdetails.appendChild(SVG_drawText("duration", objects[i].x + objects[i].width / 2 - activity.x, 3 * unitY , "<- " + formatDurationInHoursMinutes(objects[i].width) + " ->"));
           }

           endDetailActivity.add(objects[i].width, "m");

           if( i % 2 == 1 ) {
             Gdetails.appendChild(SVG_drawText("dtl_hour end_hour" , objects[i].x + objects[i].width - activity.x, 5 * unitY, endDetailActivity.format("HH:mm")));
           }

         }
       });
     }



     // ===============================================
     // Data MODELs and STOREs
     // ===============================================

     var TrackableMemory = declare([Memory, Trackable]); 

     // -----------------------------------------------
     // Configuration Model
     // -----------------------------------------------
     var configurationModel = declare(Model, {
       validateOnSet : false,
    
       schema        : {
         id                                            : { type : "numeric", default : 0, },
         transportationTime                            : { type : "numeric", default : 0, },
         midnightOffset                                : { type : "numeric", default : 0, },
         reportTime                                    : { type : "numeric", default : 0, },
         releaseTime                                   : { type : "numeric", default : 0, },
         CalendarTimezone                              : { type : "string",  default : undefined, },
         CalendarStation                               : { type : "string",  default : undefined, },
         CalendarStart                                 : { type : "string",  default : undefined, },
         CalendarEnd                                   : { type : "string",  default : undefined, },
         MenuFile                                      : { type : "boolean", default : false, },
         MenuFileLoadSVGFile                           : { type : "boolean", default : false, },
         MenuFileLoadXMLStationFile                    : { type : "boolean", default : false, },
         MenuFileSaveSVGFile                           : { type : "boolean", default : true, },
         MenuFileExportToPI                            : { type : "boolean", default : true, },
         MenuCalendar                                  : { type : "boolean", default : true, },
         MenuCalendarSetStartEnd                       : { type : "boolean", default : true, },
         MenuCalendarSetStartPeriods                   : { type : "boolean", default : true, },
         MenuBusinessObject                            : { type : "boolean", default : true, },
         MenuBusinessObjectShowConstants               : { type : "boolean", default : false, },
         MenuBusinessObjectCreateCrewMember            : { type : "boolean", default : false, },
         MenuBusinessObjectCreateActivity              : { type : "boolean", default : false, },
         MenuBusinessObjectCreateActivityDayOff        : { type : "boolean", default : false, },
         MenuBusinessObjectCreateActivityTrip          : { type : "boolean", default : false, },
         MenuBusinessObjectCreateActivityTraining      : { type : "boolean", default : false, },
         MenuBusinessObjectCreateActivityOtherActivity : { type : "boolean", default : true, },
         MenuGraphOption                               : { type : "boolean", default : true, },
         MenuGraphOptionCalendar                       : { type : "boolean", default : false, },
         MenuGraphOptionActivity                       : { type : "boolean", default : false, },
         MenuHighLights                                : { type : "boolean", default : true, },
         MenuHighLightsEvent                           : { type : "boolean", default : false, },
         MenuHighLightsDistance                        : { type : "boolean", default : false, },
         MenuHighLightsWindow                          : { type : "boolean", default : true, },
         MenuHighLightsNote                            : { type : "boolean", default : false, },
         SHCalendarHours                               : { type : "boolean", default : true, },
         SHCalendarHourBars                            : { type : "boolean", default : true, },
         SHCalendarDayX                                : { type : "boolean", default : true, },
         SHCalendarDayYYYYMMDD                         : { type : "boolean", default : true, },
         SHCalendarDayBars                             : { type : "boolean", default : true, },
         XGraphCompression                             : { type : "numeric", default : 1, },
         SHActivityHours                               : { type : "boolean", default : true, },
         SHActivityDetails                             : { type : "boolean", default : true, },
         SHActivityDetailHours                         : { type : "boolean", default : true, },
         SHActivityDetailStations                      : { type : "boolean", default : true, },
       },
       Apply         : function() {
                         var self = this;

                         if( typeof(self.CalendarStart) != "undefined" ) {
                           registry.byId("CalendarStart").set("value", self.CalendarStart);
                           var start = moment(self.CalendarStart);
                           Xorig = start.unix();
                         }
                         if( typeof(self.CalendarEnd) != "undefined" ) {
                           registry.byId("CalendarEnd").set("value", self.CalendarEnd);
                         }
                         if( self.CalendarTimezone ) {
                           timezoneStore.filter({name: self.CalendarTimezone}).fetchRange({start: 0, end: 1}).then(function(results) {
                             if( results.length > 0 ) {
                               registry.byId("CalendarTimezone").set("value", "" + results[0].id);
console.log("**************************************************");
console.log(reusults[0]);
                               registry.byId("CalendarTimezone").set("value", timezoneStoreAdapter.getIdentity(results[0].id));

                             }
                           });
                         }  

                         registry.byId("XGraphCompression").set("value", self.XGraphCompression);

                         registry.byId("SHCalendarHours").set("checked", self.SHCalendarHours);
                         registry.byId("SHCalendarDayX").set("checked", self.SHCalendarDayX);
                         registry.byId("SHCalendarDayYYYYMMDD").set("checked", self.SHCalendarDayYYYYMMDD);
                         registry.byId("SHCalendarDayBars").set("checked", self.SHCalendarDayBars);
                         registry.byId("SHCalendarHourBars").set("checked", self.SHCalendarHourBars);
                         
                         registry.byId("SHActivityHours").set("checked", self.SHActivityHours);
                         registry.byId("SHActivityDetails").set("checked", self.SHActivityDetails);
                         registry.byId("SHActivityDetailHours").set("checked", self.SHActivityDetailHours);
                         registry.byId("SHActivityDetailStations").set("checked", self.SHActivityDetailStations);
                       },
     });

     var configurationStore = new Memory({
       Model           : configurationModel,
       idProperty      : "id",
       svgId           : "ConfigurationStore",
       svgItemNodeName : "configuration",
     });

     configurationStore.on("add, update", function(event) {
       var cfg     = event.target;
       var pattern = new RegExp("^Menu");

       for(var property in cfg) {
         if( pattern.test(property) ) {
           registry.byId(property).set("disabled", cfg.get(property));
         }
       }
     });

     var config = configurationStore.Model();

     config.Apply();

     configurationStore.addSync(config);

     
     // -----------------------------------------------
     // station Model and Store
     // -----------------------------------------------
     var StationModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         id             : "string",
         code           : "string",
         name           : "string",
         dstShift       : "string",
         dstStartLst    : "string",
         dstEndLst      : "string",
         utcOffset      : "string",
         offset         : "numeric",
         regionList     : "array",
         /* do not work with query !!!
         offset         : new ComputedProperty({ 
                            dependsOn : ["utcOffet"],
                            getValue  : function(utcOffset) {
                              var data = offsetRegex.exec(utcOffset);

                              return moment.duration({hours: data[1], minutes: data[2]}).asMinutes() * -1;
                            }
         }),
         */
       },
     });


     var stationStore = new Memory({
       Model           : StationModel,
       idProperty      : "id",
       svgId           : "StationStore",
       svgItemNodeName : "station",
     });



     // -----------------------------------------------
     // yCoord Model and Store.
     // -----------------------------------------------
     var yCoordModel = declare(Model, {
       schema        : {
         pk     : "numeric",
         y      : "numeric",
         height : "numeric",
         fk_hl  : "numeric",
         fk_dst : "numeric",
         fk_cm  : "numeric",
       },
       validateOnSet : false,
     });

     var yCoordStore = new TrackableMemory({
       Model             : yCoordModel,
       idProperty        : "pk",
       nextPk            : 1,
       nextY             : 0,
       svgId             : "YCoordStore",
       svgItemNodeName   : "ycoord",
       StretchSVGHeight  : function() {
                             var self = this;
                             // scale vertically the calendar to fit the number of crewmember.
                             var height = self.nextY;

                             if( OpenTimeLineCount > 0 ) {
                               height += MARGIN_TOP_CM + HEIGHT_LINE_CM * OpenTimeLineCount + MARGIN_BOTTOM_CM;
                             }
console.log("strech");
console.log(self.nextY);
                             svg.getElementById("calendar_bar").setAttribute("transform", "scale(1," + height + ")");
                             svg.getElementById("opentime").setAttribute("transform","translate(0, " + self.nextY + ")");
                           },
       GetNextPKSequence : function() {
                            var self = this;

                            return self.nextPk;
                          },
       GetNextY          : function() {
                             var self = this;

                             return self.nextY;
                           },  
       ComputeYAndHeigth : function() {
                             yCoordStore.sort('y').fetch().then(function(items) {
                               var nextY = 0;
                               for (var i = 0 ; i < items.length ; i++) {
                                 items[i].y = nextY;
                                 nextY += items[i].height;
                               }
                               yCoordStore.nextY = nextY;
                             });    
                           },
     });


     yCoordStore.on("add", function(event) {
       // 1 - increment primary key sequence.
       yCoordStore.nextPk = Math.max(event.target.pk + 1, yCoordStore.nextPk); 

       if( event.target.load != true ) {
         // 2 - recompute y and height of each item.
         yCoordStore.ComputeYAndHeigth();
       }
     });


     yCoordStore.on("update", function(event) {
       // 1 - set next primary key value.
       yCoordStore.nextPk = Math.max(event.target.pk + 1, yCoordStore.nextPk); 

       // 2 - recompute y and height of each item.
       yCoordStore.ComputeYAndHeigth();
     });


     yCoordStore.on("delete", function(event) {
       // 1 - recompute y and height of each item.
       yCoordStore.ComputeYAndHeigth();
     });


     // -----------------------------------------------
     // Calendar Model
     // -----------------------------------------------
     var calendarModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         pk            : "numeric",
         x             : "numeric",
         width         : "numeric",
         name          : "string",
         relative      : "numeric",
         startperiod   : { type : "boolean", default : false },
         type          : new ComputedProperty({
                           dependsOn : ["pk"],
                           getValue  : function(pk) {
                             return pk % 2 ? "uneven" : "even";
                           }
                         }),
         ident         : new ComputedProperty({ 
                           dependsOn : ["pk"],
                           getValue  : function(pk) {
                             return "cd" + pk;  // cd stands for Calendar Day.
                           }
                         }),
         barident      : new ComputedProperty({ 
                           dependsOn : ["pk"],
                           getValue  : function(pk) {
                             return "bcd" + pk;  // bcd stands for Bar Calendar Day.
                           }
                         }),
       },
       DrawSVG       : function() { 
                         var self = this;
                         
                         SVG_drawCalendarDate(self); 
                       },
     });


     var calendarStore = new TrackableMemory({
       Model             : calendarModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "CalendarStore",
       svgItemNodeName   : "calendar",
     });


     calendarStore.on("add", function(event) {
       calendarStore.nextPk += 1;
     });


     calendarStore.on("update", function(event) {
       calendarStore.nextPk = Math.max(event.target.pk + 1, calendarStore.nextPk); 
     });


     var calendarStoreAdapter = new DstoreAdapter(calendarStore);
     registry.byId("CalendarStartPeriods").set("labelAttr", "name");

     registry.byId("DayOffDatesSelect").set("labelAttr", "name");
     registry.byId("DayOffDatesSelect").setStore(calendarStoreAdapter);
     registry.byId("EventDatesSelect").set("labelAttr", "name");
     registry.byId("EventDatesSelect").setStore(calendarStoreAdapter);


     // -----------------------------------------------
     // crewMember Model and Store
     // -----------------------------------------------
     var crewMemberModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         name      : "string",
         birthdate : "string",
         pk        : "numeric",
         fk_yc     : "numeric",
         lineCount : "numeric",
         ident     : new ComputedProperty({
                       dependsOn : ["pk"],
                       getValue  : function(pk) {
                         return "cm" + pk; // cm stands for CrewMember.
                       }
                     }),
         barident  : new ComputedProperty({ 
                       dependsOn : ["pk"],
                       getValue  : function(pk) {
                         return "bcm" + pk; // bcm stands for Bar CrewMember.
                       }
                     }),
       },
       DrawSVG       : function() { 
                         var self = this;

                         SVG_drawCrewMember(self); 
                       },
       GetYCoord     : function() {
                         var self = this;
          
                         return yCoordStore.getSync(self.fk_yc).y;
                       },
       GetHeight     : function() {
                         var self = this;

                         return yCoordStore.getSync(self.fk_yc).height;
                       },
     });


     var crewMemberStore = new TrackableMemory({
       Model             : crewMemberModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "CrewMemberStore",
       svgItemNodeName   : "crew",
       GetNextPKSequence : function() {
                             var self = this;

                             return self.nextPk;
                           },
     });

     crewMemberStore.on("add", function(event) {
       // 1 - inc pk sequence.
       crewMemberStore.nextPk += 1;

       if( typeof(event.target.fk_yc) == 'undefined' ) {
         // 2 - create y coord object.
         var yCoordinate = yCoordStore.addSync({
           pk     : yCoordStore.GetNextPKSequence(),
           fk_cm  : event.target.pk,
           y      : yCoordStore.GetNextY(),
           height : MARGIN_TOP_CM + HEIGHT_LINE_CM + MARGIN_BOTTOM_CM,
         });

         // 3 - save foreign key of the Y coordinate object.
         event.target.fk_yc = yCoordinate.pk;
       }
     });


     crewMemberStore.on("update", function(event) {
       crewMemberStore.nextPk = Math.max(event.target.pk + 1, crewMemberStore.nextPk);

       var yCoordinate = yCoordStore.getSync(event.target.fk_yc); 

       yCoordinate.height = MARGIN_TOP_CM + HEIGHT_LINE_CM * event.target.lineCount + MARGIN_BOTTOM_CM; 

       yCoordStore.putSync(yCoordinate);      
     });


     crewMemberStore.on("delete", function(event) {
       // Remove 
       activityStore.filter({fk_cm: event.target.pk}).forEach(function(item) {
         activityStore.removeSync(item.pk);
       });

       // Remove coords that reference this distance.
       yCoordStore.filter({fk_cm: event.target.pk}).forEach(function(item) {
         yCoordStore.removeSync(item.pk);
       });
     });


     var crewMemberStoreAdapter = new DstoreAdapter(crewMemberStore);

     registry.byId("DayOffCrewMemberSelect").set("store", crewMemberStoreAdapter);
     registry.byId("TrainingCrewMemberSelect").set("store", crewMemberStoreAdapter);
     registry.byId("TripCrewMemberSelect").set("store", crewMemberStoreAdapter);


     // -----------------------------------------------
     // activity Model and Store
     // -----------------------------------------------
     var activityModel = declare(Model, {
       validateOnSet      : false,
       schema             : {
         pk             : "numeric",
         fk_cm          : "numeric", // foreign key to CrewMember.
         fk_parent      : "numeric", // foreign key to parent activity.
         name           : "string",
         fullname       : "string",
         x              : "numeric",
         midnightoffset : "numeric",
         width          : "numeric",
         tp             : "numeric",
         resta          : "numeric",
         restb          : "numeric",
         type           : "string",
         lbtStart       : "string",
         lbtEnd         : "string",
         utcStart       : "string",
         utcEnd         : "string",
         block          : "numeric",
         credit         : "numeric",
         duty           : "numeric",
         tafbInPeriod   : "numeric",
         blockInPeriod  : "numeric",
         creditInPeriod : "numeric",
         dutyInPeriod   : "numeric",
         station        : "string",
         lineNb         : "numeric",
         ident          : new ComputedProperty({
                            dependsOn    : ["pk", "type"],
                            getValue     : function(pk, type) {
                              return type.toLowerCase() + pk;  // DOxxx or TRPxxx or  .. 
                            }
                          }),
       },
       DrawSVG            : function() { 
                              var self = this;

                              if( typeof(this.fk_parent) == "undefined" ) {
                                SVG_drawActivity(self);
                              }
                            },
       GetYCoord          : function() {
                              var self = this;

                              return self.fk_cm ? crewMemberStore.getSync(self.fk_cm).GetYCoord() : yCoordStore.nextY;
                            },
       GetCrewMember      : function() {
                              var self = this;

                              return self.fk_cm ? crewMemberStore.getSync(self.fk_cm) : undefined;
                            },

       GetCrewMemberIdent : function() {
                              var self = this;

                              return self.fk_cm ? crewMemberStore.getSync(self.fk_cm).get("ident") : "opentime"; 
                            },
       CreateEvents       : function() {
                              var self = this;

                              var x = self.x + self.midnightoffset;

                              if( self.restb > 0 ) {
                                eventStore.addSync({
                                  pk : eventStore.GetNextPKSequence(),
                                  x  : x - self.restb - self.tp,
                                  short_label : "Start of rest before activity",
                                  label : "Start of rest before activity",
                                  fk_act : self.pk,
                                  start : 0,
                                });
                              }
                              if( self.tp > 0 ) {
                                eventStore.addSync({
                                  pk : eventStore.GetNextPKSequence(),
                                  x  : x - self.tp,
                                  short_label : "Start of transportation time before activity",
                                  label : "Start of transportation time before activity",
                                  fk_act : self.pk,
                                  start : 0,
                                });
                              }
                              eventStore.addSync({
                                pk : eventStore.GetNextPKSequence(),
                                x  : x,
                                short_label : "Start of activity",
                                label : "Start of activity",
                                fk_act : self.pk,
                                start : 1,
                              });

                              activityStore.filter({fk_parent: self.pk}).fetch().then(function(objects) {
                                for(i = 1; i < objects.length; i++) {
                                  eventStore.addSync({
                                    pk : eventStore.GetNextPKSequence(),
                                    x  : objects[i].x,
                                    short_label : "Start of " + objects[i].name,
                                    label : "Start of " + objects[i].name,
                                    fk_act : self.pk,
                                    start : 0,
                                  });
                                }
                              });

                              eventStore.addSync({
                                pk : eventStore.GetNextPKSequence(),
                                x  : x + self.width,
                                short_label : " End of activity",
                                label : " End of activity",
                                fk_act : self.pk,
                                start : 0,
                              });
                              if( self.tp > 0 ) {
                                eventStore.addSync({
                                  pk : eventStore.GetNextPKSequence(),
                                  x  : x + self.width + self.tp,
                                  short_label : "End of transportation time after activity",
                                  label : "End of transportation time after activity",
                                  fk_act : self.pk,
                                  start : 0,
                                });
                              }
                              if( self.resta > 0 ) {
                                eventStore.addSync({
                                  pk : eventStore.GetNextPKSequence(),
                                  x  : x + self.width + self.tp + self.resta,
                                  short_label : "End of rest after activity",
                                  label : "End of rest after activity",
                                  fk_act : self.pk,
                                  start : 0,
                                });
                              }
                            },          
     });


     var activityStore = new TrackableMemory({
       Model             : activityModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "ActivityStore",
       svgItemNodeName   : "activity",
       GetNextPKSequence : function() {
                             var self = this;

                             return self.nextPk;
                           },
     });


     activityStore.on("add", function(event) {
       activityStore.nextPk += 1;
       if( event.target.fk_cm == 0 ) {
         if( typeof(event.target.lineNb) != 'undefined') {
           OpenTimeLineCount = Math.max(event.target.lineNb, OpenTimeLineCount);
         }
       }
     });


     activityStore.on("update", function(event) {
       activityStore.nextPk = Math.max(event.target.pk + 1, activityStore.nextPk); 
     });


     activityStore.on("delete", function(event) {
       // Remove distance that reference this activity.
       distanceStore.filter({fk_actFrom: event.target.pk}).forEach(function(item) {
         distanceStore.removeSync(item.pk);
       });
       distanceStore.filter({fk_actTo: event.target.pk}).forEach(function(item) {
         distanceStore.removeSync(item.pk);
       });

       // Remove details (legs, layovers and stations) in case of trip.
       activityStore.filter({fk_parent: event.target.pk}).forEach(function(item) {
         activityStore.removeSync(item.pk);
       });
     });


     var activityStoreAdapter = new DstoreAdapter(activityStore.filter({fk_parent: undefined}));

     registry.byId("DistanceFromActSelect").set("labelAttr", "fullname");
     registry.byId("DistanceFromActSelect").set("searchAttr", "fullname");
     registry.byId("DistanceFromActSelect").set("store", activityStoreAdapter);
     registry.byId("DistanceToActSelect").set("labelAttr", "fullname");
     registry.byId("DistanceToActSelect").set("searchAttr", "fullname");
     registry.byId("DistanceToActSelect").set("store", activityStoreAdapter);

     // -----------------------------------------------
     // distance Model and Store
     // -----------------------------------------------
     var distanceModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         pk         : "numeric",
         fk_actFrom : "numeric",
         fk_evtFrom : "numeric",
         fk_actTo   : "numeric",
         fk_evtTo   : "numeric",
         fk_yc      : "numeric",
         ident      : new ComputedProperty({
                        dependsOn : ["pk"],
                        getValue: function(pk) {
                          return "dst" + pk;  // dst stands for distance
                        }
                      }),
       },
       DrawSVG       : function() {
                         var self = this;

                         SVG_drawDistance(self); 
                       },
       GetYCoord     : function() {
                         var self = this;

                         return yCoordStore.getSync(self.fk_yc).y;
                       },
       GetActFrom    : function() {
                         var self = this;

                         return activityStore.getSync(self.fk_actFrom);
                       },
       GetActTo      : function() {
                         var self = this;

                         return activityStore.getSync(self.fk_actTo);
                       },
       GetEventFrom  : function() {          
                         var self = this;

                         return eventStore.getSync(self.fk_evtFrom);
                       },
       GetEventTo    : function() {          
                         var self = this;

                         return eventStore.getSync(self.fk_evtTo);
                       },
     });


     var distanceStore = new Memory({
       Model             : distanceModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "DistanceStore",
       svgItemNodeName   : "distance",
       GetNextPKSequence : function() {
                             var self = this;

                             return self.nextPk;
                           },
     });


     distanceStore.on("add", function(event) {
       distanceStore.nextPk += 1;
     });


     distanceStore.on("update", function(event) {
       distanceStore.nextPk = Math.max(event.target.pk + 1, distanceStore.nextPk);
     });


     distanceStore.on("delete", function(event) {
       // Remove coords that reference this distance.
       yCoordStore.removeSync(event.target.fk_yc);
     });

     // -----------------------------------------------
     // event Model and Store
     // -----------------------------------------------
     var eventModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         pk            :  "numeric",
         x             : "numeric",
         short_label   : "string",
         label         : "string",
         fk_act        : "numeric", // 0 means no activity
         start         : "numeric",
         fk_yc         : "numeric",
         ident         : new ComputedProperty({
                           dependsOn : ["pk"],
                           getValue  : function(pk) {
                             return "evt" + pk;  // evt stands for Event
                           }
                         }),
         barident      : new ComputedProperty({ 
                           dependsOn : ["pk"],
                           getValue  : function(pk) {
                             return "bevt" + pk;  // bevt stands for Bar Event
                           }
                         }),
       },
       DrawSVG       : function() { 
                         var self = this;
                         
                         if( typeof(self.fk_act) == 'undefined' ){
                           SVG_drawEvent(self); 
                         }
                       },
       GetYCoord     : function() {
                         var self = this;

                         return yCoordStore.getSync(self.fk_yc).y;
                       },
     });

     var eventStore = new TrackableMemory({
       Model             : eventModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "EventStore",
       svgItemNodeName   : "event",
       GetNextPKSequence : function() {
                             var self = this;

                             return self.nextPk;
                           },
     });

     eventStore.on("add", function(event) {
       // 1 - increment primary key sequence.
       eventStore.nextPk += 1;

       // for recurent hl, there is only one yCoord object, created before the creation
       // of each recurent hl. So there is no need for the following.
       if( typeof(event.target.fk_yc) == 'undefined' && typeof(event.target.fk_act) == 'undefined'){
         // 2 - create y coord object.
         var yCoordinate = yCoordStore.addSync({
           pk     : yCoordStore.GetNextPKSequence(),
           fk_hl  : event.target.pk,
           y      : 0,
           height : HEIGHT_LINE_HL,
         });

         // 3 - save coordinate primary key into event object.
         event.target.fk_yc = yCoordinate.pk;
       }


     });


     eventStore.on("update", function(event) {
       eventStore.nextPk = Math.max(event.target.pk + 1, eventStore.nextPk); 
     });


     eventStore.on("delete", function(event) {
       eventStore.filter({fk_yc: event.target.fk_yc}).fetch().then( function(items) {
         for (var i = 0 ; i < items.length ; i++) {
console.log(items[i]);            
         }
         if( items.length == 0 ) {
console.log("remove ycoord...");            
           yCoordStore.removeSync(event.target.fk_yc);
         }
          
       });
     });


     var eventStoreAdapter = new DstoreAdapter(eventStore.filter({fk_act: undefined}));
     var eventActivityStoreAdapter = new DstoreAdapter(eventStore.filter({fk_yc: undefined}));

     registry.byId("DistanceFromActEventSelect").set("labelAttr", "label");
     registry.byId("DistanceFromActEventSelect").set("store", eventActivityStoreAdapter);
     registry.byId("DistanceToActEventSelect").set("labelAttr", "label");
     registry.byId("DistanceToActEventSelect").set("store", eventActivityStoreAdapter);

     registry.byId("DistanceFromEventSelect").set("labelAttr", "label");
     registry.byId("DistanceFromEventSelect").set("store", eventStoreAdapter);
     registry.byId("DistanceToEventSelect").set("labelAttr", "label");
     registry.byId("DistanceToEventSelect").set("store", eventStoreAdapter);
     // -----------------------------------------------
     // note Model and Store
     // -----------------------------------------------
     var noteModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         pk     : "numeric",
         x      : "numeric",
         y      : "numeric",
         note   : "string",
         color  : "string",
       },
     });


     var noteStore = new TrackableMemory({
       Model             : noteModel,
       idProperty        : "pk",
       nextPk            : 1,
       svgId             : "NoteStore",
       svgItemNodeName   : "note",
       GetNextPKSequence : function() {
                             var self = this;

                             return self.nextPk;
                           },
     });


     noteStore.on("add", function(event) {
       noteStore.nextPk += 1;
     });


     noteStore.on("update", function(event) {
       noteStore.nextPk = Math.max(event.target.pk + 1, noteStore.nextPk); 
     });


     noteStore.on("delete", function(event) {
     });




     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     /* 
      * Determine if the new activity is overlapping with other activities
      * related to a specific crewmember. If there is a collision, then
      * the new activity will be assigned a new line. 
      * @param crewMemberPk crew member primary key. if 0, that's opentime.
      * @param x            new activity starting datetime.
      * @param width        new activity length.
      * @return The line number where the new activity will be drawn.
      */
     function GetActivityLineNumber(crewMemberPk, x , width) {
       var lineNb = 1;

       activityStore.filter({fk_cm: crewMemberPk}).forEach(function(object) {
         if( typeof(object.fk_parent) == "undefined" ) {
           var A = x;
           var B = x + width;

           var C = object.x;
           var D = object.x + object.width;

           if( !(( B <= C ) || ( A >= D ))) {    
             lineNb = Math.max(lineNb, object.lineNb + 1);
           }
         }
       });

       if ( crewMemberPk ) { // a true crewMember.
         var cm = crewMemberStore.getSync(crewMemberPk);
         if( cm.lineCount < lineNb ) {
           cm.lineCount = lineNb;
           crewMemberStore.putSync(cm);
         }
       }
       else { // opentime
         if( OpenTimeLineCount < lineNb ) {    
           OpenTimeLineCount = lineNb;          
         }  
       }

       return lineNb;
     }




     // -----------------------------------------------
     // trip detail Model and Store
     // -----------------------------------------------

     var TripDetailModel = declare(Model, {
       validateOnSet : false,
       schema        : {
         pk             : "numeric",
         order          : "numeric",
         type           : "string",
         station        : "string",
         legType        : "string",
         startDateTime  : "string",
         dhour          : "numeric",
         dminute        : "numeric",
         endDateTime    : "string",
         fk_activity    : "numeric",
         stationSelect  : "numeric",
         legTypeSelect  : "numeric",
         durationSelect : "numeric",
         newLegButton   : "numeric",
         newLayButton   : "numeric",
         deleteButton   : "numeric",
       },
     });
     var tripDetailStore = new TrackableMemory({
       Model           : TripDetailModel,
       idProperty      : "pk",
       len             : 0,
       nextPk          : 1,
       reportTime      : 20,
       releaseTime     : 15,
       startDateTime   : new moment(),
       _updDur         : function(array) {
                           var self = this;
                       
                           var currentDate = moment(self.startDateTime);
                           for( i = 0; i < array.length ; ++i ) {
                             array[i].startDateTime = currentDate.format("YYYY-MM-DD HH:mm");
                             currentDate.add(array[i].dminute, "m");
                             currentDate.add(array[i].dhour  , "h");
                             array[i].endDateTime = currentDate.format("YYYY-MM-DD HH:mm");
                           }
                       
                           registry.byId("TripEndDate").set("value", currentDate.toDate());
                           registry.byId("TripEndTime").set("value", currentDate.toDate());
                         },
       updateDuration  : function() {
                           var self = this; 
                           // based on the assumption that the store will have a reasonable size,
                           // there is no need to re 
                           self.sort('order').fetch().then(function(objects) {
                             self._updDur(objects);

                             for( i = 0; i < objects.length ; ++i ) {
                               self.putSync(objects[i]);
                             }
                           });
                         },
       process         : function() {
                           // based on the assumption that the store will have a reasonable size,
                           // there is no need to re 
                           var self = this; 

                           self.sort('order').fetch().then(function(objects) {
                             for( i = 0; i < objects.length ; ++i ) {
                               objects[i].newLegButton   = 1;
                               objects[i].newLayButton   = 1;
                               objects[i].deleteButton   = 1;
                               objects[i].stationSelect  = 1;
                               objects[i].durationSelect = 1;
                               objects[i].legTypeSelect  = 1;

                               objects[i].order = i + 1;
                             }

                             for( i = 0; i < objects.length ; ++i ) {
                               if( i == 0 ) { // first station
                                 objects[i].newLayButton   = 0;
                                 objects[i].deleteButton   = 0;
                                 objects[i].stationSelect  = 0;
                                 objects[i].durationSelect = 0;
                                 objects[i].legTypeSelect  = 0;

                                 objects[i].lblType        = "Report time";
                                 objects[i].dhour          = parseInt(self.reportTime / 60);
                                 objects[i].dminute        = self.reportTime % 60;
                               } 
                               else if( i == objects.length - 1) { // last station
                                 objects[i].newLegButton   = 0;
                                 objects[i].newLayButton   = 0;
                                 objects[i].deleteButton   = 0;
                                 objects[i].stationSelect  = 0;
                                 objects[i].durationSelect = 0;
                                 objects[i].legTypeSelect  = 0;

                                 objects[i].lblType        = "Release time";
                                 objects[i].dhour          = parseInt(self.releaseTime / 60);
                                 objects[i].dminute        = self.releaseTime % 60;
                               }
                               else if( i % 2 == 0 ) { // a station
                                 objects[i].deleteButton   = 0;
                                 objects[i].legTypeSelect  = 0;

                                 objects[i].lblType = "Ground time";

                                 if( objects[i+1].type == "lay" ) {
                                   objects[i].durationSelect = 0;
                                   objects[i].newLayButton   = 0;

                                   objects[i].lblType = "Release time";
                                   objects[i].dhour   = parseInt(self.releaseTime / 60);
                                   objects[i].dminute = self.releaseTime % 60;
                                 }
                                 if( objects[i-1].type == "lay" ) {
                                   objects[i].durationSelect = 0;
                                   objects[i].stationSelect  = 0;
                                   objects[i].newLayButton   = 0;

                                   objects[i].lblType = "Report time";
                                   objects[i].dhour   = parseInt(self.reportTime / 60);
                                   objects[i].dminute = self.reportTime % 60;
                                 }

                               }
                               else { // a leg or a lay.
                                 objects[i].newLegButton  = 0;
                                 objects[i].newLayButton  = 0;
                                 objects[i].stationSelect = 0;

                                 objects[i].lblType = objects[i].type == "leg" ? "Leg" : "Lay over";

                                 if( objects.length <= 3 ) {
                                   objects[i].deleteButton = 0; 
                                 }

                                 // can not delete a leg when it is the first, and it is followed by a lay.
                                 if( i == 1 && i + 2 < objects.length && objects[i+2].type == "lay" ) {
                                   objects[i].deleteButton = 0; 
                                 }
                                 // can not delete a leg when it is the last, and it is preceded by a lay.
                                 if( i == objects.length - 2 && i > 2 && objects[i-2].type == "lay" ) {
                                   objects[i].deleteButton = 0; 
                                 }
                               }
                             }
                             self._updDur(objects);

                             for( i = 0; i < objects.length ; ++i ) {
                               self.putSync(objects[i]);
                             }
                           });
                         },
     });

     tripDetailStore.on('add', function(event) {
       tripDetailStore.len += 1;
       tripDetailStore.nextPk += 1;
     }); 

     tripDetailStore.on('delete', function(event) {
       tripDetailStore.len -= 1;
     }); 



     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     // -----------------------------------------------
     // ===============================================
     // Redraw SVG
     // ===============================================
     function RemoveIntroMessage() {
       dojo.query("#calendar").forEach(dojo.empty);
     }


     function AdjustCrewmemberBarScaleX(x) {
       var bar = svg.getElementById("crewmember_bar");
       bar.setAttribute("transform", "scale(" + x + ",1)");
     }


     topic.subscribe("refreshGraph", function() {
       yCoordStore.StretchSVGHeight();

       dojo.query("#calendar").forEach(dojo.empty);
       dojo.query("#calendar_bar").forEach(dojo.empty);
       dojo.query("#crewmembers").forEach(dojo.empty);
       dojo.query("#crewmember_bar").forEach(dojo.empty);
       dojo.query("#opentime").forEach(dojo.empty);

       var x = 0;
       calendarStore.forEach(function(item) {
         // on.emit(item, "update", { bubbles: true, cancelable: true });
         item.DrawSVG();
         x = Math.max(x, item.get("x") + item.get("width")); 
       });
       AdjustCrewmemberBarScaleX(x);

       eventStore.forEach(function(item) {
         item.DrawSVG();
       });
       distanceStore.forEach(function(item) {
         item.DrawSVG();
       });
       crewMemberStore.forEach(function(item) {
         item.DrawSVG();
       });
       activityStore.forEach(function(item) {
         item.DrawSVG(crewMemberStore.getSync(item.fk_cm));
       });

       if( !config.SHCalendarHours ) {
         registry.byId("SHCalendarHours").set("checked", !config.SHCalendarHours);
         registry.byId("SHCalendarHours").set("checked", config.SHCalendarHours);
       }
       if( !config.SHCalendarDayX ) {
         registry.byId("SHCalendarDayX").set("checked", !config.SHCalendarDayX);
         registry.byId("SHCalendarDayX").set("checked", config.SHCalendarDayX);
       }
       if( !config.SHCalendarDayYYYYMMDD ) {
         registry.byId("SHCalendarDayYYYYMMDD").set("checked", !config.SHCalendarDayYYYYMMDD);
         registry.byId("SHCalendarDayYYYYMMDD").set("checked", config.SHCalendarDayYYYYMMDD);
       }
       if( !config.SHCalendarDayBars ) {
         registry.byId("SHCalendarDayBars").set("checked", !config.SHCalendarDayBars);
         registry.byId("SHCalendarDayBars").set("checked", config.SHCalendarDayBars);
       }
       if( !config.SHCalendarHourBars ) {
         registry.byId("SHCalendarHourBars").set("checked", !config.SHCalendarHourBars);
         registry.byId("SHCalendarHourBars").set("checked", config.SHCalendarHourBars);
       }
       
       if( !config.SHActivityHours ) {
         registry.byId("SHActivityHours").set("checked", !config.SHActivityHours);
         registry.byId("SHActivityHours").set("checked", config.SHActivityHours);
       }
       if( !config.SHActivityDetails ) {
         registry.byId("SHActivityDetails").set("checked", !config.SHActivityDetails);
         registry.byId("SHActivityDetails").set("checked", config.SHActivityDetails);
       }
       if( !config.SHActivityDetailHours ) {
         registry.byId("SHActivityDetailHours").set("checked", !config.SHActivityDetailHours);
         registry.byId("SHActivityDetailHours").set("checked", config.SHActivityDetailHours);
       }
       if( !config.SHActivityDetailStations ) {
         registry.byId("SHActivityDetailStations").set("checked", !config.SHActivityDetailStations);
         registry.byId("SHActivityDetailStations").set("checked", config.SHActivityDetailStations);
       }
     });


     // ===============================================
     // SAVING STORES TO SVG
     // ===============================================
     function SaveStore(store) {
       // clean/empty the children.
       dojo.query("#" + store.svgId).forEach(dojo.empty);

       var InsertionPointId = svg.getElementById(store.svgId);
       var schema           = store.Model().schema;
       
       store.forEach(function(item) {
         var objNode = document.createElementNS("", store.svgItemNodeName);

         InsertionPointId.appendChild(objNode);

         for(var property in schema) {
           if( schema.hasOwnProperty(property) ) {

             var node = document.createElementNS("", property);
             var data = item.get(property);

             if( data instanceof Array ) {

               data = item.get(property).slice();

               for(var j = 0; j < data.length; j++) {
                 var item = document.createElementNS("", "item");
                 var t = document.createTextNode(data[j]); 
                 item.appendChild(t);
                 node.appendChild(item);
               }
             }
             else {
               var t = document.createTextNode(data);
               node.appendChild(t);
             }
             objNode.appendChild(node);
           }
         }    
       });
     }


     function LoadStore(svgDoc, store) {
       var svgNode = svgDoc.getElementById(store.svgId);    

       if ( !svgNode ) { 
         return;
       }  

       var childrenNodes = svgNode.childNodes; // getElementsByTagName(store.svgItemNodeName);
       var schema = store.Model().schema;

       for(var i = 0; i < childrenNodes.length; i ++) {
         var data = childrenNodes[i];
         var def = {};

          if( data.nodeType == 3) {  // allow to edit svg and put white characters.
            continue;
          }

         for(var property in schema) {
           if( schema.hasOwnProperty(property) ) {
             var type = typeof(schema[property]) == "object" ? schema[property].type : schema[property];
             var elements = data.getElementsByTagName(property); // [0].textContent;

             if( elements.length > 0 ) { 
               if( type == "numeric" ) {
                 if( !isNaN(elements[0].textContent) ) def[property] = Number(elements[0].textContent);
               }
               else if( type == "boolean") def[property] = elements[0].textContent == 'true';
               else def[property] = elements[0].textContent;
             }
           }
         }
         def["load"] = true; // attribute used to flag that this is the load step, to avoid recomputing y coordinate.
         store.putSync(def);
       }
     }


     function SaveStores() {
       SaveStore(configurationStore);
       SaveStore(calendarStore);
       SaveStore(yCoordStore);
       SaveStore(crewMemberStore);
       SaveStore(activityStore);
       SaveStore(eventStore);
       SaveStore(distanceStore);
       SaveStore(stationStore); 
       SaveStore(noteStore); 
     }


     function LoadSvgStores(svgNode) {
       RemoveIntroMessage();


       LoadStore(svgNode, configurationStore);
       // load single object (id 0) in config.
       config = configurationStore.getSync(0);
       console.log(config);          
       config.Apply();

       LoadStore(svgNode, calendarStore);
       LoadStore(svgNode, yCoordStore);
       yCoordStore.ComputeYAndHeigth();
       LoadStore(svgNode, crewMemberStore);
       LoadStore(svgNode, activityStore);
       LoadStore(svgNode, eventStore);
       LoadStore(svgNode, distanceStore);
       LoadStationStore(svgNode.getElementById("StationStore"), MODE_SVG);
       LoadStore(svgNode, noteStore);

       stationStore.filter({name: config.CalendarStation}).fetchRange({start: 0, end: 1}).then(function(results) {
         if( results.length > 0 ) {
           registry.byId("CalendarStation").set("value", "" + results[0].id);
         }
       });

       topic.publish("refreshGraph");
     }


     // ===============================================
     // LOADING STORES FROM SVG
     // ===============================================

     mappingStationSvgXml = { 
       "id"          : "id",
       "code"        : "code",
       "name"        : "name",
       "dstShift"    : "dst-shift",
       "dstStartLst" : "dst-start-lst",
       "dstEndLst"   : "dst-end-lst",
       "utcOffset"   : "utc-offset",
       "regionList"  : "region-list",
       "item"        : "region"
     };

     MODE_SVG = 0;
     MODE_XML = 1;

     // Some tags are not exactly the same in svg def and xml def of a station.
     // The xml introduce some dash character in word which is not compliant with 
     // variable name.
     function convertionSvgXml(key, mode) {
       return mode == MODE_SVG ? key : mappingStationSvgXml[key];
     }


     function LoadStationStore(parentNode, mode) {
       var rootStationStoreChildren = parentNode.getElementsByTagName("station");
       var offsetRegex = /^(-?\d{2})h(\d{2})$/;

       for(var i = 0; i < rootStationStoreChildren.length; i ++) {
         var obj = rootStationStoreChildren[i];

         var data = offsetRegex.exec(obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent);
         var offset = moment.duration({hours: data[1], minutes: data[2]}).asMinutes() * -1;

         var id = mode == MODE_SVG ? obj.getElementsByTagName("id")[0].textContent : obj.getAttribute("id"); 

         var regionList = obj.getElementsByTagName(convertionSvgXml("item", mode)); 

         var regions = [];
         for(var j = 0; j < regionList.length; j++) {
           regions.push(regionList[j].textContent);
         }

//console.log("station code:   " + obj.getElementsByTagName(convertionSvgXml("code", mode))[0].textContent ); 
//console.log("station name:   " + obj.getElementsByTagName(convertionSvgXml("name", mode))[0].textContent );          
//console.log("station offset: " + offset );          

         stationStore.putSync({
           id: id,
           code: obj.getElementsByTagName(convertionSvgXml("code", mode))[0].textContent,
           name: obj.getElementsByTagName(convertionSvgXml("name", mode))[0].textContent,
           dstShift: obj.getElementsByTagName(convertionSvgXml("dstShift", mode))[0].textContent, 
           dstStartLst: obj.getElementsByTagName(convertionSvgXml("dstStartLst", mode))[0].textContent,
           dstEndLst: obj.getElementsByTagName(convertionSvgXml("dstEndLst", mode))[0].textContent,
           utcOffset: obj.getElementsByTagName(convertionSvgXml("utcOffset", mode))[0].textContent,
           offset: offset,
           regionList: regions,
         });
       }
     }


     var stationStoreAdapter = new DstoreAdapter(stationStore);
     registry.byId("CalendarStation").set("store", stationStoreAdapter);



     // ===============================================
     // 
     // ===============================================

     var grid = new (declare([OnDemandGrid, Selection, Keyboard, Editor, CompoundColumns]))({ 
         collection    : tripDetailStore,
         showHeader    : true,
         noDataMessage : 'Please fill in the "Start date time" field first.',
       },
       'TripGrid'
     );


     grid.on('dgrid-datachange', function(event) {
       var cell = grid.cell(event);

       var columnName =  cell.column.field;

       if( columnName == "station") {
         var nextRow = grid.down(cell.row, 1);
         if( nextRow.data.type == "lay" ) {
           nextRow = grid.down(cell.row, 2);
           nextRow.data.station = event.value;
           grid.collection.putSync(nextRow.data);
         }
       }
       else if( columnName == "dhour" ) {
         cell.row.data.dhour  = event.value;
         grid.collection.putSync(cell.row.data);
         grid.collection.updateDuration();
       } 
       else if( columnName == "dminute" ) {
         cell.row.data.dminute = event.value;
         grid.collection.putSync(cell.row.data);
         grid.collection.updateDuration();
       }
     });

     var columns = [{
         label      : "Station",
         field      : "station",
         sortable   : false,
         editor     : FilteringSelect,
         autoSave   : true,
         editorArgs : {
           store      : stationStoreAdapter,
           maxHeight  : 150,
           style      : "width:5em;",
           labelAttr  : "code",
           searchAttr : "code",
           required   : true,
         },
         canEdit    : function(object, value) {
                        return object.stationSelect;
                      },
       },
       {
         label    : "Type",
         field    : "lblType",
         sortable : false,
       },
       {
         label      : "Leg type",
         field      : "legType",
         sortable   : false,
         editor     : FilteringSelect,
         autoSave   : true,
         editorArgs : {
           store     : typeLegStore,
           maxHeight : 150,
           style     : "width:7em;",
           required  : true,
         },
         canEdit    : function(object, value) {
                        return object.type == "leg";
                      },
       },
       { 
         label    : 'Start',
         field    : 'startDateTime',
         sortable : false,
       },
       {
         label    : 'Duration',
         children : [{ 
             field      : 'dhour',
             label      : 'Hour',
             sortable   : false,
             editor     : ComboBox,
             autoSave   : true,
             editorArgs : {
               store      : zeroTo99Store,
               regExp     : "[0-9]+",
               style      : "width         : 5em;",
               required   : true,
             },
             canEdit    : function(object, value) {
                            return object.durationSelect;
                          },
           },
           { 
             field      : 'dminute',
             label      : 'Minute',
             sortable   : false,
             editor     : FilteringSelect,
             autoSave   : true,
             editorArgs : {
               store      : zeroTo59Store,
               style      : "width         : 5em;",
               required   : true,
             },
             canEdit    : function( object, value) {
                            return object.durationSelect;
                          },
           },
         ],
       },
       { 
         label    : 'End',
         field    : 'endDateTime',
         sortable : false,
       },
       {
         label      : 'Operations',
         sortable   : false,
         editor     : CustomEditorOperations,
         editorArgs : {
           grid : grid 
         },
       },
     ];

     grid.set("columns", columns);
     grid.set('sort', 'order');

     grid.startup();          


     // ===============================================
     // EVENTS on dijit
     // ===============================================

     registry.byId("SHCalendarHours").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("hour_label");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHCalendarDayX").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("relative");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHCalendarDayYYYYMMDD").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("yyyymmdd");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHCalendarDayBars").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("day_bar");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHCalendarHourBars").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("hour_bar");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("XGraphCompression").on("change", function(value) {
       config.XGraphCompression = value;

       configurationStore.putSync(config);          

       topic.publish("refreshGraph");
     }, true);

     // -----------------------------------------------
     // Show/Hide activity dialog
     // -----------------------------------------------
     registry.byId("SHActivityHours").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("act_hour");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHActivityDetails").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("details");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHActivityDetailHours").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("dtl_hour");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     registry.byId("SHActivityDetailStations").on("change", function(isChecked) {
       var divs = svg.getElementsByClassName("dtl_station");

       for (var i = 0; i < divs.length; i++) {
         divs[i].setAttribute("display", isChecked ? "block" : "none");
       }
     }, true);

     // -----------------------------------------------
     // Load XML station file dialog
     // -----------------------------------------------
     registry.byId("LoadStation").on("click", function() {
       var upload = registry.byId("uploader");

       var f = upload._files[0];

       if( f.type != "text/xml" ) {
         alert("Please provide an xml file");
         return;
       }          

       var reader = new FileReader();

       // Closure to capture the file information and save it in the store.
       reader.onload = (function(theFile) {
         return function(e) {
           xmlDom = xmlparser.parse(e.target.result);

           LoadStationStore(xmlDom, MODE_XML);
         };
       })(f);

       // Read in the file as a text.
       reader.readAsText(f);

       LoadStationDialog.hide();

       config.MenuCalendar = false;
       config.MenuCalendarSetStartEnd = false;

       configurationStore.putSync(config);

     });

     // -----------------------------------------------
     // Load SVG file dialog
     // -----------------------------------------------
     registry.byId("LoadSvg").on("click", function() {
       var upload = registry.byId("uploader2");

       var f = upload._files[0];

       if( f.type != "image/svg+xml" ) {
         alert("Please provide an svg file");
         return;
       }          

       var reader = new FileReader();

       // Closure to capture the file information and save it in the store.
       reader.onload = (function(theFile) {
         return function(e) {
           xmlDom = xmlparser.parse(e.target.result);

           LoadSvgStores(xmlDom);
         };
       })(f);

       // Read in the file as a text.
       reader.readAsText(f);

       LoadSvgDialog.hide();
     });


     // -----------------------------------------------
     // Constants dialog
     // -----------------------------------------------

     registry.byId("ShowConstantsDialog").on("show", function() {
       viewInForm(config, dom.byId("ShowConstantsForm"));
     }, true);

     registry.byId("SaveConstants").on("click", function() {
       if( !registry.byId("ShowConstantsForm").validate() ) {
         return;
       }

       ShowConstantsDialog.hide();

       setFromForm(config, dom.byId("ShowConstantsForm"));

       configurationStore.putSync(config);
     });

     // -----------------------------------------------
     // Show/Hide calendar dialog
     // -----------------------------------------------

     registry.byId("ShowHideCalendarDialog").on("show", function() {
       viewInForm(config, dom.byId("ShowHideCalendarForm"));
     }, true);

     registry.byId("SaveShowHideCalendar").on("click", function() {
       if( !registry.byId("ShowHideCalendarForm").validate() ) {
         return;
       }

       ShowHideCalendarDialog.hide();

       setFromForm(config, dom.byId("ShowHideCalendarForm"));

       configurationStore.putSync(config);
     });

     // -----------------------------------------------
     // Show/Hide activity dialog
     // -----------------------------------------------

     registry.byId("ShowHideActivityDialog").on("show", function() {
       viewInForm(config, dom.byId("ShowHideActivityForm"));
     }, true);

     registry.byId("SaveShowHideActivity").on("click", function() {
       if( !registry.byId("ShowHideActivityForm").validate() ) {
         return;
       }

       ShowHideActivityDialog.hide();

       setFromForm(config, dom.byId("ShowHideActivityForm"));

       configurationStore.putSync(config);
     });

     // -----------------------------------------------
     // Save file dialog
     // -----------------------------------------------
     registry.byId("SaveFile").on("click", function() {

       SaveStores();

       //get svg source.
       var serializer = new XMLSerializer();
       var source = vkbeautify.xml(serializer.serializeToString(svg));
       var blob = new Blob([source], {type: "text/plain;charset=utf-8"});

       var filename = registry.byId("filename").value;

       saveAs(blob, filename);   

       SaveFileDialog.hide();
     }, true);

     // -----------------------------------------------
     // Calendar range set up dialog
     // -----------------------------------------------
     registry.byId("CalendarTimezone").on("focus", function() {
       if( this.get("value") ) {
         registry.byId("CalendarStation").set("disabled", false);
       }          
     }, true);

     registry.byId("CalendarTimezone").on("change", function() {
       var item = timezoneStore.getSync(this.get("value"));
console.log("timezone :" + item); 

       // Set default time zone, based on user input.
       moment.tz.setDefault(item.name);

       if( item ) {          
         registry.byId("CalendarStation").set("disabled", false);

         if( !registry.byId("CalendarStation").get("value") ) {
           
           var zone = moment.tz.zone(item.name);
console.log("zone: ");  
console.log(zone);  

           var dateOutsideDST = moment();

           while( dateOutsideDST.isDST() ) {
             dateOutsideDST.subtract(1, 'months');
           }

           var offsetZone = zone.offset(dateOutsideDST.valueOf());         
console.log("offsetZone: " + offsetZone);

           registry.byId("CalendarStation").set("value", "");
           registry.byId("CalendarStation").set("query", {offset: offsetZone});
         }
       }
     }, true);


     registry.byId("CalendarStart").on("change", function() {
       registry.byId("CalendarEnd").constraints.min = date.add(this.get("value"), "day", 1);
       registry.byId("CalendarEnd").dropDownDefaultValue = this.get("value");     

       registry.byId("TrainingStartDate").constraints.min = this.get("value");
       registry.byId("TrainingStartDate").dropDownDefaultValue = this.get("value");
       registry.byId("TripStartDate").constraints.min = this.get("value");
       registry.byId("TripStartDate").dropDownDefaultValue = this.get("value");
     }, true);

     registry.byId("CalendarEnd").on("change", function() {
       var maxDate = date.add(this.get("value"), "day", -1);

       registry.byId("CalendarStart").constraints.max = maxDate;

       registry.byId("TrainingStartDate").constraints.max = maxDate;
       registry.byId("TripStartDate").constraints.max = maxDate;
     }, true);

     registry.byId("SetCalendarDialog").on("show", function() {
       viewInForm(config, dom.byId("SetCalendarForm"));
     }, true);


     registry.byId("SetCalendar").on("click", function() {
       if( !registry.byId("SetCalendarForm").validate() ) {
         return;
       }
       RemoveIntroMessage();

       setFromForm(config, dom.byId("SetCalendarForm"));

       var start = moment(config.CalendarStart);

       Xorig = start.unix();
       var end   = moment(config.CalendarEnd); 
       var range = end.diff(start, "days");

       calendarStore.fetch().then(function(days) {
         for (var i = days.length - 1; i >= 0; i--) {
           calendarStore.remove(days[i].pk);
         }
       });        

       moment.tz.setDefault();

       var dstStatus = start.isDST();

       var x = 0;
       var width = 0;

       XStartPeriod = 0;

       for(i = 0; i < range; i++) {

         var nextDay = moment(start).add(1, "days");   
         width = nextDay.diff(start, "hours") * 60;

         calendarStore.addSync({
           name: start.format().substring(0, 10),
           relative: i,
           pk: i+1, // for unknown reason, checkedmultiselect does not work with 0. 
           x: x, 
           width: width - 1, 
         });

         // look for DST
         if( width != 1440 ) { 
           var InitialState =  start.isDST();

           while( start.isDST() == InitialState ) {
             start.add(1, "minutes");
           }
 
           eventStore.addSync({
             pk          : eventStore.GetNextPKSequence(),
             label       : InitialState ? "End DST" : "Start DST",
             short_label : InitialState ? "End DST" : "Start DST",
             x           : getPositionX(start),
           });
         }

         x += width;
         start = nextDay;
         XStartNextPeriod = x;
       }

       AdjustCrewmemberBarScaleX(x);

       // enabled some menu items.
       config.MenuCalendarSetStartPeriods = false;
       config.MenuBusinessObject          = false;
       config.MenuGraphOption             = false;
       config.MenuHighLights              = false;
       config.MenuFileSaveSVGFile         = false;
       config.MenuFileExportToPI          = false;

       configurationStore.putSync(config);

       topic.publish("refreshGraph");

       SetCalendarDialog.hide();
     });


     // -----------------------------------------------
     // Manage Set Start Periods dialog
     // -----------------------------------------------
     registry.byId("SetStartPeriodsDialog").on("show", function() {
       var arrChecked = [];
       calendarStore.forEach(function(item) {
         if( item.startperiod ) {
           arrChecked.push(item.pk);
         }
       });
       arrChecked.push(0);          
       console.log(arrChecked);
       registry.byId("CalendarStartPeriods").setStore(calendarStoreAdapter, arrChecked);
     }, true);

     // Redraw start periods
     registry.byId("SetStartPeriods").on("click", function() {
       var newStarts = registry.byId("CalendarStartPeriods").value;
       var ref =  newStarts.length > 0 ? newStarts[0] : 0; 

       var i = 0; 

       calendarStore.forEach(function(item) {
         item.set("relative", item.pk - ref);
         if( i < newStarts.length && newStarts[i] == item.pk ) {
           console.log("SetStartPeriods");
           console.log(i);
           console.log(item);
           item.set("startperiod", true);
           if( i == 0 ) XStartPeriod = item.x;
           if( i == 1 ) XStartNextPeriod = item.x;  
           i+=1;
         }
         else {
           item.set("startperiod", false);
         }
         calendarStore.put(item);
       });

       SetStartPeriodsDialog.hide();

       topic.publish("refreshGraph");
     });

     // -----------------------------------------------
     // Create Crewmember dialog
     // -----------------------------------------------
     registry.byId("CreateCrewMember").on("click", function() {

       // Add the new crew in the store. Event will trigger the drawing.
       crewMemberStore.addSync({
         pk        : crewMemberStore.GetNextPKSequence(),
         name      : registry.byId("CrewMemberName").get("value"),
         birthdate : registry.byId("CrewMemberBirthDate").get("value").toISOString().substring(0, 10),
         lineCount : 1,
       });

       topic.publish("refreshGraph");

       CreateCrewMemberDialog.hide();
     });


     // -----------------------------------------------
     // Create Day Off dialog
     // -----------------------------------------------
     registry.byId("CreateDayOff").on("click", function() {
       if( !registry.byId("CreateDayOffForm").validate() ) {
         return;
       }

       CreateDayOffDialog.hide();
       var crewMemberPk = parseInt(registry.byId("DayOffCrewMemberSelect").get("value"));
       var days = registry.byId("DayOffDatesSelect").value; 

       // to avoid the "at least one item must be selected" message, form data are save in 
       // local variables before reseting the form.
       registry.byId("CreateDayOffForm").reset();

       days.forEach(function(day) {
         var calendarDay = calendarStore.getSync(day); 

         var x     = calendarDay.get("x");
         var width = calendarDay.get("width") + 1;

         var lineNb = GetActivityLineNumber(crewMemberPk, x + Number(config.midnightOffset), width);

         if( lineNb > 1 ) {  
           alert("DO starting " + calendarDay.get("name") + " is overlapping with another activity."); 
         }
         var activity = activityStore.addSync({
           name           : "DO",
           fullname       : crewMemberStore.getSync(crewMemberPk).name + " -- " + moment(calendarDay.get("name")).format("YYYY-MM-DD") + " -- DO",
           type           : "DO",           
           pk             : activityStore.GetNextPKSequence(),
           fk_cm          : crewMemberPk,
           x              : x,
           midnightoffset : Number(config.midnightOffset),
           lbtStart       : moment(calendarDay.get("name")).format("YYYY-MM-DD HH:mm"),
           lbtEnd         : moment(calendarDay.get("name")).add(width, 'm').format("YYYY-MM-DD HH:mm"),
           utcStart       : moment(calendarDay.get("name")).utc().format("YYYY-MM-DD HH:mm"),
           utcEnd         : moment(calendarDay.get("name")).add(width, 'm').utc().format("YYYY-MM-DD HH:mm"),
           width          : width,
           tp             : 0,
           resta          : 0,
           restb          : 0,
           lineNb         : lineNb,
         });

         activity.CreateEvents();
       });

       topic.publish("refreshGraph");
     });

     // -----------------------------------------------
     // Create Training dialog
     // -----------------------------------------------
     function TryEnableDuration() {
       if(   registry.byId("TrainingStartTime").get("value") != null 
           && registry.byId("TrainingStartDate").get("value") != null ) {
         registry.byId("TrainingDurationHour").readOnly = false;
         registry.byId("TrainingDurationHour").set("value", 0);
         registry.byId("TrainingDurationMinute").readOnly = false;
         registry.byId("TrainingDurationMinute").set("value", 0);

         UpdateEndDateTime("Training");
       }
     }

     registry.byId("TrainingStartDate").on("click,mousedown", function() {
       TryEnableDuration();          
     });

     registry.byId("TrainingStartDate").on("change", function(value) {
       TryEnableDuration();          
     });

     registry.byId("TrainingStartTime").on("click,mousedown", function() {
       TryEnableDuration();          
     });

     registry.byId("TrainingStartTime").on("change", function(value) {
       TryEnableDuration();          
     });

     registry.byId("TrainingDurationHour").on("click", function() {
       UpdateEndDateTime("Training");
     });
     registry.byId("TrainingDurationHour").on("change", function(val) {
       UpdateEndDateTime("Training");
     });

     registry.byId("TrainingDurationMinute").on("click", function() {
       UpdateEndDateTime("Training");
     });
     registry.byId("TrainingDurationMinute").on("change", function(val) {
       UpdateEndDateTime("Training");
     });

     CreateTrainingDialog.on("show", function() {
       // reset filteringselect Minute of rest before and after. Those two are not set to zero.
       registry.byId("TrainingRestBeforeM").set("value", 0);
       registry.byId("TrainingRestAfterM").set("value", 0);
     });

     registry.byId("CreateTraining").on("click", function() {
       if( !registry.byId("CreateTrainingForm").validate() ) {
         return;
       }

       CreateTrainingDialog.hide();

       var lbtTrainingStartDate = registry.byId("TrainingStartDate").get("value");
       var lbtTrainingStartTime = registry.byId("TrainingStartTime").get("value");
       var startTraining    = moment.tz([lbtTrainingStartDate.getYear() + 1900, lbtTrainingStartDate.getMonth(), lbtTrainingStartDate.getDate(), lbtTrainingStartTime.getHours(), lbtTrainingStartTime.getMinutes()], timezoneStore.getSync(config.CalendarTimezone).name);
       var x                = getPositionX(startTraining);

       var width = Number(registry.byId("TrainingDurationHour").get("value")) * 60 + Number(registry.byId("TrainingDurationMinute").get("value"));

       var endTraining = startTraining.clone().add(width, 'm');
       var crewMemberPk = Number(registry.byId("TrainingCrewMemberSelect").get("value"));

       var lineNb = GetActivityLineNumber(crewMemberPk, x, width);

       var fullname = crewMemberPk ? crewMemberStore.getSync(crewMemberPk).name : "Open time";
       fullname += " -- " + startTraining.format("YYYY-MM-DD HH:mm") + " -- " + registry.byId("TrainingName").get("value");

       if( lineNb > 1 ) {
         alert("The new traininig is overlapping with another activity."); 
       }
       var activity = activityStore.addSync({
         name           : registry.byId("TrainingName").get("value"),
         fullname       : fullname,
         type           : "TRN",
         pk             : activityStore.GetNextPKSequence(),
         fk_cm          : crewMemberPk,
         x              : x,
         midnightoffset : 0,
         lbtStart       : startTraining.format("YYYY-MM-DD HH:mm"),
         lbtEnd         : endTraining.format("YYYY-MM-DD HH:mm"),
         utcStart       : startTraining.utc().format("YYYY-MM-DD HH:mm"),
         utcEnd         : endTraining.utc().format("YYYY-MM-DD HH:mm"),
         width          : width,
         tp             : registry.byId("TrainingTransportationTime").checked ? Number(config.transportationTime) : 0,
         resta          : Number(registry.byId("TrainingRestAfterH").get("value")) * 60 + Number(registry.byId("TrainingRestAfterM").get("value")),
         restb          : Number(registry.byId("TrainingRestBeforeH").get("value")) * 60 + Number(registry.byId("TrainingRestBeforeM").get("value")),
         lineNb         : lineNb,
       });
       
       activity.CreateEvents();

       topic.publish("refreshGraph");
     });


     // -----------------------------------------------
     // Create Event dialog
     // -----------------------------------------------

     registry.byId("CreateEvent").on("click", function() {
       if( !registry.byId("CreateEventForm").validate() ) {
         return;
       }

       CreateEventDialog.hide();
       var label   = registry.byId("EventLabel").get("value");
       var days    = registry.byId("EventDatesSelect").value; 
       var time    = registry.byId("EventTime").value; 

       // to avoid the "at least one item must be selected" message, form data are save in 
       // local variables before reseting the form.
       registry.byId("CreateEventForm").reset();

       if( days.length == 0 ) {
         calendarStore.forEach(function(item) {
           days.push(item.pk);
         }); 
       }

       var yCoordinate = yCoordStore.addSync({
         pk     : yCoordStore.GetNextPKSequence(),
         y      : -1,
         height : HEIGHT_LINE_HL,
       });

       for(i = 0; i < days.length; i++) {
         var calDay = calendarStore.getSync(days[i]);

         var when = moment.tz(calDay.get("name"), timezoneStore.getSync(config.CalendarTimezone).name);
         when.hour(time.getHours());
         when.minute(time.getMinutes());

         if( when.isValid() ) {   
           eventStore.addSync({
             pk          : eventStore.GetNextPKSequence(),
             short_label : label,
             label       : when.format("YYYY-MM-DD HH:mm") + " -- " + label, 
             x           : getPositionX(when),
             fk_yc       : yCoordinate.pk,
           });
         }
       }

       topic.publish("refreshGraph");
     });  


     // -----------------------------------------------
     // Create Distance dialog
     // -----------------------------------------------
     function UpdateEvent(val, idEventSelect) {
       var filter = new eventStore.Filter();
       var selectInput = registry.byId(idEventSelect);   

       selectInput.set("sortByLabel", false);
       selectInput.set("query", {fk_act: val}); 

       var totoFilter = filter.eq('fk_act', val).eq('start', 1);
       eventStore.filter(totoFilter).fetch().then(function(items) {
         if( items.length == 1 ) {
           selectInput.set("displayedValue", items[0].long_lbl);
          }
       });

       selectInput.set("disabled", false);
     }

     registry.byId("DistanceFromActSelect").on("change", function(val) {
       UpdateEvent(val, "DistanceFromActEventSelect");
     });
     registry.byId("DistanceToActSelect").on("change", function(val) {
       UpdateEvent(val, "DistanceToActEventSelect");
     });

     registry.byId("DistanceFromActivity").on("click", function() {
       dojo.query(".dstFromAct").style("display", "inherit");
       dojo.query(".dstFromEvt").style("display", "none");
     });
     registry.byId("DistanceFromEvent").on("click", function() {
       dojo.query(".dstFromAct").style("display", "none");
       dojo.query(".dstFromEvt").style("display", "inherit");
     });
     registry.byId("DistanceToActivity").on("click", function() {
       dojo.query(".dstToAct").style("display", "inherit");
       dojo.query(".dstToEvt").style("display", "none");
     });
     registry.byId("DistanceToEvent").on("click", function() {
       dojo.query(".dstToAct").style("display", "none");
       dojo.query(".dstToEvt").style("display", "inherit");
     });


     registry.byId("CreateDistance").on("click", function() {
/*       if( !registry.byId("CreateDistanceForm").validate() ) {
         return;
       }*/
       var distance = new distanceModel();
       var yFrom = 0;
       var yTo   = 0;

       if( registry.byId("DistanceFromActivity").checked ) {
         distance.fk_actFrom = registry.byId("DistanceFromActSelect").value;
         distance.fk_evtFrom = registry.byId("DistanceFromActEventSelect").value;
         yFrom = activityStore.getSync(registry.byId("DistanceFromActSelect").value).GetYCoord();
       }
       else {
         distance.fk_evtFrom = registry.byId("DistanceFromEventSelect").value;
       }
       if( registry.byId("DistanceToActivity").checked ) {
         distance.fk_actTo = registry.byId("DistanceToActSelect").value;
         distance.fk_evtTo = registry.byId("DistanceToActEventSelect").value;
         yTo = activityStore.getSync(registry.byId("DistanceToActSelect").value).GetYCoord();
       }
       else {
         distance.fk_evtTo = registry.byId("DistanceToEventSelect").value;
       }

       // Add the new entry in the y coord store.
       var yCoord = yCoordStore.addSync({
         pk     : yCoordStore.GetNextPKSequence(),
         y      : Math.max(yFrom, yTo) - 1,
         height : HEIGHT_LINE_HL,
       });


       distance.pk    = distanceStore.GetNextPKSequence();
       distance.fk_yc = yCoord.pk;

       CreateDistanceDialog.hide();
       distanceStore.addSync(distance);

       topic.publish("refreshGraph");
     });  


     function TryEnableGrid() {
       if(   registry.byId("TripStartTime").get("value") != null 
           && registry.byId("TripStartDate").get("value") != null ) {
         tripDetailStore.reportTime = config.reportTime;
         tripDetailStore.releaseTime = config.releaseTime;

         var mydate = moment(registry.byId("TripStartDate").get("value"));
         var mytime = moment(registry.byId("TripStartTime").get("value"));

         // rebuild the start date from StartDate and StartTime field values, 
         mydate.hours(mytime.hours());
         mydate.minutes(mytime.minutes());

         tripDetailStore.startDateTime = mydate;

         if( tripDetailStore.len == 0 ) {

           tripDetailStore.addSync({
             pk      : 1,
             order   : 1,
             type    : "sta",
             station : config.CalendarStation,
           });
           tripDetailStore.addSync({
             pk      : 2,
             order   : 2,
             type    : "leg",
             legType : "A",
             dhour   : 2,
             dminute : 0,
           });
           tripDetailStore.addSync({
             pk      : 3,
             order   : 3,
             type    : "sta",
             station : config.CalendarStation,
           });
         }
         // allow to recompute end date time.
         tripDetailStore.process();
       }
     }


     registry.byId("TripStartDate").on("click,mousedown", function() {
       TryEnableGrid();          
     });

     registry.byId("TripStartDate").on("change", function(value) {
       TryEnableGrid();          
     });

     registry.byId("TripStartTime").on("click,mousedown", function() {
       TryEnableGrid();          
     });

     registry.byId("TripStartTime").on("change", function(value) {
       TryEnableGrid();          
     });

     registry.byId("MenuBusinessObjectCreateActivityTrip").on("click", function() {
       registry.byId("TripRestBeforeM").set("value", 0);
       registry.byId("TripRestAfterM").set("value", 0);

       registry.byId("CreateTripDialog").show();

       grid.resize();
     });


     registry.byId("CreateTripDialog").on("hide", function() {

       tripDetailStore.fetch().then(function(items) {
         for (var i = items.length - 1; i >= 0; i--) {
           tripDetailStore.remove(items[i].pk);
         }           

         grid.refresh();
       });
     });

     function formatDurationInHoursMinutes(width) {
       return parseInt(width / 60) + "h" + ("0" + width % 60).slice(-2);
     }

     function getInPeriod(x, width) {
       var tafbInPeriod = 0;

       var Xstart = Math.max(x, XStartPeriod);
       var Xend   = Math.min(x + width, XStartNextPeriod);

       return Math.max(Xend - Xstart, 0);
     }


     registry.byId("CreateTrip").on("click", function() {
       if( !registry.byId("CreateTripForm").validate() ) {
         return;
       }

       CreateTripDialog.hide();

       var lbtTripStartDate   = registry.byId("TripStartDate").get("value");
       var lbtTripStartTime   = registry.byId("TripStartTime").get("value");
       var lbtTripEndDate     = registry.byId("TripEndDate").get("value");
       var lbtTripEndTime     = registry.byId("TripEndTime").get("value");

       var startTrip = moment.tz([lbtTripStartDate.getYear() + 1900, lbtTripStartDate.getMonth(), lbtTripStartDate.getDate(), lbtTripStartTime.getHours(), lbtTripStartTime.getMinutes()], timezoneStore.getSync(config.CalendarTimezone).name);
       var endTrip   = moment.tz([lbtTripEndDate.getYear() + 1900, lbtTripEndDate.getMonth(), lbtTripEndDate.getDate(), lbtTripEndTime.getHours(), lbtTripEndTime.getMinutes()], timezoneStore.getSync(config.CalendarTimezone).name);

       var x     = getPositionX(startTrip);
       var width = getPositionX(endTrip) - x;

       var crewMemberPk = Number(registry.byId("TripCrewMemberSelect").get("value"));
       var lineNb       = GetActivityLineNumber(crewMemberPk, x, width);

       if( lineNb > 1 ) {
         alert("The new trip is overlapping with another activity."); 
       }

       var xDetail        = x;
       var credit         = 0;
       var block          = 0;
       var duty           = 0;
       var creditInPeriod = 0;
       var blockInPeriod  = 0;
       var dutyInPeriod   = 0;


       tripDetailStore.sort('order').fetch().then(function(items) {
         for (var i = 0; i < items.length ; i++) {
           var width = Number(items[i].dhour * 60) + Number(items[i].dminute);
           var inPeriod = getInPeriod(xDetail, width);
           var type = items[i].type;
           if( type == "leg" ) {
             type += items[i].legType;
             if( items[i].legType == "A" ) {
               credit         += width;
               creditInPeriod += inPeriod;
             }
             block         += width;
             blockInPeriod += inPeriod;
           }
           if( type != "lay" ) {
             duty         += width;
             dutyInPeriod += inPeriod;
           } 

           xDetail += width;
         }           
       });

       var fullname = crewMemberPk ? crewMemberStore.getSync(crewMemberPk).name : "Open time";

       fullname += " -- " + startTrip.format("YYYY-MM-DD HH:mm") + " -- " + registry.byId("TripName").get("value");  

       var trip = activityStore.addSync({
         name           : registry.byId("TripName").get("value"),
         fullname       : fullname,
         type           : "TRP",
         pk             : activityStore.GetNextPKSequence(),
         fk_cm          : crewMemberPk,
         x              : x,
         midnightoffset : 0,
         lbtStart       : startTrip.format("YYYY-MM-DD HH:mm"),
         lbtEnd         : endTrip.format("YYYY-MM-DD HH:mm"),
         utcStart       : startTrip.utc().format("YYYY-MM-DD HH:mm"),
         utcEnd         : endTrip.utc().format("YYYY-MM-DD HH:mm"),
         width          : width,
         tp             : registry.byId("TripTransportationTime").checked ? Number(config.transportationTime) : 0,
         resta          : Number(registry.byId("TripRestAfterH").get("value")) * 60 + Number(registry.byId("TripRestAfterM").get("value")),
         restb          : Number(registry.byId("TripRestBeforeH").get("value")) * 60 + Number(registry.byId("TripRestBeforeM").get("value")),
         block          : block,
         credit         : credit,
         duty           : duty,
         tafbInPeriod   : getInPeriod(x, width),
         blockInPeriod  : blockInPeriod,
         creditInPeriod : creditInPeriod,
         dutyInPeriod   : dutyInPeriod,
         lineNb         : lineNb,
       });

       xDetail        = x;

       tripDetailStore.sort('order').fetch().then(function(items) {
         var iLeg = 0;
         var iLay = 0;
         var name, width, type;

         for (var i = 0; i < items.length ; i++) {
           width = Number(items[i].dhour * 60) + Number(items[i].dminute);
           type = items[i].type;
           if( type == "leg" ) {
             type += items[i].legType;
             iLeg += 1;
             name = type + iLeg;
           }
           else {
             iLay += 1;
             name = type + iLay;
           }

           activityStore.addSync({
             name      : name,
             fullname  : name + " -- " + startTrip.format("YYYY-MM-DD HH:mm"),
             type      : type.toUpperCase(),
             pk        : activityStore.GetNextPKSequence(),
             fk_parent : trip.pk,
             fk_cm     : crewMemberPk,
             x         : xDetail,
             width     : width,
             station   : items[i].station,
           });
           xDetail += width;
         }           
       });

       trip.CreateEvents();          

       topic.publish("refreshGraph");

     });

    

     function ProcessXslt(id, strXml, strXslt) {
       var domParser = new DOMParser();

       var xslt = domParser.parseFromString(strXslt, "text/xml");
       var xml  = domParser.parseFromString(strXml,  "text/xml");
         
       var xsltProcessor = new XSLTProcessor();
       xsltProcessor.importStylesheet(xslt);

       var fragment = xsltProcessor.transformToDocument(xml);
       var serializer = new XMLSerializer();

       dom.byId(id).nextSibling.CodeMirror.getDoc().setValue(vkbeautify.xml(serializer.serializeToString(fragment))); 
     }


     function SetXslEditor(id) {
       var textarea = dom.byId(id);   

       var editor = CodeMirror.fromTextArea(textarea, {
          lineNumbers: true,
          smartIndent: true,
          mode: "xml",
          indentUnit: 2,
          matchTags: {bothTags: true},
          extraKeys: {"Ctrl-J": "toMatchingTag", 
                      "Ctrl-F": function(cm){ cm.foldCode(cm.getCursor()); }},
          foldGutter: true,
          gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
          onCursorActivity: function () {
            editor.setLineClass(hlLine, null);
            hlLine = editor.setLineClass(editor.getCursor().line, "activeline");
          },
       });

       editor.on('change', function (cm) {
         textarea.value = cm.getValue();
       });
     }

 

     SetXslEditor('XMLqual');
     SetXslEditor('XMLacts'); 
     SetXslEditor('XMLtrip'); 
     SetXslEditor('XMLtrip_sup'); 
     SetXslEditor('XMLstation'); 




     SaveFileToPIDialog.on("show", function() {
       var windowSize = win.getBox();
       var w = Math.floor(windowSize.w * 0.8);
       var h = Math.floor(windowSize.h * 0.6);

       domStyle.set("ici", {
         width: w + "px", 
         height: h + "px",
       });

       SaveStores();
       
       //get svg source.
       var serializer = new XMLSerializer();
       var strXml = serializer.serializeToString(svg);

       ProcessXslt('XMLqual',     strXml, Gantt2QualXsl);
       ProcessXslt('XMLacts',     strXml, Gantt2ActsXsl); 
       ProcessXslt('XMLtrip',     strXml, Gantt2TripXsl); 
       ProcessXslt('XMLtrip_sup', strXml, Gantt2TripSupXsl); 
       ProcessXslt('XMLstation',  strXml, Gantt2StationXsl); 
     });

     registry.byId("SaveZipFile").on("click", function() {
       if( !registry.byId("SaveFileToPIForm").validate() ) {
         return;
       }

       SaveFileToPIDialog.hide();   

       var zip = new JSZip();
       zip.file("qual.xml",     dom.byId("XMLqual").value);
       zip.file("acts.xml",     dom.byId("XMLacts").value);
       zip.file("trip.xml",     dom.byId("XMLtrip").value);
       zip.file("trip_sup.xml", dom.byId("XMLtrip_sup").value);
       zip.file("station.xml",  dom.byId("XMLstation").value);

       //get svg source.
       var serializer = new XMLSerializer();
       zip.file("data.svg", serializer.serializeToString(svg));

       var zipFilename = registry.byId("zipFilename").value;

       zip.generateAsync({type:"blob"}).then(function(content) {
         saveAs(content, zipFilename);
       });

       registry.byId("SaveFileToPIForm").reset();
     });






     cp = dijit.byId('NoteColorPaletteWidget');
     dojo.connect(cp,'onChange',function(){
       dojo.style(dojo.byId('NoteColorSwatch'),{backgroundColor: cp.value});
       dijit.popup.close(dijit.byId("NoteColorPaletteDialog"));
     });

     registry.byId("SaveNote").on("click", function() {
       if( !registry.byId("NoteForm").validate() ) {
         return;
       }

       CreateNoteDialog.hide();   

       noteStore.addSync({
         pk    : noteStore.GetNextPKSequence(),
         note  : registry.byId("NoteEditor").get("value"),
         color : registry.byId("NoteColorPaletteWidget").get("value"),
       });

       // registry.byId("NoteForm").reset();
       registry.byId("NoteEditor").set("value", "");
       registry.byId("NoteColorPaletteWidget").set("value", "#fff5ee"),
console.log(noteStore);          
     });








     // ==============================================
     // FORM
     // ==============================================
     function viewInForm(object, form) {
       for(var i = 0; i < form.elements.length; i++ ) {
         if(form.elements[i].name) {
           var element = form.elements[i];
           var name = element.name;
           var value = object[name];

           console.log(name);
           console.log(element);
           console.log(element.type);
           console.log(element.checked);
           console.log(object[name]);
           if( typeof(object[name]) != 'undefined' ) {
             if( element.type == "checkbox" ) {
               console.log('on checked');
               console.log(registry.byId(name));
               registry.byId(name).set("checked", value);
             }
             else {
               console.log('on value');
               console.log(registry.byId(name));
               if( registry.byId(name) ) {
                 registry.byId(name).set("value", value);
               }
               else  {
  console.log("================================================");          
  console.log("************************************************");          
  console.log("j'aime pas ca:" + name);          
  console.log("************************************************");          
  console.log("================================================");          
                 var input = query("input[name=" + name + "]", form)[0];
                 if(input) {
                   console.log(name + "---" + value);
                   // here is a little hack. dijit dialog create an hidden input with the right name.
                   // but the one used to display is the sibling before. So I reference the parent and
                   // pick the first child with the right class.
                   var dijitInputInner  = query(".dijitInputInner", input.parentNode)[0];
                   var dijitPlaceHolder = query(".dijitPlaceHolder", input.parentNode)[0];

                   console.log(dijitInputInner);

                   if( dijitInputInner ) dijitInputInner.value = value;
                   if( dijitPlaceHolder ) dijitPlaceHolder.style.display = "none";  
                 }
               }
             }
           }
         }
       }
     }

     function setFromForm(object, form) {
       for(var i = 0; i < form.elements.length; i++ ) {
         if(form.elements[i].name) {
           // console.log(form.elements[i].name);
           // console.log(form.elements[i].value);
           // console.log(form.elements[i].type);
           // console.log(form.elements[i].checked);
           object[form.elements[i].name] =form.elements[i].type == "checkbox" ?  form.elements[i].checked : form.elements[i].value;
         }
       }
     }



    /** 
     *  SVGPan library 1.2.1
     * ======================
     *
     * Given an unique existing element with id "viewport" (or when missing, the first g 
     * element), including the the library into any SVG adds the following capabilities:
     *
     *  - Mouse panning
     *  - Mouse zooming (using the wheel)
     *  - Object dragging
     *
     * You can configure the behaviour of the pan/zoom/drag with the variables
     * listed in the CONFIGURATION section of this file.
     *
     * Known issues:
     *
     *  - Zooming (while panning) on Safari has still some issues
     *
     * Releases:
     *
     * 1.2.1, Mon Jul  4 00:33:18 CEST 2011, Andrea Leofreddi
     *	- Fixed a regression with mouse wheel (now working on Firefox 5)
     *	- Working with viewBox attribute (#4)
     *	- Added "use strict;" and fixed resulting warnings (#5)
     *	- Added configuration variables, dragging is disabled by default (#3)
     *
     * 1.2, Sat Mar 20 08:42:50 GMT 2010, Zeng Xiaohui
     *	Fixed a bug with browser mouse handler interaction
     *
     * 1.1, Wed Feb  3 17:39:33 GMT 2010, Zeng Xiaohui
     *	Updated the zoom code to support the mouse wheel on Safari/Chrome
     *
     * 1.0, Andrea Leofreddi
     *	First release
     *
     * This code is licensed under the following BSD license:
     *
     * Copyright 2009-2010 Andrea Leofreddi <a.leofreddi@itcharm.com>. All rights reserved.
     * 
     * Redistribution and use in source and binary forms, with or without modification, are
     * permitted provided that the following conditions are met:
     * 
     *    1. Redistributions of source code must retain the above copyright notice, this list of
     *       conditions and the following disclaimer.
     * 
     *    2. Redistributions in binary form must reproduce the above copyright notice, this list
     *       of conditions and the following disclaimer in the documentation and/or other materials
     *       provided with the distribution.
     * 
     * THIS SOFTWARE IS PROVIDED BY Andrea Leofreddi ``AS IS'' AND ANY EXPRESS OR IMPLIED
     * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
     * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL Andrea Leofreddi OR
     * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
     * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
     * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
     * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
     * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     * 
     * The views and conclusions contained in the software and documentation are those of the
     * authors and should not be interpreted as representing official policies, either expressed
     * or implied, of Andrea Leofreddi.
     */

    /// CONFIGURATION 
    /// ====>

     var enablePan = 1; // 1 or 0: enable or disable panning (default enabled)
     var enableZoom = 1; // 1 or 0: enable or disable zooming (default enabled)
     var enableDrag = 0; // 1 or 0: enable or disable dragging (default disabled)

     /// <====
     /// END OF CONFIGURATION 

     var root = dom.byId("graph");

     var state = "none", svgRoot, stateTarget, stateOrigin, stateTf;

     /**
      * Retrieves the root element for SVG manipulation. The element is then cached into the svgRoot global variable.
      */
     function getRoot(root) {
       if(typeof(svgRoot) == "undefined") {
         var g = null;

         g = dom.byId("viewport");

         if(g == null)
           alert("Unable to obtain SVG root element");

         setCTM(g, g.getCTM());

         g.removeAttribute("viewBox");

         svgRoot = g;
       }

       return svgRoot;
     }

     /**
      * Instance an SVGPoint object with given event coordinates.
      */
     function getEventPoint(evt) {
       var p = root.createSVGPoint();

       p.x = evt.clientX;
       p.y = evt.clientY;

       return p;
     }

     /**
      * Sets the current transform matrix of an element.
      */
     function setCTM(element, matrix) {
       var s = "matrix(" + matrix.a + "," + matrix.b + "," + matrix.c + "," + matrix.d + "," + matrix.e + "," + matrix.f + ")";

       element.setAttribute("transform", s);
     }

     /**
      * Dumps a matrix to a string (useful for debug).
      */
     function dumpMatrix(matrix) {
       var s = "[ " + matrix.a + ", " + matrix.c + ", " + matrix.e + "\n  " + matrix.b + ", " + matrix.d + ", " + matrix.f + "\n  0, 0, 1 ]";

       return s;
     }

     /**
      * Sets attributes of an element.
      */
     function setAttributes(element, attributes) {
       for (var i in attributes)
         element.setAttributeNS(null, i, attributes[i]);
     }

     /**
      * Handle mouse wheel event.
      */
     on(root, (!has("mozilla") ? "mousewheel" : "DOMMouseScroll"), function(evt) {
       if(!enableZoom)
         return;

       if(evt.preventDefault)
         evt.preventDefault();

       evt.returnValue = false;

       var svgDoc = evt.target.ownerDocument;
       var delta;

       if(evt.wheelDelta)
         delta = evt.wheelDelta / 3600; // Chrome/Safari
       else
         delta = evt.detail / -90; // Mozilla

       var z = 1 + delta; // Zoom factor: 0.9/1.1
       var g = getRoot(svgDoc);
       var p = getEventPoint(evt);

       p = p.matrixTransform(g.getCTM().inverse());

       // Compute new scale matrix in current mouse position
       var k = root.createSVGMatrix().translate(p.x, p.y).scale(z).translate(-p.x, -p.y);

       setCTM(g, g.getCTM().multiply(k));

       if(typeof(stateTf) == "undefined")
         stateTf = g.getCTM().inverse();

       stateTf = stateTf.multiply(k.inverse());
     });

     /**
      * Handle mouse move event.
      */
     on(root, touch.move, function(evt) {
       if( evt.preventDefault ) {
         evt.preventDefault();
       }

       evt.returnValue = false;

       var svgDoc = evt.target.ownerDocument;

       var g = getRoot(svgDoc);

       if(state == "pan" && enablePan) {
         // Pan mode
         var p = getEventPoint(evt).matrixTransform(stateTf);

         setCTM(g, stateTf.inverse().translate(p.x - stateOrigin.x, p.y - stateOrigin.y));
       } else if(state == "drag" && enableDrag) {
         // Drag mode
         var p = getEventPoint(evt).matrixTransform(g.getCTM().inverse());

         setCTM(stateTarget, root.createSVGMatrix().translate(p.x - stateOrigin.x, p.y - stateOrigin.y).multiply(g.getCTM().inverse()).multiply(stateTarget.getCTM()));

         stateOrigin = p;
       }
     });

     /**
      * Handle click event.
      */
     on(root, touch.press, function(evt) {
       if( evt.preventDefault ) {
         evt.preventDefault();
       }

       evt.returnValue = false;

       var svgDoc = evt.target.ownerDocument;
       var g = getRoot(svgDoc);

       if(
           evt.target.tagName == "svg" 
           || !enableDrag // Pan anyway when drag is disabled and the user clicked on an element 
         ) {
         // Pan mode
         state = "pan";

         stateTf = g.getCTM().inverse();

         stateOrigin = getEventPoint(evt).matrixTransform(stateTf);
       } else {
         // Drag mode
         state = "drag";

         stateTarget = evt.target;

         stateTf = g.getCTM().inverse();

         stateOrigin = getEventPoint(evt).matrixTransform(stateTf);
       }
     });

     /**
      * Handle mouse button release event.
      */
     on(root, touch.release, function(evt) {
       if( evt.preventDefault ) { 
         evt.preventDefault();
       }

       evt.returnValue = false;

       var svgDoc = evt.target.ownerDocument;

       if( state == "pan" || state == "drag" ) {
         // Quit pan mode
         state = "";
       }
     });

});

  </script>

</head>
<body class="claro">
  <div id="loader">
    <div id="loaderInner" style="direction:ltr;">Loading libraries ...</div> 
  </div> 
  <div id="content" style="display:none;">
    <div data-dojo-type="dijit/MenuBar" id="navMenu" style="margin-bottom: 8px;">
      <div id="MenuFile" data-dojo-type="dijit/PopupMenuBarItem">
        <span>File</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuFileLoadSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {LoadSvgDialog.show();}">Load a SVG file</div>
          <div id="MenuFileLoadXMLStationFile" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {LoadStationDialog.show();}">Load a XML station file</div>
          <div data-dojo-type="dijit/MenuSeparator"></div>
          <div id="MenuFileSaveSVGFile"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SaveFileDialog.show();}">Save as SVG file</div>
          <div data-dojo-type="dijit/MenuSeparator"></div>
          <div id="MenuFileExportToPI"         data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SaveFileToPIDialog.show();}">Export to Planner Interface</div>
        </div>
      </div>
      <div id="MenuCalendar" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Calendar</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuCalendarSetStartEnd"     data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SetCalendarDialog.show();}">Set [Start, End[</div>
          <div id="MenuCalendarSetStartPeriods" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {SetStartPeriodsDialog.show();}">Set start period(s)</div>
        </div>
      </div>
      <div id="MenuBusinessObject" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Business objects</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuBusinessObjectShowConstants"    data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowConstantsDialog.show();}">Show constants</div>
          <div id="MenuBusinessObjectCreateCrewMember" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateCrewMemberDialog.show();}">Create crewmember</div>
          <div data-dojo-type="dijit/PopupMenuItem">
            <span>Create activity</span>
            <div id="MenuBusinessObjectCreateActivity" data-dojo-type="dijit/DropDownMenu">
              <div id="MenuBusinessObjectCreateActivityDayOff"        data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateDayOffDialog.show();}">Day off</div>
              <div id="MenuBusinessObjectCreateActivityTraining"      data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateTrainingDialog.show();}">Training</div>
              <div id="MenuBusinessObjectCreateActivityTrip"          data-dojo-type="dijit/MenuItem" data-dojo-props="">Trip</div>
              <div id="MenuBusinessObjectCreateActivityOtherActivity" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {alert('not yet available');}">Other activity</div>
            </div>
          </div>
        </div>
      </div>
      <div id="MenuGraphOption" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Graph options</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div data-dojo-type="dijit/PopupMenuItem">
            <span>Graph factor compression on X axis</span>
            <select data-dojo-type="dijit/form/Select" name="XGraphCompression" id="XGraphCompression" data-dojo-id="XGraphCompression" style="width: 3em;">
              <option value=".25">0.25</option>
              <option value=".5">0.5</option>
              <option value="1" selected="selected">1</option>
              <option value="2">2</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
            </select>
          </div>
          <div id="MenuGraphOptionCalendar" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowHideCalendarDialog.show();}">Calendar Date/Hours</div>
          <div id="MenuGraphOptionActivity" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {ShowHideActivityDialog.show();}">Activity details</div>
        </div>
      </div>
      <div id="MenuHighLights" data-dojo-type="dijit/PopupMenuBarItem">
        <span>Highlights</span>
        <div data-dojo-type="dijit/DropDownMenu">
          <div id="MenuHighLightsEvent"    data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateEventDialog.show();}">Event(s)</div>
          <div id="MenuHighLightsDistance" data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateDistanceDialog.show();}">Distance</div>
          <div id="MenuHighLightsWindow"   data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {alert('not yet available');}">Window</div>
          <div id="MenuHighLightsNote"     data-dojo-type="dijit/MenuItem" data-dojo-props="onClick:function() {CreateNoteDialog.show();}">Note</div>
        </div>
      </div>

    </div>


    <!-- SVG code -->
    <div id="gantt">
      <svg id="graph" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" height="100%" width="100%">
        <style>
.day_bar {
  fill-opacity: 0.2;
}

.line {
  fill: gray;
  fill-opacity: 0.5;
}

.start_period {
  fill: green;
  fill-opacity: 0.4;
}

.hour_bar {
}

.even {
  fill: yellow;
  fill-opacity: 0.5;
}
.uneven {
  fill: blue;
  fill-opacity: 0.1;
}

.day_label {
  text-anchor: middle; 
  font-size: 40px;
  fill: gray;
}

.hour_label {
  fill: gray;
}

.distance_label {
  text-anchor: middle; 
}

.crewmember {
  text-anchor: end; 
  font-size: 40px;
  fill: black;
}

.event {
  fill: red;
}

.event_label {
  fill: red;
  font-weight: bold;
}

/* text inside a box */
.label {
  text-anchor: start; 
  font-size: 50px;
  fill: black;
}

.act_hour, .dtl_hour {
  font-size: 9px;
  fill: black;
}

.start_hour {
  text-anchor: start; 
}

.end_hour {
  text-anchor: end; 
}

.dtl_station {
  font-size: 11px;
  fill: black;
  text-anchor: middle; 
}

.distance {
  stroke: black;
  stroke-width: 1px;
}

.DO {
  fill: orange;
  fill-opacity: 0.8;
}

.TRN {
  fill: green;
  fill-opacity: 0.6;
}

.SBY {
  fill: cyan;
  fill-opacity: 0.8;
}

.TRP {
  fill: blue;
  fill-opacity: 0.6;
}

.LEGA {
  fill: magenta;
  fill-opacity: 0.6;
}

.LEGD {
  fill: white;
  fill-opacity: 0.6;
}

.LAY {
  fill: yellow;
  fill-opacity: 0.7;
}

.STA {
  fill: gray;
  fill-opacity: 0.6;
}

.TP {
  fill: pink;
  fill-opacity: 0.6;
}
.REST {
  fill: purple;
  fill-opacity: 0.6;
}

        </style>

        <g id="viewport" transform="matrix(0.75, 0, 0, 0.75, 160, 110)">
        <!--
          ====================================================================================
          CALENDAR
          ====================================================================================
        -->
        <g id="calendar_bar" transform="scale(1,1)"></g>
        <g id="calendar">
        <g id="intro">
        <image x="220" y="20" width="140" height="195" xlink:href="https://i.ebayimg.com/00/s/MzkwWDI4MA==/z/YKQAAOSwYqxXi7cf/$_86.JPG" />

        <text x="400" y="50"  style="fill:black;font-size:40px;">Bob, the "problem" builder v0.1</text>
        <text x="400" y="90"  style="fill:black;font-size:20px;">To start, please do one of: </text>
        <text x="420" y="120" style="fill:black;font-size:20px;">- Use File menu to load a XML station file and then Calendar menu to set a period or</text>
        <text x="420" y="150" style="fill:black;font-size:20px;">- Use File menu to load a SVG file.</text>
        </g>
        </g>

        <!--
          ====================================================================================
          CREWMEMBERS
          ====================================================================================
        -->
        <g id="crewmember_bar" transform="scale(1,1)"></g>
        <g id="crewmembers">
        </g>

        <!--
          ====================================================================================
          OPENTIME
          ====================================================================================
        -->
        <g id="opentime"></g>
        </g>

        <!--
          ====================================================================================
          DSTORE
          ====================================================================================
        -->
        <!-- Those stores are managed automatically by the graph editor. -->
        <g id="ConfigurationStore"></g>
        <g id="CalendarStore"></g>
        <g id="YCoordStore"></g>
        <g id="DistanceStore"></g>
        <g id="CrewMemberStore"></g>
        <g id="ActivityStore"></g>
        <g id="StationStore"></g>
        <g id="EventStore"></g>
        <g id="NoteStore"></g>
      </svg>
    </div>

    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateTrainingDialog" title="Create training" style="display: none;" data-dojo-props="onHide: function() {CreateTrainingForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateTrainingForm" data-dojo-id="CreateTrainingForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TrainingName" required="true"></td>
          </tr>
          <tr>
            <td><label for="TrnCm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="TrnCm" id="TrainingCrewMemberSelect" required="false"/></td>
          </tr>
          <tr>
            <td><label for="transportationtime">Transportation time apply</label></td>
            <td><input data-dojo-type="dijit/form/CheckBox" name="transportationtime" id="TrainingTransportationTime" value="true" required="true"></td>
          </tr>
          <tr>
            <td><label for="restbefore">Rest before</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restbefore" id="TrainingRestBeforeH" value="0" data-dojo-props="" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restbefore" id="TrainingRestBeforeM" value="0" data-dojo-props="" required="true">m
            </td>
          </tr>
          <tr>
            <td><label for="start">Start date time</label></td>
            <td class="datetime">
              <input id="TrainingStartDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
              <input id="TrainingStartTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
            </td>
          </tr>
          <tr>
            <td><label for="duration">Duration</label></td>
            <td>
              <input id="TrainingDurationHour"   class="durationHour" data-dojo-type="dijit/form/ComboBox" name="duration" data-dojo-props="placeHolder:'0'" required="true" readonly="true" />h&nbsp;
              <input id="TrainingDurationMinute" class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="duration" data-dojo-props="placeHolder:'0'" required="true" readonly="true" />m
            </td>
          </tr>
          <tr>
            <td><label for="end">End date time</label></td>
            <td class="datetime">
              <input id="TrainingEndDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true" />
              <input id="TrainingEndTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'" readonly="true" disabled="true" />
            </td>
          </tr>
          <tr>
            <td><label for="restafter">Rest after</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restafter" id="TrainingRestAfterH" value="0" data-dojo-props="" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restafter" id="TrainingRestAfterM" value="0" data-dojo-props="" required="true">m
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateTraining">Create</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" id="ShowHideActivityDialog" data-dojo-id="ShowHideActivityDialog" title="Show/hide activity details" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowHideActivityForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="SHActivityHours">Show activity hour label</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityHours" id="SHActivityHours" data-dojo-id="SHActivityHours"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetails">Show activity details (leg/layover)</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetails" id="SHActivityDetails" data-dojo-id="SHActivityDetails"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetailHours">Show activity detail hours</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetailHours" id="SHActivityDetailHours" data-dojo-id="SHActivityDetailHours"></td>
          </tr>
          <tr>
            <td><label for="SHActivityDetailStations">Show activity detail stations</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHActivityDetailStations" id="SHActivityDetailStations" data-dojo-id="SHActivityDetailStations"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveShowHideActivity">Close</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="ShowHideCalendarDialog" data-dojo-id="ShowHideCalendarDialog" title="Show/hide Calendar items" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowHideCalendarForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="SHCalendarHours">Show calendar hour label</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHours" id="SHCalendarHours" data-dojo-id="SHCalendarHours"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarHourBars">Show calendar hour bars</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarHourBars" id="SHCalendarHourBars" data-dojo-id="SHCalendarHourBars"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayX">Show calendar Day X</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayX" id="SHCalendarDayX" data-dojo-id="SHCalendarDayX"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayYYYYMMDD">Show calendar day YYYY-MM-DD</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayYYYYMMDD" id="SHCalendarDayYYYYMMDD" data-dojo-id="SHCalendarDayYYYYMMDD"></td>
          </tr>
          <tr>
            <td><label for="SHCalendarDayBars">Show calendar day bars</label></td>
            <td><input type="checkbox" data-dojo-type="dijit/form/CheckBox" name="SHCalendarDayBars" id="SHCalendarDayBars" data-dojo-id="SHCalendarDayBars"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveShowHideCalendar">Close</button>
        </div>
      </div>
    </div>


    <!-- TODO: create a tpl, since LoadSvgDialog and LoadStationDialog look the same -->
    <div data-dojo-type="dijit/Dialog" data-dojo-id="LoadSvgDialog" title="Load SVG file" style="display: none; width: 300px;">
      <div data-dojo-type="dijit/form/Form" id="LoadSvgForm" data-dojo-id="LoadSvgForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td>
              <input name="uploadedfile" multiple="false" type="file" id="uploader2" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an SVG File'"/> 
            </td>
          </tr>
          <tr>
            <td>
              <div id="files2" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploader2"></div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="LoadSvg">Load file</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="LoadStationDialog" title="Load XML station file" style="display: none; width: 300px;">
      <div data-dojo-type="dijit/form/Form" id="LoadStationForm" data-dojo-id="LoadStationForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td>
              <input name="uploadedfile" multiple="false" type="file" id="uploader" data-dojo-type="dojox/form/Uploader" data-dojo-props="label: 'Select an XML File'"/> 
            </td>
          </tr>
          <tr>
            <td>
              <div id="files" data-dojo-type="dojox/form/uploader/FileList" uploaderId="uploader"></div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="LoadStation">Load file</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileDialog" title="Save SVG graph as a file" style="display: none;">
      <table class="dijitDialogPaneContentArea">
        <tr>
          <td><label for="filename">Filename:</label></td>
          <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="filename" data-dojo-props="placeHolder: '.svg'" required="true"></td>
        </tr>
      </table>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveFile">Save file</button>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="SaveFileToPIDialog" title="Save XML files compatible with PI" style="display: none;">
      <div id="SaveFileToPIDialogContent" class ="dijitDialogPaneContentArea">

        <div data-dojo-type="dijit/form/Form" id="SaveFileToPIForm" data-dojo-id="SaveFileToPIForm" encType="multipart/form-data" action="" method="">
          <table >
            <tr>
              <td><label for="filename">Zip filename:</label></td>
              <td><input data-dojo-type="dijit/form/TextBox" name="filename" id="zipFilename" data-dojo-props="placeHolder: '.zip'" required="true" /></td>
            </tr>
            <tr>
              <td><label for="data">Xml data:</label></td>
              <td>
                <div data-dojo-type="dijit/layout/TabContainer" id="ici" style="width: 100%; height: 100%;">
                  <div data-dojo-type="dijit/layout/ContentPane" title="qual.xml" data-dojo-props="selected:true">
                    <textarea id="XMLqual"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="acts.xml">
                    <textarea id="XMLacts"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="trip.xml">
                    <textarea id="XMLtrip"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="trip_sup.xml">
                    <textarea id="XMLtrip_sup"></textarea>
                  </div>
                  <div data-dojo-type="dijit/layout/ContentPane" title="station.xml">
                    <textarea id="XMLstation"></textarea>
                  </div>
                </div>
              </td>
            </tr>
          </table>
          <p style="margin-top: 0; margin-bottom: 0; font-size: small;">You can use <b>Ctrl+J</b> to go to matching tag, and <b>Ctrl+F</b> to fold/unfold the current line.</p>
        </div>
      </div>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" type="button" id="SaveZipFile">Save zip file</button>
      </div>
    </div>




    <div data-dojo-type="dijit/Dialog" id="SetCalendarDialog" data-dojo-id="SetCalendarDialog" title="Set calendar" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="SetCalendarForm" data-dojo-id="SetCalendarForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="CalendarTimezone">Timezone</label></td>
            <td><input data-dojo-type="dijit/form/FilteringSelect" data-dojo-id="CalendarTimezone" name="CalendarTimezone" id="CalendarTimezone" required="true" data-dojo-props="labelAttr:'name', searchAttr:'name', identifier:'id'"></td>
          </tr>
          <tr>
            <td><label for="CalendarStation">Station</label></td>
            <td><input data-dojo-type="dijit/form/FilteringSelect" data-dojo-id="CalendarStation" name="CalendarStation" id="CalendarStation" required="true" disabled="true"></td>
          </tr>
          <tr>
            <td><label for="CalendarStart">Start date</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="CalendarStart" id="CalendarStart" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
          <tr>
            <td><label for="CalendarEnd">End date (excluded)</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="CalendarEnd" id="CalendarEnd" required="true" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SetCalendar">Set</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" id="SetStartPeriodsDialog" data-dojo-id="SetStartPeriodsDialog" title="Set start period(s)" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="SetStartPeriodsForm" data-dojo-id="SetStartPeriodsForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="start">Start period date(s)</label></td>
            <td><input multiple="true" data-dojo-type="dojox/form/CheckedMultiSelect" name="start" id="CalendarStartPeriods" size="14"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SetStartPeriods">Set</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDayOffDialog" title="Create day off" style="display: none;" data-dojo-props="onHide: function() {CreateDayOffForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateDayOffForm" data-dojo-id="CreateDayOffForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="crewmemeber">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="crewmember" id="DayOffCrewMemberSelect" required="true"></td>
          </tr>
          <tr>
            <td><label for="start">date(s)</label></td>
            <td><select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="start" id="DayOffDatesSelect" required="true"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateDayOff">Create</button>
        </div>
      </div>
    </div>



    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateCrewMemberDialog" title="Create crew member" style="display: none;" data-dojo-props="onHide: function() {CreateCrewMemberForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateCrewMemberForm" data-dojo-id="CreateCrewMemberForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="CrewMemberName" required="true"></td>
          </tr>
          <tr>
            <td><label for="start">Birth date</label></td>
            <td class="datetime"><input data-dojo-type="dijit/form/DateTextBox" name="day" id="CrewMemberBirthDate" required="true"  data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"   ></td>
          </tr>
        </table>


        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateCrewMember">Create</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="ShowConstantsDialog" data-dojo-id="ShowConstantsDialog" title="Set constants" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="ShowConstantsForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="transportationTime">Transportation time duration (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="transportationTime" id="transportationTime" value="0" data-dojo-props="" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="reportTime">Report time (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="reportTime" id="reportTime" value="20" data-dojo-props="" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="releaseTime">Release time (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="releaseTime" id="releaseTime" value="15" data-dojo-props="" required="true" style="width: 5em;"></td>
          </tr>
          <tr>
            <td><label for="midnightOffset">Midnight offset (in minutes)</label></td>
            <td><input data-dojo-type="dijit/form/ComboBox" name="midnightOffset" id="midnightOffset" value="0" data-dojo-props="constraints:{max: 1440}" required="true" style="width: 5em;"></td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveConstants">Save</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateEventDialog" title="Create an event" style="display: none;" data-dojo-props="onHide: function() {CreateEventForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateEventForm" data-dojo-id="CreateEventForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="lbl">Label</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="lbl" id="EventLabel"></td>
          </tr>
          <tr>
            <td><label for="days">Date(s)</label></td>
            <td><select multiple="true" data-dojo-type="dojox/form/FixedCheckedMultiSelect" name="days" id="EventDatesSelect"></td>
          </tr>
          <tr>
            <td><label for="time">Time</label></td>
            <td class="datetime">
              <input id="EventTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateEvent">Create</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" data-dojo-id="CreateDistanceDialog" title="Distance" style="display: none;" data-dojo-props="onHide: function() {CreateDistanceForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateDistanceForm" data-dojo-id="CreateDistanceForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="DistanceFromType">From</label></td>
            <td>
               <input type="radio" name="DistanceFromType" id="DistanceFromActivity" checked value="activity" data-dojo-type="dijit/form/RadioButton" /><label for="DistanceFromActivity">Activity</label><br />
               <input type="radio" name="DistanceFromType" id="DistanceFromEvent"            value="event"    data-dojo-type="dijit/form/RadioButton" /><label for="DistanceFromEvent">Event</label><br />
            </td>
          </tr>
          <tr>
            <td></td>
            <td>
              <table class="dstFromAct">
                <tr>
                  <td><label for="From">activity name</label></td>
                  <td><select data-dojo-type="dijit/form/FilteringSelect" name="From" id="DistanceFromActSelect" style="width: 30em;"></td>
                </tr>
                <tr>
                  <td><label for="From">activity event</label></td>
                  <td><select data-dojo-type="dijit/form/Select" id="DistanceFromActEventSelect" disabled="true"></td>
                </tr>
              </table>
              <table class="dstFromEvt" style="display: none;">
                <tr>
                  <td><label for="From">event</label></td>
                  <td><select data-dojo-type="dijit/form/Select" id="DistanceFromEventSelect"></td>
                </tr>
              </table>
            </td>
          </tr>

          <tr>
            <td><label for="DistanceToType">To</label></td>
            <td>
               <input type="radio" name="DistanceToType" id="DistanceToActivity" checked value="activity" data-dojo-type="dijit/form/RadioButton" /><label for="DistanceToActivity">Activity</label><br />
               <input type="radio" name="DistanceToType" id="DistanceToEvent"            value="event"    data-dojo-type="dijit/form/RadioButton" /><label for="DistanceToEvent">Event</label><br />
            </td>
          </tr>
          <tr>
            <td></td>
            <td>
              <table class="dstToAct">
                <tr>
                  <td><label for="To">activity name</label></td>
                  <td><select data-dojo-type="dijit/form/FilteringSelect" name="To" id="DistanceToActSelect" style="width: 30em;"></td>
                </tr>
                <tr>
                  <td><label for="To">activity event</label></td>
                  <td><select data-dojo-type="dijit/form/Select" id="DistanceToActEventSelect" disabled="true"></td>
                </tr>
              </table>
              <table class="dstToEvt" style="display: none;">
                <tr>
                  <td><label for="To">event</label></td>
                  <td><select data-dojo-type="dijit/form/Select" id="DistanceToEventSelect"></td>
                </tr>
              </table>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateDistance">Create</button>
        </div>
      </div>
    </div>


    <div data-dojo-type="dijit/Dialog" id="CreateTripDialog" data-dojo-id="CreateTripDialog" title="Create trip" style="display: none;" data-dojo-props="onHide: function() {CreateTripForm.reset();}" >
      <div data-dojo-type="dijit/form/Form" id="CreateTripForm" data-dojo-id="CreateTripForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="name">Name</label></td>
            <td><input data-dojo-type="dijit/form/TextBox" name="name" id="TripName" required="true"></td>
          </tr>
          <tr>
            <td><label for="TrpCm">Crew member</label></td>
            <td><select data-dojo-type="dijit/form/FilteringSelect" name="TrpCm" id="TripCrewMemberSelect" required="false"/></td>
          </tr>
          <tr>
            <td><label for="transportationtime">Transportation time apply</label></td>
            <td><input data-dojo-type="dijit/form/CheckBox" name="transportationtime" id="TripTransportationTime" value="true" required="true"></td>
          </tr>
          <tr>
            <td><label for="restbefore">Rest before</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restbefore" id="TripRestBeforeH" value="0" data-dojo-props="" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restbefore" id="TripRestBeforeM" value="0" data-dojo-props="" required="true">m
            </td>
          </tr>
          <tr>
            <td><label for="start">Start date time</label></td>
            <td class="datetime">
              <input id="TripStartDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'"/>
              <input id="TripStartTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'"/>
            </td>
          </tr>
          <tr>
            <td><label>Details</label></td>
            <td><div id="TripGrid"></div></td>
          </tr>
          <tr>
            <td><label for="end">End date time</label></td>
            <td class="datetime">
              <input id="TripEndDate" name="start" type="date" data-dojo-type="dijit/form/DateTextBox" data-dojo-props="constraints:{  datePattern: 'yyyy-MM-dd'}, placeHolder:'yyyy-mm-dd'" readonly="true" disabled="true" />
              <input id="TripEndTime" type="text" data-dojo-type="dijit/form/TimeTextBox" data-dojo-props="constraints:{  timePattern: 'HH:mm'}, placeHolder:'00:00'" readonly="true" disabled="true" />
            </td>
          </tr>
          <tr>
            <td><label for="restafter">Rest after</label></td>
            <td>
              <input class="durationHour" data-dojo-type="dijit/form/ComboBox" name="restafter" id="TripRestAfterH" value="0" data-dojo-props="" required="true">h&nbsp;
              <input class="durationMinute" data-dojo-type="dijit/form/FilteringSelect" name="restafter" id="TripRestAfterM" value="0" data-dojo-props="" required="true">m
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="CreateTrip">Create</button>
        </div>
      </div>
    </div>

    <div data-dojo-type="dijit/Dialog" id="CreateNoteDialog" data-dojo-id="CreateNoteDialog" title="Write a note" style="display: none;">
      <div data-dojo-type="dijit/form/Form" id="NoteForm" data-dojo-id="NoteForm" encType="multipart/form-data" action="" method="">
        <table class="dijitDialogPaneContentArea">
          <tr>
            <td><label for="Note">Note</label></td>
            <td>
              <div data-dojo-type="dijit/Editor" id="NoteEditor" name="Note" data-dojo-props="plugins:['bold','italic','underline','strikethrough','subscript','superscript','|', 'indent', 'outdent', 'justifyLeft', 'justifyCenter', 'justifyRight']" />
            </td>
          </tr>
          <tr>
            <td><label for="NoteBackgroundColor">Background color</label></td>
            <td>
              <div id="NoteBackgroundColor" style="background-color: FFFFFF; border-color: black; border-width: 1px;" dojoType="dijit/form/DropDownButton">
                <span id="colorText"><span id="NoteColorSwatch" style="height: 10px; width: 80px; border: 1px solid black; background-color: #fff5ee;">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
                <div dojoType="dijit/TooltipDialog" id="NoteColorPaletteDialog" title="Color Palette">
                <div dojoType="dijit/ColorPalette" id="NoteColorPaletteWidget"></div>                    
              </div>
            </td>
          </tr>
        </table>

        <div class="dijitDialogPaneActionBar">
          <button data-dojo-type="dijit/form/Button" type="button" id="SaveNote">Save</button>
        </div>
      </div>
    </div>


    <!-- 
      <script type="text/template" id="activity-dialog-template">
<div style="width:300px;">

      <div class="dijitDialogPaneContentArea">
        <div data-dojo-attach-point="contentNode">
            ${message}              
        </div>
      </div>

      <div class="dijitDialogPaneActionBar">
        <button data-dojo-type="dijit/form/Button" data-dojo-attach-point="closeButton" >Close</button>
        <button data-dojo-type="dijit.form.Button" data-dojo-attach-point="cancelButton" >DELETE </button> 
      </div>

    </div>
      </script>
      -->

  </div> 
</html>
